(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.adapter = f()}})(function(){var define,module,exports;return (function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
    /*
     *  Copyright (c) 2017 The WebRTC project authors. All Rights Reserved.
     *
     *  Use of this source code is governed by a BSD-style license
     *  that can be found in the LICENSE file in the root of the source
     *  tree.
     */
     /* eslint-env node */
    'use strict';
    
    var SDPUtils = require('sdp');
    
    function fixStatsType(stat) {
      return {
        inboundrtp: 'inbound-rtp',
        outboundrtp: 'outbound-rtp',
        candidatepair: 'candidate-pair',
        localcandidate: 'local-candidate',
        remotecandidate: 'remote-candidate'
      }[stat.type] || stat.type;
    }
    
    function writeMediaSection(transceiver, caps, type, stream, dtlsRole) {
      var sdp = SDPUtils.writeRtpDescription(transceiver.kind, caps);
    
      // Map ICE parameters (ufrag, pwd) to SDP.
      sdp += SDPUtils.writeIceParameters(
          transceiver.iceGatherer.getLocalParameters());
    
      // Map DTLS parameters to SDP.
      sdp += SDPUtils.writeDtlsParameters(
          transceiver.dtlsTransport.getLocalParameters(),
          type === 'offer' ? 'actpass' : dtlsRole || 'active');
    
      sdp += 'a=mid:' + transceiver.mid + '\r\n';
    
      if (transceiver.rtpSender && transceiver.rtpReceiver) {
        sdp += 'a=sendrecv\r\n';
      } else if (transceiver.rtpSender) {
        sdp += 'a=sendonly\r\n';
      } else if (transceiver.rtpReceiver) {
        sdp += 'a=recvonly\r\n';
      } else {
        sdp += 'a=inactive\r\n';
      }
    
      if (transceiver.rtpSender) {
        var trackId = transceiver.rtpSender._initialTrackId ||
            transceiver.rtpSender.track.id;
        transceiver.rtpSender._initialTrackId = trackId;
        // spec.
        var msid = 'msid:' + (stream ? stream.id : '-') + ' ' +
            trackId + '\r\n';
        sdp += 'a=' + msid;
        // for Chrome. Legacy should no longer be required.
        sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].ssrc +
            ' ' + msid;
    
        // RTX
        if (transceiver.sendEncodingParameters[0].rtx) {
          sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].rtx.ssrc +
              ' ' + msid;
          sdp += 'a=ssrc-group:FID ' +
              transceiver.sendEncodingParameters[0].ssrc + ' ' +
              transceiver.sendEncodingParameters[0].rtx.ssrc +
              '\r\n';
        }
      }
      // FIXME: this should be written by writeRtpDescription.
      sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].ssrc +
          ' cname:' + SDPUtils.localCName + '\r\n';
      if (transceiver.rtpSender && transceiver.sendEncodingParameters[0].rtx) {
        sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].rtx.ssrc +
            ' cname:' + SDPUtils.localCName + '\r\n';
      }
      return sdp;
    }
    
    // Edge does not like
    // 1) stun: filtered after 14393 unless ?transport=udp is present
    // 2) turn: that does not have all of turn:host:port?transport=udp
    // 3) turn: with ipv6 addresses
    // 4) turn: occurring muliple times
    function filterIceServers(iceServers, edgeVersion) {
      var hasTurn = false;
      iceServers = JSON.parse(JSON.stringify(iceServers));
      return iceServers.filter(function(server) {
        if (server && (server.urls || server.url)) {
          var urls = server.urls || server.url;
          if (server.url && !server.urls) {
            console.warn('RTCIceServer.url is deprecated! Use urls instead.');
          }
          var isString = typeof urls === 'string';
          if (isString) {
            urls = [urls];
          }
          urls = urls.filter(function(url) {
            var validTurn = url.indexOf('turn:') === 0 &&
                url.indexOf('transport=udp') !== -1 &&
                url.indexOf('turn:[') === -1 &&
                !hasTurn;
    
            if (validTurn) {
              hasTurn = true;
              return true;
            }
            return url.indexOf('stun:') === 0 && edgeVersion >= 14393 &&
                url.indexOf('?transport=udp') === -1;
          });
    
          delete server.url;
          server.urls = isString ? urls[0] : urls;
          return !!urls.length;
        }
      });
    }
    
    // Determines the intersection of local and remote capabilities.
    function getCommonCapabilities(localCapabilities, remoteCapabilities) {
      var commonCapabilities = {
        codecs: [],
        headerExtensions: [],
        fecMechanisms: []
      };
    
      var findCodecByPayloadType = function(pt, codecs) {
        pt = parseInt(pt, 10);
        for (var i = 0; i < codecs.length; i++) {
          if (codecs[i].payloadType === pt ||
              codecs[i].preferredPayloadType === pt) {
            return codecs[i];
          }
        }
      };
    
      var rtxCapabilityMatches = function(lRtx, rRtx, lCodecs, rCodecs) {
        var lCodec = findCodecByPayloadType(lRtx.parameters.apt, lCodecs);
        var rCodec = findCodecByPayloadType(rRtx.parameters.apt, rCodecs);
        return lCodec && rCodec &&
            lCodec.name.toLowerCase() === rCodec.name.toLowerCase();
      };
    
      localCapabilities.codecs.forEach(function(lCodec) {
        for (var i = 0; i < remoteCapabilities.codecs.length; i++) {
          var rCodec = remoteCapabilities.codecs[i];
          if (lCodec.name.toLowerCase() === rCodec.name.toLowerCase() &&
              lCodec.clockRate === rCodec.clockRate) {
            if (lCodec.name.toLowerCase() === 'rtx' &&
                lCodec.parameters && rCodec.parameters.apt) {
              // for RTX we need to find the local rtx that has a apt
              // which points to the same local codec as the remote one.
              if (!rtxCapabilityMatches(lCodec, rCodec,
                  localCapabilities.codecs, remoteCapabilities.codecs)) {
                continue;
              }
            }
            rCodec = JSON.parse(JSON.stringify(rCodec)); // deepcopy
            // number of channels is the highest common number of channels
            rCodec.numChannels = Math.min(lCodec.numChannels,
                rCodec.numChannels);
            // push rCodec so we reply with offerer payload type
            commonCapabilities.codecs.push(rCodec);
    
            // determine common feedback mechanisms
            rCodec.rtcpFeedback = rCodec.rtcpFeedback.filter(function(fb) {
              for (var j = 0; j < lCodec.rtcpFeedback.length; j++) {
                if (lCodec.rtcpFeedback[j].type === fb.type &&
                    lCodec.rtcpFeedback[j].parameter === fb.parameter) {
                  return true;
                }
              }
              return false;
            });
            // FIXME: also need to determine .parameters
            //  see https://github.com/openpeer/ortc/issues/569
            break;
          }
        }
      });
    
      localCapabilities.headerExtensions.forEach(function(lHeaderExtension) {
        for (var i = 0; i < remoteCapabilities.headerExtensions.length;
             i++) {
          var rHeaderExtension = remoteCapabilities.headerExtensions[i];
          if (lHeaderExtension.uri === rHeaderExtension.uri) {
            commonCapabilities.headerExtensions.push(rHeaderExtension);
            break;
          }
        }
      });
    
      // FIXME: fecMechanisms
      return commonCapabilities;
    }
    
    // is action=setLocalDescription with type allowed in signalingState
    function isActionAllowedInSignalingState(action, type, signalingState) {
      return {
        offer: {
          setLocalDescription: ['stable', 'have-local-offer'],
          setRemoteDescription: ['stable', 'have-remote-offer']
        },
        answer: {
          setLocalDescription: ['have-remote-offer', 'have-local-pranswer'],
          setRemoteDescription: ['have-local-offer', 'have-remote-pranswer']
        }
      }[type][action].indexOf(signalingState) !== -1;
    }
    
    function maybeAddCandidate(iceTransport, candidate) {
      // Edge's internal representation adds some fields therefore
      // not all fieldѕ are taken into account.
      var alreadyAdded = iceTransport.getRemoteCandidates()
          .find(function(remoteCandidate) {
            return candidate.foundation === remoteCandidate.foundation &&
                candidate.ip === remoteCandidate.ip &&
                candidate.port === remoteCandidate.port &&
                candidate.priority === remoteCandidate.priority &&
                candidate.protocol === remoteCandidate.protocol &&
                candidate.type === remoteCandidate.type;
          });
      if (!alreadyAdded) {
        iceTransport.addRemoteCandidate(candidate);
      }
      return !alreadyAdded;
    }
    
    
    function makeError(name, description) {
      var e = new Error(description);
      e.name = name;
      // legacy error codes from https://heycam.github.io/webidl/#idl-DOMException-error-names
      e.code = {
        NotSupportedError: 9,
        InvalidStateError: 11,
        InvalidAccessError: 15,
        TypeError: undefined,
        OperationError: undefined
      }[name];
      return e;
    }
    
    module.exports = function(window, edgeVersion) {
      // https://w3c.github.io/mediacapture-main/#mediastream
      // Helper function to add the track to the stream and
      // dispatch the event ourselves.
      function addTrackToStreamAndFireEvent(track, stream) {
        stream.addTrack(track);
        stream.dispatchEvent(new window.MediaStreamTrackEvent('addtrack',
            {track: track}));
      }
    
      function removeTrackFromStreamAndFireEvent(track, stream) {
        stream.removeTrack(track);
        stream.dispatchEvent(new window.MediaStreamTrackEvent('removetrack',
            {track: track}));
      }
    
      function fireAddTrack(pc, track, receiver, streams) {
        var trackEvent = new Event('track');
        trackEvent.track = track;
        trackEvent.receiver = receiver;
        trackEvent.transceiver = {receiver: receiver};
        trackEvent.streams = streams;
        window.setTimeout(function() {
          pc._dispatchEvent('track', trackEvent);
        });
      }
    
      var RTCPeerConnection = function(config) {
        var pc = this;
    
        var _eventTarget = document.createDocumentFragment();
        ['addEventListener', 'removeEventListener', 'dispatchEvent']
            .forEach(function(method) {
              pc[method] = _eventTarget[method].bind(_eventTarget);
            });
    
        this.canTrickleIceCandidates = null;
    
        this.needNegotiation = false;
    
        this.localStreams = [];
        this.remoteStreams = [];
    
        this._localDescription = null;
        this._remoteDescription = null;
    
        this.signalingState = 'stable';
        this.iceConnectionState = 'new';
        this.connectionState = 'new';
        this.iceGatheringState = 'new';
    
        config = JSON.parse(JSON.stringify(config || {}));
    
        this.usingBundle = config.bundlePolicy === 'max-bundle';
        if (config.rtcpMuxPolicy === 'negotiate') {
          throw(makeError('NotSupportedError',
              'rtcpMuxPolicy \'negotiate\' is not supported'));
        } else if (!config.rtcpMuxPolicy) {
          config.rtcpMuxPolicy = 'require';
        }
    
        switch (config.iceTransportPolicy) {
          case 'all':
          case 'relay':
            break;
          default:
            config.iceTransportPolicy = 'all';
            break;
        }
    
        switch (config.bundlePolicy) {
          case 'balanced':
          case 'max-compat':
          case 'max-bundle':
            break;
          default:
            config.bundlePolicy = 'balanced';
            break;
        }
    
        config.iceServers = filterIceServers(config.iceServers || [], edgeVersion);
    
        this._iceGatherers = [];
        if (config.iceCandidatePoolSize) {
          for (var i = config.iceCandidatePoolSize; i > 0; i--) {
            this._iceGatherers.push(new window.RTCIceGatherer({
              iceServers: config.iceServers,
              gatherPolicy: config.iceTransportPolicy
            }));
          }
        } else {
          config.iceCandidatePoolSize = 0;
        }
    
        this._config = config;
    
        // per-track iceGathers, iceTransports, dtlsTransports, rtpSenders, ...
        // everything that is needed to describe a SDP m-line.
        this.transceivers = [];
    
        this._sdpSessionId = SDPUtils.generateSessionId();
        this._sdpSessionVersion = 0;
    
        this._dtlsRole = undefined; // role for a=setup to use in answers.
    
        this._isClosed = false;
      };
    
      Object.defineProperty(RTCPeerConnection.prototype, 'localDescription', {
        configurable: true,
        get: function() {
          return this._localDescription;
        }
      });
      Object.defineProperty(RTCPeerConnection.prototype, 'remoteDescription', {
        configurable: true,
        get: function() {
          return this._remoteDescription;
        }
      });
    
      // set up event handlers on prototype
      RTCPeerConnection.prototype.onicecandidate = null;
      RTCPeerConnection.prototype.onaddstream = null;
      RTCPeerConnection.prototype.ontrack = null;
      RTCPeerConnection.prototype.onremovestream = null;
      RTCPeerConnection.prototype.onsignalingstatechange = null;
      RTCPeerConnection.prototype.oniceconnectionstatechange = null;
      RTCPeerConnection.prototype.onconnectionstatechange = null;
      RTCPeerConnection.prototype.onicegatheringstatechange = null;
      RTCPeerConnection.prototype.onnegotiationneeded = null;
      RTCPeerConnection.prototype.ondatachannel = null;
    
      RTCPeerConnection.prototype._dispatchEvent = function(name, event) {
        if (this._isClosed) {
          return;
        }
        this.dispatchEvent(event);
        if (typeof this['on' + name] === 'function') {
          this['on' + name](event);
        }
      };
    
      RTCPeerConnection.prototype._emitGatheringStateChange = function() {
        var event = new Event('icegatheringstatechange');
        this._dispatchEvent('icegatheringstatechange', event);
      };
    
      RTCPeerConnection.prototype.getConfiguration = function() {
        return this._config;
      };
    
      RTCPeerConnection.prototype.getLocalStreams = function() {
        return this.localStreams;
      };
    
      RTCPeerConnection.prototype.getRemoteStreams = function() {
        return this.remoteStreams;
      };
    
      // internal helper to create a transceiver object.
      // (which is not yet the same as the WebRTC 1.0 transceiver)
      RTCPeerConnection.prototype._createTransceiver = function(kind, doNotAdd) {
        var hasBundleTransport = this.transceivers.length > 0;
        var transceiver = {
          track: null,
          iceGatherer: null,
          iceTransport: null,
          dtlsTransport: null,
          localCapabilities: null,
          remoteCapabilities: null,
          rtpSender: null,
          rtpReceiver: null,
          kind: kind,
          mid: null,
          sendEncodingParameters: null,
          recvEncodingParameters: null,
          stream: null,
          associatedRemoteMediaStreams: [],
          wantReceive: true
        };
        if (this.usingBundle && hasBundleTransport) {
          transceiver.iceTransport = this.transceivers[0].iceTransport;
          transceiver.dtlsTransport = this.transceivers[0].dtlsTransport;
        } else {
          var transports = this._createIceAndDtlsTransports();
          transceiver.iceTransport = transports.iceTransport;
          transceiver.dtlsTransport = transports.dtlsTransport;
        }
        if (!doNotAdd) {
          this.transceivers.push(transceiver);
        }
        return transceiver;
      };
    
      RTCPeerConnection.prototype.addTrack = function(track, stream) {
        if (this._isClosed) {
          throw makeError('InvalidStateError',
              'Attempted to call addTrack on a closed peerconnection.');
        }
    
        var alreadyExists = this.transceivers.find(function(s) {
          return s.track === track;
        });
    
        if (alreadyExists) {
          throw makeError('InvalidAccessError', 'Track already exists.');
        }
    
        var transceiver;
        for (var i = 0; i < this.transceivers.length; i++) {
          if (!this.transceivers[i].track &&
              this.transceivers[i].kind === track.kind) {
            transceiver = this.transceivers[i];
          }
        }
        if (!transceiver) {
          transceiver = this._createTransceiver(track.kind);
        }
    
        this._maybeFireNegotiationNeeded();
    
        if (this.localStreams.indexOf(stream) === -1) {
          this.localStreams.push(stream);
        }
    
        transceiver.track = track;
        transceiver.stream = stream;
        transceiver.rtpSender = new window.RTCRtpSender(track,
            transceiver.dtlsTransport);
        return transceiver.rtpSender;
      };
    
      RTCPeerConnection.prototype.addStream = function(stream) {
        var pc = this;
        if (edgeVersion >= 15025) {
          stream.getTracks().forEach(function(track) {
            pc.addTrack(track, stream);
          });
        } else {
          // Clone is necessary for local demos mostly, attaching directly
          // to two different senders does not work (build 10547).
          // Fixed in 15025 (or earlier)
          var clonedStream = stream.clone();
          stream.getTracks().forEach(function(track, idx) {
            var clonedTrack = clonedStream.getTracks()[idx];
            track.addEventListener('enabled', function(event) {
              clonedTrack.enabled = event.enabled;
            });
          });
          clonedStream.getTracks().forEach(function(track) {
            pc.addTrack(track, clonedStream);
          });
        }
      };
    
      RTCPeerConnection.prototype.removeTrack = function(sender) {
        if (this._isClosed) {
          throw makeError('InvalidStateError',
              'Attempted to call removeTrack on a closed peerconnection.');
        }
    
        if (!(sender instanceof window.RTCRtpSender)) {
          throw new TypeError('Argument 1 of RTCPeerConnection.removeTrack ' +
              'does not implement interface RTCRtpSender.');
        }
    
        var transceiver = this.transceivers.find(function(t) {
          return t.rtpSender === sender;
        });
    
        if (!transceiver) {
          throw makeError('InvalidAccessError',
              'Sender was not created by this connection.');
        }
        var stream = transceiver.stream;
    
        transceiver.rtpSender.stop();
        transceiver.rtpSender = null;
        transceiver.track = null;
        transceiver.stream = null;
    
        // remove the stream from the set of local streams
        var localStreams = this.transceivers.map(function(t) {
          return t.stream;
        });
        if (localStreams.indexOf(stream) === -1 &&
            this.localStreams.indexOf(stream) > -1) {
          this.localStreams.splice(this.localStreams.indexOf(stream), 1);
        }
    
        this._maybeFireNegotiationNeeded();
      };
    
      RTCPeerConnection.prototype.removeStream = function(stream) {
        var pc = this;
        stream.getTracks().forEach(function(track) {
          var sender = pc.getSenders().find(function(s) {
            return s.track === track;
          });
          if (sender) {
            pc.removeTrack(sender);
          }
        });
      };
    
      RTCPeerConnection.prototype.getSenders = function() {
        return this.transceivers.filter(function(transceiver) {
          return !!transceiver.rtpSender;
        })
        .map(function(transceiver) {
          return transceiver.rtpSender;
        });
      };
    
      RTCPeerConnection.prototype.getReceivers = function() {
        return this.transceivers.filter(function(transceiver) {
          return !!transceiver.rtpReceiver;
        })
        .map(function(transceiver) {
          return transceiver.rtpReceiver;
        });
      };
    
    
      RTCPeerConnection.prototype._createIceGatherer = function(sdpMLineIndex,
          usingBundle) {
        var pc = this;
        if (usingBundle && sdpMLineIndex > 0) {
          return this.transceivers[0].iceGatherer;
        } else if (this._iceGatherers.length) {
          return this._iceGatherers.shift();
        }
        var iceGatherer = new window.RTCIceGatherer({
          iceServers: this._config.iceServers,
          gatherPolicy: this._config.iceTransportPolicy
        });
        Object.defineProperty(iceGatherer, 'state',
            {value: 'new', writable: true}
        );
    
        this.transceivers[sdpMLineIndex].bufferedCandidateEvents = [];
        this.transceivers[sdpMLineIndex].bufferCandidates = function(event) {
          var end = !event.candidate || Object.keys(event.candidate).length === 0;
          // polyfill since RTCIceGatherer.state is not implemented in
          // Edge 10547 yet.
          iceGatherer.state = end ? 'completed' : 'gathering';
          if (pc.transceivers[sdpMLineIndex].bufferedCandidateEvents !== null) {
            pc.transceivers[sdpMLineIndex].bufferedCandidateEvents.push(event);
          }
        };
        iceGatherer.addEventListener('localcandidate',
          this.transceivers[sdpMLineIndex].bufferCandidates);
        return iceGatherer;
      };
    
      // start gathering from an RTCIceGatherer.
      RTCPeerConnection.prototype._gather = function(mid, sdpMLineIndex) {
        var pc = this;
        var iceGatherer = this.transceivers[sdpMLineIndex].iceGatherer;
        if (iceGatherer.onlocalcandidate) {
          return;
        }
        var bufferedCandidateEvents =
          this.transceivers[sdpMLineIndex].bufferedCandidateEvents;
        this.transceivers[sdpMLineIndex].bufferedCandidateEvents = null;
        iceGatherer.removeEventListener('localcandidate',
          this.transceivers[sdpMLineIndex].bufferCandidates);
        iceGatherer.onlocalcandidate = function(evt) {
          if (pc.usingBundle && sdpMLineIndex > 0) {
            // if we know that we use bundle we can drop candidates with
            // ѕdpMLineIndex > 0. If we don't do this then our state gets
            // confused since we dispose the extra ice gatherer.
            return;
          }
          var event = new Event('icecandidate');
          event.candidate = {sdpMid: mid, sdpMLineIndex: sdpMLineIndex};
    
          var cand = evt.candidate;
          // Edge emits an empty object for RTCIceCandidateComplete‥
          var end = !cand || Object.keys(cand).length === 0;
          if (end) {
            // polyfill since RTCIceGatherer.state is not implemented in
            // Edge 10547 yet.
            if (iceGatherer.state === 'new' || iceGatherer.state === 'gathering') {
              iceGatherer.state = 'completed';
            }
          } else {
            if (iceGatherer.state === 'new') {
              iceGatherer.state = 'gathering';
            }
            // RTCIceCandidate doesn't have a component, needs to be added
            cand.component = 1;
            // also the usernameFragment. TODO: update SDP to take both variants.
            cand.ufrag = iceGatherer.getLocalParameters().usernameFragment;
    
            var serializedCandidate = SDPUtils.writeCandidate(cand);
            event.candidate = Object.assign(event.candidate,
                SDPUtils.parseCandidate(serializedCandidate));
    
            event.candidate.candidate = serializedCandidate;
            event.candidate.toJSON = function() {
              return {
                candidate: event.candidate.candidate,
                sdpMid: event.candidate.sdpMid,
                sdpMLineIndex: event.candidate.sdpMLineIndex,
                usernameFragment: event.candidate.usernameFragment
              };
            };
          }
    
          // update local description.
          var sections = SDPUtils.getMediaSections(pc._localDescription.sdp);
          if (!end) {
            sections[event.candidate.sdpMLineIndex] +=
                'a=' + event.candidate.candidate + '\r\n';
          } else {
            sections[event.candidate.sdpMLineIndex] +=
                'a=end-of-candidates\r\n';
          }
          pc._localDescription.sdp =
              SDPUtils.getDescription(pc._localDescription.sdp) +
              sections.join('');
          var complete = pc.transceivers.every(function(transceiver) {
            return transceiver.iceGatherer &&
                transceiver.iceGatherer.state === 'completed';
          });
    
          if (pc.iceGatheringState !== 'gathering') {
            pc.iceGatheringState = 'gathering';
            pc._emitGatheringStateChange();
          }
    
          // Emit candidate. Also emit null candidate when all gatherers are
          // complete.
          if (!end) {
            pc._dispatchEvent('icecandidate', event);
          }
          if (complete) {
            pc._dispatchEvent('icecandidate', new Event('icecandidate'));
            pc.iceGatheringState = 'complete';
            pc._emitGatheringStateChange();
          }
        };
    
        // emit already gathered candidates.
        window.setTimeout(function() {
          bufferedCandidateEvents.forEach(function(e) {
            iceGatherer.onlocalcandidate(e);
          });
        }, 0);
      };
    
      // Create ICE transport and DTLS transport.
      RTCPeerConnection.prototype._createIceAndDtlsTransports = function() {
        var pc = this;
        var iceTransport = new window.RTCIceTransport(null);
        iceTransport.onicestatechange = function() {
          pc._updateIceConnectionState();
          pc._updateConnectionState();
        };
    
        var dtlsTransport = new window.RTCDtlsTransport(iceTransport);
        dtlsTransport.ondtlsstatechange = function() {
          pc._updateConnectionState();
        };
        dtlsTransport.onerror = function() {
          // onerror does not set state to failed by itself.
          Object.defineProperty(dtlsTransport, 'state',
              {value: 'failed', writable: true});
          pc._updateConnectionState();
        };
    
        return {
          iceTransport: iceTransport,
          dtlsTransport: dtlsTransport
        };
      };
    
      // Destroy ICE gatherer, ICE transport and DTLS transport.
      // Without triggering the callbacks.
      RTCPeerConnection.prototype._disposeIceAndDtlsTransports = function(
          sdpMLineIndex) {
        var iceGatherer = this.transceivers[sdpMLineIndex].iceGatherer;
        if (iceGatherer) {
          delete iceGatherer.onlocalcandidate;
          delete this.transceivers[sdpMLineIndex].iceGatherer;
        }
        var iceTransport = this.transceivers[sdpMLineIndex].iceTransport;
        if (iceTransport) {
          delete iceTransport.onicestatechange;
          delete this.transceivers[sdpMLineIndex].iceTransport;
        }
        var dtlsTransport = this.transceivers[sdpMLineIndex].dtlsTransport;
        if (dtlsTransport) {
          delete dtlsTransport.ondtlsstatechange;
          delete dtlsTransport.onerror;
          delete this.transceivers[sdpMLineIndex].dtlsTransport;
        }
      };
    
      // Start the RTP Sender and Receiver for a transceiver.
      RTCPeerConnection.prototype._transceive = function(transceiver,
          send, recv) {
        var params = getCommonCapabilities(transceiver.localCapabilities,
            transceiver.remoteCapabilities);
        if (send && transceiver.rtpSender) {
          params.encodings = transceiver.sendEncodingParameters;
          params.rtcp = {
            cname: SDPUtils.localCName,
            compound: transceiver.rtcpParameters.compound
          };
          if (transceiver.recvEncodingParameters.length) {
            params.rtcp.ssrc = transceiver.recvEncodingParameters[0].ssrc;
          }
          transceiver.rtpSender.send(params);
        }
        if (recv && transceiver.rtpReceiver && params.codecs.length > 0) {
          // remove RTX field in Edge 14942
          if (transceiver.kind === 'video'
              && transceiver.recvEncodingParameters
              && edgeVersion < 15019) {
            transceiver.recvEncodingParameters.forEach(function(p) {
              delete p.rtx;
            });
          }
          if (transceiver.recvEncodingParameters.length) {
            params.encodings = transceiver.recvEncodingParameters;
          } else {
            params.encodings = [{}];
          }
          params.rtcp = {
            compound: transceiver.rtcpParameters.compound
          };
          if (transceiver.rtcpParameters.cname) {
            params.rtcp.cname = transceiver.rtcpParameters.cname;
          }
          if (transceiver.sendEncodingParameters.length) {
            params.rtcp.ssrc = transceiver.sendEncodingParameters[0].ssrc;
          }
          transceiver.rtpReceiver.receive(params);
        }
      };
    
      RTCPeerConnection.prototype.setLocalDescription = function(description) {
        var pc = this;
    
        // Note: pranswer is not supported.
        if (['offer', 'answer'].indexOf(description.type) === -1) {
          return Promise.reject(makeError('TypeError',
              'Unsupported type "' + description.type + '"'));
        }
    
        if (!isActionAllowedInSignalingState('setLocalDescription',
            description.type, pc.signalingState) || pc._isClosed) {
          return Promise.reject(makeError('InvalidStateError',
              'Can not set local ' + description.type +
              ' in state ' + pc.signalingState));
        }
    
        var sections;
        var sessionpart;
        if (description.type === 'offer') {
          // VERY limited support for SDP munging. Limited to:
          // * changing the order of codecs
          sections = SDPUtils.splitSections(description.sdp);
          sessionpart = sections.shift();
          sections.forEach(function(mediaSection, sdpMLineIndex) {
            var caps = SDPUtils.parseRtpParameters(mediaSection);
            pc.transceivers[sdpMLineIndex].localCapabilities = caps;
          });
    
          pc.transceivers.forEach(function(transceiver, sdpMLineIndex) {
            pc._gather(transceiver.mid, sdpMLineIndex);
          });
        } else if (description.type === 'answer') {
          sections = SDPUtils.splitSections(pc._remoteDescription.sdp);
          sessionpart = sections.shift();
          var isIceLite = SDPUtils.matchPrefix(sessionpart,
              'a=ice-lite').length > 0;
          sections.forEach(function(mediaSection, sdpMLineIndex) {
            var transceiver = pc.transceivers[sdpMLineIndex];
            var iceGatherer = transceiver.iceGatherer;
            var iceTransport = transceiver.iceTransport;
            var dtlsTransport = transceiver.dtlsTransport;
            var localCapabilities = transceiver.localCapabilities;
            var remoteCapabilities = transceiver.remoteCapabilities;
    
            // treat bundle-only as not-rejected.
            var rejected = SDPUtils.isRejected(mediaSection) &&
                SDPUtils.matchPrefix(mediaSection, 'a=bundle-only').length === 0;
    
            if (!rejected && !transceiver.rejected) {
              var remoteIceParameters = SDPUtils.getIceParameters(
                  mediaSection, sessionpart);
              var remoteDtlsParameters = SDPUtils.getDtlsParameters(
                  mediaSection, sessionpart);
              if (isIceLite) {
                remoteDtlsParameters.role = 'server';
              }
    
              if (!pc.usingBundle || sdpMLineIndex === 0) {
                pc._gather(transceiver.mid, sdpMLineIndex);
                if (iceTransport.state === 'new') {
                  iceTransport.start(iceGatherer, remoteIceParameters,
                      isIceLite ? 'controlling' : 'controlled');
                }
                if (dtlsTransport.state === 'new') {
                  dtlsTransport.start(remoteDtlsParameters);
                }
              }
    
              // Calculate intersection of capabilities.
              var params = getCommonCapabilities(localCapabilities,
                  remoteCapabilities);
    
              // Start the RTCRtpSender. The RTCRtpReceiver for this
              // transceiver has already been started in setRemoteDescription.
              pc._transceive(transceiver,
                  params.codecs.length > 0,
                  false);
            }
          });
        }
    
        pc._localDescription = {
          type: description.type,
          sdp: description.sdp
        };
        if (description.type === 'offer') {
          pc._updateSignalingState('have-local-offer');
        } else {
          pc._updateSignalingState('stable');
        }
    
        return Promise.resolve();
      };
    
      RTCPeerConnection.prototype.setRemoteDescription = function(description) {
        var pc = this;
    
        // Note: pranswer is not supported.
        if (['offer', 'answer'].indexOf(description.type) === -1) {
          return Promise.reject(makeError('TypeError',
              'Unsupported type "' + description.type + '"'));
        }
    
        if (!isActionAllowedInSignalingState('setRemoteDescription',
            description.type, pc.signalingState) || pc._isClosed) {
          return Promise.reject(makeError('InvalidStateError',
              'Can not set remote ' + description.type +
              ' in state ' + pc.signalingState));
        }
    
        var streams = {};
        pc.remoteStreams.forEach(function(stream) {
          streams[stream.id] = stream;
        });
        var receiverList = [];
        var sections = SDPUtils.splitSections(description.sdp);
        var sessionpart = sections.shift();
        var isIceLite = SDPUtils.matchPrefix(sessionpart,
            'a=ice-lite').length > 0;
        var usingBundle = SDPUtils.matchPrefix(sessionpart,
            'a=group:BUNDLE ').length > 0;
        pc.usingBundle = usingBundle;
        var iceOptions = SDPUtils.matchPrefix(sessionpart,
            'a=ice-options:')[0];
        if (iceOptions) {
          pc.canTrickleIceCandidates = iceOptions.substr(14).split(' ')
              .indexOf('trickle') >= 0;
        } else {
          pc.canTrickleIceCandidates = false;
        }
    
        sections.forEach(function(mediaSection, sdpMLineIndex) {
          var lines = SDPUtils.splitLines(mediaSection);
          var kind = SDPUtils.getKind(mediaSection);
          // treat bundle-only as not-rejected.
          var rejected = SDPUtils.isRejected(mediaSection) &&
              SDPUtils.matchPrefix(mediaSection, 'a=bundle-only').length === 0;
          var protocol = lines[0].substr(2).split(' ')[2];
    
          var direction = SDPUtils.getDirection(mediaSection, sessionpart);
          var remoteMsid = SDPUtils.parseMsid(mediaSection);
    
          var mid = SDPUtils.getMid(mediaSection) || SDPUtils.generateIdentifier();
    
          // Reject datachannels which are not implemented yet.
          if (rejected || (kind === 'application' && (protocol === 'DTLS/SCTP' ||
              protocol === 'UDP/DTLS/SCTP'))) {
            // TODO: this is dangerous in the case where a non-rejected m-line
            //     becomes rejected.
            pc.transceivers[sdpMLineIndex] = {
              mid: mid,
              kind: kind,
              protocol: protocol,
              rejected: true
            };
            return;
          }
    
          if (!rejected && pc.transceivers[sdpMLineIndex] &&
              pc.transceivers[sdpMLineIndex].rejected) {
            // recycle a rejected transceiver.
            pc.transceivers[sdpMLineIndex] = pc._createTransceiver(kind, true);
          }
    
          var transceiver;
          var iceGatherer;
          var iceTransport;
          var dtlsTransport;
          var rtpReceiver;
          var sendEncodingParameters;
          var recvEncodingParameters;
          var localCapabilities;
    
          var track;
          // FIXME: ensure the mediaSection has rtcp-mux set.
          var remoteCapabilities = SDPUtils.parseRtpParameters(mediaSection);
          var remoteIceParameters;
          var remoteDtlsParameters;
          if (!rejected) {
            remoteIceParameters = SDPUtils.getIceParameters(mediaSection,
                sessionpart);
            remoteDtlsParameters = SDPUtils.getDtlsParameters(mediaSection,
                sessionpart);
            remoteDtlsParameters.role = 'client';
          }
          recvEncodingParameters =
              SDPUtils.parseRtpEncodingParameters(mediaSection);
    
          var rtcpParameters = SDPUtils.parseRtcpParameters(mediaSection);
    
          var isComplete = SDPUtils.matchPrefix(mediaSection,
              'a=end-of-candidates', sessionpart).length > 0;
          var cands = SDPUtils.matchPrefix(mediaSection, 'a=candidate:')
              .map(function(cand) {
                return SDPUtils.parseCandidate(cand);
              })
              .filter(function(cand) {
                return cand.component === 1;
              });
    
          // Check if we can use BUNDLE and dispose transports.
          if ((description.type === 'offer' || description.type === 'answer') &&
              !rejected && usingBundle && sdpMLineIndex > 0 &&
              pc.transceivers[sdpMLineIndex]) {
            pc._disposeIceAndDtlsTransports(sdpMLineIndex);
            pc.transceivers[sdpMLineIndex].iceGatherer =
                pc.transceivers[0].iceGatherer;
            pc.transceivers[sdpMLineIndex].iceTransport =
                pc.transceivers[0].iceTransport;
            pc.transceivers[sdpMLineIndex].dtlsTransport =
                pc.transceivers[0].dtlsTransport;
            if (pc.transceivers[sdpMLineIndex].rtpSender) {
              pc.transceivers[sdpMLineIndex].rtpSender.setTransport(
                  pc.transceivers[0].dtlsTransport);
            }
            if (pc.transceivers[sdpMLineIndex].rtpReceiver) {
              pc.transceivers[sdpMLineIndex].rtpReceiver.setTransport(
                  pc.transceivers[0].dtlsTransport);
            }
          }
          if (description.type === 'offer' && !rejected) {
            transceiver = pc.transceivers[sdpMLineIndex] ||
                pc._createTransceiver(kind);
            transceiver.mid = mid;
    
            if (!transceiver.iceGatherer) {
              transceiver.iceGatherer = pc._createIceGatherer(sdpMLineIndex,
                  usingBundle);
            }
    
            if (cands.length && transceiver.iceTransport.state === 'new') {
              if (isComplete && (!usingBundle || sdpMLineIndex === 0)) {
                transceiver.iceTransport.setRemoteCandidates(cands);
              } else {
                cands.forEach(function(candidate) {
                  maybeAddCandidate(transceiver.iceTransport, candidate);
                });
              }
            }
    
            localCapabilities = window.RTCRtpReceiver.getCapabilities(kind);
    
            // filter RTX until additional stuff needed for RTX is implemented
            // in adapter.js
            if (edgeVersion < 15019) {
              localCapabilities.codecs = localCapabilities.codecs.filter(
                  function(codec) {
                    return codec.name !== 'rtx';
                  });
            }
    
            sendEncodingParameters = transceiver.sendEncodingParameters || [{
              ssrc: (2 * sdpMLineIndex + 2) * 1001
            }];
    
            // TODO: rewrite to use http://w3c.github.io/webrtc-pc/#set-associated-remote-streams
            var isNewTrack = false;
            if (direction === 'sendrecv' || direction === 'sendonly') {
              isNewTrack = !transceiver.rtpReceiver;
              rtpReceiver = transceiver.rtpReceiver ||
                  new window.RTCRtpReceiver(transceiver.dtlsTransport, kind);
    
              if (isNewTrack) {
                var stream;
                track = rtpReceiver.track;
                // FIXME: does not work with Plan B.
                if (remoteMsid && remoteMsid.stream === '-') {
                  // no-op. a stream id of '-' means: no associated stream.
                } else if (remoteMsid) {
                  if (!streams[remoteMsid.stream]) {
                    streams[remoteMsid.stream] = new window.MediaStream();
                    Object.defineProperty(streams[remoteMsid.stream], 'id', {
                      get: function() {
                        return remoteMsid.stream;
                      }
                    });
                  }
                  Object.defineProperty(track, 'id', {
                    get: function() {
                      return remoteMsid.track;
                    }
                  });
                  stream = streams[remoteMsid.stream];
                } else {
                  if (!streams.default) {
                    streams.default = new window.MediaStream();
                  }
                  stream = streams.default;
                }
                if (stream) {
                  addTrackToStreamAndFireEvent(track, stream);
                  transceiver.associatedRemoteMediaStreams.push(stream);
                }
                receiverList.push([track, rtpReceiver, stream]);
              }
            } else if (transceiver.rtpReceiver && transceiver.rtpReceiver.track) {
              transceiver.associatedRemoteMediaStreams.forEach(function(s) {
                var nativeTrack = s.getTracks().find(function(t) {
                  return t.id === transceiver.rtpReceiver.track.id;
                });
                if (nativeTrack) {
                  removeTrackFromStreamAndFireEvent(nativeTrack, s);
                }
              });
              transceiver.associatedRemoteMediaStreams = [];
            }
    
            transceiver.localCapabilities = localCapabilities;
            transceiver.remoteCapabilities = remoteCapabilities;
            transceiver.rtpReceiver = rtpReceiver;
            transceiver.rtcpParameters = rtcpParameters;
            transceiver.sendEncodingParameters = sendEncodingParameters;
            transceiver.recvEncodingParameters = recvEncodingParameters;
    
            // Start the RTCRtpReceiver now. The RTPSender is started in
            // setLocalDescription.
            pc._transceive(pc.transceivers[sdpMLineIndex],
                false,
                isNewTrack);
          } else if (description.type === 'answer' && !rejected) {
            transceiver = pc.transceivers[sdpMLineIndex];
            iceGatherer = transceiver.iceGatherer;
            iceTransport = transceiver.iceTransport;
            dtlsTransport = transceiver.dtlsTransport;
            rtpReceiver = transceiver.rtpReceiver;
            sendEncodingParameters = transceiver.sendEncodingParameters;
            localCapabilities = transceiver.localCapabilities;
    
            pc.transceivers[sdpMLineIndex].recvEncodingParameters =
                recvEncodingParameters;
            pc.transceivers[sdpMLineIndex].remoteCapabilities =
                remoteCapabilities;
            pc.transceivers[sdpMLineIndex].rtcpParameters = rtcpParameters;
    
            if (cands.length && iceTransport.state === 'new') {
              if ((isIceLite || isComplete) &&
                  (!usingBundle || sdpMLineIndex === 0)) {
                iceTransport.setRemoteCandidates(cands);
              } else {
                cands.forEach(function(candidate) {
                  maybeAddCandidate(transceiver.iceTransport, candidate);
                });
              }
            }
    
            if (!usingBundle || sdpMLineIndex === 0) {
              if (iceTransport.state === 'new') {
                iceTransport.start(iceGatherer, remoteIceParameters,
                    'controlling');
              }
              if (dtlsTransport.state === 'new') {
                dtlsTransport.start(remoteDtlsParameters);
              }
            }
    
            // If the offer contained RTX but the answer did not,
            // remove RTX from sendEncodingParameters.
            var commonCapabilities = getCommonCapabilities(
              transceiver.localCapabilities,
              transceiver.remoteCapabilities);
    
            var hasRtx = commonCapabilities.codecs.filter(function(c) {
              return c.name.toLowerCase() === 'rtx';
            }).length;
            if (!hasRtx && transceiver.sendEncodingParameters[0].rtx) {
              delete transceiver.sendEncodingParameters[0].rtx;
            }
    
            pc._transceive(transceiver,
                direction === 'sendrecv' || direction === 'recvonly',
                direction === 'sendrecv' || direction === 'sendonly');
    
            // TODO: rewrite to use http://w3c.github.io/webrtc-pc/#set-associated-remote-streams
            if (rtpReceiver &&
                (direction === 'sendrecv' || direction === 'sendonly')) {
              track = rtpReceiver.track;
              if (remoteMsid) {
                if (!streams[remoteMsid.stream]) {
                  streams[remoteMsid.stream] = new window.MediaStream();
                }
                addTrackToStreamAndFireEvent(track, streams[remoteMsid.stream]);
                receiverList.push([track, rtpReceiver, streams[remoteMsid.stream]]);
              } else {
                if (!streams.default) {
                  streams.default = new window.MediaStream();
                }
                addTrackToStreamAndFireEvent(track, streams.default);
                receiverList.push([track, rtpReceiver, streams.default]);
              }
            } else {
              // FIXME: actually the receiver should be created later.
              delete transceiver.rtpReceiver;
            }
          }
        });
    
        if (pc._dtlsRole === undefined) {
          pc._dtlsRole = description.type === 'offer' ? 'active' : 'passive';
        }
    
        pc._remoteDescription = {
          type: description.type,
          sdp: description.sdp
        };
        if (description.type === 'offer') {
          pc._updateSignalingState('have-remote-offer');
        } else {
          pc._updateSignalingState('stable');
        }
        Object.keys(streams).forEach(function(sid) {
          var stream = streams[sid];
          if (stream.getTracks().length) {
            if (pc.remoteStreams.indexOf(stream) === -1) {
              pc.remoteStreams.push(stream);
              var event = new Event('addstream');
              event.stream = stream;
              window.setTimeout(function() {
                pc._dispatchEvent('addstream', event);
              });
            }
    
            receiverList.forEach(function(item) {
              var track = item[0];
              var receiver = item[1];
              if (stream.id !== item[2].id) {
                return;
              }
              fireAddTrack(pc, track, receiver, [stream]);
            });
          }
        });
        receiverList.forEach(function(item) {
          if (item[2]) {
            return;
          }
          fireAddTrack(pc, item[0], item[1], []);
        });
    
        // check whether addIceCandidate({}) was called within four seconds after
        // setRemoteDescription.
        window.setTimeout(function() {
          if (!(pc && pc.transceivers)) {
            return;
          }
          pc.transceivers.forEach(function(transceiver) {
            if (transceiver.iceTransport &&
                transceiver.iceTransport.state === 'new' &&
                transceiver.iceTransport.getRemoteCandidates().length > 0) {
              console.warn('Timeout for addRemoteCandidate. Consider sending ' +
                  'an end-of-candidates notification');
              transceiver.iceTransport.addRemoteCandidate({});
            }
          });
        }, 4000);
    
        return Promise.resolve();
      };
    
      RTCPeerConnection.prototype.close = function() {
        this.transceivers.forEach(function(transceiver) {
          /* not yet
          if (transceiver.iceGatherer) {
            transceiver.iceGatherer.close();
          }
          */
          if (transceiver.iceTransport) {
            transceiver.iceTransport.stop();
          }
          if (transceiver.dtlsTransport) {
            transceiver.dtlsTransport.stop();
          }
          if (transceiver.rtpSender) {
            transceiver.rtpSender.stop();
          }
          if (transceiver.rtpReceiver) {
            transceiver.rtpReceiver.stop();
          }
        });
        // FIXME: clean up tracks, local streams, remote streams, etc
        this._isClosed = true;
        this._updateSignalingState('closed');
      };
    
      // Update the signaling state.
      RTCPeerConnection.prototype._updateSignalingState = function(newState) {
        this.signalingState = newState;
        var event = new Event('signalingstatechange');
        this._dispatchEvent('signalingstatechange', event);
      };
    
      // Determine whether to fire the negotiationneeded event.
      RTCPeerConnection.prototype._maybeFireNegotiationNeeded = function() {
        var pc = this;
        if (this.signalingState !== 'stable' || this.needNegotiation === true) {
          return;
        }
        this.needNegotiation = true;
        window.setTimeout(function() {
          if (pc.needNegotiation) {
            pc.needNegotiation = false;
            var event = new Event('negotiationneeded');
            pc._dispatchEvent('negotiationneeded', event);
          }
        }, 0);
      };
    
      // Update the ice connection state.
      RTCPeerConnection.prototype._updateIceConnectionState = function() {
        var newState;
        var states = {
          'new': 0,
          closed: 0,
          checking: 0,
          connected: 0,
          completed: 0,
          disconnected: 0,
          failed: 0
        };
        this.transceivers.forEach(function(transceiver) {
          states[transceiver.iceTransport.state]++;
        });
    
        newState = 'new';
        if (states.failed > 0) {
          newState = 'failed';
        } else if (states.checking > 0) {
          newState = 'checking';
        } else if (states.disconnected > 0) {
          newState = 'disconnected';
        } else if (states.new > 0) {
          newState = 'new';
        } else if (states.connected > 0) {
          newState = 'connected';
        } else if (states.completed > 0) {
          newState = 'completed';
        }
    
        if (newState !== this.iceConnectionState) {
          this.iceConnectionState = newState;
          var event = new Event('iceconnectionstatechange');
          this._dispatchEvent('iceconnectionstatechange', event);
        }
      };
    
      // Update the connection state.
      RTCPeerConnection.prototype._updateConnectionState = function() {
        var newState;
        var states = {
          'new': 0,
          closed: 0,
          connecting: 0,
          connected: 0,
          completed: 0,
          disconnected: 0,
          failed: 0
        };
        this.transceivers.forEach(function(transceiver) {
          states[transceiver.iceTransport.state]++;
          states[transceiver.dtlsTransport.state]++;
        });
        // ICETransport.completed and connected are the same for this purpose.
        states.connected += states.completed;
    
        newState = 'new';
        if (states.failed > 0) {
          newState = 'failed';
        } else if (states.connecting > 0) {
          newState = 'connecting';
        } else if (states.disconnected > 0) {
          newState = 'disconnected';
        } else if (states.new > 0) {
          newState = 'new';
        } else if (states.connected > 0) {
          newState = 'connected';
        }
    
        if (newState !== this.connectionState) {
          this.connectionState = newState;
          var event = new Event('connectionstatechange');
          this._dispatchEvent('connectionstatechange', event);
        }
      };
    
      RTCPeerConnection.prototype.createOffer = function() {
        var pc = this;
    
        if (pc._isClosed) {
          return Promise.reject(makeError('InvalidStateError',
              'Can not call createOffer after close'));
        }
    
        var numAudioTracks = pc.transceivers.filter(function(t) {
          return t.kind === 'audio';
        }).length;
        var numVideoTracks = pc.transceivers.filter(function(t) {
          return t.kind === 'video';
        }).length;
    
        // Determine number of audio and video tracks we need to send/recv.
        var offerOptions = arguments[0];
        if (offerOptions) {
          // Reject Chrome legacy constraints.
          if (offerOptions.mandatory || offerOptions.optional) {
            throw new TypeError(
                'Legacy mandatory/optional constraints not supported.');
          }
          if (offerOptions.offerToReceiveAudio !== undefined) {
            if (offerOptions.offerToReceiveAudio === true) {
              numAudioTracks = 1;
            } else if (offerOptions.offerToReceiveAudio === false) {
              numAudioTracks = 0;
            } else {
              numAudioTracks = offerOptions.offerToReceiveAudio;
            }
          }
          if (offerOptions.offerToReceiveVideo !== undefined) {
            if (offerOptions.offerToReceiveVideo === true) {
              numVideoTracks = 1;
            } else if (offerOptions.offerToReceiveVideo === false) {
              numVideoTracks = 0;
            } else {
              numVideoTracks = offerOptions.offerToReceiveVideo;
            }
          }
        }
    
        pc.transceivers.forEach(function(transceiver) {
          if (transceiver.kind === 'audio') {
            numAudioTracks--;
            if (numAudioTracks < 0) {
              transceiver.wantReceive = false;
            }
          } else if (transceiver.kind === 'video') {
            numVideoTracks--;
            if (numVideoTracks < 0) {
              transceiver.wantReceive = false;
            }
          }
        });
    
        // Create M-lines for recvonly streams.
        while (numAudioTracks > 0 || numVideoTracks > 0) {
          if (numAudioTracks > 0) {
            pc._createTransceiver('audio');
            numAudioTracks--;
          }
          if (numVideoTracks > 0) {
            pc._createTransceiver('video');
            numVideoTracks--;
          }
        }
    
        var sdp = SDPUtils.writeSessionBoilerplate(pc._sdpSessionId,
            pc._sdpSessionVersion++);
        pc.transceivers.forEach(function(transceiver, sdpMLineIndex) {
          // For each track, create an ice gatherer, ice transport,
          // dtls transport, potentially rtpsender and rtpreceiver.
          var track = transceiver.track;
          var kind = transceiver.kind;
          var mid = transceiver.mid || SDPUtils.generateIdentifier();
          transceiver.mid = mid;
    
          if (!transceiver.iceGatherer) {
            transceiver.iceGatherer = pc._createIceGatherer(sdpMLineIndex,
                pc.usingBundle);
          }
    
          var localCapabilities = window.RTCRtpSender.getCapabilities(kind);
          // filter RTX until additional stuff needed for RTX is implemented
          // in adapter.js
          if (edgeVersion < 15019) {
            localCapabilities.codecs = localCapabilities.codecs.filter(
                function(codec) {
                  return codec.name !== 'rtx';
                });
          }
          localCapabilities.codecs.forEach(function(codec) {
            // work around https://bugs.chromium.org/p/webrtc/issues/detail?id=6552
            // by adding level-asymmetry-allowed=1
            if (codec.name === 'H264' &&
                codec.parameters['level-asymmetry-allowed'] === undefined) {
              codec.parameters['level-asymmetry-allowed'] = '1';
            }
    
            // for subsequent offers, we might have to re-use the payload
            // type of the last offer.
            if (transceiver.remoteCapabilities &&
                transceiver.remoteCapabilities.codecs) {
              transceiver.remoteCapabilities.codecs.forEach(function(remoteCodec) {
                if (codec.name.toLowerCase() === remoteCodec.name.toLowerCase() &&
                    codec.clockRate === remoteCodec.clockRate) {
                  codec.preferredPayloadType = remoteCodec.payloadType;
                }
              });
            }
          });
          localCapabilities.headerExtensions.forEach(function(hdrExt) {
            var remoteExtensions = transceiver.remoteCapabilities &&
                transceiver.remoteCapabilities.headerExtensions || [];
            remoteExtensions.forEach(function(rHdrExt) {
              if (hdrExt.uri === rHdrExt.uri) {
                hdrExt.id = rHdrExt.id;
              }
            });
          });
    
          // generate an ssrc now, to be used later in rtpSender.send
          var sendEncodingParameters = transceiver.sendEncodingParameters || [{
            ssrc: (2 * sdpMLineIndex + 1) * 1001
          }];
          if (track) {
            // add RTX
            if (edgeVersion >= 15019 && kind === 'video' &&
                !sendEncodingParameters[0].rtx) {
              sendEncodingParameters[0].rtx = {
                ssrc: sendEncodingParameters[0].ssrc + 1
              };
            }
          }
    
          if (transceiver.wantReceive) {
            transceiver.rtpReceiver = new window.RTCRtpReceiver(
                transceiver.dtlsTransport, kind);
          }
    
          transceiver.localCapabilities = localCapabilities;
          transceiver.sendEncodingParameters = sendEncodingParameters;
        });
    
        // always offer BUNDLE and dispose on return if not supported.
        if (pc._config.bundlePolicy !== 'max-compat') {
          sdp += 'a=group:BUNDLE ' + pc.transceivers.map(function(t) {
            return t.mid;
          }).join(' ') + '\r\n';
        }
        sdp += 'a=ice-options:trickle\r\n';
    
        pc.transceivers.forEach(function(transceiver, sdpMLineIndex) {
          sdp += writeMediaSection(transceiver, transceiver.localCapabilities,
              'offer', transceiver.stream, pc._dtlsRole);
          sdp += 'a=rtcp-rsize\r\n';
    
          if (transceiver.iceGatherer && pc.iceGatheringState !== 'new' &&
              (sdpMLineIndex === 0 || !pc.usingBundle)) {
            transceiver.iceGatherer.getLocalCandidates().forEach(function(cand) {
              cand.component = 1;
              sdp += 'a=' + SDPUtils.writeCandidate(cand) + '\r\n';
            });
    
            if (transceiver.iceGatherer.state === 'completed') {
              sdp += 'a=end-of-candidates\r\n';
            }
          }
        });
    
        var desc = new window.RTCSessionDescription({
          type: 'offer',
          sdp: sdp
        });
        return Promise.resolve(desc);
      };
    
      RTCPeerConnection.prototype.createAnswer = function() {
        var pc = this;
    
        if (pc._isClosed) {
          return Promise.reject(makeError('InvalidStateError',
              'Can not call createAnswer after close'));
        }
    
        if (!(pc.signalingState === 'have-remote-offer' ||
            pc.signalingState === 'have-local-pranswer')) {
          return Promise.reject(makeError('InvalidStateError',
              'Can not call createAnswer in signalingState ' + pc.signalingState));
        }
    
        var sdp = SDPUtils.writeSessionBoilerplate(pc._sdpSessionId,
            pc._sdpSessionVersion++);
        if (pc.usingBundle) {
          sdp += 'a=group:BUNDLE ' + pc.transceivers.map(function(t) {
            return t.mid;
          }).join(' ') + '\r\n';
        }
        sdp += 'a=ice-options:trickle\r\n';
    
        var mediaSectionsInOffer = SDPUtils.getMediaSections(
            pc._remoteDescription.sdp).length;
        pc.transceivers.forEach(function(transceiver, sdpMLineIndex) {
          if (sdpMLineIndex + 1 > mediaSectionsInOffer) {
            return;
          }
          if (transceiver.rejected) {
            if (transceiver.kind === 'application') {
              if (transceiver.protocol === 'DTLS/SCTP') { // legacy fmt
                sdp += 'm=application 0 DTLS/SCTP 5000\r\n';
              } else {
                sdp += 'm=application 0 ' + transceiver.protocol +
                    ' webrtc-datachannel\r\n';
              }
            } else if (transceiver.kind === 'audio') {
              sdp += 'm=audio 0 UDP/TLS/RTP/SAVPF 0\r\n' +
                  'a=rtpmap:0 PCMU/8000\r\n';
            } else if (transceiver.kind === 'video') {
              sdp += 'm=video 0 UDP/TLS/RTP/SAVPF 120\r\n' +
                  'a=rtpmap:120 VP8/90000\r\n';
            }
            sdp += 'c=IN IP4 0.0.0.0\r\n' +
                'a=inactive\r\n' +
                'a=mid:' + transceiver.mid + '\r\n';
            return;
          }
    
          // FIXME: look at direction.
          if (transceiver.stream) {
            var localTrack;
            if (transceiver.kind === 'audio') {
              localTrack = transceiver.stream.getAudioTracks()[0];
            } else if (transceiver.kind === 'video') {
              localTrack = transceiver.stream.getVideoTracks()[0];
            }
            if (localTrack) {
              // add RTX
              if (edgeVersion >= 15019 && transceiver.kind === 'video' &&
                  !transceiver.sendEncodingParameters[0].rtx) {
                transceiver.sendEncodingParameters[0].rtx = {
                  ssrc: transceiver.sendEncodingParameters[0].ssrc + 1
                };
              }
            }
          }
    
          // Calculate intersection of capabilities.
          var commonCapabilities = getCommonCapabilities(
              transceiver.localCapabilities,
              transceiver.remoteCapabilities);
    
          var hasRtx = commonCapabilities.codecs.filter(function(c) {
            return c.name.toLowerCase() === 'rtx';
          }).length;
          if (!hasRtx && transceiver.sendEncodingParameters[0].rtx) {
            delete transceiver.sendEncodingParameters[0].rtx;
          }
    
          sdp += writeMediaSection(transceiver, commonCapabilities,
              'answer', transceiver.stream, pc._dtlsRole);
          if (transceiver.rtcpParameters &&
              transceiver.rtcpParameters.reducedSize) {
            sdp += 'a=rtcp-rsize\r\n';
          }
        });
    
        var desc = new window.RTCSessionDescription({
          type: 'answer',
          sdp: sdp
        });
        return Promise.resolve(desc);
      };
    
      RTCPeerConnection.prototype.addIceCandidate = function(candidate) {
        var pc = this;
        var sections;
        if (candidate && !(candidate.sdpMLineIndex !== undefined ||
            candidate.sdpMid)) {
          return Promise.reject(new TypeError('sdpMLineIndex or sdpMid required'));
        }
    
        // TODO: needs to go into ops queue.
        return new Promise(function(resolve, reject) {
          if (!pc._remoteDescription) {
            return reject(makeError('InvalidStateError',
                'Can not add ICE candidate without a remote description'));
          } else if (!candidate || candidate.candidate === '') {
            for (var j = 0; j < pc.transceivers.length; j++) {
              if (pc.transceivers[j].rejected) {
                continue;
              }
              pc.transceivers[j].iceTransport.addRemoteCandidate({});
              sections = SDPUtils.getMediaSections(pc._remoteDescription.sdp);
              sections[j] += 'a=end-of-candidates\r\n';
              pc._remoteDescription.sdp =
                  SDPUtils.getDescription(pc._remoteDescription.sdp) +
                  sections.join('');
              if (pc.usingBundle) {
                break;
              }
            }
          } else {
            var sdpMLineIndex = candidate.sdpMLineIndex;
            if (candidate.sdpMid) {
              for (var i = 0; i < pc.transceivers.length; i++) {
                if (pc.transceivers[i].mid === candidate.sdpMid) {
                  sdpMLineIndex = i;
                  break;
                }
              }
            }
            var transceiver = pc.transceivers[sdpMLineIndex];
            if (transceiver) {
              if (transceiver.rejected) {
                return resolve();
              }
              var cand = Object.keys(candidate.candidate).length > 0 ?
                  SDPUtils.parseCandidate(candidate.candidate) : {};
              // Ignore Chrome's invalid candidates since Edge does not like them.
              if (cand.protocol === 'tcp' && (cand.port === 0 || cand.port === 9)) {
                return resolve();
              }
              // Ignore RTCP candidates, we assume RTCP-MUX.
              if (cand.component && cand.component !== 1) {
                return resolve();
              }
              // when using bundle, avoid adding candidates to the wrong
              // ice transport. And avoid adding candidates added in the SDP.
              if (sdpMLineIndex === 0 || (sdpMLineIndex > 0 &&
                  transceiver.iceTransport !== pc.transceivers[0].iceTransport)) {
                if (!maybeAddCandidate(transceiver.iceTransport, cand)) {
                  return reject(makeError('OperationError',
                      'Can not add ICE candidate'));
                }
              }
    
              // update the remoteDescription.
              var candidateString = candidate.candidate.trim();
              if (candidateString.indexOf('a=') === 0) {
                candidateString = candidateString.substr(2);
              }
              sections = SDPUtils.getMediaSections(pc._remoteDescription.sdp);
              sections[sdpMLineIndex] += 'a=' +
                  (cand.type ? candidateString : 'end-of-candidates')
                  + '\r\n';
              pc._remoteDescription.sdp =
                  SDPUtils.getDescription(pc._remoteDescription.sdp) +
                  sections.join('');
            } else {
              return reject(makeError('OperationError',
                  'Can not add ICE candidate'));
            }
          }
          resolve();
        });
      };
    
      RTCPeerConnection.prototype.getStats = function(selector) {
        if (selector && selector instanceof window.MediaStreamTrack) {
          var senderOrReceiver = null;
          this.transceivers.forEach(function(transceiver) {
            if (transceiver.rtpSender &&
                transceiver.rtpSender.track === selector) {
              senderOrReceiver = transceiver.rtpSender;
            } else if (transceiver.rtpReceiver &&
                transceiver.rtpReceiver.track === selector) {
              senderOrReceiver = transceiver.rtpReceiver;
            }
          });
          if (!senderOrReceiver) {
            throw makeError('InvalidAccessError', 'Invalid selector.');
          }
          return senderOrReceiver.getStats();
        }
    
        var promises = [];
        this.transceivers.forEach(function(transceiver) {
          ['rtpSender', 'rtpReceiver', 'iceGatherer', 'iceTransport',
              'dtlsTransport'].forEach(function(method) {
                if (transceiver[method]) {
                  promises.push(transceiver[method].getStats());
                }
              });
        });
        return Promise.all(promises).then(function(allStats) {
          var results = new Map();
          allStats.forEach(function(stats) {
            stats.forEach(function(stat) {
              results.set(stat.id, stat);
            });
          });
          return results;
        });
      };
    
      // fix low-level stat names and return Map instead of object.
      var ortcObjects = ['RTCRtpSender', 'RTCRtpReceiver', 'RTCIceGatherer',
        'RTCIceTransport', 'RTCDtlsTransport'];
      ortcObjects.forEach(function(ortcObjectName) {
        var obj = window[ortcObjectName];
        if (obj && obj.prototype && obj.prototype.getStats) {
          var nativeGetstats = obj.prototype.getStats;
          obj.prototype.getStats = function() {
            return nativeGetstats.apply(this)
            .then(function(nativeStats) {
              var mapStats = new Map();
              Object.keys(nativeStats).forEach(function(id) {
                nativeStats[id].type = fixStatsType(nativeStats[id]);
                mapStats.set(id, nativeStats[id]);
              });
              return mapStats;
            });
          };
        }
      });
    
      // legacy callback shims. Should be moved to adapter.js some days.
      var methods = ['createOffer', 'createAnswer'];
      methods.forEach(function(method) {
        var nativeMethod = RTCPeerConnection.prototype[method];
        RTCPeerConnection.prototype[method] = function() {
          var args = arguments;
          if (typeof args[0] === 'function' ||
              typeof args[1] === 'function') { // legacy
            return nativeMethod.apply(this, [arguments[2]])
            .then(function(description) {
              if (typeof args[0] === 'function') {
                args[0].apply(null, [description]);
              }
            }, function(error) {
              if (typeof args[1] === 'function') {
                args[1].apply(null, [error]);
              }
            });
          }
          return nativeMethod.apply(this, arguments);
        };
      });
    
      methods = ['setLocalDescription', 'setRemoteDescription', 'addIceCandidate'];
      methods.forEach(function(method) {
        var nativeMethod = RTCPeerConnection.prototype[method];
        RTCPeerConnection.prototype[method] = function() {
          var args = arguments;
          if (typeof args[1] === 'function' ||
              typeof args[2] === 'function') { // legacy
            return nativeMethod.apply(this, arguments)
            .then(function() {
              if (typeof args[1] === 'function') {
                args[1].apply(null);
              }
            }, function(error) {
              if (typeof args[2] === 'function') {
                args[2].apply(null, [error]);
              }
            });
          }
          return nativeMethod.apply(this, arguments);
        };
      });
    
      // getStats is special. It doesn't have a spec legacy method yet we support
      // getStats(something, cb) without error callbacks.
      ['getStats'].forEach(function(method) {
        var nativeMethod = RTCPeerConnection.prototype[method];
        RTCPeerConnection.prototype[method] = function() {
          var args = arguments;
          if (typeof args[1] === 'function') {
            return nativeMethod.apply(this, arguments)
            .then(function() {
              if (typeof args[1] === 'function') {
                args[1].apply(null);
              }
            });
          }
          return nativeMethod.apply(this, arguments);
        };
      });
    
      return RTCPeerConnection;
    };
    
    },{"sdp":2}],2:[function(require,module,exports){
     /* eslint-env node */
    'use strict';
    
    // SDP helpers.
    var SDPUtils = {};
    
    // Generate an alphanumeric identifier for cname or mids.
    // TODO: use UUIDs instead? https://gist.github.com/jed/982883
    SDPUtils.generateIdentifier = function() {
      return Math.random().toString(36).substr(2, 10);
    };
    
    // The RTCP CNAME used by all peerconnections from the same JS.
    SDPUtils.localCName = SDPUtils.generateIdentifier();
    
    // Splits SDP into lines, dealing with both CRLF and LF.
    SDPUtils.splitLines = function(blob) {
      return blob.trim().split('\n').map(function(line) {
        return line.trim();
      });
    };
    // Splits SDP into sessionpart and mediasections. Ensures CRLF.
    SDPUtils.splitSections = function(blob) {
      var parts = blob.split('\nm=');
      return parts.map(function(part, index) {
        return (index > 0 ? 'm=' + part : part).trim() + '\r\n';
      });
    };
    
    // returns the session description.
    SDPUtils.getDescription = function(blob) {
      var sections = SDPUtils.splitSections(blob);
      return sections && sections[0];
    };
    
    // returns the individual media sections.
    SDPUtils.getMediaSections = function(blob) {
      var sections = SDPUtils.splitSections(blob);
      sections.shift();
      return sections;
    };
    
    // Returns lines that start with a certain prefix.
    SDPUtils.matchPrefix = function(blob, prefix) {
      return SDPUtils.splitLines(blob).filter(function(line) {
        return line.indexOf(prefix) === 0;
      });
    };
    
    // Parses an ICE candidate line. Sample input:
    // candidate:702786350 2 udp 41819902 8.8.8.8 60769 typ relay raddr 8.8.8.8
    // rport 55996"
    SDPUtils.parseCandidate = function(line) {
      var parts;
      // Parse both variants.
      if (line.indexOf('a=candidate:') === 0) {
        parts = line.substring(12).split(' ');
      } else {
        parts = line.substring(10).split(' ');
      }
    
      var candidate = {
        foundation: parts[0],
        component: parseInt(parts[1], 10),
        protocol: parts[2].toLowerCase(),
        priority: parseInt(parts[3], 10),
        ip: parts[4],
        address: parts[4], // address is an alias for ip.
        port: parseInt(parts[5], 10),
        // skip parts[6] == 'typ'
        type: parts[7]
      };
    
      for (var i = 8; i < parts.length; i += 2) {
        switch (parts[i]) {
          case 'raddr':
            candidate.relatedAddress = parts[i + 1];
            break;
          case 'rport':
            candidate.relatedPort = parseInt(parts[i + 1], 10);
            break;
          case 'tcptype':
            candidate.tcpType = parts[i + 1];
            break;
          case 'ufrag':
            candidate.ufrag = parts[i + 1]; // for backward compability.
            candidate.usernameFragment = parts[i + 1];
            break;
          default: // extension handling, in particular ufrag
            candidate[parts[i]] = parts[i + 1];
            break;
        }
      }
      return candidate;
    };
    
    // Translates a candidate object into SDP candidate attribute.
    SDPUtils.writeCandidate = function(candidate) {
      var sdp = [];
      sdp.push(candidate.foundation);
      sdp.push(candidate.component);
      sdp.push(candidate.protocol.toUpperCase());
      sdp.push(candidate.priority);
      sdp.push(candidate.address || candidate.ip);
      sdp.push(candidate.port);
    
      var type = candidate.type;
      sdp.push('typ');
      sdp.push(type);
      if (type !== 'host' && candidate.relatedAddress &&
          candidate.relatedPort) {
        sdp.push('raddr');
        sdp.push(candidate.relatedAddress);
        sdp.push('rport');
        sdp.push(candidate.relatedPort);
      }
      if (candidate.tcpType && candidate.protocol.toLowerCase() === 'tcp') {
        sdp.push('tcptype');
        sdp.push(candidate.tcpType);
      }
      if (candidate.usernameFragment || candidate.ufrag) {
        sdp.push('ufrag');
        sdp.push(candidate.usernameFragment || candidate.ufrag);
      }
      return 'candidate:' + sdp.join(' ');
    };
    
    // Parses an ice-options line, returns an array of option tags.
    // a=ice-options:foo bar
    SDPUtils.parseIceOptions = function(line) {
      return line.substr(14).split(' ');
    };
    
    // Parses an rtpmap line, returns RTCRtpCoddecParameters. Sample input:
    // a=rtpmap:111 opus/48000/2
    SDPUtils.parseRtpMap = function(line) {
      var parts = line.substr(9).split(' ');
      var parsed = {
        payloadType: parseInt(parts.shift(), 10) // was: id
      };
    
      parts = parts[0].split('/');
    
      parsed.name = parts[0];
      parsed.clockRate = parseInt(parts[1], 10); // was: clockrate
      parsed.channels = parts.length === 3 ? parseInt(parts[2], 10) : 1;
      // legacy alias, got renamed back to channels in ORTC.
      parsed.numChannels = parsed.channels;
      return parsed;
    };
    
    // Generate an a=rtpmap line from RTCRtpCodecCapability or
    // RTCRtpCodecParameters.
    SDPUtils.writeRtpMap = function(codec) {
      var pt = codec.payloadType;
      if (codec.preferredPayloadType !== undefined) {
        pt = codec.preferredPayloadType;
      }
      var channels = codec.channels || codec.numChannels || 1;
      return 'a=rtpmap:' + pt + ' ' + codec.name + '/' + codec.clockRate +
          (channels !== 1 ? '/' + channels : '') + '\r\n';
    };
    
    // Parses an a=extmap line (headerextension from RFC 5285). Sample input:
    // a=extmap:2 urn:ietf:params:rtp-hdrext:toffset
    // a=extmap:2/sendonly urn:ietf:params:rtp-hdrext:toffset
    SDPUtils.parseExtmap = function(line) {
      var parts = line.substr(9).split(' ');
      return {
        id: parseInt(parts[0], 10),
        direction: parts[0].indexOf('/') > 0 ? parts[0].split('/')[1] : 'sendrecv',
        uri: parts[1]
      };
    };
    
    // Generates a=extmap line from RTCRtpHeaderExtensionParameters or
    // RTCRtpHeaderExtension.
    SDPUtils.writeExtmap = function(headerExtension) {
      return 'a=extmap:' + (headerExtension.id || headerExtension.preferredId) +
          (headerExtension.direction && headerExtension.direction !== 'sendrecv'
              ? '/' + headerExtension.direction
              : '') +
          ' ' + headerExtension.uri + '\r\n';
    };
    
    // Parses an ftmp line, returns dictionary. Sample input:
    // a=fmtp:96 vbr=on;cng=on
    // Also deals with vbr=on; cng=on
    SDPUtils.parseFmtp = function(line) {
      var parsed = {};
      var kv;
      var parts = line.substr(line.indexOf(' ') + 1).split(';');
      for (var j = 0; j < parts.length; j++) {
        kv = parts[j].trim().split('=');
        parsed[kv[0].trim()] = kv[1];
      }
      return parsed;
    };
    
    // Generates an a=ftmp line from RTCRtpCodecCapability or RTCRtpCodecParameters.
    SDPUtils.writeFmtp = function(codec) {
      var line = '';
      var pt = codec.payloadType;
      if (codec.preferredPayloadType !== undefined) {
        pt = codec.preferredPayloadType;
      }
      if (codec.parameters && Object.keys(codec.parameters).length) {
        var params = [];
        Object.keys(codec.parameters).forEach(function(param) {
          if (codec.parameters[param]) {
            params.push(param + '=' + codec.parameters[param]);
          } else {
            params.push(param);
          }
        });
        line += 'a=fmtp:' + pt + ' ' + params.join(';') + '\r\n';
      }
      return line;
    };
    
    // Parses an rtcp-fb line, returns RTCPRtcpFeedback object. Sample input:
    // a=rtcp-fb:98 nack rpsi
    SDPUtils.parseRtcpFb = function(line) {
      var parts = line.substr(line.indexOf(' ') + 1).split(' ');
      return {
        type: parts.shift(),
        parameter: parts.join(' ')
      };
    };
    // Generate a=rtcp-fb lines from RTCRtpCodecCapability or RTCRtpCodecParameters.
    SDPUtils.writeRtcpFb = function(codec) {
      var lines = '';
      var pt = codec.payloadType;
      if (codec.preferredPayloadType !== undefined) {
        pt = codec.preferredPayloadType;
      }
      if (codec.rtcpFeedback && codec.rtcpFeedback.length) {
        // FIXME: special handling for trr-int?
        codec.rtcpFeedback.forEach(function(fb) {
          lines += 'a=rtcp-fb:' + pt + ' ' + fb.type +
          (fb.parameter && fb.parameter.length ? ' ' + fb.parameter : '') +
              '\r\n';
        });
      }
      return lines;
    };
    
    // Parses an RFC 5576 ssrc media attribute. Sample input:
    // a=ssrc:3735928559 cname:something
    SDPUtils.parseSsrcMedia = function(line) {
      var sp = line.indexOf(' ');
      var parts = {
        ssrc: parseInt(line.substr(7, sp - 7), 10)
      };
      var colon = line.indexOf(':', sp);
      if (colon > -1) {
        parts.attribute = line.substr(sp + 1, colon - sp - 1);
        parts.value = line.substr(colon + 1);
      } else {
        parts.attribute = line.substr(sp + 1);
      }
      return parts;
    };
    
    SDPUtils.parseSsrcGroup = function(line) {
      var parts = line.substr(13).split(' ');
      return {
        semantics: parts.shift(),
        ssrcs: parts.map(function(ssrc) {
          return parseInt(ssrc, 10);
        })
      };
    };
    
    // Extracts the MID (RFC 5888) from a media section.
    // returns the MID or undefined if no mid line was found.
    SDPUtils.getMid = function(mediaSection) {
      var mid = SDPUtils.matchPrefix(mediaSection, 'a=mid:')[0];
      if (mid) {
        return mid.substr(6);
      }
    };
    
    SDPUtils.parseFingerprint = function(line) {
      var parts = line.substr(14).split(' ');
      return {
        algorithm: parts[0].toLowerCase(), // algorithm is case-sensitive in Edge.
        value: parts[1]
      };
    };
    
    // Extracts DTLS parameters from SDP media section or sessionpart.
    // FIXME: for consistency with other functions this should only
    //   get the fingerprint line as input. See also getIceParameters.
    SDPUtils.getDtlsParameters = function(mediaSection, sessionpart) {
      var lines = SDPUtils.matchPrefix(mediaSection + sessionpart,
          'a=fingerprint:');
      // Note: a=setup line is ignored since we use the 'auto' role.
      // Note2: 'algorithm' is not case sensitive except in Edge.
      return {
        role: 'auto',
        fingerprints: lines.map(SDPUtils.parseFingerprint)
      };
    };
    
    // Serializes DTLS parameters to SDP.
    SDPUtils.writeDtlsParameters = function(params, setupType) {
      var sdp = 'a=setup:' + setupType + '\r\n';
      params.fingerprints.forEach(function(fp) {
        sdp += 'a=fingerprint:' + fp.algorithm + ' ' + fp.value + '\r\n';
      });
      return sdp;
    };
    // Parses ICE information from SDP media section or sessionpart.
    // FIXME: for consistency with other functions this should only
    //   get the ice-ufrag and ice-pwd lines as input.
    SDPUtils.getIceParameters = function(mediaSection, sessionpart) {
      var lines = SDPUtils.splitLines(mediaSection);
      // Search in session part, too.
      lines = lines.concat(SDPUtils.splitLines(sessionpart));
      var iceParameters = {
        usernameFragment: lines.filter(function(line) {
          return line.indexOf('a=ice-ufrag:') === 0;
        })[0].substr(12),
        password: lines.filter(function(line) {
          return line.indexOf('a=ice-pwd:') === 0;
        })[0].substr(10)
      };
      return iceParameters;
    };
    
    // Serializes ICE parameters to SDP.
    SDPUtils.writeIceParameters = function(params) {
      return 'a=ice-ufrag:' + params.usernameFragment + '\r\n' +
          'a=ice-pwd:' + params.password + '\r\n';
    };
    
    // Parses the SDP media section and returns RTCRtpParameters.
    SDPUtils.parseRtpParameters = function(mediaSection) {
      var description = {
        codecs: [],
        headerExtensions: [],
        fecMechanisms: [],
        rtcp: []
      };
      var lines = SDPUtils.splitLines(mediaSection);
      var mline = lines[0].split(' ');
      for (var i = 3; i < mline.length; i++) { // find all codecs from mline[3..]
        var pt = mline[i];
        var rtpmapline = SDPUtils.matchPrefix(
            mediaSection, 'a=rtpmap:' + pt + ' ')[0];
        if (rtpmapline) {
          var codec = SDPUtils.parseRtpMap(rtpmapline);
          var fmtps = SDPUtils.matchPrefix(
              mediaSection, 'a=fmtp:' + pt + ' ');
          // Only the first a=fmtp:<pt> is considered.
          codec.parameters = fmtps.length ? SDPUtils.parseFmtp(fmtps[0]) : {};
          codec.rtcpFeedback = SDPUtils.matchPrefix(
              mediaSection, 'a=rtcp-fb:' + pt + ' ')
            .map(SDPUtils.parseRtcpFb);
          description.codecs.push(codec);
          // parse FEC mechanisms from rtpmap lines.
          switch (codec.name.toUpperCase()) {
            case 'RED':
            case 'ULPFEC':
              description.fecMechanisms.push(codec.name.toUpperCase());
              break;
            default: // only RED and ULPFEC are recognized as FEC mechanisms.
              break;
          }
        }
      }
      SDPUtils.matchPrefix(mediaSection, 'a=extmap:').forEach(function(line) {
        description.headerExtensions.push(SDPUtils.parseExtmap(line));
      });
      // FIXME: parse rtcp.
      return description;
    };
    
    // Generates parts of the SDP media section describing the capabilities /
    // parameters.
    SDPUtils.writeRtpDescription = function(kind, caps) {
      var sdp = '';
    
      // Build the mline.
      sdp += 'm=' + kind + ' ';
      sdp += caps.codecs.length > 0 ? '9' : '0'; // reject if no codecs.
      sdp += ' UDP/TLS/RTP/SAVPF ';
      sdp += caps.codecs.map(function(codec) {
        if (codec.preferredPayloadType !== undefined) {
          return codec.preferredPayloadType;
        }
        return codec.payloadType;
      }).join(' ') + '\r\n';
    
      sdp += 'c=IN IP4 0.0.0.0\r\n';
      sdp += 'a=rtcp:9 IN IP4 0.0.0.0\r\n';
    
      // Add a=rtpmap lines for each codec. Also fmtp and rtcp-fb.
      caps.codecs.forEach(function(codec) {
        sdp += SDPUtils.writeRtpMap(codec);
        sdp += SDPUtils.writeFmtp(codec);
        sdp += SDPUtils.writeRtcpFb(codec);
      });
      var maxptime = 0;
      caps.codecs.forEach(function(codec) {
        if (codec.maxptime > maxptime) {
          maxptime = codec.maxptime;
        }
      });
      if (maxptime > 0) {
        sdp += 'a=maxptime:' + maxptime + '\r\n';
      }
      sdp += 'a=rtcp-mux\r\n';
    
      if (caps.headerExtensions) {
        caps.headerExtensions.forEach(function(extension) {
          sdp += SDPUtils.writeExtmap(extension);
        });
      }
      // FIXME: write fecMechanisms.
      return sdp;
    };
    
    // Parses the SDP media section and returns an array of
    // RTCRtpEncodingParameters.
    SDPUtils.parseRtpEncodingParameters = function(mediaSection) {
      var encodingParameters = [];
      var description = SDPUtils.parseRtpParameters(mediaSection);
      var hasRed = description.fecMechanisms.indexOf('RED') !== -1;
      var hasUlpfec = description.fecMechanisms.indexOf('ULPFEC') !== -1;
    
      // filter a=ssrc:... cname:, ignore PlanB-msid
      var ssrcs = SDPUtils.matchPrefix(mediaSection, 'a=ssrc:')
      .map(function(line) {
        return SDPUtils.parseSsrcMedia(line);
      })
      .filter(function(parts) {
        return parts.attribute === 'cname';
      });
      var primarySsrc = ssrcs.length > 0 && ssrcs[0].ssrc;
      var secondarySsrc;
    
      var flows = SDPUtils.matchPrefix(mediaSection, 'a=ssrc-group:FID')
      .map(function(line) {
        var parts = line.substr(17).split(' ');
        return parts.map(function(part) {
          return parseInt(part, 10);
        });
      });
      if (flows.length > 0 && flows[0].length > 1 && flows[0][0] === primarySsrc) {
        secondarySsrc = flows[0][1];
      }
    
      description.codecs.forEach(function(codec) {
        if (codec.name.toUpperCase() === 'RTX' && codec.parameters.apt) {
          var encParam = {
            ssrc: primarySsrc,
            codecPayloadType: parseInt(codec.parameters.apt, 10)
          };
          if (primarySsrc && secondarySsrc) {
            encParam.rtx = {ssrc: secondarySsrc};
          }
          encodingParameters.push(encParam);
          if (hasRed) {
            encParam = JSON.parse(JSON.stringify(encParam));
            encParam.fec = {
              ssrc: primarySsrc,
              mechanism: hasUlpfec ? 'red+ulpfec' : 'red'
            };
            encodingParameters.push(encParam);
          }
        }
      });
      if (encodingParameters.length === 0 && primarySsrc) {
        encodingParameters.push({
          ssrc: primarySsrc
        });
      }
    
      // we support both b=AS and b=TIAS but interpret AS as TIAS.
      var bandwidth = SDPUtils.matchPrefix(mediaSection, 'b=');
      if (bandwidth.length) {
        if (bandwidth[0].indexOf('b=TIAS:') === 0) {
          bandwidth = parseInt(bandwidth[0].substr(7), 10);
        } else if (bandwidth[0].indexOf('b=AS:') === 0) {
          // use formula from JSEP to convert b=AS to TIAS value.
          bandwidth = parseInt(bandwidth[0].substr(5), 10) * 1000 * 0.95
              - (50 * 40 * 8);
        } else {
          bandwidth = undefined;
        }
        encodingParameters.forEach(function(params) {
          params.maxBitrate = bandwidth;
        });
      }
      return encodingParameters;
    };
    
    // parses http://draft.ortc.org/#rtcrtcpparameters*
    SDPUtils.parseRtcpParameters = function(mediaSection) {
      var rtcpParameters = {};
    
      // Gets the first SSRC. Note tha with RTX there might be multiple
      // SSRCs.
      var remoteSsrc = SDPUtils.matchPrefix(mediaSection, 'a=ssrc:')
          .map(function(line) {
            return SDPUtils.parseSsrcMedia(line);
          })
          .filter(function(obj) {
            return obj.attribute === 'cname';
          })[0];
      if (remoteSsrc) {
        rtcpParameters.cname = remoteSsrc.value;
        rtcpParameters.ssrc = remoteSsrc.ssrc;
      }
    
      // Edge uses the compound attribute instead of reducedSize
      // compound is !reducedSize
      var rsize = SDPUtils.matchPrefix(mediaSection, 'a=rtcp-rsize');
      rtcpParameters.reducedSize = rsize.length > 0;
      rtcpParameters.compound = rsize.length === 0;
    
      // parses the rtcp-mux attrіbute.
      // Note that Edge does not support unmuxed RTCP.
      var mux = SDPUtils.matchPrefix(mediaSection, 'a=rtcp-mux');
      rtcpParameters.mux = mux.length > 0;
    
      return rtcpParameters;
    };
    
    // parses either a=msid: or a=ssrc:... msid lines and returns
    // the id of the MediaStream and MediaStreamTrack.
    SDPUtils.parseMsid = function(mediaSection) {
      var parts;
      var spec = SDPUtils.matchPrefix(mediaSection, 'a=msid:');
      if (spec.length === 1) {
        parts = spec[0].substr(7).split(' ');
        return {stream: parts[0], track: parts[1]};
      }
      var planB = SDPUtils.matchPrefix(mediaSection, 'a=ssrc:')
      .map(function(line) {
        return SDPUtils.parseSsrcMedia(line);
      })
      .filter(function(msidParts) {
        return msidParts.attribute === 'msid';
      });
      if (planB.length > 0) {
        parts = planB[0].value.split(' ');
        return {stream: parts[0], track: parts[1]};
      }
    };
    
    // Generate a session ID for SDP.
    // https://tools.ietf.org/html/draft-ietf-rtcweb-jsep-20#section-5.2.1
    // recommends using a cryptographically random +ve 64-bit value
    // but right now this should be acceptable and within the right range
    SDPUtils.generateSessionId = function() {
      return Math.random().toString().substr(2, 21);
    };
    
    // Write boilder plate for start of SDP
    // sessId argument is optional - if not supplied it will
    // be generated randomly
    // sessVersion is optional and defaults to 2
    // sessUser is optional and defaults to 'thisisadapterortc'
    SDPUtils.writeSessionBoilerplate = function(sessId, sessVer, sessUser) {
      var sessionId;
      var version = sessVer !== undefined ? sessVer : 2;
      if (sessId) {
        sessionId = sessId;
      } else {
        sessionId = SDPUtils.generateSessionId();
      }
      var user = sessUser || 'thisisadapterortc';
      // FIXME: sess-id should be an NTP timestamp.
      return 'v=0\r\n' +
          'o=' + user + ' ' + sessionId + ' ' + version +
            ' IN IP4 127.0.0.1\r\n' +
          's=-\r\n' +
          't=0 0\r\n';
    };
    
    SDPUtils.writeMediaSection = function(transceiver, caps, type, stream) {
      var sdp = SDPUtils.writeRtpDescription(transceiver.kind, caps);
    
      // Map ICE parameters (ufrag, pwd) to SDP.
      sdp += SDPUtils.writeIceParameters(
          transceiver.iceGatherer.getLocalParameters());
    
      // Map DTLS parameters to SDP.
      sdp += SDPUtils.writeDtlsParameters(
          transceiver.dtlsTransport.getLocalParameters(),
          type === 'offer' ? 'actpass' : 'active');
    
      sdp += 'a=mid:' + transceiver.mid + '\r\n';
    
      if (transceiver.direction) {
        sdp += 'a=' + transceiver.direction + '\r\n';
      } else if (transceiver.rtpSender && transceiver.rtpReceiver) {
        sdp += 'a=sendrecv\r\n';
      } else if (transceiver.rtpSender) {
        sdp += 'a=sendonly\r\n';
      } else if (transceiver.rtpReceiver) {
        sdp += 'a=recvonly\r\n';
      } else {
        sdp += 'a=inactive\r\n';
      }
    
      if (transceiver.rtpSender) {
        // spec.
        var msid = 'msid:' + stream.id + ' ' +
            transceiver.rtpSender.track.id + '\r\n';
        sdp += 'a=' + msid;
    
        // for Chrome.
        sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].ssrc +
            ' ' + msid;
        if (transceiver.sendEncodingParameters[0].rtx) {
          sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].rtx.ssrc +
              ' ' + msid;
          sdp += 'a=ssrc-group:FID ' +
              transceiver.sendEncodingParameters[0].ssrc + ' ' +
              transceiver.sendEncodingParameters[0].rtx.ssrc +
              '\r\n';
        }
      }
      // FIXME: this should be written by writeRtpDescription.
      sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].ssrc +
          ' cname:' + SDPUtils.localCName + '\r\n';
      if (transceiver.rtpSender && transceiver.sendEncodingParameters[0].rtx) {
        sdp += 'a=ssrc:' + transceiver.sendEncodingParameters[0].rtx.ssrc +
            ' cname:' + SDPUtils.localCName + '\r\n';
      }
      return sdp;
    };
    
    // Gets the direction from the mediaSection or the sessionpart.
    SDPUtils.getDirection = function(mediaSection, sessionpart) {
      // Look for sendrecv, sendonly, recvonly, inactive, default to sendrecv.
      var lines = SDPUtils.splitLines(mediaSection);
      for (var i = 0; i < lines.length; i++) {
        switch (lines[i]) {
          case 'a=sendrecv':
          case 'a=sendonly':
          case 'a=recvonly':
          case 'a=inactive':
            return lines[i].substr(2);
          default:
            // FIXME: What should happen here?
        }
      }
      if (sessionpart) {
        return SDPUtils.getDirection(sessionpart);
      }
      return 'sendrecv';
    };
    
    SDPUtils.getKind = function(mediaSection) {
      var lines = SDPUtils.splitLines(mediaSection);
      var mline = lines[0].split(' ');
      return mline[0].substr(2);
    };
    
    SDPUtils.isRejected = function(mediaSection) {
      return mediaSection.split(' ', 2)[1] === '0';
    };
    
    SDPUtils.parseMLine = function(mediaSection) {
      var lines = SDPUtils.splitLines(mediaSection);
      var parts = lines[0].substr(2).split(' ');
      return {
        kind: parts[0],
        port: parseInt(parts[1], 10),
        protocol: parts[2],
        fmt: parts.slice(3).join(' ')
      };
    };
    
    SDPUtils.parseOLine = function(mediaSection) {
      var line = SDPUtils.matchPrefix(mediaSection, 'o=')[0];
      var parts = line.substr(2).split(' ');
      return {
        username: parts[0],
        sessionId: parts[1],
        sessionVersion: parseInt(parts[2], 10),
        netType: parts[3],
        addressType: parts[4],
        address: parts[5]
      };
    };
    
    // a very naive interpretation of a valid SDP.
    SDPUtils.isValidSDP = function(blob) {
      if (typeof blob !== 'string' || blob.length === 0) {
        return false;
      }
      var lines = SDPUtils.splitLines(blob);
      for (var i = 0; i < lines.length; i++) {
        if (lines[i].length < 2 || lines[i].charAt(1) !== '=') {
          return false;
        }
        // TODO: check the modifier a bit more.
      }
      return true;
    };
    
    // Expose public methods.
    if (typeof module === 'object') {
      module.exports = SDPUtils;
    }
    
    },{}],3:[function(require,module,exports){
    (function (global){
    /*
     *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.
     *
     *  Use of this source code is governed by a BSD-style license
     *  that can be found in the LICENSE file in the root of the source
     *  tree.
     */
     /* eslint-env node */
    
    'use strict';
    
    var adapterFactory = require('./adapter_factory.js');
    module.exports = adapterFactory({window: global.window});
    
    }).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
    },{"./adapter_factory.js":4}],4:[function(require,module,exports){
    /*
     *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.
     *
     *  Use of this source code is governed by a BSD-style license
     *  that can be found in the LICENSE file in the root of the source
     *  tree.
     */
     /* eslint-env node */
    
    'use strict';
    
    var utils = require('./utils');
    // Shimming starts here.
    module.exports = function(dependencies, opts) {
      var window = dependencies && dependencies.window;
    
      var options = {
        shimChrome: true,
        shimFirefox: true,
        shimEdge: true,
        shimSafari: true,
      };
    
      for (var key in opts) {
        if (hasOwnProperty.call(opts, key)) {
          options[key] = opts[key];
        }
      }
    
      // Utils.
      var logging = utils.log;
      var browserDetails = utils.detectBrowser(window);
    
      // Uncomment the line below if you want logging to occur, including logging
      // for the switch statement below. Can also be turned on in the browser via
      // adapter.disableLog(false), but then logging from the switch statement below
      // will not appear.
      // require('./utils').disableLog(false);
    
      // Browser shims.
      var chromeShim = require('./chrome/chrome_shim') || null;
      var edgeShim = require('./edge/edge_shim') || null;
      var firefoxShim = require('./firefox/firefox_shim') || null;
      var safariShim = require('./safari/safari_shim') || null;
      var commonShim = require('./common_shim') || null;
    
      // Export to the adapter global object visible in the browser.
      var adapter = {
        browserDetails: browserDetails,
        commonShim: commonShim,
        extractVersion: utils.extractVersion,
        disableLog: utils.disableLog,
        disableWarnings: utils.disableWarnings
      };
    
      // Shim browser if found.
      switch (browserDetails.browser) {
        case 'chrome':
          if (!chromeShim || !chromeShim.shimPeerConnection ||
              !options.shimChrome) {
            logging('Chrome shim is not included in this adapter release.');
            return adapter;
          }
          logging('adapter.js shimming chrome.');
          // Export to the adapter global object visible in the browser.
          adapter.browserShim = chromeShim;
          commonShim.shimCreateObjectURL(window);
    
          chromeShim.shimGetUserMedia(window);
          chromeShim.shimMediaStream(window);
          chromeShim.shimSourceObject(window);
          chromeShim.shimPeerConnection(window);
          chromeShim.shimOnTrack(window);
          chromeShim.shimAddTrackRemoveTrack(window);
          chromeShim.shimGetSendersWithDtmf(window);
          chromeShim.shimSenderReceiverGetStats(window);
          chromeShim.fixNegotiationNeeded(window);
    
          commonShim.shimRTCIceCandidate(window);
          commonShim.shimMaxMessageSize(window);
          commonShim.shimSendThrowTypeError(window);
          break;
        case 'firefox':
          if (!firefoxShim || !firefoxShim.shimPeerConnection ||
              !options.shimFirefox) {
            logging('Firefox shim is not included in this adapter release.');
            return adapter;
          }
          logging('adapter.js shimming firefox.');
          // Export to the adapter global object visible in the browser.
          adapter.browserShim = firefoxShim;
          commonShim.shimCreateObjectURL(window);
    
          firefoxShim.shimGetUserMedia(window);
          firefoxShim.shimSourceObject(window);
          firefoxShim.shimPeerConnection(window);
          firefoxShim.shimOnTrack(window);
          firefoxShim.shimRemoveStream(window);
          firefoxShim.shimSenderGetStats(window);
          firefoxShim.shimReceiverGetStats(window);
          firefoxShim.shimRTCDataChannel(window);
    
          commonShim.shimRTCIceCandidate(window);
          commonShim.shimMaxMessageSize(window);
          commonShim.shimSendThrowTypeError(window);
          break;
        case 'edge':
          if (!edgeShim || !edgeShim.shimPeerConnection || !options.shimEdge) {
            logging('MS edge shim is not included in this adapter release.');
            return adapter;
          }
          logging('adapter.js shimming edge.');
          // Export to the adapter global object visible in the browser.
          adapter.browserShim = edgeShim;
          commonShim.shimCreateObjectURL(window);
    
          edgeShim.shimGetUserMedia(window);
          edgeShim.shimPeerConnection(window);
          edgeShim.shimReplaceTrack(window);
    
          // the edge shim implements the full RTCIceCandidate object.
    
          commonShim.shimMaxMessageSize(window);
          commonShim.shimSendThrowTypeError(window);
          break;
        case 'safari':
          if (!safariShim || !options.shimSafari) {
            logging('Safari shim is not included in this adapter release.');
            return adapter;
          }
          logging('adapter.js shimming safari.');
          // Export to the adapter global object visible in the browser.
          adapter.browserShim = safariShim;
          commonShim.shimCreateObjectURL(window);
    
          safariShim.shimRTCIceServerUrls(window);
          safariShim.shimCreateOfferLegacy(window);
          safariShim.shimCallbacksAPI(window);
          safariShim.shimLocalStreamsAPI(window);
          safariShim.shimRemoteStreamsAPI(window);
          safariShim.shimTrackEventTransceiver(window);
          safariShim.shimGetUserMedia(window);
    
          commonShim.shimRTCIceCandidate(window);
          commonShim.shimMaxMessageSize(window);
          commonShim.shimSendThrowTypeError(window);
          break;
        default:
          logging('Unsupported browser!');
          break;
      }
    
      return adapter;
    };
    
    },{"./chrome/chrome_shim":5,"./common_shim":7,"./edge/edge_shim":8,"./firefox/firefox_shim":11,"./safari/safari_shim":13,"./utils":14}],5:[function(require,module,exports){
    
    /*
     *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.
     *
     *  Use of this source code is governed by a BSD-style license
     *  that can be found in the LICENSE file in the root of the source
     *  tree.
     */
     /* eslint-env node */
    'use strict';
    var utils = require('../utils.js');
    var logging = utils.log;
    
    /* iterates the stats graph recursively. */
    function walkStats(stats, base, resultSet) {
      if (!base || resultSet.has(base.id)) {
        return;
      }
      resultSet.set(base.id, base);
      Object.keys(base).forEach(function(name) {
        if (name.endsWith('Id')) {
          walkStats(stats, stats.get(base[name]), resultSet);
        } else if (name.endsWith('Ids')) {
          base[name].forEach(function(id) {
            walkStats(stats, stats.get(id), resultSet);
          });
        }
      });
    }
    
    /* filter getStats for a sender/receiver track. */
    function filterStats(result, track, outbound) {
      var streamStatsType = outbound ? 'outbound-rtp' : 'inbound-rtp';
      var filteredResult = new Map();
      if (track === null) {
        return filteredResult;
      }
      var trackStats = [];
      result.forEach(function(value) {
        if (value.type === 'track' &&
            value.trackIdentifier === track.id) {
          trackStats.push(value);
        }
      });
      trackStats.forEach(function(trackStat) {
        result.forEach(function(stats) {
          if (stats.type === streamStatsType && stats.trackId === trackStat.id) {
            walkStats(result, stats, filteredResult);
          }
        });
      });
      return filteredResult;
    }
    
    module.exports = {
      shimGetUserMedia: require('./getusermedia'),
      shimMediaStream: function(window) {
        window.MediaStream = window.MediaStream || window.webkitMediaStream;
      },
    
      shimOnTrack: function(window) {
        if (typeof window === 'object' && window.RTCPeerConnection && !('ontrack' in
            window.RTCPeerConnection.prototype)) {
          Object.defineProperty(window.RTCPeerConnection.prototype, 'ontrack', {
            get: function() {
              return this._ontrack;
            },
            set: function(f) {
              if (this._ontrack) {
                this.removeEventListener('track', this._ontrack);
              }
              this.addEventListener('track', this._ontrack = f);
            },
            enumerable: true,
            configurable: true
          });
          var origSetRemoteDescription =
              window.RTCPeerConnection.prototype.setRemoteDescription;
          window.RTCPeerConnection.prototype.setRemoteDescription = function() {
            var pc = this;
            if (!pc._ontrackpoly) {
              pc._ontrackpoly = function(e) {
                // onaddstream does not fire when a track is added to an existing
                // stream. But stream.onaddtrack is implemented so we use that.
                e.stream.addEventListener('addtrack', function(te) {
                  var receiver;
                  if (window.RTCPeerConnection.prototype.getReceivers) {
                    receiver = pc.getReceivers().find(function(r) {
                      return r.track && r.track.id === te.track.id;
                    });
                  } else {
                    receiver = {track: te.track};
                  }
    
                  var event = new Event('track');
                  event.track = te.track;
                  event.receiver = receiver;
                  event.transceiver = {receiver: receiver};
                  event.streams = [e.stream];
                  pc.dispatchEvent(event);
                });
                e.stream.getTracks().forEach(function(track) {
                  var receiver;
                  if (window.RTCPeerConnection.prototype.getReceivers) {
                    receiver = pc.getReceivers().find(function(r) {
                      return r.track && r.track.id === track.id;
                    });
                  } else {
                    receiver = {track: track};
                  }
                  var event = new Event('track');
                  event.track = track;
                  event.receiver = receiver;
                  event.transceiver = {receiver: receiver};
                  event.streams = [e.stream];
                  pc.dispatchEvent(event);
                });
              };
              pc.addEventListener('addstream', pc._ontrackpoly);
            }
            return origSetRemoteDescription.apply(pc, arguments);
          };
        } else {
          // even if RTCRtpTransceiver is in window, it is only used and
          // emitted in unified-plan. Unfortunately this means we need
          // to unconditionally wrap the event.
          utils.wrapPeerConnectionEvent(window, 'track', function(e) {
            if (!e.transceiver) {
              Object.defineProperty(e, 'transceiver',
                {value: {receiver: e.receiver}});
            }
            return e;
          });
        }
      },
    
      shimGetSendersWithDtmf: function(window) {
        // Overrides addTrack/removeTrack, depends on shimAddTrackRemoveTrack.
        if (typeof window === 'object' && window.RTCPeerConnection &&
            !('getSenders' in window.RTCPeerConnection.prototype) &&
            'createDTMFSender' in window.RTCPeerConnection.prototype) {
          var shimSenderWithDtmf = function(pc, track) {
            return {
              track: track,
              get dtmf() {
                if (this._dtmf === undefined) {
                  if (track.kind === 'audio') {
                    this._dtmf = pc.createDTMFSender(track);
                  } else {
                    this._dtmf = null;
                  }
                }
                return this._dtmf;
              },
              _pc: pc
            };
          };
    
          // augment addTrack when getSenders is not available.
          if (!window.RTCPeerConnection.prototype.getSenders) {
            window.RTCPeerConnection.prototype.getSenders = function() {
              this._senders = this._senders || [];
              return this._senders.slice(); // return a copy of the internal state.
            };
            var origAddTrack = window.RTCPeerConnection.prototype.addTrack;
            window.RTCPeerConnection.prototype.addTrack = function(track, stream) {
              var pc = this;
              var sender = origAddTrack.apply(pc, arguments);
              if (!sender) {
                sender = shimSenderWithDtmf(pc, track);
                pc._senders.push(sender);
              }
              return sender;
            };
    
            var origRemoveTrack = window.RTCPeerConnection.prototype.removeTrack;
            window.RTCPeerConnection.prototype.removeTrack = function(sender) {
              var pc = this;
              origRemoveTrack.apply(pc, arguments);
              var idx = pc._senders.indexOf(sender);
              if (idx !== -1) {
                pc._senders.splice(idx, 1);
              }
            };
          }
          var origAddStream = window.RTCPeerConnection.prototype.addStream;
          window.RTCPeerConnection.prototype.addStream = function(stream) {
            var pc = this;
            pc._senders = pc._senders || [];
            origAddStream.apply(pc, [stream]);
            stream.getTracks().forEach(function(track) {
              pc._senders.push(shimSenderWithDtmf(pc, track));
            });
          };
    
          var origRemoveStream = window.RTCPeerConnection.prototype.removeStream;
          window.RTCPeerConnection.prototype.removeStream = function(stream) {
            var pc = this;
            pc._senders = pc._senders || [];
            origRemoveStream.apply(pc, [stream]);
    
            stream.getTracks().forEach(function(track) {
              var sender = pc._senders.find(function(s) {
                return s.track === track;
              });
              if (sender) {
                pc._senders.splice(pc._senders.indexOf(sender), 1); // remove sender
              }
            });
          };
        } else if (typeof window === 'object' && window.RTCPeerConnection &&
                   'getSenders' in window.RTCPeerConnection.prototype &&
                   'createDTMFSender' in window.RTCPeerConnection.prototype &&
                   window.RTCRtpSender &&
                   !('dtmf' in window.RTCRtpSender.prototype)) {
          var origGetSenders = window.RTCPeerConnection.prototype.getSenders;
          window.RTCPeerConnection.prototype.getSenders = function() {
            var pc = this;
            var senders = origGetSenders.apply(pc, []);
            senders.forEach(function(sender) {
              sender._pc = pc;
            });
            return senders;
          };
    
          Object.defineProperty(window.RTCRtpSender.prototype, 'dtmf', {
            get: function() {
              if (this._dtmf === undefined) {
                if (this.track.kind === 'audio') {
                  this._dtmf = this._pc.createDTMFSender(this.track);
                } else {
                  this._dtmf = null;
                }
              }
              return this._dtmf;
            }
          });
        }
      },
    
      shimSenderReceiverGetStats: function(window) {
        if (!(typeof window === 'object' && window.RTCPeerConnection &&
            window.RTCRtpSender && window.RTCRtpReceiver)) {
          return;
        }
    
        // shim sender stats.
        if (!('getStats' in window.RTCRtpSender.prototype)) {
          var origGetSenders = window.RTCPeerConnection.prototype.getSenders;
          if (origGetSenders) {
            window.RTCPeerConnection.prototype.getSenders = function() {
              var pc = this;
              var senders = origGetSenders.apply(pc, []);
              senders.forEach(function(sender) {
                sender._pc = pc;
              });
              return senders;
            };
          }
    
          var origAddTrack = window.RTCPeerConnection.prototype.addTrack;
          if (origAddTrack) {
            window.RTCPeerConnection.prototype.addTrack = function() {
              var sender = origAddTrack.apply(this, arguments);
              sender._pc = this;
              return sender;
            };
          }
          window.RTCRtpSender.prototype.getStats = function() {
            var sender = this;
            return this._pc.getStats().then(function(result) {
              /* Note: this will include stats of all senders that
               *   send a track with the same id as sender.track as
               *   it is not possible to identify the RTCRtpSender.
               */
              return filterStats(result, sender.track, true);
            });
          };
        }
    
        // shim receiver stats.
        if (!('getStats' in window.RTCRtpReceiver.prototype)) {
          var origGetReceivers = window.RTCPeerConnection.prototype.getReceivers;
          if (origGetReceivers) {
            window.RTCPeerConnection.prototype.getReceivers = function() {
              var pc = this;
              var receivers = origGetReceivers.apply(pc, []);
              receivers.forEach(function(receiver) {
                receiver._pc = pc;
              });
              return receivers;
            };
          }
          utils.wrapPeerConnectionEvent(window, 'track', function(e) {
            e.receiver._pc = e.srcElement;
            return e;
          });
          window.RTCRtpReceiver.prototype.getStats = function() {
            var receiver = this;
            return this._pc.getStats().then(function(result) {
              return filterStats(result, receiver.track, false);
            });
          };
        }
    
        if (!('getStats' in window.RTCRtpSender.prototype &&
            'getStats' in window.RTCRtpReceiver.prototype)) {
          return;
        }
    
        // shim RTCPeerConnection.getStats(track).
        var origGetStats = window.RTCPeerConnection.prototype.getStats;
        window.RTCPeerConnection.prototype.getStats = function() {
          var pc = this;
          if (arguments.length > 0 &&
              arguments[0] instanceof window.MediaStreamTrack) {
            var track = arguments[0];
            var sender;
            var receiver;
            var err;
            pc.getSenders().forEach(function(s) {
              if (s.track === track) {
                if (sender) {
                  err = true;
                } else {
                  sender = s;
                }
              }
            });
            pc.getReceivers().forEach(function(r) {
              if (r.track === track) {
                if (receiver) {
                  err = true;
                } else {
                  receiver = r;
                }
              }
              return r.track === track;
            });
            if (err || (sender && receiver)) {
              return Promise.reject(new DOMException(
                'There are more than one sender or receiver for the track.',
                'InvalidAccessError'));
            } else if (sender) {
              return sender.getStats();
            } else if (receiver) {
              return receiver.getStats();
            }
            return Promise.reject(new DOMException(
              'There is no sender or receiver for the track.',
              'InvalidAccessError'));
          }
          return origGetStats.apply(pc, arguments);
        };
      },
    
      shimSourceObject: function(window) {
        var URL = window && window.URL;
    
        if (typeof window === 'object') {
          if (window.HTMLMediaElement &&
            !('srcObject' in window.HTMLMediaElement.prototype)) {
            // Shim the srcObject property, once, when HTMLMediaElement is found.
            Object.defineProperty(window.HTMLMediaElement.prototype, 'srcObject', {
              get: function() {
                return this._srcObject;
              },
              set: function(stream) {
                var self = this;
                // Use _srcObject as a private property for this shim
                this._srcObject = stream;
                if (this.src) {
                  URL.revokeObjectURL(this.src);
                }
    
                if (!stream) {
                  this.src = '';
                  return undefined;
                }
                this.src = URL.createObjectURL(stream);
                // We need to recreate the blob url when a track is added or
                // removed. Doing it manually since we want to avoid a recursion.
                stream.addEventListener('addtrack', function() {
                  if (self.src) {
                    URL.revokeObjectURL(self.src);
                  }
                  self.src = URL.createObjectURL(stream);
                });
                stream.addEventListener('removetrack', function() {
                  if (self.src) {
                    URL.revokeObjectURL(self.src);
                  }
                  self.src = URL.createObjectURL(stream);
                });
              }
            });
          }
        }
      },
    
      shimAddTrackRemoveTrackWithNative: function(window) {
        // shim addTrack/removeTrack with native variants in order to make
        // the interactions with legacy getLocalStreams behave as in other browsers.
        // Keeps a mapping stream.id => [stream, rtpsenders...]
        window.RTCPeerConnection.prototype.getLocalStreams = function() {
          var pc = this;
          this._shimmedLocalStreams = this._shimmedLocalStreams || {};
          return Object.keys(this._shimmedLocalStreams).map(function(streamId) {
            return pc._shimmedLocalStreams[streamId][0];
          });
        };
    
        var origAddTrack = window.RTCPeerConnection.prototype.addTrack;
        window.RTCPeerConnection.prototype.addTrack = function(track, stream) {
          if (!stream) {
            return origAddTrack.apply(this, arguments);
          }
          this._shimmedLocalStreams = this._shimmedLocalStreams || {};
    
          var sender = origAddTrack.apply(this, arguments);
          if (!this._shimmedLocalStreams[stream.id]) {
            this._shimmedLocalStreams[stream.id] = [stream, sender];
          } else if (this._shimmedLocalStreams[stream.id].indexOf(sender) === -1) {
            this._shimmedLocalStreams[stream.id].push(sender);
          }
          return sender;
        };
    
        var origAddStream = window.RTCPeerConnection.prototype.addStream;
        window.RTCPeerConnection.prototype.addStream = function(stream) {
          var pc = this;
          this._shimmedLocalStreams = this._shimmedLocalStreams || {};
    
          stream.getTracks().forEach(function(track) {
            var alreadyExists = pc.getSenders().find(function(s) {
              return s.track === track;
            });
            if (alreadyExists) {
              throw new DOMException('Track already exists.',
                  'InvalidAccessError');
            }
          });
          var existingSenders = pc.getSenders();
          origAddStream.apply(this, arguments);
          var newSenders = pc.getSenders().filter(function(newSender) {
            return existingSenders.indexOf(newSender) === -1;
          });
          this._shimmedLocalStreams[stream.id] = [stream].concat(newSenders);
        };
    
        var origRemoveStream = window.RTCPeerConnection.prototype.removeStream;
        window.RTCPeerConnection.prototype.removeStream = function(stream) {
          this._shimmedLocalStreams = this._shimmedLocalStreams || {};
          delete this._shimmedLocalStreams[stream.id];
          return origRemoveStream.apply(this, arguments);
        };
    
        var origRemoveTrack = window.RTCPeerConnection.prototype.removeTrack;
        window.RTCPeerConnection.prototype.removeTrack = function(sender) {
          var pc = this;
          this._shimmedLocalStreams = this._shimmedLocalStreams || {};
          if (sender) {
            Object.keys(this._shimmedLocalStreams).forEach(function(streamId) {
              var idx = pc._shimmedLocalStreams[streamId].indexOf(sender);
              if (idx !== -1) {
                pc._shimmedLocalStreams[streamId].splice(idx, 1);
              }
              if (pc._shimmedLocalStreams[streamId].length === 1) {
                delete pc._shimmedLocalStreams[streamId];
              }
            });
          }
          return origRemoveTrack.apply(this, arguments);
        };
      },
    
      shimAddTrackRemoveTrack: function(window) {
        var browserDetails = utils.detectBrowser(window);
        // shim addTrack and removeTrack.
        if (window.RTCPeerConnection.prototype.addTrack &&
            browserDetails.version >= 65) {
          return this.shimAddTrackRemoveTrackWithNative(window);
        }
    
        // also shim pc.getLocalStreams when addTrack is shimmed
        // to return the original streams.
        var origGetLocalStreams = window.RTCPeerConnection.prototype
            .getLocalStreams;
        window.RTCPeerConnection.prototype.getLocalStreams = function() {
          var pc = this;
          var nativeStreams = origGetLocalStreams.apply(this);
          pc._reverseStreams = pc._reverseStreams || {};
          return nativeStreams.map(function(stream) {
            return pc._reverseStreams[stream.id];
          });
        };
    
        var origAddStream = window.RTCPeerConnection.prototype.addStream;
        window.RTCPeerConnection.prototype.addStream = function(stream) {
          var pc = this;
          pc._streams = pc._streams || {};
          pc._reverseStreams = pc._reverseStreams || {};
    
          stream.getTracks().forEach(function(track) {
            var alreadyExists = pc.getSenders().find(function(s) {
              return s.track === track;
            });
            if (alreadyExists) {
              throw new DOMException('Track already exists.',
                  'InvalidAccessError');
            }
          });
          // Add identity mapping for consistency with addTrack.
          // Unless this is being used with a stream from addTrack.
          if (!pc._reverseStreams[stream.id]) {
            var newStream = new window.MediaStream(stream.getTracks());
            pc._streams[stream.id] = newStream;
            pc._reverseStreams[newStream.id] = stream;
            stream = newStream;
          }
          origAddStream.apply(pc, [stream]);
        };
    
        var origRemoveStream = window.RTCPeerConnection.prototype.removeStream;
        window.RTCPeerConnection.prototype.removeStream = function(stream) {
          var pc = this;
          pc._streams = pc._streams || {};
          pc._reverseStreams = pc._reverseStreams || {};
    
          origRemoveStream.apply(pc, [(pc._streams[stream.id] || stream)]);
          delete pc._reverseStreams[(pc._streams[stream.id] ?
              pc._streams[stream.id].id : stream.id)];
          delete pc._streams[stream.id];
        };
    
        window.RTCPeerConnection.prototype.addTrack = function(track, stream) {
          var pc = this;
          if (pc.signalingState === 'closed') {
            throw new DOMException(
              'The RTCPeerConnection\'s signalingState is \'closed\'.',
              'InvalidStateError');
          }
          var streams = [].slice.call(arguments, 1);
          if (streams.length !== 1 ||
              !streams[0].getTracks().find(function(t) {
                return t === track;
              })) {
            // this is not fully correct but all we can manage without
            // [[associated MediaStreams]] internal slot.
            throw new DOMException(
              'The adapter.js addTrack polyfill only supports a single ' +
              ' stream which is associated with the specified track.',
              'NotSupportedError');
          }
    
          var alreadyExists = pc.getSenders().find(function(s) {
            return s.track === track;
          });
          if (alreadyExists) {
            throw new DOMException('Track already exists.',
                'InvalidAccessError');
          }
    
          pc._streams = pc._streams || {};
          pc._reverseStreams = pc._reverseStreams || {};
          var oldStream = pc._streams[stream.id];
          if (oldStream) {
            // this is using odd Chrome behaviour, use with caution:
            // https://bugs.chromium.org/p/webrtc/issues/detail?id=7815
            // Note: we rely on the high-level addTrack/dtmf shim to
            // create the sender with a dtmf sender.
            oldStream.addTrack(track);
    
            // Trigger ONN async.
            Promise.resolve().then(function() {
              pc.dispatchEvent(new Event('negotiationneeded'));
            });
          } else {
            var newStream = new window.MediaStream([track]);
            pc._streams[stream.id] = newStream;
            pc._reverseStreams[newStream.id] = stream;
            pc.addStream(newStream);
          }
          return pc.getSenders().find(function(s) {
            return s.track === track;
          });
        };
    
        // replace the internal stream id with the external one and
        // vice versa.
        function replaceInternalStreamId(pc, description) {
          var sdp = description.sdp;
          Object.keys(pc._reverseStreams || []).forEach(function(internalId) {
            var externalStream = pc._reverseStreams[internalId];
            var internalStream = pc._streams[externalStream.id];
            sdp = sdp.replace(new RegExp(internalStream.id, 'g'),
                externalStream.id);
          });
          return new RTCSessionDescription({
            type: description.type,
            sdp: sdp
          });
        }
        function replaceExternalStreamId(pc, description) {
          var sdp = description.sdp;
          Object.keys(pc._reverseStreams || []).forEach(function(internalId) {
            var externalStream = pc._reverseStreams[internalId];
            var internalStream = pc._streams[externalStream.id];
            sdp = sdp.replace(new RegExp(externalStream.id, 'g'),
                internalStream.id);
          });
          return new RTCSessionDescription({
            type: description.type,
            sdp: sdp
          });
        }
        ['createOffer', 'createAnswer'].forEach(function(method) {
          var nativeMethod = window.RTCPeerConnection.prototype[method];
          window.RTCPeerConnection.prototype[method] = function() {
            var pc = this;
            var args = arguments;
            var isLegacyCall = arguments.length &&
                typeof arguments[0] === 'function';
            if (isLegacyCall) {
              return nativeMethod.apply(pc, [
                function(description) {
                  var desc = replaceInternalStreamId(pc, description);
                  args[0].apply(null, [desc]);
                },
                function(err) {
                  if (args[1]) {
                    args[1].apply(null, err);
                  }
                }, arguments[2]
              ]);
            }
            return nativeMethod.apply(pc, arguments)
            .then(function(description) {
              return replaceInternalStreamId(pc, description);
            });
          };
        });
    
        var origSetLocalDescription =
            window.RTCPeerConnection.prototype.setLocalDescription;
        window.RTCPeerConnection.prototype.setLocalDescription = function() {
          var pc = this;
          if (!arguments.length || !arguments[0].type) {
            return origSetLocalDescription.apply(pc, arguments);
          }
          arguments[0] = replaceExternalStreamId(pc, arguments[0]);
          return origSetLocalDescription.apply(pc, arguments);
        };
    
        // TODO: mangle getStats: https://w3c.github.io/webrtc-stats/#dom-rtcmediastreamstats-streamidentifier
    
        var origLocalDescription = Object.getOwnPropertyDescriptor(
            window.RTCPeerConnection.prototype, 'localDescription');
        Object.defineProperty(window.RTCPeerConnection.prototype,
            'localDescription', {
              get: function() {
                var pc = this;
                var description = origLocalDescription.get.apply(this);
                if (description.type === '') {
                  return description;
                }
                return replaceInternalStreamId(pc, description);
              }
            });
    
        window.RTCPeerConnection.prototype.removeTrack = function(sender) {
          var pc = this;
          if (pc.signalingState === 'closed') {
            throw new DOMException(
              'The RTCPeerConnection\'s signalingState is \'closed\'.',
              'InvalidStateError');
          }
          // We can not yet check for sender instanceof RTCRtpSender
          // since we shim RTPSender. So we check if sender._pc is set.
          if (!sender._pc) {
            throw new DOMException('Argument 1 of RTCPeerConnection.removeTrack ' +
                'does not implement interface RTCRtpSender.', 'TypeError');
          }
          var isLocal = sender._pc === pc;
          if (!isLocal) {
            throw new DOMException('Sender was not created by this connection.',
                'InvalidAccessError');
          }
    
          // Search for the native stream the senders track belongs to.
          pc._streams = pc._streams || {};
          var stream;
          Object.keys(pc._streams).forEach(function(streamid) {
            var hasTrack = pc._streams[streamid].getTracks().find(function(track) {
              return sender.track === track;
            });
            if (hasTrack) {
              stream = pc._streams[streamid];
            }
          });
    
          if (stream) {
            if (stream.getTracks().length === 1) {
              // if this is the last track of the stream, remove the stream. This
              // takes care of any shimmed _senders.
              pc.removeStream(pc._reverseStreams[stream.id]);
            } else {
              // relying on the same odd chrome behaviour as above.
              stream.removeTrack(sender.track);
            }
            pc.dispatchEvent(new Event('negotiationneeded'));
          }
        };
      },
    
      shimPeerConnection: function(window) {
        var browserDetails = utils.detectBrowser(window);
    
        // The RTCPeerConnection object.
        if (!window.RTCPeerConnection && window.webkitRTCPeerConnection) {
          window.RTCPeerConnection = function(pcConfig, pcConstraints) {
            // Translate iceTransportPolicy to iceTransports,
            // see https://code.google.com/p/webrtc/issues/detail?id=4869
            // this was fixed in M56 along with unprefixing RTCPeerConnection.
            logging('PeerConnection');
            if (pcConfig && pcConfig.iceTransportPolicy) {
              pcConfig.iceTransports = pcConfig.iceTransportPolicy;
            }
    
            return new window.webkitRTCPeerConnection(pcConfig, pcConstraints);
          };
          window.RTCPeerConnection.prototype =
              window.webkitRTCPeerConnection.prototype;
          // wrap static methods. Currently just generateCertificate.
          if (window.webkitRTCPeerConnection.generateCertificate) {
            Object.defineProperty(window.RTCPeerConnection, 'generateCertificate', {
              get: function() {
                return window.webkitRTCPeerConnection.generateCertificate;
              }
            });
          }
        }
    
        var origGetStats = window.RTCPeerConnection.prototype.getStats;
        window.RTCPeerConnection.prototype.getStats = function(selector,
            successCallback, errorCallback) {
          var pc = this;
          var args = arguments;
    
          // If selector is a function then we are in the old style stats so just
          // pass back the original getStats format to avoid breaking old users.
          if (arguments.length > 0 && typeof selector === 'function') {
            return origGetStats.apply(this, arguments);
          }
    
          // When spec-style getStats is supported, return those when called with
          // either no arguments or the selector argument is null.
          if (origGetStats.length === 0 && (arguments.length === 0 ||
              typeof arguments[0] !== 'function')) {
            return origGetStats.apply(this, []);
          }
    
          var fixChromeStats_ = function(response) {
            var standardReport = {};
            var reports = response.result();
            reports.forEach(function(report) {
              var standardStats = {
                id: report.id,
                timestamp: report.timestamp,
                type: {
                  localcandidate: 'local-candidate',
                  remotecandidate: 'remote-candidate'
                }[report.type] || report.type
              };
              report.names().forEach(function(name) {
                standardStats[name] = report.stat(name);
              });
              standardReport[standardStats.id] = standardStats;
            });
    
            return standardReport;
          };
    
          // shim getStats with maplike support
          var makeMapStats = function(stats) {
            return new Map(Object.keys(stats).map(function(key) {
              return [key, stats[key]];
            }));
          };
    
          if (arguments.length >= 2) {
            var successCallbackWrapper_ = function(response) {
              args[1](makeMapStats(fixChromeStats_(response)));
            };
    
            return origGetStats.apply(this, [successCallbackWrapper_,
              arguments[0]]);
          }
    
          // promise-support
          return new Promise(function(resolve, reject) {
            origGetStats.apply(pc, [
              function(response) {
                resolve(makeMapStats(fixChromeStats_(response)));
              }, reject]);
          }).then(successCallback, errorCallback);
        };
    
        // add promise support -- natively available in Chrome 51
        if (browserDetails.version < 51) {
          ['setLocalDescription', 'setRemoteDescription', 'addIceCandidate']
              .forEach(function(method) {
                var nativeMethod = window.RTCPeerConnection.prototype[method];
                window.RTCPeerConnection.prototype[method] = function() {
                  var args = arguments;
                  var pc = this;
                  var promise = new Promise(function(resolve, reject) {
                    nativeMethod.apply(pc, [args[0], resolve, reject]);
                  });
                  if (args.length < 2) {
                    return promise;
                  }
                  return promise.then(function() {
                    args[1].apply(null, []);
                  },
                  function(err) {
                    if (args.length >= 3) {
                      args[2].apply(null, [err]);
                    }
                  });
                };
              });
        }
    
        // promise support for createOffer and createAnswer. Available (without
        // bugs) since M52: crbug/619289
        if (browserDetails.version < 52) {
          ['createOffer', 'createAnswer'].forEach(function(method) {
            var nativeMethod = window.RTCPeerConnection.prototype[method];
            window.RTCPeerConnection.prototype[method] = function() {
              var pc = this;
              if (arguments.length < 1 || (arguments.length === 1 &&
                  typeof arguments[0] === 'object')) {
                var opts = arguments.length === 1 ? arguments[0] : undefined;
                return new Promise(function(resolve, reject) {
                  nativeMethod.apply(pc, [resolve, reject, opts]);
                });
              }
              return nativeMethod.apply(this, arguments);
            };
          });
        }
    
        // shim implicit creation of RTCSessionDescription/RTCIceCandidate
        ['setLocalDescription', 'setRemoteDescription', 'addIceCandidate']
            .forEach(function(method) {
              var nativeMethod = window.RTCPeerConnection.prototype[method];
              window.RTCPeerConnection.prototype[method] = function() {
                arguments[0] = new ((method === 'addIceCandidate') ?
                    window.RTCIceCandidate :
                    window.RTCSessionDescription)(arguments[0]);
                return nativeMethod.apply(this, arguments);
              };
            });
    
        // support for addIceCandidate(null or undefined)
        var nativeAddIceCandidate =
            window.RTCPeerConnection.prototype.addIceCandidate;
        window.RTCPeerConnection.prototype.addIceCandidate = function() {
          if (!arguments[0]) {
            if (arguments[1]) {
              arguments[1].apply(null);
            }
            return Promise.resolve();
          }
          return nativeAddIceCandidate.apply(this, arguments);
        };
      },
    
      fixNegotiationNeeded: function(window) {
        utils.wrapPeerConnectionEvent(window, 'negotiationneeded', function(e) {
          var pc = e.target;
          if (pc.signalingState !== 'stable') {
            return;
          }
          return e;
        });
      },
    
      shimGetDisplayMedia: function(window, getSourceId) {
        if ('getDisplayMedia' in window.navigator) {
          return;
        }
        // getSourceId is a function that returns a promise resolving with
        // the sourceId of the screen/window/tab to be shared.
        if (typeof getSourceId !== 'function') {
          console.error('shimGetDisplayMedia: getSourceId argument is not ' +
              'a function');
          return;
        }
        navigator.getDisplayMedia = function(constraints) {
          return getSourceId(constraints)
            .then(function(sourceId) {
              constraints.video = {
                mandatory: {
                  chromeMediaSource: 'desktop',
                  chromeMediaSourceId: sourceId,
                  maxFrameRate: constraints.video.frameRate || 3
                }
              };
              return navigator.mediaDevices.getUserMedia(constraints);
            });
        };
      }
    };
    
    },{"../utils.js":14,"./getusermedia":6}],6:[function(require,module,exports){
    /*
     *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.
     *
     *  Use of this source code is governed by a BSD-style license
     *  that can be found in the LICENSE file in the root of the source
     *  tree.
     */
     /* eslint-env node */
    'use strict';
    var utils = require('../utils.js');
    var logging = utils.log;
    
    // Expose public methods.
    module.exports = function(window) {
      var browserDetails = utils.detectBrowser(window);
      var navigator = window && window.navigator;
    
      var constraintsToChrome_ = function(c) {
        if (typeof c !== 'object' || c.mandatory || c.optional) {
          return c;
        }
        var cc = {};
        Object.keys(c).forEach(function(key) {
          if (key === 'require' || key === 'advanced' || key === 'mediaSource') {
            return;
          }
          var r = (typeof c[key] === 'object') ? c[key] : {ideal: c[key]};
          if (r.exact !== undefined && typeof r.exact === 'number') {
            r.min = r.max = r.exact;
          }
          var oldname_ = function(prefix, name) {
            if (prefix) {
              return prefix + name.charAt(0).toUpperCase() + name.slice(1);
            }
            return (name === 'deviceId') ? 'sourceId' : name;
          };
          if (r.ideal !== undefined) {
            cc.optional = cc.optional || [];
            var oc = {};
            if (typeof r.ideal === 'number') {
              oc[oldname_('min', key)] = r.ideal;
              cc.optional.push(oc);
              oc = {};
              oc[oldname_('max', key)] = r.ideal;
              cc.optional.push(oc);
            } else {
              oc[oldname_('', key)] = r.ideal;
              cc.optional.push(oc);
            }
          }
          if (r.exact !== undefined && typeof r.exact !== 'number') {
            cc.mandatory = cc.mandatory || {};
            cc.mandatory[oldname_('', key)] = r.exact;
          } else {
            ['min', 'max'].forEach(function(mix) {
              if (r[mix] !== undefined) {
                cc.mandatory = cc.mandatory || {};
                cc.mandatory[oldname_(mix, key)] = r[mix];
              }
            });
          }
        });
        if (c.advanced) {
          cc.optional = (cc.optional || []).concat(c.advanced);
        }
        return cc;
      };
    
      var shimConstraints_ = function(constraints, func) {
        if (browserDetails.version >= 61) {
          return func(constraints);
        }
        constraints = JSON.parse(JSON.stringify(constraints));
        if (constraints && typeof constraints.audio === 'object') {
          var remap = function(obj, a, b) {
            if (a in obj && !(b in obj)) {
              obj[b] = obj[a];
              delete obj[a];
            }
          };
          constraints = JSON.parse(JSON.stringify(constraints));
          remap(constraints.audio, 'autoGainControl', 'googAutoGainControl');
          remap(constraints.audio, 'noiseSuppression', 'googNoiseSuppression');
          constraints.audio = constraintsToChrome_(constraints.audio);
        }
        if (constraints && typeof constraints.video === 'object') {
          // Shim facingMode for mobile & surface pro.
          var face = constraints.video.facingMode;
          face = face && ((typeof face === 'object') ? face : {ideal: face});
          var getSupportedFacingModeLies = browserDetails.version < 66;
    
          if ((face && (face.exact === 'user' || face.exact === 'environment' ||
                        face.ideal === 'user' || face.ideal === 'environment')) &&
              !(navigator.mediaDevices.getSupportedConstraints &&
                navigator.mediaDevices.getSupportedConstraints().facingMode &&
                !getSupportedFacingModeLies)) {
            delete constraints.video.facingMode;
            var matches;
            if (face.exact === 'environment' || face.ideal === 'environment') {
              matches = ['back', 'rear'];
            } else if (face.exact === 'user' || face.ideal === 'user') {
              matches = ['front'];
            }
            if (matches) {
              // Look for matches in label, or use last cam for back (typical).
              return navigator.mediaDevices.enumerateDevices()
              .then(function(devices) {
                devices = devices.filter(function(d) {
                  return d.kind === 'videoinput';
                });
                var dev = devices.find(function(d) {
                  return matches.some(function(match) {
                    return d.label.toLowerCase().indexOf(match) !== -1;
                  });
                });
                if (!dev && devices.length && matches.indexOf('back') !== -1) {
                  dev = devices[devices.length - 1]; // more likely the back cam
                }
                if (dev) {
                  constraints.video.deviceId = face.exact ? {exact: dev.deviceId} :
                                                            {ideal: dev.deviceId};
                }
                constraints.video = constraintsToChrome_(constraints.video);
                logging('chrome: ' + JSON.stringify(constraints));
                return func(constraints);
              });
            }
          }
          constraints.video = constraintsToChrome_(constraints.video);
        }
        logging('chrome: ' + JSON.stringify(constraints));
        return func(constraints);
      };
    
      var shimError_ = function(e) {
        if (browserDetails.version >= 64) {
          return e;
        }
        return {
          name: {
            PermissionDeniedError: 'NotAllowedError',
            PermissionDismissedError: 'NotAllowedError',
            InvalidStateError: 'NotAllowedError',
            DevicesNotFoundError: 'NotFoundError',
            ConstraintNotSatisfiedError: 'OverconstrainedError',
            TrackStartError: 'NotReadableError',
            MediaDeviceFailedDueToShutdown: 'NotAllowedError',
            MediaDeviceKillSwitchOn: 'NotAllowedError',
            TabCaptureError: 'AbortError',
            ScreenCaptureError: 'AbortError',
            DeviceCaptureError: 'AbortError'
          }[e.name] || e.name,
          message: e.message,
          constraint: e.constraint || e.constraintName,
          toString: function() {
            return this.name + (this.message && ': ') + this.message;
          }
        };
      };
    
      var getUserMedia_ = function(constraints, onSuccess, onError) {
        shimConstraints_(constraints, function(c) {
          navigator.webkitGetUserMedia(c, onSuccess, function(e) {
            if (onError) {
              onError(shimError_(e));
            }
          });
        });
      };
    
      navigator.getUserMedia = getUserMedia_;
    
      // Returns the result of getUserMedia as a Promise.
      var getUserMediaPromise_ = function(constraints) {
        return new Promise(function(resolve, reject) {
          navigator.getUserMedia(constraints, resolve, reject);
        });
      };
    
      if (!navigator.mediaDevices) {
        navigator.mediaDevices = {
          getUserMedia: getUserMediaPromise_,
          enumerateDevices: function() {
            return new Promise(function(resolve) {
              var kinds = {audio: 'audioinput', video: 'videoinput'};
              return window.MediaStreamTrack.getSources(function(devices) {
                resolve(devices.map(function(device) {
                  return {label: device.label,
                    kind: kinds[device.kind],
                    deviceId: device.id,
                    groupId: ''};
                }));
              });
            });
          },
          getSupportedConstraints: function() {
            return {
              deviceId: true, echoCancellation: true, facingMode: true,
              frameRate: true, height: true, width: true
            };
          }
        };
      }
    
      // A shim for getUserMedia method on the mediaDevices object.
      // TODO(KaptenJansson) remove once implemented in Chrome stable.
      if (!navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia = function(constraints) {
          return getUserMediaPromise_(constraints);
        };
      } else {
        // Even though Chrome 45 has navigator.mediaDevices and a getUserMedia
        // function which returns a Promise, it does not accept spec-style
        // constraints.
        var origGetUserMedia = navigator.mediaDevices.getUserMedia.
            bind(navigator.mediaDevices);
        navigator.mediaDevices.getUserMedia = function(cs) {
          return shimConstraints_(cs, function(c) {
            return origGetUserMedia(c).then(function(stream) {
              if (c.audio && !stream.getAudioTracks().length ||
                  c.video && !stream.getVideoTracks().length) {
                stream.getTracks().forEach(function(track) {
                  track.stop();
                });
                throw new DOMException('', 'NotFoundError');
              }
              return stream;
            }, function(e) {
              return Promise.reject(shimError_(e));
            });
          });
        };
      }
    
      // Dummy devicechange event methods.
      // TODO(KaptenJansson) remove once implemented in Chrome stable.
      if (typeof navigator.mediaDevices.addEventListener === 'undefined') {
        navigator.mediaDevices.addEventListener = function() {
          logging('Dummy mediaDevices.addEventListener called.');
        };
      }
      if (typeof navigator.mediaDevices.removeEventListener === 'undefined') {
        navigator.mediaDevices.removeEventListener = function() {
          logging('Dummy mediaDevices.removeEventListener called.');
        };
      }
    };
    
    },{"../utils.js":14}],7:[function(require,module,exports){
    /*
     *  Copyright (c) 2017 The WebRTC project authors. All Rights Reserved.
     *
     *  Use of this source code is governed by a BSD-style license
     *  that can be found in the LICENSE file in the root of the source
     *  tree.
     */
     /* eslint-env node */
    'use strict';
    
    var SDPUtils = require('sdp');
    var utils = require('./utils');
    
    module.exports = {
      shimRTCIceCandidate: function(window) {
        // foundation is arbitrarily chosen as an indicator for full support for
        // https://w3c.github.io/webrtc-pc/#rtcicecandidate-interface
        if (!window.RTCIceCandidate || (window.RTCIceCandidate && 'foundation' in
            window.RTCIceCandidate.prototype)) {
          return;
        }
    
        var NativeRTCIceCandidate = window.RTCIceCandidate;
        window.RTCIceCandidate = function(args) {
          // Remove the a= which shouldn't be part of the candidate string.
          if (typeof args === 'object' && args.candidate &&
              args.candidate.indexOf('a=') === 0) {
            args = JSON.parse(JSON.stringify(args));
            args.candidate = args.candidate.substr(2);
          }
    
          if (args.candidate && args.candidate.length) {
            // Augment the native candidate with the parsed fields.
            var nativeCandidate = new NativeRTCIceCandidate(args);
            var parsedCandidate = SDPUtils.parseCandidate(args.candidate);
            var augmentedCandidate = Object.assign(nativeCandidate,
                parsedCandidate);
    
            // Add a serializer that does not serialize the extra attributes.
            augmentedCandidate.toJSON = function() {
              return {
                candidate: augmentedCandidate.candidate,
                sdpMid: augmentedCandidate.sdpMid,
                sdpMLineIndex: augmentedCandidate.sdpMLineIndex,
                usernameFragment: augmentedCandidate.usernameFragment,
              };
            };
            return augmentedCandidate;
          }
          return new NativeRTCIceCandidate(args);
        };
        window.RTCIceCandidate.prototype = NativeRTCIceCandidate.prototype;
    
        // Hook up the augmented candidate in onicecandidate and
        // addEventListener('icecandidate', ...)
        utils.wrapPeerConnectionEvent(window, 'icecandidate', function(e) {
          if (e.candidate) {
            Object.defineProperty(e, 'candidate', {
              value: new window.RTCIceCandidate(e.candidate),
              writable: 'false'
            });
          }
          return e;
        });
      },
    
      // shimCreateObjectURL must be called before shimSourceObject to avoid loop.
    
      shimCreateObjectURL: function(window) {
        var URL = window && window.URL;
    
        if (!(typeof window === 'object' && window.HTMLMediaElement &&
              'srcObject' in window.HTMLMediaElement.prototype &&
            URL.createObjectURL && URL.revokeObjectURL)) {
          // Only shim CreateObjectURL using srcObject if srcObject exists.
          return undefined;
        }
    
        var nativeCreateObjectURL = URL.createObjectURL.bind(URL);
        var nativeRevokeObjectURL = URL.revokeObjectURL.bind(URL);
        var streams = new Map(), newId = 0;
    
        URL.createObjectURL = function(stream) {
          if ('getTracks' in stream) {
            var url = 'polyblob:' + (++newId);
            streams.set(url, stream);
            utils.deprecated('URL.createObjectURL(stream)',
                'elem.srcObject = stream');
            return url;
          }
          return nativeCreateObjectURL(stream);
        };
        URL.revokeObjectURL = function(url) {
          nativeRevokeObjectURL(url);
          streams.delete(url);
        };
    
        var dsc = Object.getOwnPropertyDescriptor(window.HTMLMediaElement.prototype,
                                                  'src');
        Object.defineProperty(window.HTMLMediaElement.prototype, 'src', {
          get: function() {
            return dsc.get.apply(this);
          },
          set: function(url) {
            this.srcObject = streams.get(url) || null;
            return dsc.set.apply(this, [url]);
          }
        });
    
        var nativeSetAttribute = window.HTMLMediaElement.prototype.setAttribute;
        window.HTMLMediaElement.prototype.setAttribute = function() {
          if (arguments.length === 2 &&
              ('' + arguments[0]).toLowerCase() === 'src') {
            this.srcObject = streams.get(arguments[1]) || null;
          }
          return nativeSetAttribute.apply(this, arguments);
        };
      },
    
      shimMaxMessageSize: function(window) {
        if (window.RTCSctpTransport || !window.RTCPeerConnection) {
          return;
        }
        var browserDetails = utils.detectBrowser(window);
    
        if (!('sctp' in window.RTCPeerConnection.prototype)) {
          Object.defineProperty(window.RTCPeerConnection.prototype, 'sctp', {
            get: function() {
              return typeof this._sctp === 'undefined' ? null : this._sctp;
            }
          });
        }
    
        var sctpInDescription = function(description) {
          var sections = SDPUtils.splitSections(description.sdp);
          sections.shift();
          return sections.some(function(mediaSection) {
            var mLine = SDPUtils.parseMLine(mediaSection);
            return mLine && mLine.kind === 'application'
                && mLine.protocol.indexOf('SCTP') !== -1;
          });
        };
    
        var getRemoteFirefoxVersion = function(description) {
          // TODO: Is there a better solution for detecting Firefox?
          var match = description.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);
          if (match === null || match.length < 2) {
            return -1;
          }
          var version = parseInt(match[1], 10);
          // Test for NaN (yes, this is ugly)
          return version !== version ? -1 : version;
        };
    
        var getCanSendMaxMessageSize = function(remoteIsFirefox) {
          // Every implementation we know can send at least 64 KiB.
          // Note: Although Chrome is technically able to send up to 256 KiB, the
          //       data does not reach the other peer reliably.
          //       See: https://bugs.chromium.org/p/webrtc/issues/detail?id=8419
          var canSendMaxMessageSize = 65536;
          if (browserDetails.browser === 'firefox') {
            if (browserDetails.version < 57) {
              if (remoteIsFirefox === -1) {
                // FF < 57 will send in 16 KiB chunks using the deprecated PPID
                // fragmentation.
                canSendMaxMessageSize = 16384;
              } else {
                // However, other FF (and RAWRTC) can reassemble PPID-fragmented
                // messages. Thus, supporting ~2 GiB when sending.
                canSendMaxMessageSize = 2147483637;
              }
            } else if (browserDetails.version < 60) {
              // Currently, all FF >= 57 will reset the remote maximum message size
              // to the default value when a data channel is created at a later
              // stage. :(
              // See: https://bugzilla.mozilla.org/show_bug.cgi?id=1426831
              canSendMaxMessageSize =
                browserDetails.version === 57 ? 65535 : 65536;
            } else {
              // FF >= 60 supports sending ~2 GiB
              canSendMaxMessageSize = 2147483637;
            }
          }
          return canSendMaxMessageSize;
        };
    
        var getMaxMessageSize = function(description, remoteIsFirefox) {
          // Note: 65536 bytes is the default value from the SDP spec. Also,
          //       every implementation we know supports receiving 65536 bytes.
          var maxMessageSize = 65536;
    
          // FF 57 has a slightly incorrect default remote max message size, so
          // we need to adjust it here to avoid a failure when sending.
          // See: https://bugzilla.mozilla.org/show_bug.cgi?id=1425697
          if (browserDetails.browser === 'firefox'
               && browserDetails.version === 57) {
            maxMessageSize = 65535;
          }
    
          var match = SDPUtils.matchPrefix(description.sdp, 'a=max-message-size:');
          if (match.length > 0) {
            maxMessageSize = parseInt(match[0].substr(19), 10);
          } else if (browserDetails.browser === 'firefox' &&
                      remoteIsFirefox !== -1) {
            // If the maximum message size is not present in the remote SDP and
            // both local and remote are Firefox, the remote peer can receive
            // ~2 GiB.
            maxMessageSize = 2147483637;
          }
          return maxMessageSize;
        };
    
        var origSetRemoteDescription =
            window.RTCPeerConnection.prototype.setRemoteDescription;
        window.RTCPeerConnection.prototype.setRemoteDescription = function() {
          var pc = this;
          pc._sctp = null;
    
          if (sctpInDescription(arguments[0])) {
            // Check if the remote is FF.
            var isFirefox = getRemoteFirefoxVersion(arguments[0]);
    
            // Get the maximum message size the local peer is capable of sending
            var canSendMMS = getCanSendMaxMessageSize(isFirefox);
    
            // Get the maximum message size of the remote peer.
            var remoteMMS = getMaxMessageSize(arguments[0], isFirefox);
    
            // Determine final maximum message size
            var maxMessageSize;
            if (canSendMMS === 0 && remoteMMS === 0) {
              maxMessageSize = Number.POSITIVE_INFINITY;
            } else if (canSendMMS === 0 || remoteMMS === 0) {
              maxMessageSize = Math.max(canSendMMS, remoteMMS);
            } else {
              maxMessageSize = Math.min(canSendMMS, remoteMMS);
            }
    
            // Create a dummy RTCSctpTransport object and the 'maxMessageSize'
            // attribute.
            var sctp = {};
            Object.defineProperty(sctp, 'maxMessageSize', {
              get: function() {
                return maxMessageSize;
              }
            });
            pc._sctp = sctp;
          }
    
          return origSetRemoteDescription.apply(pc, arguments);
        };
      },
    
      shimSendThrowTypeError: function(window) {
        if (!(window.RTCPeerConnection &&
            'createDataChannel' in window.RTCPeerConnection.prototype)) {
          return;
        }
    
        // Note: Although Firefox >= 57 has a native implementation, the maximum
        //       message size can be reset for all data channels at a later stage.
        //       See: https://bugzilla.mozilla.org/show_bug.cgi?id=1426831
    
        function wrapDcSend(dc, pc) {
          var origDataChannelSend = dc.send;
          dc.send = function() {
            var data = arguments[0];
            var length = data.length || data.size || data.byteLength;
            if (dc.readyState === 'open' &&
                pc.sctp && length > pc.sctp.maxMessageSize) {
              throw new TypeError('Message too large (can send a maximum of ' +
                pc.sctp.maxMessageSize + ' bytes)');
            }
            return origDataChannelSend.apply(dc, arguments);
          };
        }
        var origCreateDataChannel =
          window.RTCPeerConnection.prototype.createDataChannel;
        window.RTCPeerConnection.prototype.createDataChannel = function() {
          var pc = this;
          var dataChannel = origCreateDataChannel.apply(pc, arguments);
          wrapDcSend(dataChannel, pc);
          return dataChannel;
        };
        utils.wrapPeerConnectionEvent(window, 'datachannel', function(e) {
          wrapDcSend(e.channel, e.target);
          return e;
        });
      }
    };
    
    },{"./utils":14,"sdp":2}],8:[function(require,module,exports){
    /*
     *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.
     *
     *  Use of this source code is governed by a BSD-style license
     *  that can be found in the LICENSE file in the root of the source
     *  tree.
     */
     /* eslint-env node */
    'use strict';
    
    var utils = require('../utils');
    var filterIceServers = require('./filtericeservers');
    var shimRTCPeerConnection = require('rtcpeerconnection-shim');
    
    module.exports = {
      shimGetUserMedia: require('./getusermedia'),
      shimPeerConnection: function(window) {
        var browserDetails = utils.detectBrowser(window);
    
        if (window.RTCIceGatherer) {
          if (!window.RTCIceCandidate) {
            window.RTCIceCandidate = function(args) {
              return args;
            };
          }
          if (!window.RTCSessionDescription) {
            window.RTCSessionDescription = function(args) {
              return args;
            };
          }
          // this adds an additional event listener to MediaStrackTrack that signals
          // when a tracks enabled property was changed. Workaround for a bug in
          // addStream, see below. No longer required in 15025+
          if (browserDetails.version < 15025) {
            var origMSTEnabled = Object.getOwnPropertyDescriptor(
                window.MediaStreamTrack.prototype, 'enabled');
            Object.defineProperty(window.MediaStreamTrack.prototype, 'enabled', {
              set: function(value) {
                origMSTEnabled.set.call(this, value);
                var ev = new Event('enabled');
                ev.enabled = value;
                this.dispatchEvent(ev);
              }
            });
          }
        }
    
        // ORTC defines the DTMF sender a bit different.
        // https://github.com/w3c/ortc/issues/714
        if (window.RTCRtpSender && !('dtmf' in window.RTCRtpSender.prototype)) {
          Object.defineProperty(window.RTCRtpSender.prototype, 'dtmf', {
            get: function() {
              if (this._dtmf === undefined) {
                if (this.track.kind === 'audio') {
                  this._dtmf = new window.RTCDtmfSender(this);
                } else if (this.track.kind === 'video') {
                  this._dtmf = null;
                }
              }
              return this._dtmf;
            }
          });
        }
        // Edge currently only implements the RTCDtmfSender, not the
        // RTCDTMFSender alias. See http://draft.ortc.org/#rtcdtmfsender2*
        if (window.RTCDtmfSender && !window.RTCDTMFSender) {
          window.RTCDTMFSender = window.RTCDtmfSender;
        }
    
        var RTCPeerConnectionShim = shimRTCPeerConnection(window,
            browserDetails.version);
        window.RTCPeerConnection = function(config) {
          if (config && config.iceServers) {
            config.iceServers = filterIceServers(config.iceServers);
          }
          return new RTCPeerConnectionShim(config);
        };
        window.RTCPeerConnection.prototype = RTCPeerConnectionShim.prototype;
      },
      shimReplaceTrack: function(window) {
        // ORTC has replaceTrack -- https://github.com/w3c/ortc/issues/614
        if (window.RTCRtpSender &&
            !('replaceTrack' in window.RTCRtpSender.prototype)) {
          window.RTCRtpSender.prototype.replaceTrack =
              window.RTCRtpSender.prototype.setTrack;
        }
      }
    };
    
    },{"../utils":14,"./filtericeservers":9,"./getusermedia":10,"rtcpeerconnection-shim":1}],9:[function(require,module,exports){
    /*
     *  Copyright (c) 2018 The WebRTC project authors. All Rights Reserved.
     *
     *  Use of this source code is governed by a BSD-style license
     *  that can be found in the LICENSE file in the root of the source
     *  tree.
     */
     /* eslint-env node */
    'use strict';
    
    var utils = require('../utils');
    // Edge does not like
    // 1) stun: filtered after 14393 unless ?transport=udp is present
    // 2) turn: that does not have all of turn:host:port?transport=udp
    // 3) turn: with ipv6 addresses
    // 4) turn: occurring muliple times
    module.exports = function(iceServers, edgeVersion) {
      var hasTurn = false;
      iceServers = JSON.parse(JSON.stringify(iceServers));
      return iceServers.filter(function(server) {
        if (server && (server.urls || server.url)) {
          var urls = server.urls || server.url;
          if (server.url && !server.urls) {
            utils.deprecated('RTCIceServer.url', 'RTCIceServer.urls');
          }
          var isString = typeof urls === 'string';
          if (isString) {
            urls = [urls];
          }
          urls = urls.filter(function(url) {
            var validTurn = url.indexOf('turn:') === 0 &&
                url.indexOf('transport=udp') !== -1 &&
                url.indexOf('turn:[') === -1 &&
                !hasTurn;
    
            if (validTurn) {
              hasTurn = true;
              return true;
            }
            return url.indexOf('stun:') === 0 && edgeVersion >= 14393 &&
                url.indexOf('?transport=udp') === -1;
          });
    
          delete server.url;
          server.urls = isString ? urls[0] : urls;
          return !!urls.length;
        }
      });
    };
    
    },{"../utils":14}],10:[function(require,module,exports){
    /*
     *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.
     *
     *  Use of this source code is governed by a BSD-style license
     *  that can be found in the LICENSE file in the root of the source
     *  tree.
     */
     /* eslint-env node */
    'use strict';
    
    // Expose public methods.
    module.exports = function(window) {
      var navigator = window && window.navigator;
    
      var shimError_ = function(e) {
        return {
          name: {PermissionDeniedError: 'NotAllowedError'}[e.name] || e.name,
          message: e.message,
          constraint: e.constraint,
          toString: function() {
            return this.name;
          }
        };
      };
    
      // getUserMedia error shim.
      var origGetUserMedia = navigator.mediaDevices.getUserMedia.
          bind(navigator.mediaDevices);
      navigator.mediaDevices.getUserMedia = function(c) {
        return origGetUserMedia(c).catch(function(e) {
          return Promise.reject(shimError_(e));
        });
      };
    };
    
    },{}],11:[function(require,module,exports){
    /*
     *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.
     *
     *  Use of this source code is governed by a BSD-style license
     *  that can be found in the LICENSE file in the root of the source
     *  tree.
     */
     /* eslint-env node */
    'use strict';
    
    var utils = require('../utils');
    
    module.exports = {
      shimGetUserMedia: require('./getusermedia'),
      shimOnTrack: function(window) {
        if (typeof window === 'object' && window.RTCPeerConnection && !('ontrack' in
            window.RTCPeerConnection.prototype)) {
          Object.defineProperty(window.RTCPeerConnection.prototype, 'ontrack', {
            get: function() {
              return this._ontrack;
            },
            set: function(f) {
              if (this._ontrack) {
                this.removeEventListener('track', this._ontrack);
                this.removeEventListener('addstream', this._ontrackpoly);
              }
              this.addEventListener('track', this._ontrack = f);
              this.addEventListener('addstream', this._ontrackpoly = function(e) {
                e.stream.getTracks().forEach(function(track) {
                  var event = new Event('track');
                  event.track = track;
                  event.receiver = {track: track};
                  event.transceiver = {receiver: event.receiver};
                  event.streams = [e.stream];
                  this.dispatchEvent(event);
                }.bind(this));
              }.bind(this));
            },
            enumerable: true,
            configurable: true
          });
        }
        if (typeof window === 'object' && window.RTCTrackEvent &&
            ('receiver' in window.RTCTrackEvent.prototype) &&
            !('transceiver' in window.RTCTrackEvent.prototype)) {
          Object.defineProperty(window.RTCTrackEvent.prototype, 'transceiver', {
            get: function() {
              return {receiver: this.receiver};
            }
          });
        }
      },
    
      shimSourceObject: function(window) {
        // Firefox has supported mozSrcObject since FF22, unprefixed in 42.
        if (typeof window === 'object') {
          if (window.HTMLMediaElement &&
            !('srcObject' in window.HTMLMediaElement.prototype)) {
            // Shim the srcObject property, once, when HTMLMediaElement is found.
            Object.defineProperty(window.HTMLMediaElement.prototype, 'srcObject', {
              get: function() {
                return this.mozSrcObject;
              },
              set: function(stream) {
                this.mozSrcObject = stream;
              }
            });
          }
        }
      },
    
      shimPeerConnection: function(window) {
        var browserDetails = utils.detectBrowser(window);
    
        if (typeof window !== 'object' || !(window.RTCPeerConnection ||
            window.mozRTCPeerConnection)) {
          return; // probably media.peerconnection.enabled=false in about:config
        }
        // The RTCPeerConnection object.
        if (!window.RTCPeerConnection) {
          window.RTCPeerConnection = function(pcConfig, pcConstraints) {
            if (browserDetails.version < 38) {
              // .urls is not supported in FF < 38.
              // create RTCIceServers with a single url.
              if (pcConfig && pcConfig.iceServers) {
                var newIceServers = [];
                for (var i = 0; i < pcConfig.iceServers.length; i++) {
                  var server = pcConfig.iceServers[i];
                  if (server.hasOwnProperty('urls')) {
                    for (var j = 0; j < server.urls.length; j++) {
                      var newServer = {
                        url: server.urls[j]
                      };
                      if (server.urls[j].indexOf('turn') === 0) {
                        newServer.username = server.username;
                        newServer.credential = server.credential;
                      }
                      newIceServers.push(newServer);
                    }
                  } else {
                    newIceServers.push(pcConfig.iceServers[i]);
                  }
                }
                pcConfig.iceServers = newIceServers;
              }
            }
            return new window.mozRTCPeerConnection(pcConfig, pcConstraints);
          };
          window.RTCPeerConnection.prototype =
              window.mozRTCPeerConnection.prototype;
    
          // wrap static methods. Currently just generateCertificate.
          if (window.mozRTCPeerConnection.generateCertificate) {
            Object.defineProperty(window.RTCPeerConnection, 'generateCertificate', {
              get: function() {
                return window.mozRTCPeerConnection.generateCertificate;
              }
            });
          }
    
          window.RTCSessionDescription = window.mozRTCSessionDescription;
          window.RTCIceCandidate = window.mozRTCIceCandidate;
        }
    
        // shim away need for obsolete RTCIceCandidate/RTCSessionDescription.
        ['setLocalDescription', 'setRemoteDescription', 'addIceCandidate']
            .forEach(function(method) {
              var nativeMethod = window.RTCPeerConnection.prototype[method];
              window.RTCPeerConnection.prototype[method] = function() {
                arguments[0] = new ((method === 'addIceCandidate') ?
                    window.RTCIceCandidate :
                    window.RTCSessionDescription)(arguments[0]);
                return nativeMethod.apply(this, arguments);
              };
            });
    
        // support for addIceCandidate(null or undefined)
        var nativeAddIceCandidate =
            window.RTCPeerConnection.prototype.addIceCandidate;
        window.RTCPeerConnection.prototype.addIceCandidate = function() {
          if (!arguments[0]) {
            if (arguments[1]) {
              arguments[1].apply(null);
            }
            return Promise.resolve();
          }
          return nativeAddIceCandidate.apply(this, arguments);
        };
    
        // shim getStats with maplike support
        var makeMapStats = function(stats) {
          var map = new Map();
          Object.keys(stats).forEach(function(key) {
            map.set(key, stats[key]);
            map[key] = stats[key];
          });
          return map;
        };
    
        var modernStatsTypes = {
          inboundrtp: 'inbound-rtp',
          outboundrtp: 'outbound-rtp',
          candidatepair: 'candidate-pair',
          localcandidate: 'local-candidate',
          remotecandidate: 'remote-candidate'
        };
    
        var nativeGetStats = window.RTCPeerConnection.prototype.getStats;
        window.RTCPeerConnection.prototype.getStats = function(
          selector,
          onSucc,
          onErr
        ) {
          return nativeGetStats.apply(this, [selector || null])
            .then(function(stats) {
              if (browserDetails.version < 48) {
                stats = makeMapStats(stats);
              }
              if (browserDetails.version < 53 && !onSucc) {
                // Shim only promise getStats with spec-hyphens in type names
                // Leave callback version alone; misc old uses of forEach before Map
                try {
                  stats.forEach(function(stat) {
                    stat.type = modernStatsTypes[stat.type] || stat.type;
                  });
                } catch (e) {
                  if (e.name !== 'TypeError') {
                    throw e;
                  }
                  // Avoid TypeError: "type" is read-only, in old versions. 34-43ish
                  stats.forEach(function(stat, i) {
                    stats.set(i, Object.assign({}, stat, {
                      type: modernStatsTypes[stat.type] || stat.type
                    }));
                  });
                }
              }
              return stats;
            })
            .then(onSucc, onErr);
        };
      },
    
      shimSenderGetStats: function(window) {
        if (!(typeof window === 'object' && window.RTCPeerConnection &&
            window.RTCRtpSender)) {
          return;
        }
        if (window.RTCRtpSender && 'getStats' in window.RTCRtpSender.prototype) {
          return;
        }
        var origGetSenders = window.RTCPeerConnection.prototype.getSenders;
        if (origGetSenders) {
          window.RTCPeerConnection.prototype.getSenders = function() {
            var pc = this;
            var senders = origGetSenders.apply(pc, []);
            senders.forEach(function(sender) {
              sender._pc = pc;
            });
            return senders;
          };
        }
    
        var origAddTrack = window.RTCPeerConnection.prototype.addTrack;
        if (origAddTrack) {
          window.RTCPeerConnection.prototype.addTrack = function() {
            var sender = origAddTrack.apply(this, arguments);
            sender._pc = this;
            return sender;
          };
        }
        window.RTCRtpSender.prototype.getStats = function() {
          return this.track ? this._pc.getStats(this.track) :
              Promise.resolve(new Map());
        };
      },
    
      shimReceiverGetStats: function(window) {
        if (!(typeof window === 'object' && window.RTCPeerConnection &&
            window.RTCRtpSender)) {
          return;
        }
        if (window.RTCRtpSender && 'getStats' in window.RTCRtpReceiver.prototype) {
          return;
        }
        var origGetReceivers = window.RTCPeerConnection.prototype.getReceivers;
        if (origGetReceivers) {
          window.RTCPeerConnection.prototype.getReceivers = function() {
            var pc = this;
            var receivers = origGetReceivers.apply(pc, []);
            receivers.forEach(function(receiver) {
              receiver._pc = pc;
            });
            return receivers;
          };
        }
        utils.wrapPeerConnectionEvent(window, 'track', function(e) {
          e.receiver._pc = e.srcElement;
          return e;
        });
        window.RTCRtpReceiver.prototype.getStats = function() {
          return this._pc.getStats(this.track);
        };
      },
    
      shimRemoveStream: function(window) {
        if (!window.RTCPeerConnection ||
            'removeStream' in window.RTCPeerConnection.prototype) {
          return;
        }
        window.RTCPeerConnection.prototype.removeStream = function(stream) {
          var pc = this;
          utils.deprecated('removeStream', 'removeTrack');
          this.getSenders().forEach(function(sender) {
            if (sender.track && stream.getTracks().indexOf(sender.track) !== -1) {
              pc.removeTrack(sender);
            }
          });
        };
      },
    
      shimRTCDataChannel: function(window) {
        // rename DataChannel to RTCDataChannel (native fix in FF60):
        // https://bugzilla.mozilla.org/show_bug.cgi?id=1173851
        if (window.DataChannel && !window.RTCDataChannel) {
          window.RTCDataChannel = window.DataChannel;
        }
      },
    
      shimGetDisplayMedia: function(window, preferredMediaSource) {
        if ('getDisplayMedia' in window.navigator) {
          return;
        }
        navigator.getDisplayMedia = function(constraints) {
          if (!(constraints && constraints.video)) {
            var err = new DOMException('getDisplayMedia without video ' +
                'constraints is undefined');
            err.name = 'NotFoundError';
            // from https://heycam.github.io/webidl/#idl-DOMException-error-names
            err.code = 8;
            return Promise.reject(err);
          }
          if (constraints.video === true) {
            constraints.video = {mediaSource: preferredMediaSource};
          } else {
            constraints.video.mediaSource = preferredMediaSource;
          }
          return navigator.mediaDevices.getUserMedia(constraints);
        };
      }
    };
    
    },{"../utils":14,"./getusermedia":12}],12:[function(require,module,exports){
    /*
     *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.
     *
     *  Use of this source code is governed by a BSD-style license
     *  that can be found in the LICENSE file in the root of the source
     *  tree.
     */
     /* eslint-env node */
    'use strict';
    
    var utils = require('../utils');
    var logging = utils.log;
    
    // Expose public methods.
    module.exports = function(window) {
      var browserDetails = utils.detectBrowser(window);
      var navigator = window && window.navigator;
      var MediaStreamTrack = window && window.MediaStreamTrack;
    
      var shimError_ = function(e) {
        return {
          name: {
            InternalError: 'NotReadableError',
            NotSupportedError: 'TypeError',
            PermissionDeniedError: 'NotAllowedError',
            SecurityError: 'NotAllowedError'
          }[e.name] || e.name,
          message: {
            'The operation is insecure.': 'The request is not allowed by the ' +
            'user agent or the platform in the current context.'
          }[e.message] || e.message,
          constraint: e.constraint,
          toString: function() {
            return this.name + (this.message && ': ') + this.message;
          }
        };
      };
    
      // getUserMedia constraints shim.
      var getUserMedia_ = function(constraints, onSuccess, onError) {
        var constraintsToFF37_ = function(c) {
          if (typeof c !== 'object' || c.require) {
            return c;
          }
          var require = [];
          Object.keys(c).forEach(function(key) {
            if (key === 'require' || key === 'advanced' || key === 'mediaSource') {
              return;
            }
            var r = c[key] = (typeof c[key] === 'object') ?
                c[key] : {ideal: c[key]};
            if (r.min !== undefined ||
                r.max !== undefined || r.exact !== undefined) {
              require.push(key);
            }
            if (r.exact !== undefined) {
              if (typeof r.exact === 'number') {
                r. min = r.max = r.exact;
              } else {
                c[key] = r.exact;
              }
              delete r.exact;
            }
            if (r.ideal !== undefined) {
              c.advanced = c.advanced || [];
              var oc = {};
              if (typeof r.ideal === 'number') {
                oc[key] = {min: r.ideal, max: r.ideal};
              } else {
                oc[key] = r.ideal;
              }
              c.advanced.push(oc);
              delete r.ideal;
              if (!Object.keys(r).length) {
                delete c[key];
              }
            }
          });
          if (require.length) {
            c.require = require;
          }
          return c;
        };
        constraints = JSON.parse(JSON.stringify(constraints));
        if (browserDetails.version < 38) {
          logging('spec: ' + JSON.stringify(constraints));
          if (constraints.audio) {
            constraints.audio = constraintsToFF37_(constraints.audio);
          }
          if (constraints.video) {
            constraints.video = constraintsToFF37_(constraints.video);
          }
          logging('ff37: ' + JSON.stringify(constraints));
        }
        return navigator.mozGetUserMedia(constraints, onSuccess, function(e) {
          onError(shimError_(e));
        });
      };
    
      // Returns the result of getUserMedia as a Promise.
      var getUserMediaPromise_ = function(constraints) {
        return new Promise(function(resolve, reject) {
          getUserMedia_(constraints, resolve, reject);
        });
      };
    
      // Shim for mediaDevices on older versions.
      if (!navigator.mediaDevices) {
        navigator.mediaDevices = {getUserMedia: getUserMediaPromise_,
          addEventListener: function() { },
          removeEventListener: function() { }
        };
      }
      navigator.mediaDevices.enumerateDevices =
          navigator.mediaDevices.enumerateDevices || function() {
            return new Promise(function(resolve) {
              var infos = [
                {kind: 'audioinput', deviceId: 'default', label: '', groupId: ''},
                {kind: 'videoinput', deviceId: 'default', label: '', groupId: ''}
              ];
              resolve(infos);
            });
          };
    
      if (browserDetails.version < 41) {
        // Work around http://bugzil.la/1169665
        var orgEnumerateDevices =
            navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);
        navigator.mediaDevices.enumerateDevices = function() {
          return orgEnumerateDevices().then(undefined, function(e) {
            if (e.name === 'NotFoundError') {
              return [];
            }
            throw e;
          });
        };
      }
      if (browserDetails.version < 49) {
        var origGetUserMedia = navigator.mediaDevices.getUserMedia.
            bind(navigator.mediaDevices);
        navigator.mediaDevices.getUserMedia = function(c) {
          return origGetUserMedia(c).then(function(stream) {
            // Work around https://bugzil.la/802326
            if (c.audio && !stream.getAudioTracks().length ||
                c.video && !stream.getVideoTracks().length) {
              stream.getTracks().forEach(function(track) {
                track.stop();
              });
              throw new DOMException('The object can not be found here.',
                                     'NotFoundError');
            }
            return stream;
          }, function(e) {
            return Promise.reject(shimError_(e));
          });
        };
      }
      if (!(browserDetails.version > 55 &&
          'autoGainControl' in navigator.mediaDevices.getSupportedConstraints())) {
        var remap = function(obj, a, b) {
          if (a in obj && !(b in obj)) {
            obj[b] = obj[a];
            delete obj[a];
          }
        };
    
        var nativeGetUserMedia = navigator.mediaDevices.getUserMedia.
            bind(navigator.mediaDevices);
        navigator.mediaDevices.getUserMedia = function(c) {
          if (typeof c === 'object' && typeof c.audio === 'object') {
            c = JSON.parse(JSON.stringify(c));
            remap(c.audio, 'autoGainControl', 'mozAutoGainControl');
            remap(c.audio, 'noiseSuppression', 'mozNoiseSuppression');
          }
          return nativeGetUserMedia(c);
        };
    
        if (MediaStreamTrack && MediaStreamTrack.prototype.getSettings) {
          var nativeGetSettings = MediaStreamTrack.prototype.getSettings;
          MediaStreamTrack.prototype.getSettings = function() {
            var obj = nativeGetSettings.apply(this, arguments);
            remap(obj, 'mozAutoGainControl', 'autoGainControl');
            remap(obj, 'mozNoiseSuppression', 'noiseSuppression');
            return obj;
          };
        }
    
        if (MediaStreamTrack && MediaStreamTrack.prototype.applyConstraints) {
          var nativeApplyConstraints = MediaStreamTrack.prototype.applyConstraints;
          MediaStreamTrack.prototype.applyConstraints = function(c) {
            if (this.kind === 'audio' && typeof c === 'object') {
              c = JSON.parse(JSON.stringify(c));
              remap(c, 'autoGainControl', 'mozAutoGainControl');
              remap(c, 'noiseSuppression', 'mozNoiseSuppression');
            }
            return nativeApplyConstraints.apply(this, [c]);
          };
        }
      }
      navigator.getUserMedia = function(constraints, onSuccess, onError) {
        if (browserDetails.version < 44) {
          return getUserMedia_(constraints, onSuccess, onError);
        }
        // Replace Firefox 44+'s deprecation warning with unprefixed version.
        utils.deprecated('navigator.getUserMedia',
            'navigator.mediaDevices.getUserMedia');
        navigator.mediaDevices.getUserMedia(constraints).then(onSuccess, onError);
      };
    };
    
    },{"../utils":14}],13:[function(require,module,exports){
    /*
     *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.
     *
     *  Use of this source code is governed by a BSD-style license
     *  that can be found in the LICENSE file in the root of the source
     *  tree.
     */
    'use strict';
    var utils = require('../utils');
    
    module.exports = {
      shimLocalStreamsAPI: function(window) {
        if (typeof window !== 'object' || !window.RTCPeerConnection) {
          return;
        }
        if (!('getLocalStreams' in window.RTCPeerConnection.prototype)) {
          window.RTCPeerConnection.prototype.getLocalStreams = function() {
            if (!this._localStreams) {
              this._localStreams = [];
            }
            return this._localStreams;
          };
        }
        if (!('getStreamById' in window.RTCPeerConnection.prototype)) {
          window.RTCPeerConnection.prototype.getStreamById = function(id) {
            var result = null;
            if (this._localStreams) {
              this._localStreams.forEach(function(stream) {
                if (stream.id === id) {
                  result = stream;
                }
              });
            }
            if (this._remoteStreams) {
              this._remoteStreams.forEach(function(stream) {
                if (stream.id === id) {
                  result = stream;
                }
              });
            }
            return result;
          };
        }
        if (!('addStream' in window.RTCPeerConnection.prototype)) {
          var _addTrack = window.RTCPeerConnection.prototype.addTrack;
          window.RTCPeerConnection.prototype.addStream = function(stream) {
            if (!this._localStreams) {
              this._localStreams = [];
            }
            if (this._localStreams.indexOf(stream) === -1) {
              this._localStreams.push(stream);
            }
            var pc = this;
            stream.getTracks().forEach(function(track) {
              _addTrack.call(pc, track, stream);
            });
          };
    
          window.RTCPeerConnection.prototype.addTrack = function(track, stream) {
            if (stream) {
              if (!this._localStreams) {
                this._localStreams = [stream];
              } else if (this._localStreams.indexOf(stream) === -1) {
                this._localStreams.push(stream);
              }
            }
            return _addTrack.call(this, track, stream);
          };
        }
        if (!('removeStream' in window.RTCPeerConnection.prototype)) {
          window.RTCPeerConnection.prototype.removeStream = function(stream) {
            if (!this._localStreams) {
              this._localStreams = [];
            }
            var index = this._localStreams.indexOf(stream);
            if (index === -1) {
              return;
            }
            this._localStreams.splice(index, 1);
            var pc = this;
            var tracks = stream.getTracks();
            this.getSenders().forEach(function(sender) {
              if (tracks.indexOf(sender.track) !== -1) {
                pc.removeTrack(sender);
              }
            });
          };
        }
      },
      shimRemoteStreamsAPI: function(window) {
        if (typeof window !== 'object' || !window.RTCPeerConnection) {
          return;
        }
        if (!('getRemoteStreams' in window.RTCPeerConnection.prototype)) {
          window.RTCPeerConnection.prototype.getRemoteStreams = function() {
            return this._remoteStreams ? this._remoteStreams : [];
          };
        }
        if (!('onaddstream' in window.RTCPeerConnection.prototype)) {
          Object.defineProperty(window.RTCPeerConnection.prototype, 'onaddstream', {
            get: function() {
              return this._onaddstream;
            },
            set: function(f) {
              if (this._onaddstream) {
                this.removeEventListener('addstream', this._onaddstream);
              }
              this.addEventListener('addstream', this._onaddstream = f);
            }
          });
          var origSetRemoteDescription =
              window.RTCPeerConnection.prototype.setRemoteDescription;
          window.RTCPeerConnection.prototype.setRemoteDescription = function() {
            var pc = this;
            if (!this._onaddstreampoly) {
              this.addEventListener('track', this._onaddstreampoly = function(e) {
                e.streams.forEach(function(stream) {
                  if (!pc._remoteStreams) {
                    pc._remoteStreams = [];
                  }
                  if (pc._remoteStreams.indexOf(stream) >= 0) {
                    return;
                  }
                  pc._remoteStreams.push(stream);
                  var event = new Event('addstream');
                  event.stream = stream;
                  pc.dispatchEvent(event);
                });
              });
            }
            return origSetRemoteDescription.apply(pc, arguments);
          };
        }
      },
      shimCallbacksAPI: function(window) {
        if (typeof window !== 'object' || !window.RTCPeerConnection) {
          return;
        }
        var prototype = window.RTCPeerConnection.prototype;
        var createOffer = prototype.createOffer;
        var createAnswer = prototype.createAnswer;
        var setLocalDescription = prototype.setLocalDescription;
        var setRemoteDescription = prototype.setRemoteDescription;
        var addIceCandidate = prototype.addIceCandidate;
    
        prototype.createOffer = function(successCallback, failureCallback) {
          var options = (arguments.length >= 2) ? arguments[2] : arguments[0];
          var promise = createOffer.apply(this, [options]);
          if (!failureCallback) {
            return promise;
          }
          promise.then(successCallback, failureCallback);
          return Promise.resolve();
        };
    
        prototype.createAnswer = function(successCallback, failureCallback) {
          var options = (arguments.length >= 2) ? arguments[2] : arguments[0];
          var promise = createAnswer.apply(this, [options]);
          if (!failureCallback) {
            return promise;
          }
          promise.then(successCallback, failureCallback);
          return Promise.resolve();
        };
    
        var withCallback = function(description, successCallback, failureCallback) {
          var promise = setLocalDescription.apply(this, [description]);
          if (!failureCallback) {
            return promise;
          }
          promise.then(successCallback, failureCallback);
          return Promise.resolve();
        };
        prototype.setLocalDescription = withCallback;
    
        withCallback = function(description, successCallback, failureCallback) {
          var promise = setRemoteDescription.apply(this, [description]);
          if (!failureCallback) {
            return promise;
          }
          promise.then(successCallback, failureCallback);
          return Promise.resolve();
        };
        prototype.setRemoteDescription = withCallback;
    
        withCallback = function(candidate, successCallback, failureCallback) {
          var promise = addIceCandidate.apply(this, [candidate]);
          if (!failureCallback) {
            return promise;
          }
          promise.then(successCallback, failureCallback);
          return Promise.resolve();
        };
        prototype.addIceCandidate = withCallback;
      },
      shimGetUserMedia: function(window) {
        var navigator = window && window.navigator;
    
        if (!navigator.getUserMedia) {
          if (navigator.webkitGetUserMedia) {
            navigator.getUserMedia = navigator.webkitGetUserMedia.bind(navigator);
          } else if (navigator.mediaDevices &&
              navigator.mediaDevices.getUserMedia) {
            navigator.getUserMedia = function(constraints, cb, errcb) {
              navigator.mediaDevices.getUserMedia(constraints)
              .then(cb, errcb);
            }.bind(navigator);
          }
        }
      },
      shimRTCIceServerUrls: function(window) {
        // migrate from non-spec RTCIceServer.url to RTCIceServer.urls
        var OrigPeerConnection = window.RTCPeerConnection;
        window.RTCPeerConnection = function(pcConfig, pcConstraints) {
          if (pcConfig && pcConfig.iceServers) {
            var newIceServers = [];
            for (var i = 0; i < pcConfig.iceServers.length; i++) {
              var server = pcConfig.iceServers[i];
              if (!server.hasOwnProperty('urls') &&
                  server.hasOwnProperty('url')) {
                utils.deprecated('RTCIceServer.url', 'RTCIceServer.urls');
                server = JSON.parse(JSON.stringify(server));
                server.urls = server.url;
                delete server.url;
                newIceServers.push(server);
              } else {
                newIceServers.push(pcConfig.iceServers[i]);
              }
            }
            pcConfig.iceServers = newIceServers;
          }
          return new OrigPeerConnection(pcConfig, pcConstraints);
        };
        window.RTCPeerConnection.prototype = OrigPeerConnection.prototype;
        // wrap static methods. Currently just generateCertificate.
        if ('generateCertificate' in window.RTCPeerConnection) {
          Object.defineProperty(window.RTCPeerConnection, 'generateCertificate', {
            get: function() {
              return OrigPeerConnection.generateCertificate;
            }
          });
        }
      },
      shimTrackEventTransceiver: function(window) {
        // Add event.transceiver member over deprecated event.receiver
        if (typeof window === 'object' && window.RTCPeerConnection &&
            ('receiver' in window.RTCTrackEvent.prototype) &&
            // can't check 'transceiver' in window.RTCTrackEvent.prototype, as it is
            // defined for some reason even when window.RTCTransceiver is not.
            !window.RTCTransceiver) {
          Object.defineProperty(window.RTCTrackEvent.prototype, 'transceiver', {
            get: function() {
              return {receiver: this.receiver};
            }
          });
        }
      },
    
      shimCreateOfferLegacy: function(window) {
        var origCreateOffer = window.RTCPeerConnection.prototype.createOffer;
        window.RTCPeerConnection.prototype.createOffer = function(offerOptions) {
          var pc = this;
          if (offerOptions) {
            if (typeof offerOptions.offerToReceiveAudio !== 'undefined') {
              // support bit values
              offerOptions.offerToReceiveAudio = !!offerOptions.offerToReceiveAudio;
            }
            var audioTransceiver = pc.getTransceivers().find(function(transceiver) {
              return transceiver.sender.track &&
                  transceiver.sender.track.kind === 'audio';
            });
            if (offerOptions.offerToReceiveAudio === false && audioTransceiver) {
              if (audioTransceiver.direction === 'sendrecv') {
                if (audioTransceiver.setDirection) {
                  audioTransceiver.setDirection('sendonly');
                } else {
                  audioTransceiver.direction = 'sendonly';
                }
              } else if (audioTransceiver.direction === 'recvonly') {
                if (audioTransceiver.setDirection) {
                  audioTransceiver.setDirection('inactive');
                } else {
                  audioTransceiver.direction = 'inactive';
                }
              }
            } else if (offerOptions.offerToReceiveAudio === true &&
                !audioTransceiver) {
              pc.addTransceiver('audio');
            }
    
    
            if (typeof offerOptions.offerToReceiveVideo !== 'undefined') {
              // support bit values
              offerOptions.offerToReceiveVideo = !!offerOptions.offerToReceiveVideo;
            }
            var videoTransceiver = pc.getTransceivers().find(function(transceiver) {
              return transceiver.sender.track &&
                  transceiver.sender.track.kind === 'video';
            });
            if (offerOptions.offerToReceiveVideo === false && videoTransceiver) {
              if (videoTransceiver.direction === 'sendrecv') {
                videoTransceiver.setDirection('sendonly');
              } else if (videoTransceiver.direction === 'recvonly') {
                videoTransceiver.setDirection('inactive');
              }
            } else if (offerOptions.offerToReceiveVideo === true &&
                !videoTransceiver) {
              pc.addTransceiver('video');
            }
          }
          return origCreateOffer.apply(pc, arguments);
        };
      }
    };
    
    },{"../utils":14}],14:[function(require,module,exports){
    /*
     *  Copyright (c) 2016 The WebRTC project authors. All Rights Reserved.
     *
     *  Use of this source code is governed by a BSD-style license
     *  that can be found in the LICENSE file in the root of the source
     *  tree.
     */
     /* eslint-env node */
    'use strict';
    
    var logDisabled_ = true;
    var deprecationWarnings_ = true;
    
    /**
     * Extract browser version out of the provided user agent string.
     *
     * @param {!string} uastring userAgent string.
     * @param {!string} expr Regular expression used as match criteria.
     * @param {!number} pos position in the version string to be returned.
     * @return {!number} browser version.
     */
    function extractVersion(uastring, expr, pos) {
      var match = uastring.match(expr);
      return match && match.length >= pos && parseInt(match[pos], 10);
    }
    
    // Wraps the peerconnection event eventNameToWrap in a function
    // which returns the modified event object (or false to prevent
    // the event).
    function wrapPeerConnectionEvent(window, eventNameToWrap, wrapper) {
      if (!window.RTCPeerConnection) {
        return;
      }
      var proto = window.RTCPeerConnection.prototype;
      var nativeAddEventListener = proto.addEventListener;
      proto.addEventListener = function(nativeEventName, cb) {
        if (nativeEventName !== eventNameToWrap) {
          return nativeAddEventListener.apply(this, arguments);
        }
        var wrappedCallback = function(e) {
          var modifiedEvent = wrapper(e);
          if (modifiedEvent) {
            cb(modifiedEvent);
          }
        };
        this._eventMap = this._eventMap || {};
        this._eventMap[cb] = wrappedCallback;
        return nativeAddEventListener.apply(this, [nativeEventName,
          wrappedCallback]);
      };
    
      var nativeRemoveEventListener = proto.removeEventListener;
      proto.removeEventListener = function(nativeEventName, cb) {
        if (nativeEventName !== eventNameToWrap || !this._eventMap
            || !this._eventMap[cb]) {
          return nativeRemoveEventListener.apply(this, arguments);
        }
        var unwrappedCb = this._eventMap[cb];
        delete this._eventMap[cb];
        return nativeRemoveEventListener.apply(this, [nativeEventName,
          unwrappedCb]);
      };
    
      Object.defineProperty(proto, 'on' + eventNameToWrap, {
        get: function() {
          return this['_on' + eventNameToWrap];
        },
        set: function(cb) {
          if (this['_on' + eventNameToWrap]) {
            this.removeEventListener(eventNameToWrap,
                this['_on' + eventNameToWrap]);
            delete this['_on' + eventNameToWrap];
          }
          if (cb) {
            this.addEventListener(eventNameToWrap,
                this['_on' + eventNameToWrap] = cb);
          }
        },
        enumerable: true,
        configurable: true
      });
    }
    
    // Utility methods.
    module.exports = {
      extractVersion: extractVersion,
      wrapPeerConnectionEvent: wrapPeerConnectionEvent,
      disableLog: function(bool) {
        if (typeof bool !== 'boolean') {
          return new Error('Argument type: ' + typeof bool +
              '. Please use a boolean.');
        }
        logDisabled_ = bool;
        return (bool) ? 'adapter.js logging disabled' :
            'adapter.js logging enabled';
      },
    
      /**
       * Disable or enable deprecation warnings
       * @param {!boolean} bool set to true to disable warnings.
       */
      disableWarnings: function(bool) {
        if (typeof bool !== 'boolean') {
          return new Error('Argument type: ' + typeof bool +
              '. Please use a boolean.');
        }
        deprecationWarnings_ = !bool;
        return 'adapter.js deprecation warnings ' + (bool ? 'disabled' : 'enabled');
      },
    
      log: function() {
        if (typeof window === 'object') {
          if (logDisabled_) {
            return;
          }
          if (typeof console !== 'undefined' && typeof console.log === 'function') {
            console.log.apply(console, arguments);
          }
        }
      },
    
      /**
       * Shows a deprecation warning suggesting the modern and spec-compatible API.
       */
      deprecated: function(oldMethod, newMethod) {
        if (!deprecationWarnings_) {
          return;
        }
        console.warn(oldMethod + ' is deprecated, please use ' + newMethod +
            ' instead.');
      },
    
      /**
       * Browser detector.
       *
       * @return {object} result containing browser and version
       *     properties.
       */
      detectBrowser: function(window) {
        var navigator = window && window.navigator;
    
        // Returned result object.
        var result = {};
        result.browser = null;
        result.version = null;
    
        // Fail early if it's not a browser
        if (typeof window === 'undefined' || !window.navigator) {
          result.browser = 'Not a browser.';
          return result;
        }
    
        if (navigator.mozGetUserMedia) { // Firefox.
          result.browser = 'firefox';
          result.version = extractVersion(navigator.userAgent,
              /Firefox\/(\d+)\./, 1);
        } else if (navigator.webkitGetUserMedia) {
          // Chrome, Chromium, Webview, Opera.
          // Version matches Chrome/WebRTC version.
          result.browser = 'chrome';
          result.version = extractVersion(navigator.userAgent,
              /Chrom(e|ium)\/(\d+)\./, 2);
        } else if (navigator.mediaDevices &&
            navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)) { // Edge.
          result.browser = 'edge';
          result.version = extractVersion(navigator.userAgent,
              /Edge\/(\d+).(\d+)$/, 2);
        } else if (window.RTCPeerConnection &&
            navigator.userAgent.match(/AppleWebKit\/(\d+)\./)) { // Safari.
          result.browser = 'safari';
          result.version = extractVersion(navigator.userAgent,
              /AppleWebKit\/(\d+)\./, 1);
        } else { // Default fallthrough: not supported.
          result.browser = 'Not a supported browser.';
          return result;
        }
    
        return result;
      }
    };
    
    },{}]},{},[3])(3)
    });
    
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.flvjs=e()}}(function(){var e;return function e(t,n,r){function i(a,s){if(!n[a]){if(!t[a]){var u="function"==typeof require&&require;if(!s&&u)return u(a,!0);if(o)return o(a,!0);var l=new Error("Cannot find module '"+a+"'");throw l.code="MODULE_NOT_FOUND",l}var d=n[a]={exports:{}};t[a][0].call(d.exports,function(e){var n=t[a][1][e];return i(n||e)},d,d.exports,e,t,n,r)}return n[a].exports}for(var o="function"==typeof require&&require,a=0;a<r.length;a++)i(r[a]);return i}({1:[function(t,n,r){(function(i,o){!function(t,i){"object"==typeof r&&void 0!==n?n.exports=i():"function"==typeof e&&e.amd?e(i):t.ES6Promise=i()}(this,function(){"use strict";function e(e){var t=typeof e;return null!==e&&("object"===t||"function"===t)}function n(e){return"function"==typeof e}function r(e){G=e}function a(e){H=e}function s(){return void 0!==z?function(){z(l)}:u()}function u(){var e=setTimeout;return function(){return e(l,1)}}function l(){for(var e=0;e<V;e+=2){(0,Y[e])(Y[e+1]),Y[e]=void 0,Y[e+1]=void 0}V=0}function d(e,t){var n=this,r=new this.constructor(f);void 0===r[Q]&&x(r);var i=n._state;if(i){var o=arguments[i-1];H(function(){return T(i,r,o,n._result)})}else E(n,r,e,t);return r}function c(e){var t=this;if(e&&"object"==typeof e&&e.constructor===t)return e;var n=new t(f);return b(n,e),n}function f(){}function h(){return new TypeError("You cannot resolve a promise with itself")}function _(){return new TypeError("A promises callback cannot return that same promise.")}function p(e){try{return e.then}catch(e){return ne.error=e,ne}}function m(e,t,n,r){try{e.call(t,n,r)}catch(e){return e}}function v(e,t,n){H(function(e){var r=!1,i=m(n,t,function(n){r||(r=!0,t!==n?b(e,n):k(e,n))},function(t){r||(r=!0,w(e,t))},"Settle: "+(e._label||" unknown promise"));!r&&i&&(r=!0,w(e,i))},e)}function g(e,t){t._state===ee?k(e,t._result):t._state===te?w(e,t._result):E(t,void 0,function(t){return b(e,t)},function(t){return w(e,t)})}function y(e,t,r){t.constructor===e.constructor&&r===d&&t.constructor.resolve===c?g(e,t):r===ne?(w(e,ne.error),ne.error=null):void 0===r?k(e,t):n(r)?v(e,t,r):k(e,t)}function b(t,n){t===n?w(t,h()):e(n)?y(t,n,p(n)):k(t,n)}function S(e){e._onerror&&e._onerror(e._result),R(e)}function k(e,t){e._state===$&&(e._result=t,e._state=ee,0!==e._subscribers.length&&H(R,e))}function w(e,t){e._state===$&&(e._state=te,e._result=t,H(S,e))}function E(e,t,n,r){var i=e._subscribers,o=i.length;e._onerror=null,i[o]=t,i[o+ee]=n,i[o+te]=r,0===o&&e._state&&H(R,e)}function R(e){var t=e._subscribers,n=e._state;if(0!==t.length){for(var r=void 0,i=void 0,o=e._result,a=0;a<t.length;a+=3)r=t[a],i=t[a+n],r?T(n,r,i,o):i(o);e._subscribers.length=0}}function A(){this.error=null}function L(e,t){try{return e(t)}catch(e){return re.error=e,re}}function T(e,t,r,i){var o=n(r),a=void 0,s=void 0,u=void 0,l=void 0;if(o){if(a=L(r,i),a===re?(l=!0,s=a.error,a.error=null):u=!0,t===a)return void w(t,_())}else a=i,u=!0;t._state!==$||(o&&u?b(t,a):l?w(t,s):e===ee?k(t,a):e===te&&w(t,a))}function C(e,t){try{t(function(t){b(e,t)},function(t){w(e,t)})}catch(t){w(e,t)}}function O(){return ie++}function x(e){e[Q]=ie++,e._state=void 0,e._result=void 0,e._subscribers=[]}function D(){return new Error("Array Methods must be provided an Array")}function D(){return new Error("Array Methods must be provided an Array")}function I(e){return new oe(this,e).promise}function M(e){var t=this;return new t(F(e)?function(n,r){for(var i=e.length,o=0;o<i;o++)t.resolve(e[o]).then(n,r)}:function(e,t){return t(new TypeError("You must pass an array to race."))})}function B(e){var t=this,n=new t(f);return w(n,e),n}function j(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function P(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function U(){var e=void 0;if(void 0!==o)e=o;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var n=null;try{n=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===n&&!t.cast)return}e.Promise=ae}var N=void 0;N=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)};var F=N,V=0,z=void 0,G=void 0,H=function(e,t){Y[V]=e,Y[V+1]=t,2===(V+=2)&&(G?G(l):Z())},q="undefined"!=typeof window?window:void 0,W=q||{},K=W.MutationObserver||W.WebKitMutationObserver,X="undefined"==typeof self&&void 0!==i&&"[object process]"==={}.toString.call(i),J="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,Y=new Array(1e3),Z=void 0;Z=X?function(){return function(){return i.nextTick(l)}}():K?function(){var e=0,t=new K(l),n=document.createTextNode("");return t.observe(n,{characterData:!0}),function(){n.data=e=++e%2}}():J?function(){var e=new MessageChannel;return e.port1.onmessage=l,function(){return e.port2.postMessage(0)}}():void 0===q&&"function"==typeof t?function(){try{var e=t,n=e("vertx");return z=n.runOnLoop||n.runOnContext,s()}catch(e){return u()}}():u();var Q=Math.random().toString(36).substring(16),$=void 0,ee=1,te=2,ne=new A,re=new A,ie=0,oe=function(){function e(e,t){this._instanceConstructor=e,this.promise=new e(f),this.promise[Q]||x(this.promise),F(t)?(this.length=t.length,this._remaining=t.length,this._result=new Array(this.length),0===this.length?k(this.promise,this._result):(this.length=this.length||0,this._enumerate(t),0===this._remaining&&k(this.promise,this._result))):w(this.promise,D())}return e.prototype._enumerate=function(e){for(var t=0;this._state===$&&t<e.length;t++)this._eachEntry(e[t],t)},e.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,r=n.resolve;if(r===c){var i=p(e);if(i===d&&e._state!==$)this._settledAt(e._state,t,e._result);else if("function"!=typeof i)this._remaining--,this._result[t]=e;else if(n===ae){var o=new n(f);y(o,e,i),this._willSettleAt(o,t)}else this._willSettleAt(new n(function(t){return t(e)}),t)}else this._willSettleAt(r(e),t)},e.prototype._settledAt=function(e,t,n){var r=this.promise;r._state===$&&(this._remaining--,e===te?w(r,n):this._result[t]=n),0===this._remaining&&k(r,this._result)},e.prototype._willSettleAt=function(e,t){var n=this;E(e,void 0,function(e){return n._settledAt(ee,t,e)},function(e){return n._settledAt(te,t,e)})},e}(),ae=function(){function e(t){this[Q]=O(),this._result=this._state=void 0,this._subscribers=[],f!==t&&("function"!=typeof t&&j(),this instanceof e?C(this,t):P())}return e.prototype.catch=function(e){return this.then(null,e)},e.prototype.finally=function(e){var t=this,n=t.constructor;return t.then(function(t){return n.resolve(e()).then(function(){return t})},function(t){return n.resolve(e()).then(function(){throw t})})},e}();return ae.prototype.then=d,ae.all=I,ae.race=M,ae.resolve=c,ae.reject=B,ae._setScheduler=r,ae._setAsap=a,ae._asap=H,ae.polyfill=U,ae.Promise=ae,ae})}).call(this,t("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{_process:3}],2:[function(e,t,n){function r(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function i(e){return"function"==typeof e}function o(e){return"number"==typeof e}function a(e){return"object"==typeof e&&null!==e}function s(e){return void 0===e}t.exports=r,r.EventEmitter=r,r.prototype._events=void 0,r.prototype._maxListeners=void 0,r.defaultMaxListeners=10,r.prototype.setMaxListeners=function(e){if(!o(e)||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},r.prototype.emit=function(e){var t,n,r,o,u,l;if(this._events||(this._events={}),"error"===e&&(!this._events.error||a(this._events.error)&&!this._events.error.length)){if((t=arguments[1])instanceof Error)throw t;var d=new Error('Uncaught, unspecified "error" event. ('+t+")");throw d.context=t,d}if(n=this._events[e],s(n))return!1;if(i(n))switch(arguments.length){case 1:n.call(this);break;case 2:n.call(this,arguments[1]);break;case 3:n.call(this,arguments[1],arguments[2]);break;default:o=Array.prototype.slice.call(arguments,1),n.apply(this,o)}else if(a(n))for(o=Array.prototype.slice.call(arguments,1),l=n.slice(),r=l.length,u=0;u<r;u++)l[u].apply(this,o);return!0},r.prototype.addListener=function(e,t){var n;if(!i(t))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,i(t.listener)?t.listener:t),this._events[e]?a(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,a(this._events[e])&&!this._events[e].warned&&(n=s(this._maxListeners)?r.defaultMaxListeners:this._maxListeners)&&n>0&&this._events[e].length>n&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace()),this},r.prototype.on=r.prototype.addListener,r.prototype.once=function(e,t){function n(){this.removeListener(e,n),r||(r=!0,t.apply(this,arguments))}if(!i(t))throw TypeError("listener must be a function");var r=!1;return n.listener=t,this.on(e,n),this},r.prototype.removeListener=function(e,t){var n,r,o,s;if(!i(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(n=this._events[e],o=n.length,r=-1,n===t||i(n.listener)&&n.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(a(n)){for(s=o;s-- >0;)if(n[s]===t||n[s].listener&&n[s].listener===t){r=s;break}if(r<0)return this;1===n.length?(n.length=0,delete this._events[e]):n.splice(r,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},r.prototype.removeAllListeners=function(e){var t,n;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(n=this._events[e],i(n))this.removeListener(e,n);else if(n)for(;n.length;)this.removeListener(e,n[n.length-1]);return delete this._events[e],this},r.prototype.listeners=function(e){return this._events&&this._events[e]?i(this._events[e])?[this._events[e]]:this._events[e].slice():[]},r.prototype.listenerCount=function(e){if(this._events){var t=this._events[e];if(i(t))return 1;if(t)return t.length}return 0},r.listenerCount=function(e,t){return e.listenerCount(t)}},{}],3:[function(e,t,n){function r(){throw new Error("setTimeout has not been defined")}function i(){throw new Error("clearTimeout has not been defined")}function o(e){if(c===setTimeout)return setTimeout(e,0);if((c===r||!c)&&setTimeout)return c=setTimeout,setTimeout(e,0);try{return c(e,0)}catch(t){try{return c.call(null,e,0)}catch(t){return c.call(this,e,0)}}}function a(e){if(f===clearTimeout)return clearTimeout(e);if((f===i||!f)&&clearTimeout)return f=clearTimeout,clearTimeout(e);try{return f(e)}catch(t){try{return f.call(null,e)}catch(t){return f.call(this,e)}}}function s(){m&&_&&(m=!1,_.length?p=_.concat(p):v=-1,p.length&&u())}function u(){if(!m){var e=o(s);m=!0;for(var t=p.length;t;){for(_=p,p=[];++v<t;)_&&_[v].run();v=-1,t=p.length}_=null,m=!1,a(e)}}function l(e,t){this.fun=e,this.array=t}function d(){}var c,f,h=t.exports={};!function(){try{c="function"==typeof setTimeout?setTimeout:r}catch(e){c=r}try{f="function"==typeof clearTimeout?clearTimeout:i}catch(e){f=i}}();var _,p=[],m=!1,v=-1;h.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];p.push(new l(e,t)),1!==p.length||m||o(u)},l.prototype.run=function(){this.fun.apply(null,this.array)},h.title="browser",h.browser=!0,h.env={},h.argv=[],h.version="",h.versions={},h.on=d,h.addListener=d,h.once=d,h.off=d,h.removeListener=d,h.removeAllListeners=d,h.emit=d,h.prependListener=d,h.prependOnceListener=d,h.listeners=function(e){return[]},h.binding=function(e){throw new Error("process.binding is not supported")},h.cwd=function(){return"/"},h.chdir=function(e){throw new Error("process.chdir is not supported")},h.umask=function(){return 0}},{}],4:[function(e,t,n){var r=arguments[3],i=arguments[4],o=arguments[5],a=JSON.stringify;t.exports=function(e,t){function n(e){m[e]=!0;for(var t in i[e][1]){var r=i[e][1][t];m[r]||n(r)}}for(var s,u=Object.keys(o),l=0,d=u.length;l<d;l++){var c=u[l],f=o[c].exports;if(f===e||f&&f.default===e){s=c;break}}if(!s){s=Math.floor(Math.pow(16,8)*Math.random()).toString(16);for(var h={},l=0,d=u.length;l<d;l++){var c=u[l];h[c]=c}i[s]=["function(require,module,exports){"+e+"(self); }",h]}var _=Math.floor(Math.pow(16,8)*Math.random()).toString(16),p={};p[s]=s,i[_]=["function(require,module,exports){var f = require("+a(s)+");(f.default ? f.default : f)(self);}",p];var m={};n(_);var v="("+r+")({"+Object.keys(m).map(function(e){return a(e)+":["+i[e][0]+","+a(i[e][1])+"]"}).join(",")+"},{},["+a(_)+"])",g=window.URL||window.webkitURL||window.mozURL||window.msURL,y=new Blob([v],{type:"text/javascript"});if(t&&t.bare)return y;var b=g.createObjectURL(y),S=new Worker(b);return S.objectURL=b,S}},{}],5:[function(e,t,n){"use strict";function r(){return Object.assign({},i)}Object.defineProperty(n,"__esModule",{value:!0}),n.createDefaultConfig=r;var i=n.defaultConfig={enableWorker:!1,enableStashBuffer:!0,stashInitialSize:void 0,isLive:!1,lazyLoad:!0,lazyLoadMaxDuration:3600,lazyLoadRecoverDuration:30,deferLoadAfterSourceOpen:!0,autoCleanupMaxBackwardDuration:180,autoCleanupMinBackwardDuration:120,statisticsInfoReportInterval:600,fixAudioTimestampGap:!0,accurateSeek:!1,seekType:"range",seekParamStart:"bstart",seekParamEnd:"bend",rangeLoadZeroStart:!1,customSeekHandler:void 0,reuseRedirectedURL:!1}},{}],6:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=e("../io/io-controller.js"),a=function(e){return e&&e.__esModule?e:{default:e}}(o),s=e("../config.js"),u=function(){function e(){r(this,e)}return i(e,null,[{key:"supportMSEH264Playback",value:function(){return window.MediaSource&&window.MediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"')}},{key:"supportNetworkStreamIO",value:function(){var e=new a.default({},(0,s.createDefaultConfig)()),t=e.loaderType;return e.destroy(),"fetch-stream-loader"==t||"xhr-moz-chunked-loader"==t}},{key:"getNetworkLoaderTypeName",value:function(){var e=new a.default({},(0,s.createDefaultConfig)()),t=e.loaderType;return e.destroy(),t}},{key:"supportNativeMediaPlayback",value:function(t){void 0==e.videoElement&&(e.videoElement=window.document.createElement("video"));var n=e.videoElement.canPlayType(t);return"probably"===n||"maybe"==n}},{key:"getFeatureList",value:function(){var t={mseFlvPlayback:!1,mseLiveFlvPlayback:!1,networkStreamIO:!1,networkLoaderName:"",nativeMP4H264Playback:!1,nativeWebmVP8Playback:!1,nativeWebmVP9Playback:!1};return t.mseFlvPlayback=e.supportMSEH264Playback(),t.networkStreamIO=e.supportNetworkStreamIO(),t.networkLoaderName=e.getNetworkLoaderTypeName(),t.mseLiveFlvPlayback=t.mseFlvPlayback&&t.networkStreamIO,t.nativeMP4H264Playback=e.supportNativeMediaPlayback('video/mp4; codecs="avc1.42001E, mp4a.40.2"'),t.nativeWebmVP8Playback=e.supportNativeMediaPlayback('video/webm; codecs="vp8.0, vorbis"'),t.nativeWebmVP9Playback=e.supportNativeMediaPlayback('video/webm; codecs="vp9"'),t}}]),e}();n.default=u},{"../config.js":5,"../io/io-controller.js":24}],7:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function e(){r(this,e),this.mimeType=null,this.duration=null,this.hasAudio=null,this.hasVideo=null,this.audioCodec=null,this.videoCodec=null,this.audioDataRate=null,this.videoDataRate=null,this.audioSampleRate=null,this.audioChannelCount=null,this.width=null,this.height=null,this.fps=null,this.profile=null,this.level=null,this.chromaFormat=null,this.sarNum=null,this.sarDen=null,this.metadata=null,this.segments=null,this.segmentCount=null,this.hasKeyframesIndex=null,this.keyframesIndex=null}return i(e,[{key:"isComplete",value:function(){var e=!1===this.hasAudio||!0===this.hasAudio&&null!=this.audioCodec&&null!=this.audioSampleRate&&null!=this.audioChannelCount,t=!1===this.hasVideo||!0===this.hasVideo&&null!=this.videoCodec&&null!=this.width&&null!=this.height&&null!=this.fps&&null!=this.profile&&null!=this.level&&null!=this.chromaFormat&&null!=this.sarNum&&null!=this.sarDen;return null!=this.mimeType&&null!=this.duration&&null!=this.metadata&&null!=this.hasKeyframesIndex&&e&&t}},{key:"isSeekable",value:function(){return!0===this.hasKeyframesIndex}},{key:"getNearestKeyframe",value:function(e){if(null==this.keyframesIndex)return null;var t=this.keyframesIndex,n=this._search(t.times,e);return{index:n,milliseconds:t.times[n],fileposition:t.filepositions[n]}}},{key:"_search",value:function(e,t){var n=0,r=e.length-1,i=0,o=0,a=r;for(t<e[0]&&(n=0,o=a+1);o<=a;){if((i=o+Math.floor((a-o)/2))===r||t>=e[i]&&t<e[i+1]){n=i;break}e[i]<t?o=i+1:a=i-1}return n}}]),e}();n.default=o},{}],8:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();n.SampleInfo=function e(t,n,i,o,a){r(this,e),this.dts=t,this.pts=n,this.duration=i,this.originalDts=o,this.isSyncPoint=a,this.fileposition=null},n.MediaSegmentInfo=function(){function e(){r(this,e),this.beginDts=0,this.endDts=0,this.beginPts=0,this.endPts=0,this.originalBeginDts=0,this.originalEndDts=0,this.syncPoints=[],this.firstSample=null,this.lastSample=null}return i(e,[{key:"appendSyncPoint",value:function(e){e.isSyncPoint=!0,this.syncPoints.push(e)}}]),e}(),n.IDRSampleList=function(){function e(){r(this,e),this._list=[]}return i(e,[{key:"clear",value:function(){this._list=[]}},{key:"appendArray",value:function(e){var t=this._list;0!==e.length&&(t.length>0&&e[0].originalDts<t[t.length-1].originalDts&&this.clear(),Array.prototype.push.apply(t,e))}},{key:"getLastSyncPointBeforeDts",value:function(e){if(0==this._list.length)return null;var t=this._list,n=0,r=t.length-1,i=0,o=0,a=r;for(e<t[0].dts&&(n=0,o=a+1);o<=a;){if((i=o+Math.floor((a-o)/2))===r||e>=t[i].dts&&e<t[i+1].dts){n=i;break}t[i].dts<e?o=i+1:a=i-1}return this._list[n]}}]),e}(),n.MediaSegmentInfoList=function(){function e(t){r(this,e),this._type=t,this._list=[],this._lastAppendLocation=-1}return i(e,[{key:"isEmpty",value:function(){return 0===this._list.length}},{key:"clear",value:function(){this._list=[],this._lastAppendLocation=-1}},{key:"_searchNearestSegmentBefore",value:function(e){var t=this._list;if(0===t.length)return-2;var n=t.length-1,r=0,i=0,o=n,a=0;if(e<t[0].originalBeginDts)return a=-1;for(;i<=o;){if((r=i+Math.floor((o-i)/2))===n||e>t[r].lastSample.originalDts&&e<t[r+1].originalBeginDts){a=r;break}t[r].originalBeginDts<e?i=r+1:o=r-1}return a}},{key:"_searchNearestSegmentAfter",value:function(e){return this._searchNearestSegmentBefore(e)+1}},{key:"append",value:function(e){var t=this._list,n=e,r=this._lastAppendLocation,i=0;-1!==r&&r<t.length&&n.originalBeginDts>=t[r].lastSample.originalDts&&(r===t.length-1||r<t.length-1&&n.originalBeginDts<t[r+1].originalBeginDts)?i=r+1:t.length>0&&(i=this._searchNearestSegmentBefore(n.originalBeginDts)+1),this._lastAppendLocation=i,this._list.splice(i,0,n)}},{key:"getLastSegmentBefore",value:function(e){var t=this._searchNearestSegmentBefore(e);return t>=0?this._list[t]:null}},{key:"getLastSampleBefore",value:function(e){var t=this.getLastSegmentBefore(e);return null!=t?t.lastSample:null}},{key:"getLastSyncPointBefore",value:function(e){for(var t=this._searchNearestSegmentBefore(e),n=this._list[t].syncPoints;0===n.length&&t>0;)t--,n=this._list[t].syncPoints;return n.length>0?n[n.length-1]:null}},{key:"type",get:function(){return this._type}},{key:"length",get:function(){return this._list.length}}]),e}()},{}],9:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=e("events"),s=r(a),u=e("../utils/logger.js"),l=r(u),d=e("../utils/browser.js"),c=r(d),f=e("./mse-events.js"),h=r(f),_=e("./media-segment-info.js"),p=e("../utils/exception.js"),m=function(){function e(t){i(this,e),this.TAG="MSEController",this._config=t,this._emitter=new s.default,this._config.isLive&&void 0==this._config.autoCleanupSourceBuffer&&(this._config.autoCleanupSourceBuffer=!0),this.e={onSourceOpen:this._onSourceOpen.bind(this),onSourceEnded:this._onSourceEnded.bind(this),onSourceClose:this._onSourceClose.bind(this),onSourceBufferError:this._onSourceBufferError.bind(this),onSourceBufferUpdateEnd:this._onSourceBufferUpdateEnd.bind(this)},this._mediaSource=null,this._mediaSourceObjectURL=null,this._mediaElement=null,this._isBufferFull=!1,this._hasPendingEos=!1,this._requireSetMediaDuration=!1,this._pendingMediaDuration=0,this._pendingSourceBufferInit=[],this._mimeTypes={video:null,audio:null},this._sourceBuffers={video:null,audio:null},this._lastInitSegments={video:null,audio:null},this._pendingSegments={video:[],audio:[]},this._pendingRemoveRanges={video:[],audio:[]},this._idrList=new _.IDRSampleList}return o(e,[{key:"destroy",value:function(){(this._mediaElement||this._mediaSource)&&this.detachMediaElement(),this.e=null,this._emitter.removeAllListeners(),this._emitter=null}},{key:"on",value:function(e,t){this._emitter.addListener(e,t)}},{key:"off",value:function(e,t){this._emitter.removeListener(e,t)}},{key:"attachMediaElement",value:function(e){if(this._mediaSource)throw new p.IllegalStateException("MediaSource has been attached to an HTMLMediaElement!");var t=this._mediaSource=new window.MediaSource;t.addEventListener("sourceopen",this.e.onSourceOpen),t.addEventListener("sourceended",this.e.onSourceEnded),t.addEventListener("sourceclose",this.e.onSourceClose),this._mediaElement=e,this._mediaSourceObjectURL=window.URL.createObjectURL(this._mediaSource),e.src=this._mediaSourceObjectURL}},{key:"detachMediaElement",value:function(){if(this._mediaSource){var e=this._mediaSource;for(var t in this._sourceBuffers){var n=this._pendingSegments[t];n.splice(0,n.length),this._pendingSegments[t]=null,this._pendingRemoveRanges[t]=null,this._lastInitSegments[t]=null;var r=this._sourceBuffers[t];r&&("closed"!==e.readyState&&(e.removeSourceBuffer(r),r.removeEventListener("error",this.e.onSourceBufferError),r.removeEventListener("updateend",this.e.onSourceBufferUpdateEnd)),this._mimeTypes[t]=null,this._sourceBuffers[t]=null)}if("open"===e.readyState)try{e.endOfStream()}catch(e){l.default.e(this.TAG,e.message)}e.removeEventListener("sourceopen",this.e.onSourceOpen),e.removeEventListener("sourceended",this.e.onSourceEnded),e.removeEventListener("sourceclose",this.e.onSourceClose),this._pendingSourceBufferInit=[],this._isBufferFull=!1,this._idrList.clear(),this._mediaSource=null}this._mediaElement&&(this._mediaElement.src="",this._mediaElement.removeAttribute("src"),this._mediaElement=null),this._mediaSourceObjectURL&&(window.URL.revokeObjectURL(this._mediaSourceObjectURL),this._mediaSourceObjectURL=null)}},{key:"appendInitSegment",value:function(e,t){if(!this._mediaSource||"open"!==this._mediaSource.readyState)return this._pendingSourceBufferInit.push(e),void this._pendingSegments[e.type].push(e);var n=e,r=""+n.container;n.codec&&n.codec.length>0&&(r+=";codecs="+n.codec);var i=!1;if(l.default.v(this.TAG,"Received Initialization Segment, mimeType: "+r),this._lastInitSegments[n.type]=n,r!==this._mimeTypes[n.type]){if(this._mimeTypes[n.type])l.default.v(this.TAG,"Notice: "+n.type+" mimeType changed, origin: "+this._mimeTypes[n.type]+", target: "+r);else{i=!0;try{if("audio"===n.type&&!this._sourceBuffers.video&&(void 0===this._config.hasAudio||this._config.hasAudio)){var o=this._sourceBuffers.video=this._mediaSource.addSourceBuffer('video/mp4; codecs="avc1.42E01E');o.addEventListener("error",this.e.onSourceBufferError),o.addEventListener("updateend",this.e.onSourceBufferUpdateEnd),o.mode="sequence",this._mimeTypes.video='video/mp4; codecs="avc1.42E01E'}var a=this._sourceBuffers[n.type]=this._mediaSource.addSourceBuffer(r);a.addEventListener("error",this.e.onSourceBufferError),a.addEventListener("updateend",this.e.onSourceBufferUpdateEnd),a.mode="sequence"}catch(e){return l.default.e(this.TAG,e.message),void this._emitter.emit(h.default.ERROR,{code:e.code,msg:e.message})}}this._mimeTypes[n.type]=r}t||this._pendingSegments[n.type].push(n),i||this._sourceBuffers[n.type]&&!this._sourceBuffers[n.type].updating&&this._doAppendSegments(),c.default.safari&&"audio/mpeg"===n.container&&n.mediaDuration>0&&(this._requireSetMediaDuration=!0,this._pendingMediaDuration=n.mediaDuration/1e3,this._updateMediaSourceDuration())}},{key:"appendMediaSegment",value:function(e){var t=e;this._pendingSegments[t.type].push(t),this._config.autoCleanupSourceBuffer&&this._needCleanupSourceBuffer()&&this._doCleanupSourceBuffer();var n=this._sourceBuffers[t.type];!n||n.updating||this._hasPendingRemoveRanges()||this._doAppendSegments()}},{key:"seek",value:function(e){for(var t in this._sourceBuffers)if(this._sourceBuffers[t]){var n=this._sourceBuffers[t];if("open"===this._mediaSource.readyState)try{n.abort()}catch(e){l.default.e(this.TAG,e.message)}this._idrList.clear();var r=this._pendingSegments[t];if(r.splice(0,r.length),"closed"!==this._mediaSource.readyState){for(var i=0;i<n.buffered.length;i++){var o=n.buffered.start(i),a=n.buffered.end(i);this._pendingRemoveRanges[t].push({start:o,end:a})}if(n.updating||this._doRemoveRanges(),c.default.safari){var s=this._lastInitSegments[t];s&&(this._pendingSegments[t].push(s),n.updating||this._doAppendSegments())}}}}},{key:"endOfStream",value:function(){var e=this._mediaSource,t=this._sourceBuffers;if(!e||"open"!==e.readyState)return void(e&&"closed"===e.readyState&&this._hasPendingSegments()&&(this._hasPendingEos=!0));t.video&&t.video.updating||t.audio&&t.audio.updating?this._hasPendingEos=!0:(this._hasPendingEos=!1,e.endOfStream())}},{key:"getNearestKeyframe",value:function(e){return this._idrList.getLastSyncPointBeforeDts(e)}},{key:"_needCleanupSourceBuffer",value:function(){if(!this._config.autoCleanupSourceBuffer)return!1;var e=this._mediaElement.currentTime;for(var t in this._sourceBuffers){var n=this._sourceBuffers[t];if(n){var r=n.buffered;if(r.length>=1&&e-r.start(0)>=this._config.autoCleanupMaxBackwardDuration)return!0}}return!1}},{key:"_doCleanupSourceBuffer",value:function(){var e=this._mediaElement.currentTime;for(var t in this._sourceBuffers){var n=this._sourceBuffers[t];if(n){for(var r=n.buffered,i=!1,o=0;o<r.length;o++){var a=r.start(o),s=r.end(o);if(a<=e&&e<s+3){if(e-a>=this._config.autoCleanupMaxBackwardDuration){i=!0;var u=e-this._config.autoCleanupMinBackwardDuration;this._pendingRemoveRanges[t].push({start:a,end:u})}}else s<e&&(i=!0,this._pendingRemoveRanges[t].push({start:a,end:s}))}i&&!n.updating&&this._doRemoveRanges()}}}},{key:"_updateMediaSourceDuration",value:function(){var e=this._sourceBuffers;if(0!==this._mediaElement.readyState&&"open"===this._mediaSource.readyState&&!(e.video&&e.video.updating||e.audio&&e.audio.updating)){var t=this._mediaSource.duration,n=this._pendingMediaDuration;n>0&&(isNaN(t)||n>t)&&(l.default.v(this.TAG,"Update MediaSource duration from "+t+" to "+n),this._mediaSource.duration=n),this._requireSetMediaDuration=!1,this._pendingMediaDuration=0}}},{key:"_doRemoveRanges",value:function(){for(var e in this._pendingRemoveRanges)if(this._sourceBuffers[e]&&!this._sourceBuffers[e].updating)for(var t=this._sourceBuffers[e],n=this._pendingRemoveRanges[e];n.length&&!t.updating;){var r=n.shift();r.start<r.end&&t.remove(r.start,r.end)}}},{key:"_doAppendSegments",value:function(){var e=this._pendingSegments;for(var t in e)if(this._sourceBuffers[t]&&!this._sourceBuffers[t].updating&&e[t].length>0){var n=e[t].shift();if(n.timestampOffset){var r=this._sourceBuffers[t].timestampOffset,i=n.timestampOffset/1e3,o=Math.abs(r-i);o>.1&&(l.default.v(this.TAG,"Update MPEG audio timestampOffset from "+r+" to "+i),this._sourceBuffers[t].timestampOffset=i),delete n.timestampOffset}if(!n.data||0===n.data.byteLength)continue;try{this._sourceBuffers[t].appendBuffer(n.data),this._isBufferFull=!1,"video"===t&&n.hasOwnProperty("info")&&this._idrList.appendArray(n.info.syncPoints)}catch(e){this._pendingSegments[t].unshift(n),22===e.code?(this._isBufferFull||this._emitter.emit(h.default.BUFFER_FULL),this._isBufferFull=!0):(l.default.e(this.TAG,e.message),this._emitter.emit(h.default.ERROR,{code:e.code,msg:e.message}))}}}},{key:"_onSourceOpen",value:function(){if(l.default.v(this.TAG,"MediaSource onSourceOpen"),this._mediaSource.removeEventListener("sourceopen",this.e.onSourceOpen),this._pendingSourceBufferInit.length>0)for(var e=this._pendingSourceBufferInit;e.length;){var t=e.shift();this.appendInitSegment(t,!0)}this._hasPendingSegments()&&this._doAppendSegments(),this._emitter.emit(h.default.SOURCE_OPEN)}},{key:"_onSourceEnded",value:function(){l.default.v(this.TAG,"MediaSource onSourceEnded")}},{key:"_onSourceClose",value:function(){l.default.v(this.TAG,"MediaSource onSourceClose"),this._mediaSource&&null!=this.e&&(this._mediaSource.removeEventListener("sourceopen",this.e.onSourceOpen),this._mediaSource.removeEventListener("sourceended",this.e.onSourceEnded),this._mediaSource.removeEventListener("sourceclose",this.e.onSourceClose))}},{key:"_hasPendingSegments",value:function(){var e=this._pendingSegments;return e.video.length>0||e.audio.length>0}},{key:"_hasPendingRemoveRanges",value:function(){var e=this._pendingRemoveRanges;return e.video.length>0||e.audio.length>0}},{key:"_onSourceBufferUpdateEnd",value:function(){this._requireSetMediaDuration?this._updateMediaSourceDuration():this._hasPendingRemoveRanges()?this._doRemoveRanges():this._hasPendingSegments()?this._doAppendSegments():this._hasPendingEos&&this.endOfStream(),this._emitter.emit(h.default.UPDATE_END)}},{key:"_onSourceBufferError",value:function(e){l.default.e(this.TAG,"SourceBuffer Error: "+e)}}]),e}();n.default=m},{"../utils/browser.js":42,"../utils/exception.js":43,"../utils/logger.js":44,"./media-segment-info.js":8,"./mse-events.js":10,events:2}],10:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0})
;var r={ERROR:"error",SOURCE_OPEN:"source_open",UPDATE_END:"update_end",BUFFER_FULL:"buffer_full"};n.default=r},{}],11:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=e("events"),s=r(a),u=e("../utils/logger.js"),l=r(u),d=e("../utils/logging-control.js"),c=r(d),f=e("./transmuxing-controller.js"),h=r(f),_=e("./transmuxing-events.js"),p=r(_),m=e("./transmuxing-worker.js"),v=r(m),g=e("./media-info.js"),y=r(g),b=function(){function t(n,r){if(i(this,t),this.TAG="Transmuxer",this._emitter=new s.default,r.enableWorker&&"undefined"!=typeof Worker)try{var o=e("webworkify");this._worker=o(v.default),this._workerDestroying=!1,this._worker.addEventListener("message",this._onWorkerMessage.bind(this)),this._worker.postMessage({cmd:"init",param:[n,r]}),this.e={onLoggingConfigChanged:this._onLoggingConfigChanged.bind(this)},c.default.registerListener(this.e.onLoggingConfigChanged),this._worker.postMessage({cmd:"logging_config",param:c.default.getConfig()})}catch(e){l.default.e(this.TAG,"Error while initialize transmuxing worker, fallback to inline transmuxing"),this._worker=null,this._controller=new h.default(n,r)}else this._controller=new h.default(n,r);if(this._controller){var a=this._controller;a.on(p.default.IO_ERROR,this._onIOError.bind(this)),a.on(p.default.DEMUX_ERROR,this._onDemuxError.bind(this)),a.on(p.default.INIT_SEGMENT,this._onInitSegment.bind(this)),a.on(p.default.MEDIA_SEGMENT,this._onMediaSegment.bind(this)),a.on(p.default.LOADING_COMPLETE,this._onLoadingComplete.bind(this)),a.on(p.default.RECOVERED_EARLY_EOF,this._onRecoveredEarlyEof.bind(this)),a.on(p.default.MEDIA_INFO,this._onMediaInfo.bind(this)),a.on(p.default.STATISTICS_INFO,this._onStatisticsInfo.bind(this)),a.on(p.default.RECOMMEND_SEEKPOINT,this._onRecommendSeekpoint.bind(this))}}return o(t,[{key:"destroy",value:function(){this._worker?this._workerDestroying||(this._workerDestroying=!0,this._worker.postMessage({cmd:"destroy"}),c.default.removeListener(this.e.onLoggingConfigChanged),this.e=null):(this._controller.destroy(),this._controller=null),this._emitter.removeAllListeners(),this._emitter=null}},{key:"on",value:function(e,t){this._emitter.addListener(e,t)}},{key:"off",value:function(e,t){this._emitter.removeListener(e,t)}},{key:"hasWorker",value:function(){return null!=this._worker}},{key:"open",value:function(){this._worker?this._worker.postMessage({cmd:"start"}):this._controller.start()}},{key:"close",value:function(){this._worker?this._worker.postMessage({cmd:"stop"}):this._controller.stop()}},{key:"seek",value:function(e){this._worker?this._worker.postMessage({cmd:"seek",param:e}):this._controller.seek(e)}},{key:"pause",value:function(){this._worker?this._worker.postMessage({cmd:"pause"}):this._controller.pause()}},{key:"resume",value:function(){this._worker?this._worker.postMessage({cmd:"resume"}):this._controller.resume()}},{key:"_onInitSegment",value:function(e,t){var n=this;Promise.resolve().then(function(){n._emitter.emit(p.default.INIT_SEGMENT,e,t)})}},{key:"_onMediaSegment",value:function(e,t){var n=this;Promise.resolve().then(function(){n._emitter.emit(p.default.MEDIA_SEGMENT,e,t)})}},{key:"_onLoadingComplete",value:function(){var e=this;Promise.resolve().then(function(){e._emitter.emit(p.default.LOADING_COMPLETE)})}},{key:"_onRecoveredEarlyEof",value:function(){var e=this;Promise.resolve().then(function(){e._emitter.emit(p.default.RECOVERED_EARLY_EOF)})}},{key:"_onMediaInfo",value:function(e){var t=this;Promise.resolve().then(function(){t._emitter.emit(p.default.MEDIA_INFO,e)})}},{key:"_onStatisticsInfo",value:function(e){var t=this;Promise.resolve().then(function(){t._emitter.emit(p.default.STATISTICS_INFO,e)})}},{key:"_onIOError",value:function(e,t){var n=this;Promise.resolve().then(function(){n._emitter.emit(p.default.IO_ERROR,e,t)})}},{key:"_onDemuxError",value:function(e,t){var n=this;Promise.resolve().then(function(){n._emitter.emit(p.default.DEMUX_ERROR,e,t)})}},{key:"_onRecommendSeekpoint",value:function(e){var t=this;Promise.resolve().then(function(){t._emitter.emit(p.default.RECOMMEND_SEEKPOINT,e)})}},{key:"_onLoggingConfigChanged",value:function(e){this._worker&&this._worker.postMessage({cmd:"logging_config",param:e})}},{key:"_onWorkerMessage",value:function(e){var t=e.data,n=t.data;if("destroyed"===t.msg||this._workerDestroying)return this._workerDestroying=!1,this._worker.terminate(),void(this._worker=null);switch(t.msg){case p.default.INIT_SEGMENT:case p.default.MEDIA_SEGMENT:this._emitter.emit(t.msg,n.type,n.data);break;case p.default.LOADING_COMPLETE:case p.default.RECOVERED_EARLY_EOF:this._emitter.emit(t.msg);break;case p.default.MEDIA_INFO:Object.setPrototypeOf(n,y.default.prototype),this._emitter.emit(t.msg,n);break;case p.default.STATISTICS_INFO:this._emitter.emit(t.msg,n);break;case p.default.IO_ERROR:case p.default.DEMUX_ERROR:this._emitter.emit(t.msg,n.type,n.info);break;case p.default.RECOMMEND_SEEKPOINT:this._emitter.emit(t.msg,n);break;case"logcat_callback":l.default.emitter.emit("log",n.type,n.logcat)}}}]),t}();n.default=b},{"../utils/logger.js":44,"../utils/logging-control.js":45,"./media-info.js":7,"./transmuxing-controller.js":12,"./transmuxing-events.js":13,"./transmuxing-worker.js":14,events:2,webworkify:4}],12:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=e("events"),s=r(a),u=e("../utils/logger.js"),l=r(u),d=e("../utils/browser.js"),c=r(d),f=e("./media-info.js"),h=r(f),_=e("../demux/flv-demuxer.js"),p=r(_),m=e("../remux/mp4-remuxer.js"),v=r(m),g=e("../demux/demux-errors.js"),y=r(g),b=e("../io/io-controller.js"),S=r(b),k=e("./transmuxing-events.js"),w=r(k),E=(e("../io/loader.js"),function(){function e(t,n){i(this,e),this.TAG="TransmuxingController",this._emitter=new s.default,this._config=n,t.segments||(t.segments=[{duration:t.duration,filesize:t.filesize,url:t.url}]),"boolean"!=typeof t.cors&&(t.cors=!0),"boolean"!=typeof t.withCredentials&&(t.withCredentials=!1),this._mediaDataSource=t,this._currentSegmentIndex=0;var r=0;this._mediaDataSource.segments.forEach(function(e){e.timestampBase=r,r+=e.duration,e.cors=t.cors,e.withCredentials=t.withCredentials,n.referrerPolicy&&(e.referrerPolicy=n.referrerPolicy)}),isNaN(r)||this._mediaDataSource.duration===r||(this._mediaDataSource.duration=r),this._mediaInfo=null,this._demuxer=null,this._remuxer=null,this._ioctl=null,this._pendingSeekTime=null,this._pendingResolveSeekPoint=null,this._statisticsReporter=null,this._enableDecrypt=!1}return o(e,[{key:"destroy",value:function(){this._mediaInfo=null,this._mediaDataSource=null,this._statisticsReporter&&this._disableStatisticsReporter(),this._ioctl&&(this._ioctl.destroy(),this._ioctl=null),this._demuxer&&(this._demuxer.destroy(),this._demuxer=null),this._remuxer&&(this._remuxer.destroy(),this._remuxer=null),this._emitter.removeAllListeners(),this._emitter=null,this._enableDecrypt=!1}},{key:"on",value:function(e,t){this._emitter.addListener(e,t)}},{key:"off",value:function(e,t){this._emitter.removeListener(e,t)}},{key:"start",value:function(){this._loadSegment(0),this._enableStatisticsReporter()}},{key:"_loadSegment",value:function(e,t){this._currentSegmentIndex=e;var n=this._mediaDataSource.segments[e],r=this._ioctl=new S.default(n,this._config,e);r.onError=this._onIOException.bind(this),r.onSeeked=this._onIOSeeked.bind(this),r.onComplete=this._onIOComplete.bind(this),r.onRedirect=this._onIORedirect.bind(this),r.onRecoveredEarlyEof=this._onIORecoveredEarlyEof.bind(this),r.onOpened=this._onIOOpened.bind(this),t?this._demuxer.bindDataSource(this._ioctl):r.onDataArrival=this._onInitChunkArrival.bind(this),r.open(t)}},{key:"stop",value:function(){this._internalAbort(),this._disableStatisticsReporter()}},{key:"_internalAbort",value:function(){this._ioctl&&(this._ioctl.destroy(),this._ioctl=null)}},{key:"pause",value:function(){this._ioctl&&this._ioctl.isWorking()&&(this._ioctl.pause(),this._disableStatisticsReporter())}},{key:"resume",value:function(){this._ioctl&&this._ioctl.isPaused()&&(this._demuxer._firstParse=!0,this._demuxer._dataOffset=0,this._ioctl.resumeTime(this._remuxer._videoNextDts),this._enableStatisticsReporter())}},{key:"seek",value:function(e){if(null!=this._mediaInfo&&this._mediaInfo.isSeekable()){var t=this._searchSegmentIndexContains(e);if(t===this._currentSegmentIndex){var n=this._mediaInfo.segments[t];if(void 0==n)this._pendingSeekTime=e;else{var r=n.getNearestKeyframe(e);this._remuxer.seek(r.milliseconds),this._ioctl.seek(r.fileposition),this._pendingResolveSeekPoint=r.milliseconds}}else{var i=this._mediaInfo.segments[t];if(void 0==i)this._pendingSeekTime=e,this._internalAbort(),this._remuxer.seek(),this._remuxer.insertDiscontinuity(),this._loadSegment(t);else{var o=i.getNearestKeyframe(e);this._internalAbort(),this._remuxer.seek(e),this._remuxer.insertDiscontinuity(),this._demuxer.resetMediaInfo(),this._demuxer.timestampBase=this._mediaDataSource.segments[t].timestampBase,this._loadSegment(t,o.fileposition),this._pendingResolveSeekPoint=o.milliseconds,this._reportSegmentMediaInfo(t)}}this._enableStatisticsReporter()}}},{key:"_searchSegmentIndexContains",value:function(e){for(var t=this._mediaDataSource.segments,n=t.length-1,r=0;r<t.length;r++)if(e<t[r].timestampBase){n=r-1;break}return n}},{key:"_onInitChunkArrival",value:function(e,t){var n=this,r=null,i=0;if(t>0)this._demuxer.bindDataSource(this._ioctl),this._demuxer.timestampBase=this._mediaDataSource.segments[this._currentSegmentIndex].timestampBase,i=this._demuxer.parseChunks(e,t);else if((r=p.default.probe(e)).match){this._demuxer=new p.default(r,this._config),this._demuxer.enableDecrypt(this._enableDecrypt),this._remuxer||(this._remuxer=new v.default(this._config));var o=this._mediaDataSource;void 0==o.duration||isNaN(o.duration)||(this._demuxer.overridedDuration=o.duration),"boolean"==typeof o.hasAudio&&(this._demuxer.overridedHasAudio=o.hasAudio),"boolean"==typeof o.hasVideo&&(this._demuxer.overridedHasVideo=o.hasVideo),this._demuxer.timestampBase=o.segments[this._currentSegmentIndex].timestampBase,this._demuxer.onError=this._onDemuxException.bind(this),this._demuxer.onMediaInfo=this._onMediaInfo.bind(this),this._remuxer.bindDataSource(this._demuxer.bindDataSource(this._ioctl)),this._remuxer.onInitSegment=this._onRemuxerInitSegmentArrival.bind(this),this._remuxer.onMediaSegment=this._onRemuxerMediaSegmentArrival.bind(this),i=this._demuxer.parseChunks(e,t)}else r=null,l.default.e(this.TAG,"Non-FLV, Unsupported media type!"),Promise.resolve().then(function(){n._internalAbort()}),this._emitter.emit(w.default.DEMUX_ERROR,y.default.FORMAT_UNSUPPORTED,"Non-FLV, Unsupported media type"),i=0;return i}},{key:"_onMediaInfo",value:function(e){var t=this;null==this._mediaInfo&&(this._mediaInfo=Object.assign({},e),this._mediaInfo.keyframesIndex=null,this._mediaInfo.segments=[],this._mediaInfo.segmentCount=this._mediaDataSource.segments.length,Object.setPrototypeOf(this._mediaInfo,h.default.prototype));var n=Object.assign({},e);Object.setPrototypeOf(n,h.default.prototype),this._mediaInfo.segments[this._currentSegmentIndex]=n,this._reportSegmentMediaInfo(this._currentSegmentIndex),null!=this._pendingSeekTime&&Promise.resolve().then(function(){var e=t._pendingSeekTime;t._pendingSeekTime=null,t.seek(e)})}},{key:"_onIOOpened",value:function(e){this._enableDecrypt=e}},{key:"_onIOSeeked",value:function(){this._remuxer.insertDiscontinuity()}},{key:"_onIOComplete",value:function(e){var t=e,n=t+1;n<this._mediaDataSource.segments.length?(this._internalAbort(),this._loadSegment(n)):(this._emitter.emit(w.default.LOADING_COMPLETE),this._disableStatisticsReporter())}},{key:"_onIORedirect",value:function(e){var t=this._ioctl.extraData;this._mediaDataSource.segments[t].redirectedURL=e}},{key:"_onIORecoveredEarlyEof",value:function(){this._emitter.emit(w.default.RECOVERED_EARLY_EOF)}},{key:"_onIOException",value:function(e,t){l.default.e(this.TAG,"IOException: type = "+e+", code = "+t.code+", msg = "+t.msg),this._emitter.emit(w.default.IO_ERROR,e,t),this._disableStatisticsReporter()}},{key:"_onDemuxException",value:function(e,t){l.default.e(this.TAG,"DemuxException: type = "+e+", info = "+t),this._emitter.emit(w.default.DEMUX_ERROR,e,t)}},{key:"_onRemuxerInitSegmentArrival",value:function(e,t){this._emitter.emit(w.default.INIT_SEGMENT,e,t)}},{key:"_onRemuxerMediaSegmentArrival",value:function(e,t){if(null==this._pendingSeekTime&&(this._emitter.emit(w.default.MEDIA_SEGMENT,e,t),null!=this._pendingResolveSeekPoint&&"video"===e)){var n=t.info.syncPoints,r=this._pendingResolveSeekPoint;this._pendingResolveSeekPoint=null,c.default.safari&&n.length>0&&n[0].originalDts===r&&(r=n[0].pts),this._emitter.emit(w.default.RECOMMEND_SEEKPOINT,r)}}},{key:"_enableStatisticsReporter",value:function(){null==this._statisticsReporter&&(this._statisticsReporter=self.setInterval(this._reportStatisticsInfo.bind(this),this._config.statisticsInfoReportInterval))}},{key:"_disableStatisticsReporter",value:function(){this._statisticsReporter&&(self.clearInterval(this._statisticsReporter),this._statisticsReporter=null)}},{key:"_reportSegmentMediaInfo",value:function(e){var t=this._mediaInfo.segments[e],n=Object.assign({},t);n.duration=this._mediaInfo.duration,n.segmentCount=this._mediaInfo.segmentCount,delete n.segments,delete n.keyframesIndex,this._emitter.emit(w.default.MEDIA_INFO,n)}},{key:"_reportStatisticsInfo",value:function(){var e={};e.url=this._ioctl.currentURL,e.hasRedirect=this._ioctl.hasRedirect,e.hasRedirect&&(e.redirectedURL=this._ioctl.currentRedirectedURL),e.speed=this._ioctl.currentSpeed,e.loaderType=this._ioctl.loaderType,e.currentSegmentIndex=this._currentSegmentIndex,e.totalSegmentCount=this._mediaDataSource.segments.length,this._emitter.emit(w.default.STATISTICS_INFO,e)}}]),e}());n.default=E},{"../demux/demux-errors.js":17,"../demux/flv-demuxer.js":19,"../io/io-controller.js":24,"../io/loader.js":25,"../remux/mp4-remuxer.js":41,"../utils/browser.js":42,"../utils/logger.js":44,"./media-info.js":7,"./transmuxing-events.js":13,events:2}],13:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r={IO_ERROR:"io_error",DEMUX_ERROR:"demux_error",INIT_SEGMENT:"init_segment",MEDIA_SEGMENT:"media_segment",LOADING_COMPLETE:"loading_complete",RECOVERED_EARLY_EOF:"recovered_early_eof",MEDIA_INFO:"media_info",STATISTICS_INFO:"statistics_info",RECOMMEND_SEEKPOINT:"recommend_seekpoint"};n.default=r},{}],14:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(n,"__esModule",{value:!0});var i=e("../utils/logger.js"),o=(r(i),e("../utils/logging-control.js")),a=r(o),s=e("../utils/polyfill.js"),u=r(s),l=e("./transmuxing-controller.js"),d=r(l),c=e("./transmuxing-events.js"),f=r(c),h=function(e){function t(t,n){var r={msg:f.default.INIT_SEGMENT,data:{type:t,data:n}};e.postMessage(r,[n.data])}function n(t,n){var r={msg:f.default.MEDIA_SEGMENT,data:{type:t,data:n}};e.postMessage(r,[n.data])}function r(){var t={msg:f.default.LOADING_COMPLETE};e.postMessage(t)}function i(){var t={msg:f.default.RECOVERED_EARLY_EOF};e.postMessage(t)}function o(t){var n={msg:f.default.MEDIA_INFO,data:t};e.postMessage(n)}function s(t){var n={msg:f.default.STATISTICS_INFO,data:t};e.postMessage(n)}function l(t,n){e.postMessage({msg:f.default.IO_ERROR,data:{type:t,info:n}})}function c(t,n){e.postMessage({msg:f.default.DEMUX_ERROR,data:{type:t,info:n}})}function h(t){e.postMessage({msg:f.default.RECOMMEND_SEEKPOINT,data:t})}function _(t,n){e.postMessage({msg:"logcat_callback",data:{type:t,logcat:n}})}var p=null,m=_.bind(this);u.default.install(),e.addEventListener("message",function(u){switch(u.data.cmd){case"init":p=new d.default(u.data.param[0],u.data.param[1]),p.on(f.default.IO_ERROR,l.bind(this)),p.on(f.default.DEMUX_ERROR,c.bind(this)),p.on(f.default.INIT_SEGMENT,t.bind(this)),p.on(f.default.MEDIA_SEGMENT,n.bind(this)),p.on(f.default.LOADING_COMPLETE,r.bind(this)),p.on(f.default.RECOVERED_EARLY_EOF,i.bind(this)),p.on(f.default.MEDIA_INFO,o.bind(this)),p.on(f.default.STATISTICS_INFO,s.bind(this)),p.on(f.default.RECOMMEND_SEEKPOINT,h.bind(this));break;case"destroy":p&&(p.destroy(),p=null),e.postMessage({msg:"destroyed"});break;case"start":p.start();break;case"stop":p.stop();break;case"seek":p.seek(u.data.param);break;case"pause":p.pause();break;case"resume":p.resume();break;case"logging_config":var _=u.data.param;a.default.applyConfig(_),!0===_.enableCallback?a.default.addLogListener(m):a.default.removeLogListener(m)}})};n.default=h},{"../utils/logger.js":44,"../utils/logging-control.js":45,"../utils/polyfill.js":46,"./transmuxing-controller.js":12,"./transmuxing-events.js":13}],15:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r=r||function(e,t){var n={},r=n.lib={},i=function(){},o=r.Base={extend:function(e){i.prototype=this;var t=new i;return e&&t.mixIn(e),t.hasOwnProperty("init")||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},a=r.WordArray=o.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=void 0!=t?t:4*e.length},toString:function(e){return(e||u).stringify(this)},concat:function(e){var t=this.words,n=e.words,r=this.sigBytes;if(e=e.sigBytes,this.clamp(),r%4)for(var i=0;i<e;i++)t[r+i>>>2]|=(n[i>>>2]>>>24-i%4*8&255)<<24-(r+i)%4*8;else if(65535<n.length)for(i=0;i<e;i+=4)t[r+i>>>2]=n[i>>>2];else t.push.apply(t,n);return this.sigBytes+=e,this},clamp:function(){var t=this.words,n=this.sigBytes;t[n>>>2]&=4294967295<<32-n%4*8,t.length=e.ceil(n/4)},clone:function(){var e=o.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var n=[],r=0;r<t;r+=4)n.push(4294967296*e.random()|0);return new a.init(n,t)}}),s=n.enc={},u=s.Hex={stringify:function(e){var t=e.words;e=e.sigBytes;for(var n=[],r=0;r<e;r++){var i=t[r>>>2]>>>24-r%4*8&255;n.push((i>>>4).toString(16)),n.push((15&i).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r+=2)n[r>>>3]|=parseInt(e.substr(r,2),16)<<24-r%8*4;return new a.init(n,t/2)}},l=s.Latin1={stringify:function(e){var t=e.words;e=e.sigBytes;for(var n=[],r=0;r<e;r++)n.push(String.fromCharCode(t[r>>>2]>>>24-r%4*8&255));return n.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r++)n[r>>>2]|=(255&e.charCodeAt(r))<<24-r%4*8;return new a.init(n,t)}},d=s.Utf8={stringify:function(e){try{return decodeURIComponent(escape(l.stringify(e)))}catch(e){throw Error("Malformed UTF-8 data")}},parse:function(e){return l.parse(unescape(encodeURIComponent(e)))}},c=r.BufferedBlockAlgorithm=o.extend({reset:function(){this._data=new a.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=d.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var n=this._data,r=n.words,i=n.sigBytes,o=this.blockSize,s=i/(4*o),s=t?e.ceil(s):e.max((0|s)-this._minBufferSize,0);if(t=s*o,i=e.min(4*t,i),t){for(var u=0;u<t;u+=o)this._doProcessBlock(r,u);u=r.splice(0,t),n.sigBytes-=i}return new a.init(u,i)},clone:function(){var e=o.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});r.Hasher=c.extend({cfg:o.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){c.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,n){return new e.init(n).finalize(t)}},_createHmacHelper:function(e){return function(t,n){return new f.HMAC.init(e,n).finalize(t)}}});var f=n.algo={};return n}(Math),r=r||function(e,t){var n={},r=n.lib={},i=function(){},o=r.Base={extend:function(e){i.prototype=this;var t=new i;return e&&t.mixIn(e),t.hasOwnProperty("init")||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},a=r.WordArray=o.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=void 0!=t?t:4*e.length},toString:function(e){return(e||u).stringify(this)},concat:function(e){var t=this.words,n=e.words,r=this.sigBytes;if(e=e.sigBytes,this.clamp(),r%4)for(var i=0;i<e;i++)t[r+i>>>2]|=(n[i>>>2]>>>24-i%4*8&255)<<24-(r+i)%4*8;else if(65535<n.length)for(i=0;i<e;i+=4)t[r+i>>>2]=n[i>>>2];else t.push.apply(t,n);return this.sigBytes+=e,this},clamp:function(){var t=this.words,n=this.sigBytes;t[n>>>2]&=4294967295<<32-n%4*8,t.length=e.ceil(n/4)},clone:function(){var e=o.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var n=[],r=0;r<t;r+=4)n.push(4294967296*e.random()|0);return new a.init(n,t)}}),s=n.enc={},u=s.Hex={stringify:function(e){var t=e.words;e=e.sigBytes;for(var n=[],r=0;r<e;r++){var i=t[r>>>2]>>>24-r%4*8&255;n.push((i>>>4).toString(16)),n.push((15&i).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r+=2)n[r>>>3]|=parseInt(e.substr(r,2),16)<<24-r%8*4;return new a.init(n,t/2)}},l=s.Latin1={stringify:function(e){var t=e.words;e=e.sigBytes;for(var n=[],r=0;r<e;r++)n.push(String.fromCharCode(t[r>>>2]>>>24-r%4*8&255));return n.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r++)n[r>>>2]|=(255&e.charCodeAt(r))<<24-r%4*8;return new a.init(n,t)}},d=s.Utf8={stringify:function(e){try{return decodeURIComponent(escape(l.stringify(e)))}catch(e){throw Error("Malformed UTF-8 data")}},parse:function(e){return l.parse(unescape(encodeURIComponent(e)))}},c=r.BufferedBlockAlgorithm=o.extend({reset:function(){this._data=new a.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=d.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var n=this._data,r=n.words,i=n.sigBytes,o=this.blockSize,s=i/(4*o),s=t?e.ceil(s):e.max((0|s)-this._minBufferSize,0);if(t=s*o,i=e.min(4*t,i),t){for(var u=0;u<t;u+=o)this._doProcessBlock(r,u);u=r.splice(0,t),n.sigBytes-=i}return new a.init(u,i)},clone:function(){var e=o.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});r.Hasher=c.extend({cfg:o.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){c.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,n){return new e.init(n).finalize(t)}},_createHmacHelper:function(e){return function(t,n){return new f.HMAC.init(e,n).finalize(t)}}});var f=n.algo={};return n}(Math);!function(){var e=r,t=e.lib.WordArray;e.enc.Base64={stringify:function(e){var t=e.words,n=e.sigBytes,r=this._map;e.clamp(),e=[];for(var i=0;i<n;i+=3)for(var o=(t[i>>>2]>>>24-i%4*8&255)<<16|(t[i+1>>>2]>>>24-(i+1)%4*8&255)<<8|t[i+2>>>2]>>>24-(i+2)%4*8&255,a=0;4>a&&i+.75*a<n;a++)e.push(r.charAt(o>>>6*(3-a)&63));if(t=r.charAt(64))for(;e.length%4;)e.push(t);return e.join("")},parse:function(e){var n=e.length,r=this._map,i=r.charAt(64);i&&-1!=(i=e.indexOf(i))&&(n=i);for(var i=[],o=0,a=0;a<n;a++)if(a%4){var s=r.indexOf(e.charAt(a-1))<<a%4*2,u=r.indexOf(e.charAt(a))>>>6-a%4*2;i[o>>>2]|=(s|u)<<24-o%4*8,o++}return t.create(i,o)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),function(e){function t(e,t,n,r,i,o,a){return((e=e+(t&n|~t&r)+i+a)<<o|e>>>32-o)+t}function n(e,t,n,r,i,o,a){return((e=e+(t&r|n&~r)+i+a)<<o|e>>>32-o)+t}function i(e,t,n,r,i,o,a){return((e=e+(t^n^r)+i+a)<<o|e>>>32-o)+t}function o(e,t,n,r,i,o,a){return((e=e+(n^(t|~r))+i+a)<<o|e>>>32-o)+t}for(var a=r,s=a.lib,u=s.WordArray,l=s.Hasher,s=a.algo,d=[],c=0;64>c;c++)d[c]=4294967296*e.abs(e.sin(c+1))|0;s=s.MD5=l.extend({_doReset:function(){this._hash=new u.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(e,r){for(var a=0;16>a;a++){var s=r+a,u=e[s];e[s]=16711935&(u<<8|u>>>24)|4278255360&(u<<24|u>>>8)}var a=this._hash.words,s=e[r+0],u=e[r+1],l=e[r+2],c=e[r+3],f=e[r+4],h=e[r+5],_=e[r+6],p=e[r+7],m=e[r+8],v=e[r+9],g=e[r+10],y=e[r+11],b=e[r+12],S=e[r+13],k=e[r+14],w=e[r+15],E=a[0],R=a[1],A=a[2],L=a[3],E=t(E,R,A,L,s,7,d[0]),L=t(L,E,R,A,u,12,d[1]),A=t(A,L,E,R,l,17,d[2]),R=t(R,A,L,E,c,22,d[3]),E=t(E,R,A,L,f,7,d[4]),L=t(L,E,R,A,h,12,d[5]),A=t(A,L,E,R,_,17,d[6]),R=t(R,A,L,E,p,22,d[7]),E=t(E,R,A,L,m,7,d[8]),L=t(L,E,R,A,v,12,d[9]),A=t(A,L,E,R,g,17,d[10]),R=t(R,A,L,E,y,22,d[11]),E=t(E,R,A,L,b,7,d[12]),L=t(L,E,R,A,S,12,d[13]),A=t(A,L,E,R,k,17,d[14]),R=t(R,A,L,E,w,22,d[15]),E=n(E,R,A,L,u,5,d[16]),L=n(L,E,R,A,_,9,d[17]),A=n(A,L,E,R,y,14,d[18]),R=n(R,A,L,E,s,20,d[19]),E=n(E,R,A,L,h,5,d[20]),L=n(L,E,R,A,g,9,d[21]),A=n(A,L,E,R,w,14,d[22]),R=n(R,A,L,E,f,20,d[23]),E=n(E,R,A,L,v,5,d[24]),L=n(L,E,R,A,k,9,d[25]),A=n(A,L,E,R,c,14,d[26]),R=n(R,A,L,E,m,20,d[27]),E=n(E,R,A,L,S,5,d[28]),L=n(L,E,R,A,l,9,d[29]),A=n(A,L,E,R,p,14,d[30]),R=n(R,A,L,E,b,20,d[31]),E=i(E,R,A,L,h,4,d[32]),L=i(L,E,R,A,m,11,d[33]),A=i(A,L,E,R,y,16,d[34]),R=i(R,A,L,E,k,23,d[35]),E=i(E,R,A,L,u,4,d[36]),L=i(L,E,R,A,f,11,d[37]),A=i(A,L,E,R,p,16,d[38]),R=i(R,A,L,E,g,23,d[39]),E=i(E,R,A,L,S,4,d[40]),L=i(L,E,R,A,s,11,d[41]),A=i(A,L,E,R,c,16,d[42]),R=i(R,A,L,E,_,23,d[43]),E=i(E,R,A,L,v,4,d[44]),L=i(L,E,R,A,b,11,d[45]),A=i(A,L,E,R,w,16,d[46]),R=i(R,A,L,E,l,23,d[47]),E=o(E,R,A,L,s,6,d[48]),L=o(L,E,R,A,p,10,d[49]),A=o(A,L,E,R,k,15,d[50]),R=o(R,A,L,E,h,21,d[51]),E=o(E,R,A,L,b,6,d[52]),L=o(L,E,R,A,c,10,d[53]),A=o(A,L,E,R,g,15,d[54]),R=o(R,A,L,E,u,21,d[55]),E=o(E,R,A,L,m,6,d[56]),L=o(L,E,R,A,w,10,d[57]),A=o(A,L,E,R,_,15,d[58]),R=o(R,A,L,E,S,21,d[59]),E=o(E,R,A,L,f,6,d[60]),L=o(L,E,R,A,y,10,d[61]),A=o(A,L,E,R,l,15,d[62]),R=o(R,A,L,E,v,21,d[63]);a[0]=a[0]+E|0,a[1]=a[1]+R|0,a[2]=a[2]+A|0,a[3]=a[3]+L|0},_doFinalize:function(){var t=this._data,n=t.words,r=8*this._nDataBytes,i=8*t.sigBytes;n[i>>>5]|=128<<24-i%32;var o=e.floor(r/4294967296);for(n[15+(i+64>>>9<<4)]=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),n[14+(i+64>>>9<<4)]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8),t.sigBytes=4*(n.length+1),this._process(),t=this._hash,n=t.words,r=0;4>r;r++)i=n[r],n[r]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8);return t},clone:function(){var e=l.clone.call(this);return e._hash=this._hash.clone(),e}}),a.MD5=l._createHelper(s),a.HmacMD5=l._createHmacHelper(s)}(Math),function(){var e=r,t=e.lib,n=t.Base,i=t.WordArray,t=e.algo,o=t.EvpKDF=n.extend({cfg:n.extend({keySize:4,hasher:t.MD5,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e)},compute:function(e,t){for(var n=this.cfg,r=n.hasher.create(),o=i.create(),a=o.words,s=n.keySize,n=n.iterations;a.length<s;){u&&r.update(u);var u=r.update(e).finalize(t);r.reset();for(var l=1;l<n;l++)u=r.finalize(u),r.reset();o.concat(u)}return o.sigBytes=4*s,o}});e.EvpKDF=function(e,t,n){return o.create(n).compute(e,t)}}(),r.lib.Cipher||function(e){var t=r,n=t.lib,i=n.Base,o=n.WordArray,a=n.BufferedBlockAlgorithm,s=t.enc.Base64,u=t.algo.EvpKDF,l=n.Cipher=a.extend({cfg:i.extend(),createEncryptor:function(e,t){return this.create(this._ENC_XFORM_MODE,e,t)},createDecryptor:function(e,t){return this.create(this._DEC_XFORM_MODE,e,t)},init:function(e,t,n){this.cfg=this.cfg.extend(n),this._xformMode=e,this._key=t,this.reset()},reset:function(){a.reset.call(this),this._doReset()},process:function(e){return this._append(e),this._process()},finalize:function(e){return e&&this._append(e),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(e){return{encrypt:function(t,n,r){return("string"==typeof n?p:_).encrypt(e,t,n,r)},decrypt:function(t,n,r){return("string"==typeof n?p:_).decrypt(e,t,n,r)}}}});n.StreamCipher=l.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var d=t.mode={},c=function(e,t,n){var r=this._iv;r?this._iv=void 0:r=this._prevBlock;for(var i=0;i<n;i++)e[t+i]^=r[i]},f=(n.BlockCipherMode=i.extend({createEncryptor:function(e,t){return this.Encryptor.create(e,t)},createDecryptor:function(e,t){return this.Decryptor.create(e,t)},init:function(e,t){this._cipher=e,this._iv=t}})).extend();f.Encryptor=f.extend({processBlock:function(e,t){var n=this._cipher,r=n.blockSize;c.call(this,e,t,r),n.encryptBlock(e,t),this._prevBlock=e.slice(t,t+r)}}),f.Decryptor=f.extend({processBlock:function(e,t){var n=this._cipher,r=n.blockSize,i=e.slice(t,t+r);n.decryptBlock(e,t),c.call(this,e,t,r),this._prevBlock=i}}),d=d.CBC=f,f=(t.pad={}).Pkcs7={pad:function(e,t){for(var n=4*t,n=n-e.sigBytes%n,r=n<<24|n<<16|n<<8|n,i=[],a=0;a<n;a+=4)i.push(r);n=o.create(i,n),e.concat(n)},unpad:function(e){e.sigBytes-=255&e.words[e.sigBytes-1>>>2]}},n.BlockCipher=l.extend({cfg:l.cfg.extend({mode:d,padding:f}),reset:function(){l.reset.call(this);var e=this.cfg,t=e.iv,e=e.mode;if(this._xformMode==this._ENC_XFORM_MODE)var n=e.createEncryptor;else n=e.createDecryptor,this._minBufferSize=1;this._mode=n.call(e,this,t&&t.words)},_doProcessBlock:function(e,t){this._mode.processBlock(e,t)},_doFinalize:function(){var e=this.cfg.padding;if(this._xformMode==this._ENC_XFORM_MODE){e.pad(this._data,this.blockSize);var t=this._process(!0)}else t=this._process(!0),e.unpad(t);return t},blockSize:4});var h=n.CipherParams=i.extend({init:function(e){this.mixIn(e)},toString:function(e){return(e||this.formatter).stringify(this)}}),d=(t.format={}).OpenSSL={stringify:function(e){var t=e.ciphertext;return e=e.salt,(e?o.create([1398893684,1701076831]).concat(e).concat(t):t).toString(s)},parse:function(e){e=s.parse(e);var t=e.words;if(1398893684==t[0]&&1701076831==t[1]){var n=o.create(t.slice(2,4));t.splice(0,4),e.sigBytes-=16}return h.create({ciphertext:e,salt:n})}},_=n.SerializableCipher=i.extend({cfg:i.extend({format:d}),encrypt:function(e,t,n,r){r=this.cfg.extend(r);var i=e.createEncryptor(n,r);return t=i.finalize(t),i=i.cfg,h.create({ciphertext:t,key:n,iv:i.iv,algorithm:e,mode:i.mode,padding:i.padding,blockSize:e.blockSize,formatter:r.format})},decrypt:function(e,t,n,r){return r=this.cfg.extend(r),t=this._parse(t,r.format),e.createDecryptor(n,r).finalize(t.ciphertext)},_parse:function(e,t){return"string"==typeof e?t.parse(e,this):e}}),t=(t.kdf={}).OpenSSL={execute:function(e,t,n,r){return r||(r=o.random(8)),e=u.create({keySize:t+n}).compute(e,r),n=o.create(e.words.slice(t),4*n),e.sigBytes=4*t,h.create({key:e,iv:n,salt:r})}},p=n.PasswordBasedCipher=_.extend({cfg:_.cfg.extend({kdf:t}),encrypt:function(e,t,n,r){return r=this.cfg.extend(r),n=r.kdf.execute(n,e.keySize,e.ivSize),r.iv=n.iv,e=_.encrypt.call(this,e,t,n.key,r),e.mixIn(n),e},decrypt:function(e,t,n,r){return r=this.cfg.extend(r),t=this._parse(t,r.format),n=r.kdf.execute(n,e.keySize,e.ivSize,t.salt),r.iv=n.iv,_.decrypt.call(this,e,t,n.key,r)}})}(),function(){for(var e=r,t=e.lib.BlockCipher,n=e.algo,i=[],o=[],a=[],s=[],u=[],l=[],d=[],c=[],f=[],h=[],_=[],p=0;256>p;p++)_[p]=128>p?p<<1:p<<1^283;for(var m=0,v=0,p=0;256>p;p++){var g=v^v<<1^v<<2^v<<3^v<<4,g=g>>>8^255&g^99;i[m]=g,o[g]=m
;var y=_[m],b=_[y],S=_[b],k=257*_[g]^16843008*g;a[m]=k<<24|k>>>8,s[m]=k<<16|k>>>16,u[m]=k<<8|k>>>24,l[m]=k,k=16843009*S^65537*b^257*y^16843008*m,d[g]=k<<24|k>>>8,c[g]=k<<16|k>>>16,f[g]=k<<8|k>>>24,h[g]=k,m?(m=y^_[_[_[S^y]]],v^=_[_[v]]):m=v=1}var w=[0,1,2,4,8,16,32,64,128,27,54],n=n.AES=t.extend({_doReset:function(){for(var e=this._key,t=e.words,n=e.sigBytes/4,e=4*((this._nRounds=n+6)+1),r=this._keySchedule=[],o=0;o<e;o++)if(o<n)r[o]=t[o];else{var a=r[o-1];o%n?6<n&&4==o%n&&(a=i[a>>>24]<<24|i[a>>>16&255]<<16|i[a>>>8&255]<<8|i[255&a]):(a=a<<8|a>>>24,a=i[a>>>24]<<24|i[a>>>16&255]<<16|i[a>>>8&255]<<8|i[255&a],a^=w[o/n|0]<<24),r[o]=r[o-n]^a}for(t=this._invKeySchedule=[],n=0;n<e;n++)o=e-n,a=n%4?r[o]:r[o-4],t[n]=4>n||4>=o?a:d[i[a>>>24]]^c[i[a>>>16&255]]^f[i[a>>>8&255]]^h[i[255&a]]},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._keySchedule,a,s,u,l,i)},decryptBlock:function(e,t){var n=e[t+1];e[t+1]=e[t+3],e[t+3]=n,this._doCryptBlock(e,t,this._invKeySchedule,d,c,f,h,o),n=e[t+1],e[t+1]=e[t+3],e[t+3]=n},_doCryptBlock:function(e,t,n,r,i,o,a,s){for(var u=this._nRounds,l=e[t]^n[0],d=e[t+1]^n[1],c=e[t+2]^n[2],f=e[t+3]^n[3],h=4,_=1;_<u;_++)var p=r[l>>>24]^i[d>>>16&255]^o[c>>>8&255]^a[255&f]^n[h++],m=r[d>>>24]^i[c>>>16&255]^o[f>>>8&255]^a[255&l]^n[h++],v=r[c>>>24]^i[f>>>16&255]^o[l>>>8&255]^a[255&d]^n[h++],f=r[f>>>24]^i[l>>>16&255]^o[d>>>8&255]^a[255&c]^n[h++],l=p,d=m,c=v;p=(s[l>>>24]<<24|s[d>>>16&255]<<16|s[c>>>8&255]<<8|s[255&f])^n[h++],m=(s[d>>>24]<<24|s[c>>>16&255]<<16|s[f>>>8&255]<<8|s[255&l])^n[h++],v=(s[c>>>24]<<24|s[f>>>16&255]<<16|s[l>>>8&255]<<8|s[255&d])^n[h++],f=(s[f>>>24]<<24|s[l>>>16&255]<<16|s[d>>>8&255]<<8|s[255&c])^n[h++],e[t]=p,e[t+1]=m,e[t+2]=v,e[t+3]=f},keySize:8});e.AES=t._createHelper(n)}();var r=r||function(e,t){var n={},r=n.lib={},i=function(){},o=r.Base={extend:function(e){i.prototype=this;var t=new i;return e&&t.mixIn(e),t.hasOwnProperty("init")||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},a=r.WordArray=o.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=void 0!=t?t:4*e.length},toString:function(e){return(e||u).stringify(this)},concat:function(e){var t=this.words,n=e.words,r=this.sigBytes;if(e=e.sigBytes,this.clamp(),r%4)for(var i=0;i<e;i++)t[r+i>>>2]|=(n[i>>>2]>>>24-i%4*8&255)<<24-(r+i)%4*8;else if(65535<n.length)for(i=0;i<e;i+=4)t[r+i>>>2]=n[i>>>2];else t.push.apply(t,n);return this.sigBytes+=e,this},clamp:function(){var t=this.words,n=this.sigBytes;t[n>>>2]&=4294967295<<32-n%4*8,t.length=e.ceil(n/4)},clone:function(){var e=o.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var n=[],r=0;r<t;r+=4)n.push(4294967296*e.random()|0);return new a.init(n,t)}}),s=n.enc={},u=s.Hex={stringify:function(e){var t=e.words;e=e.sigBytes;for(var n=[],r=0;r<e;r++){var i=t[r>>>2]>>>24-r%4*8&255;n.push((i>>>4).toString(16)),n.push((15&i).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r+=2)n[r>>>3]|=parseInt(e.substr(r,2),16)<<24-r%8*4;return new a.init(n,t/2)}},l=s.Latin1={stringify:function(e){var t=e.words;e=e.sigBytes;for(var n=[],r=0;r<e;r++)n.push(String.fromCharCode(t[r>>>2]>>>24-r%4*8&255));return n.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r++)n[r>>>2]|=(255&e.charCodeAt(r))<<24-r%4*8;return new a.init(n,t)}},d=s.Utf8={stringify:function(e){try{return decodeURIComponent(escape(l.stringify(e)))}catch(e){throw Error("Malformed UTF-8 data")}},parse:function(e){return l.parse(unescape(encodeURIComponent(e)))}},c=r.BufferedBlockAlgorithm=o.extend({reset:function(){this._data=new a.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=d.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var n=this._data,r=n.words,i=n.sigBytes,o=this.blockSize,s=i/(4*o),s=t?e.ceil(s):e.max((0|s)-this._minBufferSize,0);if(t=s*o,i=e.min(4*t,i),t){for(var u=0;u<t;u+=o)this._doProcessBlock(r,u);u=r.splice(0,t),n.sigBytes-=i}return new a.init(u,i)},clone:function(){var e=o.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});r.Hasher=c.extend({cfg:o.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){c.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,n){return new e.init(n).finalize(t)}},_createHmacHelper:function(e){return function(t,n){return new f.HMAC.init(e,n).finalize(t)}}});var f=n.algo={};return n}(Math);!function(){var e=r,t=e.lib.WordArray;e.enc.Base64={stringify:function(e){var t=e.words,n=e.sigBytes,r=this._map;e.clamp(),e=[];for(var i=0;i<n;i+=3)for(var o=(t[i>>>2]>>>24-i%4*8&255)<<16|(t[i+1>>>2]>>>24-(i+1)%4*8&255)<<8|t[i+2>>>2]>>>24-(i+2)%4*8&255,a=0;4>a&&i+.75*a<n;a++)e.push(r.charAt(o>>>6*(3-a)&63));if(t=r.charAt(64))for(;e.length%4;)e.push(t);return e.join("")},parse:function(e){var n=e.length,r=this._map,i=r.charAt(64);i&&-1!=(i=e.indexOf(i))&&(n=i);for(var i=[],o=0,a=0;a<n;a++)if(a%4){var s=r.indexOf(e.charAt(a-1))<<a%4*2,u=r.indexOf(e.charAt(a))>>>6-a%4*2;i[o>>>2]|=(s|u)<<24-o%4*8,o++}return t.create(i,o)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),function(e){function t(e,t,n,r,i,o,a){return((e=e+(t&n|~t&r)+i+a)<<o|e>>>32-o)+t}function n(e,t,n,r,i,o,a){return((e=e+(t&r|n&~r)+i+a)<<o|e>>>32-o)+t}function i(e,t,n,r,i,o,a){return((e=e+(t^n^r)+i+a)<<o|e>>>32-o)+t}function o(e,t,n,r,i,o,a){return((e=e+(n^(t|~r))+i+a)<<o|e>>>32-o)+t}for(var a=r,s=a.lib,u=s.WordArray,l=s.Hasher,s=a.algo,d=[],c=0;64>c;c++)d[c]=4294967296*e.abs(e.sin(c+1))|0;s=s.MD5=l.extend({_doReset:function(){this._hash=new u.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(e,r){for(var a=0;16>a;a++){var s=r+a,u=e[s];e[s]=16711935&(u<<8|u>>>24)|4278255360&(u<<24|u>>>8)}var a=this._hash.words,s=e[r+0],u=e[r+1],l=e[r+2],c=e[r+3],f=e[r+4],h=e[r+5],_=e[r+6],p=e[r+7],m=e[r+8],v=e[r+9],g=e[r+10],y=e[r+11],b=e[r+12],S=e[r+13],k=e[r+14],w=e[r+15],E=a[0],R=a[1],A=a[2],L=a[3],E=t(E,R,A,L,s,7,d[0]),L=t(L,E,R,A,u,12,d[1]),A=t(A,L,E,R,l,17,d[2]),R=t(R,A,L,E,c,22,d[3]),E=t(E,R,A,L,f,7,d[4]),L=t(L,E,R,A,h,12,d[5]),A=t(A,L,E,R,_,17,d[6]),R=t(R,A,L,E,p,22,d[7]),E=t(E,R,A,L,m,7,d[8]),L=t(L,E,R,A,v,12,d[9]),A=t(A,L,E,R,g,17,d[10]),R=t(R,A,L,E,y,22,d[11]),E=t(E,R,A,L,b,7,d[12]),L=t(L,E,R,A,S,12,d[13]),A=t(A,L,E,R,k,17,d[14]),R=t(R,A,L,E,w,22,d[15]),E=n(E,R,A,L,u,5,d[16]),L=n(L,E,R,A,_,9,d[17]),A=n(A,L,E,R,y,14,d[18]),R=n(R,A,L,E,s,20,d[19]),E=n(E,R,A,L,h,5,d[20]),L=n(L,E,R,A,g,9,d[21]),A=n(A,L,E,R,w,14,d[22]),R=n(R,A,L,E,f,20,d[23]),E=n(E,R,A,L,v,5,d[24]),L=n(L,E,R,A,k,9,d[25]),A=n(A,L,E,R,c,14,d[26]),R=n(R,A,L,E,m,20,d[27]),E=n(E,R,A,L,S,5,d[28]),L=n(L,E,R,A,l,9,d[29]),A=n(A,L,E,R,p,14,d[30]),R=n(R,A,L,E,b,20,d[31]),E=i(E,R,A,L,h,4,d[32]),L=i(L,E,R,A,m,11,d[33]),A=i(A,L,E,R,y,16,d[34]),R=i(R,A,L,E,k,23,d[35]),E=i(E,R,A,L,u,4,d[36]),L=i(L,E,R,A,f,11,d[37]),A=i(A,L,E,R,p,16,d[38]),R=i(R,A,L,E,g,23,d[39]),E=i(E,R,A,L,S,4,d[40]),L=i(L,E,R,A,s,11,d[41]),A=i(A,L,E,R,c,16,d[42]),R=i(R,A,L,E,_,23,d[43]),E=i(E,R,A,L,v,4,d[44]),L=i(L,E,R,A,b,11,d[45]),A=i(A,L,E,R,w,16,d[46]),R=i(R,A,L,E,l,23,d[47]),E=o(E,R,A,L,s,6,d[48]),L=o(L,E,R,A,p,10,d[49]),A=o(A,L,E,R,k,15,d[50]),R=o(R,A,L,E,h,21,d[51]),E=o(E,R,A,L,b,6,d[52]),L=o(L,E,R,A,c,10,d[53]),A=o(A,L,E,R,g,15,d[54]),R=o(R,A,L,E,u,21,d[55]),E=o(E,R,A,L,m,6,d[56]),L=o(L,E,R,A,w,10,d[57]),A=o(A,L,E,R,_,15,d[58]),R=o(R,A,L,E,S,21,d[59]),E=o(E,R,A,L,f,6,d[60]),L=o(L,E,R,A,y,10,d[61]),A=o(A,L,E,R,l,15,d[62]),R=o(R,A,L,E,v,21,d[63]);a[0]=a[0]+E|0,a[1]=a[1]+R|0,a[2]=a[2]+A|0,a[3]=a[3]+L|0},_doFinalize:function(){var t=this._data,n=t.words,r=8*this._nDataBytes,i=8*t.sigBytes;n[i>>>5]|=128<<24-i%32;var o=e.floor(r/4294967296);for(n[15+(i+64>>>9<<4)]=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),n[14+(i+64>>>9<<4)]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8),t.sigBytes=4*(n.length+1),this._process(),t=this._hash,n=t.words,r=0;4>r;r++)i=n[r],n[r]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8);return t},clone:function(){var e=l.clone.call(this);return e._hash=this._hash.clone(),e}}),a.MD5=l._createHelper(s),a.HmacMD5=l._createHmacHelper(s)}(Math),function(){var e=r,t=e.lib,n=t.Base,i=t.WordArray,t=e.algo,o=t.EvpKDF=n.extend({cfg:n.extend({keySize:4,hasher:t.MD5,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e)},compute:function(e,t){for(var n=this.cfg,r=n.hasher.create(),o=i.create(),a=o.words,s=n.keySize,n=n.iterations;a.length<s;){u&&r.update(u);var u=r.update(e).finalize(t);r.reset();for(var l=1;l<n;l++)u=r.finalize(u),r.reset();o.concat(u)}return o.sigBytes=4*s,o}});e.EvpKDF=function(e,t,n){return o.create(n).compute(e,t)}}(),r.lib.Cipher||function(e){var t=r,n=t.lib,i=n.Base,o=n.WordArray,a=n.BufferedBlockAlgorithm,s=t.enc.Base64,u=t.algo.EvpKDF,l=n.Cipher=a.extend({cfg:i.extend(),createEncryptor:function(e,t){return this.create(this._ENC_XFORM_MODE,e,t)},createDecryptor:function(e,t){return this.create(this._DEC_XFORM_MODE,e,t)},init:function(e,t,n){this.cfg=this.cfg.extend(n),this._xformMode=e,this._key=t,this.reset()},reset:function(){a.reset.call(this),this._doReset()},process:function(e){return this._append(e),this._process()},finalize:function(e){return e&&this._append(e),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(e){return{encrypt:function(t,n,r){return("string"==typeof n?p:_).encrypt(e,t,n,r)},decrypt:function(t,n,r){return("string"==typeof n?p:_).decrypt(e,t,n,r)}}}});n.StreamCipher=l.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var d=t.mode={},c=function(e,t,n){var r=this._iv;r?this._iv=void 0:r=this._prevBlock;for(var i=0;i<n;i++)e[t+i]^=r[i]},f=(n.BlockCipherMode=i.extend({createEncryptor:function(e,t){return this.Encryptor.create(e,t)},createDecryptor:function(e,t){return this.Decryptor.create(e,t)},init:function(e,t){this._cipher=e,this._iv=t}})).extend();f.Encryptor=f.extend({processBlock:function(e,t){var n=this._cipher,r=n.blockSize;c.call(this,e,t,r),n.encryptBlock(e,t),this._prevBlock=e.slice(t,t+r)}}),f.Decryptor=f.extend({processBlock:function(e,t){var n=this._cipher,r=n.blockSize,i=e.slice(t,t+r);n.decryptBlock(e,t),c.call(this,e,t,r),this._prevBlock=i}}),d=d.CBC=f,f=(t.pad={}).Pkcs7={pad:function(e,t){for(var n=4*t,n=n-e.sigBytes%n,r=n<<24|n<<16|n<<8|n,i=[],a=0;a<n;a+=4)i.push(r);n=o.create(i,n),e.concat(n)},unpad:function(e){e.sigBytes-=255&e.words[e.sigBytes-1>>>2]}},n.BlockCipher=l.extend({cfg:l.cfg.extend({mode:d,padding:f}),reset:function(){l.reset.call(this);var e=this.cfg,t=e.iv,e=e.mode;if(this._xformMode==this._ENC_XFORM_MODE)var n=e.createEncryptor;else n=e.createDecryptor,this._minBufferSize=1;this._mode=n.call(e,this,t&&t.words)},_doProcessBlock:function(e,t){this._mode.processBlock(e,t)},_doFinalize:function(){var e=this.cfg.padding;if(this._xformMode==this._ENC_XFORM_MODE){e.pad(this._data,this.blockSize);var t=this._process(!0)}else t=this._process(!0),e.unpad(t);return t},blockSize:4});var h=n.CipherParams=i.extend({init:function(e){this.mixIn(e)},toString:function(e){return(e||this.formatter).stringify(this)}}),d=(t.format={}).OpenSSL={stringify:function(e){var t=e.ciphertext;return e=e.salt,(e?o.create([1398893684,1701076831]).concat(e).concat(t):t).toString(s)},parse:function(e){e=s.parse(e);var t=e.words;if(1398893684==t[0]&&1701076831==t[1]){var n=o.create(t.slice(2,4));t.splice(0,4),e.sigBytes-=16}return h.create({ciphertext:e,salt:n})}},_=n.SerializableCipher=i.extend({cfg:i.extend({format:d}),encrypt:function(e,t,n,r){r=this.cfg.extend(r);var i=e.createEncryptor(n,r);return t=i.finalize(t),i=i.cfg,h.create({ciphertext:t,key:n,iv:i.iv,algorithm:e,mode:i.mode,padding:i.padding,blockSize:e.blockSize,formatter:r.format})},decrypt:function(e,t,n,r){return r=this.cfg.extend(r),t=this._parse(t,r.format),e.createDecryptor(n,r).finalize(t.ciphertext)},_parse:function(e,t){return"string"==typeof e?t.parse(e,this):e}}),t=(t.kdf={}).OpenSSL={execute:function(e,t,n,r){return r||(r=o.random(8)),e=u.create({keySize:t+n}).compute(e,r),n=o.create(e.words.slice(t),4*n),e.sigBytes=4*t,h.create({key:e,iv:n,salt:r})}},p=n.PasswordBasedCipher=_.extend({cfg:_.cfg.extend({kdf:t}),encrypt:function(e,t,n,r){return r=this.cfg.extend(r),n=r.kdf.execute(n,e.keySize,e.ivSize),r.iv=n.iv,e=_.encrypt.call(this,e,t,n.key,r),e.mixIn(n),e},decrypt:function(e,t,n,r){return r=this.cfg.extend(r),t=this._parse(t,r.format),n=r.kdf.execute(n,e.keySize,e.ivSize,t.salt),r.iv=n.iv,_.decrypt.call(this,e,t,n.key,r)}})}(),function(){function e(){for(var e=this._S,t=this._i,n=this._j,r=0,i=0;4>i;i++){var t=(t+1)%256,n=(n+e[t])%256,o=e[t];e[t]=e[n],e[n]=o,r|=e[(e[t]+e[n])%256]<<24-8*i}return this._i=t,this._j=n,r}var t=r,n=t.lib.StreamCipher,i=t.algo,o=i.RC4=n.extend({_doReset:function(){for(var e=this._key,t=e.words,e=e.sigBytes,n=this._S=[],r=0;256>r;r++)n[r]=r;for(var i=r=0;256>r;r++){var o=r%e,i=(i+n[r]+(t[o>>>2]>>>24-o%4*8&255))%256,o=n[r];n[r]=n[i],n[i]=o}this._i=this._j=0},_doProcessBlock:function(t,n){t[n]^=e.call(this)},keySize:8,ivSize:0});t.RC4=n._createHelper(o),i=i.RC4Drop=o.extend({cfg:o.cfg.extend({drop:192}),_doReset:function(){o._doReset.call(this);for(var t=this.cfg.drop;0<t;t--)e.call(this)}}),t.RC4Drop=n._createHelper(i)}(),r.pad.ZeroPadding={pad:function(e,t){var n=4*t;e.clamp(),e.sigBytes+=n-(e.sigBytes%n||n)},unpad:function(e){for(var t=e.words,n=e.sigBytes-1;!(t[n>>>2]>>>24-n%4*8&255);)n--;e.sigBytes=n+1}};var r=r||function(e,t){var n={},r=n.lib={},i=function(){},o=r.Base={extend:function(e){i.prototype=this;var t=new i;return e&&t.mixIn(e),t.hasOwnProperty("init")||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},a=r.WordArray=o.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=void 0!=t?t:4*e.length},toString:function(e){return(e||u).stringify(this)},concat:function(e){var t=this.words,n=e.words,r=this.sigBytes;if(e=e.sigBytes,this.clamp(),r%4)for(var i=0;i<e;i++)t[r+i>>>2]|=(n[i>>>2]>>>24-i%4*8&255)<<24-(r+i)%4*8;else if(65535<n.length)for(i=0;i<e;i+=4)t[r+i>>>2]=n[i>>>2];else t.push.apply(t,n);return this.sigBytes+=e,this},clamp:function(){var t=this.words,n=this.sigBytes;t[n>>>2]&=4294967295<<32-n%4*8,t.length=e.ceil(n/4)},clone:function(){var e=o.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var n=[],r=0;r<t;r+=4)n.push(4294967296*e.random()|0);return new a.init(n,t)}}),s=n.enc={},u=s.Hex={stringify:function(e){var t=e.words;e=e.sigBytes;for(var n=[],r=0;r<e;r++){var i=t[r>>>2]>>>24-r%4*8&255;n.push((i>>>4).toString(16)),n.push((15&i).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r+=2)n[r>>>3]|=parseInt(e.substr(r,2),16)<<24-r%8*4;return new a.init(n,t/2)}},l=s.Latin1={stringify:function(e){var t=e.words;e=e.sigBytes;for(var n=[],r=0;r<e;r++)n.push(String.fromCharCode(t[r>>>2]>>>24-r%4*8&255));return n.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r++)n[r>>>2]|=(255&e.charCodeAt(r))<<24-r%4*8;return new a.init(n,t)}},d=s.Utf8={stringify:function(e){try{return decodeURIComponent(escape(l.stringify(e)))}catch(e){throw Error("Malformed UTF-8 data")}},parse:function(e){return l.parse(unescape(encodeURIComponent(e)))}},c=r.BufferedBlockAlgorithm=o.extend({reset:function(){this._data=new a.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=d.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var n=this._data,r=n.words,i=n.sigBytes,o=this.blockSize,s=i/(4*o),s=t?e.ceil(s):e.max((0|s)-this._minBufferSize,0);if(t=s*o,i=e.min(4*t,i),t){for(var u=0;u<t;u+=o)this._doProcessBlock(r,u);u=r.splice(0,t),n.sigBytes-=i}return new a.init(u,i)},clone:function(){var e=o.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});r.Hasher=c.extend({cfg:o.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){c.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,n){return new e.init(n).finalize(t)}},_createHmacHelper:function(e){return function(t,n){return new f.HMAC.init(e,n).finalize(t)}}});var f=n.algo={};return n}(Math);!function(e){function t(e,t,n,r,i,o,a){return((e=e+(t&n|~t&r)+i+a)<<o|e>>>32-o)+t}function n(e,t,n,r,i,o,a){return((e=e+(t&r|n&~r)+i+a)<<o|e>>>32-o)+t}function i(e,t,n,r,i,o,a){return((e=e+(t^n^r)+i+a)<<o|e>>>32-o)+t}function o(e,t,n,r,i,o,a){return((e=e+(n^(t|~r))+i+a)<<o|e>>>32-o)+t}for(var a=r,s=a.lib,u=s.WordArray,l=s.Hasher,s=a.algo,d=[],c=0;64>c;c++)d[c]=4294967296*e.abs(e.sin(c+1))|0;s=s.MD5=l.extend({_doReset:function(){this._hash=new u.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(e,r){for(var a=0;16>a;a++){var s=r+a,u=e[s];e[s]=16711935&(u<<8|u>>>24)|4278255360&(u<<24|u>>>8)}var a=this._hash.words,s=e[r+0],u=e[r+1],l=e[r+2],c=e[r+3],f=e[r+4],h=e[r+5],_=e[r+6],p=e[r+7],m=e[r+8],v=e[r+9],g=e[r+10],y=e[r+11],b=e[r+12],S=e[r+13],k=e[r+14],w=e[r+15],E=a[0],R=a[1],A=a[2],L=a[3],E=t(E,R,A,L,s,7,d[0]),L=t(L,E,R,A,u,12,d[1]),A=t(A,L,E,R,l,17,d[2]),R=t(R,A,L,E,c,22,d[3]),E=t(E,R,A,L,f,7,d[4]),L=t(L,E,R,A,h,12,d[5]),A=t(A,L,E,R,_,17,d[6]),R=t(R,A,L,E,p,22,d[7]),E=t(E,R,A,L,m,7,d[8]),L=t(L,E,R,A,v,12,d[9]),A=t(A,L,E,R,g,17,d[10]),R=t(R,A,L,E,y,22,d[11]),E=t(E,R,A,L,b,7,d[12]),L=t(L,E,R,A,S,12,d[13]),A=t(A,L,E,R,k,17,d[14]),R=t(R,A,L,E,w,22,d[15]),E=n(E,R,A,L,u,5,d[16]),L=n(L,E,R,A,_,9,d[17]),A=n(A,L,E,R,y,14,d[18]),R=n(R,A,L,E,s,20,d[19]),E=n(E,R,A,L,h,5,d[20]),L=n(L,E,R,A,g,9,d[21]),A=n(A,L,E,R,w,14,d[22]),R=n(R,A,L,E,f,20,d[23]),E=n(E,R,A,L,v,5,d[24]),L=n(L,E,R,A,k,9,d[25]),A=n(A,L,E,R,c,14,d[26]),R=n(R,A,L,E,m,20,d[27]),E=n(E,R,A,L,S,5,d[28]),L=n(L,E,R,A,l,9,d[29]),A=n(A,L,E,R,p,14,d[30]),R=n(R,A,L,E,b,20,d[31]),E=i(E,R,A,L,h,4,d[32]),L=i(L,E,R,A,m,11,d[33]),A=i(A,L,E,R,y,16,d[34]),R=i(R,A,L,E,k,23,d[35]),E=i(E,R,A,L,u,4,d[36]),L=i(L,E,R,A,f,11,d[37]),A=i(A,L,E,R,p,16,d[38]),R=i(R,A,L,E,g,23,d[39]),E=i(E,R,A,L,S,4,d[40]),L=i(L,E,R,A,s,11,d[41]),A=i(A,L,E,R,c,16,d[42]),R=i(R,A,L,E,_,23,d[43]),E=i(E,R,A,L,v,4,d[44]),L=i(L,E,R,A,b,11,d[45]),A=i(A,L,E,R,w,16,d[46]),R=i(R,A,L,E,l,23,d[47]),E=o(E,R,A,L,s,6,d[48]),L=o(L,E,R,A,p,10,d[49]),A=o(A,L,E,R,k,15,d[50]),R=o(R,A,L,E,h,21,d[51]),E=o(E,R,A,L,b,6,d[52]),L=o(L,E,R,A,c,10,d[53]),A=o(A,L,E,R,g,15,d[54]),R=o(R,A,L,E,u,21,d[55]),E=o(E,R,A,L,m,6,d[56]),L=o(L,E,R,A,w,10,d[57]),A=o(A,L,E,R,_,15,d[58]),R=o(R,A,L,E,S,21,d[59]),E=o(E,R,A,L,f,6,d[60]),L=o(L,E,R,A,y,10,d[61]),A=o(A,L,E,R,l,15,d[62]),R=o(R,A,L,E,v,21,d[63]);a[0]=a[0]+E|0,a[1]=a[1]+R|0,a[2]=a[2]+A|0,a[3]=a[3]+L|0},_doFinalize:function(){var t=this._data,n=t.words,r=8*this._nDataBytes,i=8*t.sigBytes;n[i>>>5]|=128<<24-i%32;var o=e.floor(r/4294967296);for(n[15+(i+64>>>9<<4)]=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),n[14+(i+64>>>9<<4)]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8),t.sigBytes=4*(n.length+1),this._process(),t=this._hash,n=t.words,r=0;4>r;r++)i=n[r],n[r]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8);return t},clone:function(){var e=l.clone.call(this);return e._hash=this._hash.clone(),e}}),a.MD5=l._createHelper(s),a.HmacMD5=l._createHmacHelper(s)}(Math),r.enc.u8array={stringify:function(e){for(var t=e.words,n=e.sigBytes,r=new Uint8Array(n),i=0;i<n;i++){var o=t[i>>>2]>>>24-i%4*8&255;r[i]=o}return t=n=null,r},parse:function(e){for(var t=e.length,n=[],i=0;i<t;i++)n[i>>>2]|=(255&e[i])<<24-i%4*8;var o=r.lib.WordArray.create(n,t);return n=null,o}};var i={};i.generateUUID=function(){var e=(new Date).getTime();return"xxxxxxxx-xxxx4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?n:3&n|8).toString(16)})},i.rc4=function(){this._skd=null,this._key=null,this._iv=null,this.init=function(e){if(this._skd=new Uint8Array(256),this._key=e,e.length<16)for(var t=e.length;t<16;t++)e+="0";else e.length>16&&(e=e.substring(0,16));var t,n,r=this._skd,i=0;for(t=0;t<256;t++)r[t]=t;for(t=0;t<256;t++)i=(i+r[t]+e.charCodeAt(t%e.length))%256,n=r[t],r[t]=r[i],r[i]=n},this.decrypt=function(e){var t,n,r,i=0,o=0,a=this._skd,s=new Uint8Array(e.length);for(r=0;r<s.length;r++)i=(i+1)%256,t=a[i],o=(o+t)%256,n=a[o],a[i]=n,a[o]=t,s[r]=e[r]^a[(t+n)%256];return s}},i.aes=function(){this.init=function(e,t){this._key=e,this._iv=t},this.decrypt=function(e){if(this._key&&this._iv){var t=this._key;if(t.length<16&&t.length>0)for(var n=t.length;n<16;n++)t+="0";else t.length>16&&(t=t.substring(0,16));var i=r.enc.Utf8.parse(t),o=r.enc.Utf8.parse(this._iv),a=r.enc.u8array.parse(e),s=r.AES.decrypt(r.enc.Base64.stringify(a),i,{iv:o,mode:r.mode.CBC,padding:r.pad.ZeroPadding}),u=r.enc.u8array.stringify(s);return s=i=a=o=null,u}return e}},i.Digest=function(e,t,n,i,o,a,s,u,l,d){var c=new Uint8Array(32),f=new Uint8Array(32),h=function(e,t){var n,r;for(n=0;n<16;n++)r=e[n]>>4&15,t[2*n]=r<=9?r+48:r+97-10,r=15&e[n],t[2*n+1]=r<=9?r+48:r+97-10;t[32]=0},_=r.algo.MD5.create();_.update(e),_.update(":"),_.update(i),_.update(":"),_.update(t);var p=_.finalize();"md5-sess"==n&&(_=r.algo.MD5.create(),_.update(r.enc.u8array.stringify(p)),_.update(":"),_.update(o),_.update(":"),_.update(a),p=_.finalize()),h(r.enc.u8array.stringify(p),c),p=null,_=null;var m=new Uint8Array(32),_=r.algo.MD5.create();_.update(u),_.update(":"),_.update(l),"auth-int"==d&&(_.update(":"),_.update(m));var v=_.finalize(),g=new Uint8Array(32);h(r.enc.u8array.stringify(v),g);var y=r.algo.MD5.create();y.update(r.enc.u8array.parse(c)),y.update(":"),y.update(o),y.update(":"),d&&(y.update(s),y.update(":"),y.update(a),y.update(":"),y.update(d),y.update(":")),y.update(r.enc.u8array.parse(g));var b=y.finalize();h(r.enc.u8array.stringify(b),f),_=null,y=null,b=null,v=null,g=null,p=null;for(var S="",k=0;k<f.length;k++)S+=String.fromCharCode(f[k]);return S},n.default=i},{}],16:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=e("../utils/logger.js"),s=r(a),u=e("../utils/utf8-conv.js"),l=r(u),d=e("../utils/exception.js"),c=function(){var e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256===new Int16Array(e)[0]}(),f=function(){function e(){i(this,e)}return o(e,null,[{key:"parseScriptData",value:function(t,n,r){var i={};try{var o=e.parseValue(t,n,r),a=e.parseValue(t,n+o.size,r-o.size);i[o.data]=a.data}catch(e){s.default.e("AMF",e.toString())}return i}},{key:"parseObject",value:function(t,n,r){if(r<3)throw new d.IllegalStateException("Data not enough when parse ScriptDataObject");var i=e.parseString(t,n,r),o=e.parseValue(t,n+i.size,r-i.size),a=o.objectEnd;return{data:{name:i.data,value:o.data},size:i.size+o.size,objectEnd:a}}},{key:"parseVariable",value:function(t,n,r){return e.parseObject(t,n,r)}},{key:"parseString",value:function(e,t,n){if(n<2)throw new d.IllegalStateException("Data not enough when parse String");var r=new DataView(e,t,n),i=r.getUint16(0,!c),o=void 0;return o=i>0?(0,l.default)(new Uint8Array(e,t+2,i)):"",{data:o,size:2+i}}},{key:"parseLongString",value:function(e,t,n){if(n<4)throw new d.IllegalStateException("Data not enough when parse LongString");var r=new DataView(e,t,n),i=r.getUint32(0,!c),o=void 0;return o=i>0?(0,l.default)(new Uint8Array(e,t+4,i)):"",{data:o,size:4+i}}},{key:"parseDate",value:function(e,t,n){if(n<10)throw new d.IllegalStateException("Data size invalid when parse Date");var r=new DataView(e,t,n),i=r.getFloat64(0,!c);return i+=60*r.getInt16(8,!c)*1e3,{data:new Date(i),size:10}}},{key:"parseValue",value:function(t,n,r){if(r<1)throw new d.IllegalStateException("Data not enough when parse Value");var i=new DataView(t,n,r),o=1,a=i.getUint8(0),u=void 0,l=!1;try{switch(a){case 0:u=i.getFloat64(1,!c),o+=8;break;case 1:u=!!i.getUint8(1),o+=1;break;case 2:var f=e.parseString(t,n+1,r-1);u=f.data,o+=f.size;break;case 3:u={};var h=0;for(9==(16777215&i.getUint32(r-4,!c))&&(h=3);o<r-4;){var _=e.parseObject(t,n+o,r-o-h);if(_.objectEnd)break;u[_.data.name]=_.data.value,o+=_.size}if(o<=r-3){9===(16777215&i.getUint32(o-1,!c))&&(o+=3)}break;case 8:u={},o+=4;var p=0;for(9==(16777215&i.getUint32(r-4,!c))&&(p=3);o<r-8;){var m=e.parseVariable(t,n+o,r-o-p);if(m.objectEnd)break;u[m.data.name]=m.data.value,o+=m.size}if(o<=r-3){9===(16777215&i.getUint32(o-1,!c))&&(o+=3)}break;case 9:u=void 0,o=1,l=!0;break;case 10:u=[];var v=i.getUint32(1,!c);o+=4;for(var g=0;g<v;g++){var y=e.parseValue(t,n+o,r-o);u.push(y.data),o+=y.size}break;case 11:var b=e.parseDate(t,n+1,r-1);u=b.data,o+=b.size;break;case 12:var S=e.parseString(t,n+1,r-1);u=S.data,o+=S.size;break;default:o=r,s.default.w("AMF","Unsupported AMF value type "+a)}}catch(e){s.default.e("AMF",e.toString())}return{data:u,size:o,objectEnd:l}}}]),e}();n.default=f},{"../utils/exception.js":43,"../utils/logger.js":44,"../utils/utf8-conv.js":47}],17:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r={OK:"OK",FORMAT_ERROR:"FormatError",FORMAT_UNSUPPORTED:"FormatUnsupported",CODEC_UNSUPPORTED:"CodecUnsupported"};n.default=r},{}],18:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=e("../utils/exception.js"),a=function(){function e(t){r(this,e),this.TAG="ExpGolomb",this._buffer=t,this._buffer_index=0,this._total_bytes=t.byteLength,this._total_bits=8*t.byteLength,this._current_word=0,this._current_word_bits_left=0}return i(e,[{key:"destroy",value:function(){this._buffer=null}},{key:"_fillCurrentWord",value:function(){var e=this._total_bytes-this._buffer_index;if(e<=0)throw new o.IllegalStateException("ExpGolomb: _fillCurrentWord() but no bytes available");var t=Math.min(4,e),n=new Uint8Array(4);n.set(this._buffer.subarray(this._buffer_index,this._buffer_index+t)),this._current_word=new DataView(n.buffer).getUint32(0,!1),this._buffer_index+=t,this._current_word_bits_left=8*t}},{key:"readBits",value:function(e){if(e>32)throw new o.InvalidArgumentException("ExpGolomb: readBits() bits exceeded max 32bits!");if(e<=this._current_word_bits_left){var t=this._current_word>>>32-e;return this._current_word<<=e,this._current_word_bits_left-=e,t}var n=this._current_word_bits_left?this._current_word:0;n>>>=32-this._current_word_bits_left;var r=e-this._current_word_bits_left;this._fillCurrentWord();var i=Math.min(r,this._current_word_bits_left),a=this._current_word>>>32-i;return this._current_word<<=i,this._current_word_bits_left-=i,n=n<<i|a}},{key:"readBool",value:function(){return 1===this.readBits(1)}},{key:"readByte",value:function(){return this.readBits(8)}},{key:"_skipLeadingZero",value:function(){var e=void 0;for(e=0;e<this._current_word_bits_left;e++)if(0!=(this._current_word&2147483648>>>e))return this._current_word<<=e,this._current_word_bits_left-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()}},{key:"readUEG",value:function(){var e=this._skipLeadingZero();return this.readBits(e+1)-1}},{key:"readSEG",value:function(){var e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)}}]),e}();n.default=a},{"../utils/exception.js":43}],19:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}Object.defineProperty(n,"__esModule",{value:!0});var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=e("../utils/logger.js"),l=r(u),d=e("./amf-parser.js"),c=r(d),f=e("./sps-parser.js"),h=r(f),_=e("./demux-errors.js"),p=r(_),m=e("../core/media-info.js"),v=r(m),g=e("../utils/exception.js"),y=e("../crypto/crypto.js"),b=r(y),S=e("../remux/aac-silent.js"),k=r(S),w=function(){function e(t,n){i(this,e),this.TAG="FLVDemuxer",this._config=n,this._onError=null,this._onMediaInfo=null,this._onTrackMetadata=null,this._onDataAvailable=null,this._dataOffset=t.dataOffset,this._firstParse=!0,this._dispatch=!1,this._hasAudio=t.hasAudioTrack,this._hasVideo=t.hasVideoTrack,this._hasAudioFlagOverrided=!1,this._hasVideoFlagOverrided=!1,this._audioInitialMetadataDispatched=!1,this._videoInitialMetadataDispatched=!1,this._mediaInfo=new v.default,this._mediaInfo.hasAudio=this._hasAudio,this._mediaInfo.hasVideo=this._hasVideo,this._metadata=null,this._audioMetadata=null,this._videoMetadata=null,this._naluLengthSize=4,this._timestampBase=0,this._timescale=1e3,this._duration=0,this._durationOverrided=!1,this._referenceFrameRate={fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},this._flvSoundRateTable=[5500,11025,22050,44100,48e3],this._mpegSamplingRates=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],this._mpegAudioV10SampleRateTable=[44100,48e3,32e3,0],this._mpegAudioV20SampleRateTable=[22050,24e3,16e3,0],this._mpegAudioV25SampleRateTable=[11025,12e3,8e3,0],this._mpegAudioL1BitRateTable=[0,32,64,96,128,160,192,224,256,288,320,352,384,416,448,-1],this._mpegAudioL2BitRateTable=[0,32,48,56,64,80,96,112,128,160,192,224,256,320,384,-1],this._mpegAudioL3BitRateTable=[0,32,40,48,56,64,80,96,112,128,160,192,224,256,320,-1],this._videoTrack={type:"video",id:1,sequenceNumber:0,samples:[],length:0},this._audioTrack={type:"audio",id:2,sequenceNumber:0,samples:[],length:0},this._littleEndian=function(){var e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256===new Int16Array(e)[0]}(),this._lastTagType=0,this._enableDecrypt=!1,this._rc4=new b.default.rc4,this._rc4.init(this._config.password),this._aes=new b.default.aes,this._aes.init(this._config.password,"0000000000000000"),this._inputSilent=this._hasAudio}return s(e,[{key:"destroy",value:function(){this._mediaInfo=null,this._metadata=null,this._audioMetadata=null,this._videoMetadata=null,this._videoTrack=null,this._audioTrack=null,this._onError=null,this._onMediaInfo=null,this._onTrackMetadata=null,this._onDataAvailable=null,this._enableDecrypt=!1,this._rc4=null,this._aes=null}},{key:"bindDataSource",value:function(e){return e.onDataArrival=this.parseChunks.bind(this),this}},{key:"resetMediaInfo",value:function(){this._mediaInfo=new v.default}},{key:"_isInitialMetadataDispatched",value:function(){return this._hasVideo&&this._videoInitialMetadataDispatched}},{key:"parseChunks",value:function(t,n){
if(!(this._onError&&this._onMediaInfo&&this._onTrackMetadata&&this._onDataAvailable))throw new g.IllegalStateException("Flv: onError & onMediaInfo & onTrackMetadata & onDataAvailable callback must be specified");var r=0,i=this._littleEndian;if(0===n){if(!(t.byteLength>13))return 0;r=e.probe(t).dataOffset}if(this._firstParse){this._firstParse=!1,n+r!==this._dataOffset&&l.default.w(this.TAG,"First time parsing but chunk byteStart invalid!");0!==new DataView(t,r).getUint32(0,!i)&&l.default.w(this.TAG,"PrevTagSize0 !== 0 !!!"),r+=4}for(;r<t.byteLength;){this._dispatch=!0;var o=new DataView(t,r);if(r+11+4>t.byteLength)break;var a=o.getUint8(0),s=16777215&o.getUint32(0,!i);if(r+11+s+4>t.byteLength)break;if(8===a||9===a||18===a){var u=o.getUint8(4),d=o.getUint8(5),c=o.getUint8(6),f=o.getUint8(7);f>63&&(f=0);var h=c|d<<8|u<<16|f<<24;0!==(16777215&o.getUint32(7,!i))&&l.default.w(this.TAG,"Meet tag which has StreamID != 0!");var _=r+11;switch(a){case 8:this._parseAudioData(t,_,s,h);break;case 9:this._parseVideoData(t,_,s,h,n+r);break;case 18:this._parseScriptData(t,_,s)}var p=o.getUint32(11+s,!i);p!==11+s&&l.default.w(this.TAG,"Invalid PrevTagSize "+p),r+=11+s+4}else l.default.w(this.TAG,"Unsupported tag type "+a+", skipped"),r+=11+s+4}return this._isInitialMetadataDispatched()&&this._dispatch&&(this._audioTrack.length||this._videoTrack.length)&&this._onDataAvailable(this._audioTrack,this._videoTrack),r}},{key:"_parseScriptData",value:function(e,t,n){var r=c.default.parseScriptData(e,t,n);if(r.hasOwnProperty("onMetaData")){if(null==r.onMetaData||"object"!==a(r.onMetaData))return void l.default.w(this.TAG,"Invalid onMetaData structure!");this._metadata&&l.default.w(this.TAG,"Found another onMetaData tag!"),this._metadata=r;var i=this._metadata.onMetaData;if("boolean"==typeof i.hasAudio&&!1===this._hasAudioFlagOverrided&&(this._hasAudio=i.hasAudio,this._mediaInfo.hasAudio=this._hasAudio,this._inputSilent=this._hasAudio),"boolean"==typeof i.hasVideo&&!1===this._hasVideoFlagOverrided&&(this._hasVideo=i.hasVideo,this._mediaInfo.hasVideo=this._hasVideo),"number"==typeof i.audiodatarate&&(this._mediaInfo.audioDataRate=i.audiodatarate),"number"==typeof i.videodatarate&&(this._mediaInfo.videoDataRate=i.videodatarate),"number"==typeof i.width&&(this._mediaInfo.width=i.width),"number"==typeof i.height&&(this._mediaInfo.height=i.height),"number"==typeof i.duration){if(!this._durationOverrided){var o=Math.floor(i.duration*this._timescale);this._duration=o,this._mediaInfo.duration=o}}else this._mediaInfo.duration=0;if("number"==typeof i.framerate){var s=Math.floor(1e3*i.framerate);if(s>0){var u=s/1e3;this._referenceFrameRate.fixed=!0,this._referenceFrameRate.fps=u,this._referenceFrameRate.fps_num=s,this._referenceFrameRate.fps_den=1e3,this._mediaInfo.fps=u}}if("object"===a(i.keyframes)){this._mediaInfo.hasKeyframesIndex=!0;var d=i.keyframes;this._mediaInfo.keyframesIndex=this._parseKeyframesIndex(d),i.keyframes=null}else this._mediaInfo.hasKeyframesIndex=!1;if(this._dispatch=!1,this._mediaInfo.metadata=i,l.default.v(this.TAG,"Parsed onMetaData"),this._mediaInfo.isComplete()&&this._onMediaInfo(this._mediaInfo),this._hasAudio){var f={};f.type="audio",f.id=2,f.timescale=1e3,f.duration=this._mediaInfo.duration,f.audioSampleRate=8e3,f.channelCount=1,f.codec="mp4a.40.5",f.originalCodec="mp4a.40.2",f.config=[45,1420,8,0],f.refSampleDuration=1024/f.audioSampleRate*f.timescale,this._dispatch=!1,this._onTrackMetadata("audio",f)}}}},{key:"_parseKeyframesIndex",value:function(e){for(var t=[],n=[],r=1;r<e.times.length;r++){var i=this._timestampBase+Math.floor(1e3*e.times[r]);t.push(i),n.push(e.filepositions[r])}return{times:t,filepositions:n}}},{key:"_parseAudioData",value:function(e,t,n,r){if(n<=1)return void l.default.w(this.TAG,"Flv: Invalid audio packet, missing SoundData payload!");if(!0!==this._hasAudioFlagOverrided||!1!==this._hasAudio){var i=(this._littleEndian,new DataView(e,t,n)),o=i.getUint8(0),a=o>>>4;if(2!==a&&10!==a)return void this._onError(p.default.CODEC_UNSUPPORTED,"Flv: Unsupported audio codec idx: "+a);var s=0,u=(12&o)>>>2;if(!(u>=0&&u<=4))return void this._onError(p.default.FORMAT_ERROR,"Flv: Invalid audio sample rate idx: "+u);s=this._flvSoundRateTable[u];var d=1&o,c=this._audioMetadata,f=this._audioTrack;if(c||(!1===this._hasAudio&&!1===this._hasAudioFlagOverrided&&(this._hasAudio=!0,this._mediaInfo.hasAudio=!0),c=this._audioMetadata={},c.type="audio",c.id=f.id,c.timescale=this._timescale,c.duration=this._duration,c.audioSampleRate=s,c.channelCount=0===d?1:2),10===a){var h=this._parseAACAudioData(e,t+1,n-1);if(void 0==h)return;if(0===h.packetType){c.config&&l.default.w(this.TAG,"Found another AudioSpecificConfig!");var _=h.data;c.audioSampleRate=_.samplingRate,c.channelCount=_.channelCount,c.codec=_.codec,c.originalCodec=_.originalCodec,c.config=_.config,c.refSampleDuration=1024/c.audioSampleRate*c.timescale,l.default.v(this.TAG,"Parsed AudioSpecificConfig"),this._isInitialMetadataDispatched()?this._dispatch&&(this._audioTrack.length||this._videoTrack.length)&&this._onDataAvailable(this._audioTrack,this._videoTrack):this._audioInitialMetadataDispatched=!0,this._dispatch=!1,this._onTrackMetadata("audio",c);var m=this._mediaInfo;m.audioCodec=c.originalCodec,m.audioSampleRate=c.audioSampleRate,m.audioChannelCount=c.channelCount,m.hasVideo?null!=m.videoCodec&&(m.mimeType='video/x-flv; codecs="'+m.videoCodec+","+m.audioCodec+'"'):m.mimeType='video/x-flv; codecs="'+m.audioCodec+'"',m.isComplete()&&this._onMediaInfo(m)}else if(1===h.packetType){this._inputSilent&&(this._inputSilent=!1);var v=this._timestampBase+r,g={unit:h.data,dts:v,pts:v};f.samples.push(g),f.length+=h.data.length}else l.default.e(this.TAG,"Flv: Unsupported AAC data type "+h.packetType)}else if(2===a){if(!c.codec){var y=this._parseMP3AudioData(e,t+1,n-1,!0);if(void 0==y)return;c.audioSampleRate=y.samplingRate,c.channelCount=y.channelCount,c.codec=y.codec,c.originalCodec=y.originalCodec,c.refSampleDuration=1152/c.audioSampleRate*c.timescale,l.default.v(this.TAG,"Parsed MPEG Audio Frame Header"),this._audioInitialMetadataDispatched=!0,this._onTrackMetadata("audio",c);var b=this._mediaInfo;b.audioCodec=c.codec,b.audioSampleRate=c.audioSampleRate,b.audioChannelCount=c.channelCount,b.audioDataRate=y.bitRate,b.hasVideo?null!=b.videoCodec&&(b.mimeType='video/x-flv; codecs="'+b.videoCodec+","+b.audioCodec+'"'):b.mimeType='video/x-flv; codecs="'+b.audioCodec+'"',b.isComplete()&&this._onMediaInfo(b)}var S=this._parseMP3AudioData(e,t+1,n-1,!1);if(void 0==S)return;var k=this._timestampBase+r,w={unit:S,dts:k,pts:k};f.samples.push(w),f.length+=S.length}}}},{key:"_parseAACAudioData",value:function(e,t,n){if(n<=1)return void l.default.w(this.TAG,"Flv: Invalid AAC packet, missing AACPacketType or/and Data!");var r={},i=new Uint8Array(e,t,n);return r.packetType=i[0],0===i[0]?r.data=this._parseAACAudioSpecificConfig(e,t+1,n-1):r.data=i.subarray(1),r}},{key:"_parseAACAudioSpecificConfig",value:function(e,t,n){var r=new Uint8Array(e,t,n),i=null,o=0,a=0,s=0,u=null;if(o=a=r[0]>>>3,(s=(7&r[0])<<1|r[1]>>>7)<0||s>=this._mpegSamplingRates.length)return void this._onError(p.default.FORMAT_ERROR,"Flv: AAC invalid sampling frequency index!");var l=this._mpegSamplingRates[s],d=(120&r[1])>>>3;if(d<0||d>=8)return void this._onError(p.default.FORMAT_ERROR,"Flv: AAC invalid channel configuration");5===o&&(u=(7&r[1])<<1|r[2]>>>7,r[2]);var c=self.navigator.userAgent.toLowerCase();return-1!==c.indexOf("firefox")?s>=6?(o=5,i=new Array(4),u=s-3):(o=2,i=new Array(2),u=s):-1!==c.indexOf("android")?(o=2,i=new Array(2),u=s):(o=5,u=s,i=new Array(4),s>=6?u=s-3:1===d&&(o=2,i=new Array(2),u=s)),i[0]=o<<3,i[0]|=(15&s)>>>1,i[1]=(15&s)<<7,i[1]|=(15&d)<<3,5===o&&(i[1]|=(15&u)>>>1,i[2]=(1&u)<<7,i[2]|=8,i[3]=0),{config:i,samplingRate:l,channelCount:d,codec:"mp4a.40."+o,originalCodec:"mp4a.40."+a}}},{key:"_parseMP3AudioData",value:function(e,t,n,r){if(n<4)return void l.default.w(this.TAG,"Flv: Invalid MP3 packet, header missing!");var i=(this._littleEndian,new Uint8Array(e,t,n)),o=null;if(r){if(255!==i[0])return;var a=i[1]>>>3&3,s=(6&i[1])>>1,u=(240&i[2])>>>4,d=(12&i[2])>>>2,c=i[3]>>>6&3,f=3!==c?2:1,h=0,_=0;switch(a){case 0:h=this._mpegAudioV25SampleRateTable[d];break;case 2:h=this._mpegAudioV20SampleRateTable[d];break;case 3:h=this._mpegAudioV10SampleRateTable[d]}switch(s){case 1:34,u<this._mpegAudioL3BitRateTable.length&&(_=this._mpegAudioL3BitRateTable[u]);break;case 2:33,u<this._mpegAudioL2BitRateTable.length&&(_=this._mpegAudioL2BitRateTable[u]);break;case 3:32,u<this._mpegAudioL1BitRateTable.length&&(_=this._mpegAudioL1BitRateTable[u])}o={bitRate:_,samplingRate:h,channelCount:f,codec:"mp3",originalCodec:"mp3"}}else o=i;return o}},{key:"_parseVideoData",value:function(e,t,n,r,i){if(n<=1)return void l.default.w(this.TAG,"Flv: Invalid video packet, missing VideoData payload!");if(!0!==this._hasVideoFlagOverrided||!1!==this._hasVideo){var o=new Uint8Array(e,t,n)[0],a=(240&o)>>>4,s=15&o;if(7!==s)return void this._onError(p.default.CODEC_UNSUPPORTED,"Flv: Unsupported codec in video frame: "+s);this._parseAVCVideoPacket(e,t+1,n-1,r,i,a)}}},{key:"_parseAVCVideoPacket",value:function(e,t,n,r,i,o){if(n<4)return void l.default.w(this.TAG,"Flv: Invalid AVC packet, missing AVCPacketType or/and CompositionTime");var a=this._littleEndian,s=new DataView(e,t,n),u=s.getUint8(0),d=16777215&s.getUint32(0,!a);if(0===u)this._parseAVCDecoderConfigurationRecord(e,t+4,n-4);else if(1===u)this._parseAVCVideoData(e,t+4,n-4,r,i,o,d);else if(2!==u)return void this._onError(p.default.FORMAT_ERROR,"Flv: Invalid video packet type "+u)}},{key:"_parseAVCDecoderConfigurationRecord",value:function(e,t,n){if(n<7)return void l.default.w(this.TAG,"Flv: Invalid AVCDecoderConfigurationRecord, lack of data!");var r=this._videoMetadata,i=this._videoTrack,o=this._littleEndian,a=new DataView(e,t,n);r?void 0!==r.avcc&&l.default.w(this.TAG,"Found another AVCDecoderConfigurationRecord!"):(!1===this._hasVideo&&!1===this._hasVideoFlagOverrided&&(this._hasVideo=!0,this._mediaInfo.hasVideo=!0),r=this._videoMetadata={},r.type="video",r.id=i.id,r.timescale=this._timescale,r.duration=this._duration);var s=a.getUint8(0),u=a.getUint8(1);a.getUint8(2),a.getUint8(3);if(1!==s||0===u)return void this._onError(p.default.FORMAT_ERROR,"Flv: Invalid AVCDecoderConfigurationRecord");if(this._naluLengthSize=1+(3&a.getUint8(4)),3!==this._naluLengthSize&&4!==this._naluLengthSize)return void this._onError(p.default.FORMAT_ERROR,"Flv: Strange NaluLengthSizeMinusOne: "+(this._naluLengthSize-1));var d=31&a.getUint8(5);if(0===d)return void this._onError(p.default.FORMAT_ERROR,"Flv: Invalid AVCDecoderConfigurationRecord: No SPS");d>1&&l.default.w(this.TAG,"Flv: Strange AVCDecoderConfigurationRecord: SPS Count = "+d);var c=6;this._lastTagType=1,this._config.password&&this._enableDecrypt&&this._rc4.init(this._config.password);for(var f=0,_=0;_<d;_++){var m=a.getUint16(c,!o);if(c+=2,0!==m){if(this._config.password&&this._enableDecrypt){var v=new Uint8Array(e,t+c+1,m-1),g=this._aes.decrypt(v);a.setUint8(c-1,g.length+1,!o),v.set(g),f=g.length-v.length,v=g=null}var y=new Uint8Array(e,t+c,m+f);c+=m;var b=h.default.parseSPS(y);if(0===_){r.codecWidth=b.codec_size.width,r.codecHeight=b.codec_size.height,r.presentWidth=b.present_size.width,r.presentHeight=b.present_size.height,r.profile=b.profile_string,r.profileValue=b.profile_value,r.level=b.level_string,r.bitDepth=b.bit_depth,r.chromaFormat=b.chroma_format,r.sarRatio=b.sar_ratio,r.frameRate=b.frame_rate,!1!==b.frame_rate.fixed&&0!==b.frame_rate.fps_num&&0!==b.frame_rate.fps_den||(r.frameRate=this._referenceFrameRate);var S=r.frameRate.fps_den,k=r.frameRate.fps_num;r.refSampleDuration=r.timescale*(S/k);for(var w=y.subarray(1,4),E="avc1.",R=0;R<3;R++){var A=w[R].toString(16);A.length<2&&(A="0"+A),E+=A}"avc1.640032"==E&&(E="avc1.4d0014"),r.codec=E;var L=this._mediaInfo;L.width=r.codecWidth,L.height=r.codecHeight,L.fps=r.frameRate.fps,L.profile=r.profile,L.level=r.level,L.chromaFormat=b.chroma_format_string,L.sarNum=r.sarRatio.width,L.sarDen=r.sarRatio.height,L.videoCodec=E,L.hasAudio?null!=L.audioCodec&&(L.mimeType='video/x-flv; codecs="'+L.videoCodec+","+L.audioCodec+'"'):L.mimeType='video/x-flv; codecs="'+L.videoCodec+'"',L.isComplete()&&this._onMediaInfo(L)}}}var T=a.getUint8(c);if(0===T)return void this._onError(p.default.FORMAT_ERROR,"Flv: Invalid AVCDecoderConfigurationRecord: No PPS");T>1&&l.default.w(this.TAG,"Flv: Strange AVCDecoderConfigurationRecord: PPS Count = "+T),c++;for(var C=0,O=0;O<T;O++){var x=a.getUint16(c,!o);if(c+=2,0!==x){if(this._config.password&&this._enableDecrypt){var D=new Uint8Array(e,t+c+1,x-1),I=this._aes.decrypt(D);a.setUint8(c-1,I.length+1),D.set(I),C=I.length-D.length,D=I=null}c+=x}}r.avcc=new Uint8Array(n+f+C);var M=new Uint8Array(e,t,n+f+C);if(M[1]!=r.profileValue&&(M[1]=r.profileValue),this._config.password&&this._config.password.length>0&&this._enableDecrypt)for(var B=22;B<29;B++)M[B]=a.getUint8(B+3);r.avcc.set(M,0),l.default.v(this.TAG,"Parsed AVCDecoderConfigurationRecord"),this._isInitialMetadataDispatched()?this._dispatch&&(this._audioTrack.length||this._videoTrack.length)&&this._onDataAvailable(this._audioTrack,this._videoTrack):this._videoInitialMetadataDispatched=!0,this._dispatch=!1,this._onTrackMetadata("video",r)}},{key:"_parseAVCVideoData",value:function(e,t,n,r,i,o,a){for(var s=this._littleEndian,u=new DataView(e,t,n),d=[],c=0,f=0,h=this._naluLengthSize,_=this._timestampBase+r,p=1===o;f<n;){if(f+4>=n){l.default.w(this.TAG,"Malformed Nalu near timestamp "+_+", offset = "+f+", dataSize = "+n);break}var m=u.getUint32(f,!s);if(3===h&&(m>>>=8),m>n-h)return void l.default.w(this.TAG,"Malformed Nalus near timestamp "+_+", NaluSize > DataSize!");this._config.password&&this._config.password.length>0&&this._enableDecrypt;var v=31&u.getUint8(f+h);if(5===v&&(p=!0,this._lastTagType=1),this._inputSilent){var g=k.default.getSilentFrame("mp4a.40.2",1),y=this._audioTrack,b={unit:g,dts:_,pts:_,duration:35};y.samples.push(b),y.length+=g.byteLength}var S=0;if(this._config.password&&this._config.password.length>0&&this._enableDecrypt){var w=new Uint8Array(e,t+f+5,h+m-5),E=this._aes.decrypt(w);u.setUint32(f,E.length+1,!s),w.set(E),S=E.length-w.length,w=E=null}var R=new Uint8Array(e,t+f,h+m+S),A={type:v,data:R};d.push(A),c+=R.byteLength,f+=h+m}if(d.length){var L=this._videoTrack,T={units:d,length:c,isKeyframe:p,dts:_,cts:a,pts:_+a};p&&(T.fileposition=i),L.samples.push(T),L.length+=c}}},{key:"enableDecrypt",value:function(e){this._enableDecrypt=e}},{key:"onTrackMetadata",get:function(){return this._onTrackMetadata},set:function(e){this._onTrackMetadata=e}},{key:"onMediaInfo",get:function(){return this._onMediaInfo},set:function(e){this._onMediaInfo=e}},{key:"onError",get:function(){return this._onError},set:function(e){this._onError=e}},{key:"onDataAvailable",get:function(){return this._onDataAvailable},set:function(e){this._onDataAvailable=e}},{key:"timestampBase",get:function(){return this._timestampBase},set:function(e){this._timestampBase=e}},{key:"overridedDuration",get:function(){return this._duration},set:function(e){this._durationOverrided=!0,this._duration=e,this._mediaInfo.duration=e}},{key:"overridedHasAudio",set:function(e){this._hasAudioFlagOverrided=!0,this._hasAudio=e,this._mediaInfo.hasAudio=e,this._inputSilent=e}},{key:"overridedHasVideo",set:function(e){this._hasVideoFlagOverrided=!0,this._hasVideo=e,this._mediaInfo.hasVideo=e}}],[{key:"probe",value:function(e){var t=new Uint8Array(e),n={match:!1};if(70!==t[0]||76!==t[1]||86!==t[2]||1!==t[3])return n;var r=(4&t[4])>>>2!=0,i=0!=(1&t[4]),a=o(t,5);return a<9?n:{match:!0,consumed:a,dataOffset:a,hasAudioTrack:r,hasVideoTrack:i}}}]),e}();n.default=w},{"../core/media-info.js":7,"../crypto/crypto.js":15,"../remux/aac-silent.js":39,"../utils/exception.js":43,"../utils/logger.js":44,"./amf-parser.js":16,"./demux-errors.js":17,"./sps-parser.js":20}],20:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=e("./exp-golomb.js"),a=function(e){return e&&e.__esModule?e:{default:e}}(o),s=function(){function e(){r(this,e)}return i(e,null,[{key:"_ebsp2rbsp",value:function(e){for(var t=e,n=t.byteLength,r=new Uint8Array(n),i=0,o=0;o<n;o++)o>=2&&3===t[o]&&0===t[o-1]&&0===t[o-2]||(r[i]=t[o],i++);return new Uint8Array(r.buffer,0,i)}},{key:"parseSPS",value:function(t){var n=e._ebsp2rbsp(t),r=new a.default(n);r.readByte();var i=r.readByte();r.readByte();var o=r.readByte();r.readUEG();var s=e.getProfileString(i),u=e.getLevelString(o),l=1,d=420,c=[0,420,422,444],f=8;if((100===i||110===i||122===i||244===i||44===i||83===i||86===i||118===i||128===i||138===i||144===i)&&(l=r.readUEG(),3===l&&r.readBits(1),l<=3&&(d=c[l]),f=r.readUEG()+8,r.readUEG(),r.readBits(1),r.readBool()))for(var h=3!==l?8:12,_=0;_<h;_++)r.readBool()&&(_<6?e._skipScalingList(r,16):e._skipScalingList(r,64));r.readUEG();var p=r.readUEG();if(0===p)r.readUEG();else if(1===p){r.readBits(1),r.readSEG(),r.readSEG();for(var m=r.readUEG(),v=0;v<m;v++)r.readSEG()}r.readUEG(),r.readBits(1);var g=r.readUEG(),y=r.readUEG(),b=r.readBits(1);0===b&&r.readBits(1),r.readBits(1);var S=0,k=0,w=0,E=0;r.readBool()&&(S=r.readUEG(),k=r.readUEG(),w=r.readUEG(),E=r.readUEG());var R=1,A=1,L=0,T=!0,C=0,O=0;if(r.readBool()){if(r.readBool()){var x=r.readByte(),D=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2],I=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];x>0&&x<16?(R=D[x-1],A=I[x-1]):255===x&&(R=r.readByte()<<8|r.readByte(),A=r.readByte()<<8|r.readByte())}if(r.readBool()&&r.readBool(),r.readBool()&&(r.readBits(4),r.readBool()&&r.readBits(24)),r.readBool()&&(r.readUEG(),r.readUEG()),r.readBool()){var M=r.readBits(32),B=r.readBits(32);T=r.readBool(),C=B,O=2*M,L=C/O}}var j=1;1===R&&1===A||(j=R/A);var P=0,U=0;if(0===l)P=1,U=2-b;else{var N=3===l?1:2,F=1===l?2:1;P=N,U=F*(2-b)}var V=16*(g+1),z=16*(y+1)*(2-b);V-=(S+k)*P,z-=(w+E)*U;var G=Math.ceil(V*j);return r.destroy(),r=null,{profile_value:i,profile_string:s,level_string:u,bit_depth:f,chroma_format:d,chroma_format_string:e.getChromaFormatString(d),frame_rate:{fixed:T,fps:L,fps_den:O,fps_num:C},sar_ratio:{width:R,height:A},codec_size:{width:V,height:z},present_size:{width:G,height:z}}}},{key:"_skipScalingList",value:function(e,t){for(var n=8,r=8,i=0,o=0;o<t;o++)0!==r&&(i=e.readSEG(),r=(n+i+256)%256),n=0===r?n:r}},{key:"getProfileString",value:function(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}},{key:"getLevelString",value:function(e){return(e/10).toFixed(1)}},{key:"getChromaFormatString",value:function(e){switch(e){case 420:return"4:2:0";case 422:return"4:2:2";case 444:return"4:4:4";default:return"Unknown"}}}]),e}();n.default=s},{"./exp-golomb.js":18}],21:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){var n=e;if(null==n||"object"!==(void 0===n?"undefined":s(n)))throw new S.InvalidArgumentException("MediaDataSource must be an javascript object!");if(!n.hasOwnProperty("type"))throw new S.InvalidArgumentException("MediaDataSource must has type field to indicate video file type!");switch(n.type){case"flv":return new h.default(n,t);case"janusstream":return new w.default(n,t);default:return new p.default(n,t)}}function o(){return c.default.supportMSEH264Playback()}function a(){return c.default.getFeatureList()}Object.defineProperty(n,"__esModule",{value:!0});var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},u=e("./utils/polyfill.js"),l=r(u),d=e("./core/features.js"),c=r(d),f=e("./player/flv-player.js"),h=r(f),_=e("./player/native-player.js"),p=r(_),m=e("./player/player-events.js"),v=r(m),g=e("./player/player-errors.js"),y=e("./utils/logging-control.js"),b=r(y),S=e("./utils/exception.js"),k=e("./player/janusstream-player.js"),w=r(k);l.default.install();var E={};E.createPlayer=i,E.isSupported=o,E.getFeatureList=a,E.Events=v.default,E.ErrorTypes=g.ErrorTypes,E.ErrorDetails=g.ErrorDetails,E.FlvPlayer=h.default,E.NativePlayer=p.default,E.JanusStreamPlayer=w.default,E.LoggingControl=b.default,Object.defineProperty(E,"version",{enumerable:!0,get:function(){return"1.3.3"}}),n.default=E},{"./core/features.js":6,"./player/flv-player.js":33,"./player/janusstream-player.js":35,"./player/native-player.js":36,"./player/player-errors.js":37,"./player/player-events.js":38,"./utils/exception.js":43,"./utils/logging-control.js":45,"./utils/polyfill.js":46}],22:[function(e,t,n){"use strict";t.exports=e("./flv.js").default},{"./flv.js":21}],23:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(n,"__esModule",{value:!0});var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},u=function e(t,n,r){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,n,r)}if("value"in i)return i.value;var a=i.get;if(void 0!==a)return a.call(r)},l=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),d=e("../utils/logger.js"),c=(r(d),e("../utils/browser.js")),f=r(c),h=e("./loader.js"),_=e("../utils/exception.js"),p=e("../crypto/crypto.js"),m=r(p),v=function(e){function t(e,n){i(this,t);var r=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"fetch-stream-loader"));return r.TAG="FetchStreamLoader",r._seekHandler=e,r._config=n,r._needStash=!0,r._requestAbort=!1,r._contentLength=null,r._receivedLength=0,r._requestURL="",r._bInvaidPwd=!1,r._authInfo=null,r}return a(t,e),l(t,null,[{key:"isSupported",value:function(){try{var e=f.default.msedge&&f.default.version.minor>=15048,t=!f.default.msedge||e;return self.fetch&&self.ReadableStream&&t}catch(e){return!1}}}]),l(t,[{key:"destroy",value:function(){this.isWorking()&&this.abort(),u(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"open",value:function(e,t){var n=this;this._dataSource=e,this._range=t,this._receivedLength=0;var r=e.url;this._config.reuseRedirectedURL&&void 0!=e.redirectedURL&&(r=e.redirectedURL);var i=this._seekHandler.getConfig(r,t);this._requestURL=i.url;var o=new self.Headers;if("object"===s(i.headers)){var a=i.headers;for(var u in a)a.hasOwnProperty(u)&&o.append(u,a[u])}this._authInfo&&this._authInfo.length?(o.append("Authorization",this._authInfo),this._authInfo=null):(this._config.date&&o.append("x-amz-date",this._config.date),this._config.auth&&o.append("Authorization",this._config.auth));var l={method:"GET",headers:o,mode:"cors",cache:"default",referrerPolicy:"no-referrer-when-downgrade"};!1===e.cors&&(l.mode="same-origin"),e.withCredentials&&(l.credentials="include"),e.referrerPolicy&&(l.referrerPolicy=e.referrerPolicy),this._status=h.LoaderStatus.kConnecting,self.fetch(i.url,l).then(function(e){if(n._requestAbort)return n._authInfo=null,n._requestAbort=!1,void(n._status=h.LoaderStatus.kIdle);if(e.ok&&e.status>=200&&e.status<=299){if(n._authInfo=null,e.url!==i.url&&n._onURLRedirect){var t=n._seekHandler.removeURLParameters(e.url);n._onURLRedirect(t)}var r=e.headers.get("Content-Length");null!=r&&(n._contentLength=parseInt(r),0!==n._contentLength&&n._onContentLengthKnown&&n._onContentLengthKnown(n._contentLength));var o="true"===e.headers.get("Secretive");return console.log("encrypted ? "+o),n.onOpened(o),n._pump.call(n,e.body.getReader())}if(401==e.status&&!n._bInvaidPwd){(e.redirected||e.url&&e.url.length&&e.url!=n._dataSource.url)&&(n._dataSource.url=n._requestURL=e.url),n._bInvaidPwd=!0;var a=e.headers.get("WWW-Authenticate"),s=a.indexOf('realm="')+7,u=a.substring(s,a.indexOf(",",s)-1);s=a.indexOf('qop="')+5;var l=a.substring(s,a.indexOf(",",s)-1);l.replace('"',""),s=a.indexOf('nonce="')+7;var d=a.substring(s,a.indexOf('"',s));s=a.indexOf('algorithm="')+11;var c=a.substring(s,a.indexOf(",",s)-1),f=n._config.username,p=n._config.password,v=n._requestURL.substring(n._requestURL.indexOf("/",8),n._requestURL.length),g=m.default.generateUUID(),y=m.default.Digest(f,p,c,u,d,g,"00000001","GET",v,l);return n._authInfo='Digest username="'+f+'", realm="'+u+'", nonce="'+d+'", uri="'+v+'", algorithm='+c+', response="'+y+'", opaque="5ccc069c403ebaf9f0171e9517f40e41", qop="'+l+'", nc=00000001, cnonce="'+g+'"',void n.open(n._dataSource,n._range)}if(n._status=h.LoaderStatus.kError,!n._onError)throw new _.RuntimeException("FetchStreamLoader: Http code invalid, "+e.status+" "+e.statusText);n._onError(h.LoaderErrors.HTTP_STATUS_CODE_INVALID,{code:e.status,msg:e.statusText})}).catch(function(e){if(n._status=h.LoaderStatus.kError,!n._onError)throw e;n._onError(h.LoaderErrors.EXCEPTION,{code:-1,msg:e.message})})}},{key:"abort",value:function(){this._authInfo=null,this._bInvaidPwd=!1,this._requestAbort=!0}},{key:"_pump",value:function(e){var t=this;return e.read().then(function(n){if(n.done)t._status=h.LoaderStatus.kComplete,t._onComplete&&t._onComplete(t._range.from,t._range.from+t._receivedLength-1);else{if(!0===t._requestAbort)return t._requestAbort=!1,t._status=h.LoaderStatus.kComplete,e.cancel();t._status=h.LoaderStatus.kBuffering;var r=n.value.buffer,i=t._range.from+t._receivedLength;t._receivedLength+=r.byteLength,t._onDataArrival&&t._onDataArrival(r,i,t._receivedLength),t._pump(e)}}).catch(function(e){if(11!==e.code||!f.default.msedge){t._status=h.LoaderStatus.kError;var n=0,r=null;if(19!==e.code&&"network error"!==e.message||!(null===t._contentLength||null!==t._contentLength&&t._receivedLength<t._contentLength)?(n=h.LoaderErrors.EXCEPTION,r={code:e.code,msg:e.message}):(n=h.LoaderErrors.EARLY_EOF,r={code:e.code,msg:"Fetch stream meet Early-EOF"}),!t._onError)throw new _.RuntimeException(r.msg);t._onError(n,r)}})}}]),t}(h.BaseLoader);n.default=v},{"../crypto/crypto.js":15,"../utils/browser.js":42,"../utils/exception.js":43,"../utils/logger.js":44,"./loader.js":25}],24:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=e("../utils/logger.js"),s=r(a),u=e("./speed-sampler.js"),l=r(u),d=e("./loader.js"),c=e("./fetch-stream-loader.js"),f=r(c),h=e("./xhr-moz-chunked-loader.js"),_=r(h),p=e("./xhr-msstream-loader.js"),m=(r(p),e("./xhr-range-loader.js")),v=r(m),g=e("./websocket-loader.js"),y=r(g),b=e("./range-seek-handler.js"),S=r(b),k=e("./param-seek-handler.js"),w=r(k),E=e("../utils/exception.js"),R=function(){function e(t,n,r){i(this,e),this.TAG="IOController",this._config=n,this._extraData=r,this._stashInitialSize=393216,void 0!=n.stashInitialSize&&n.stashInitialSize>0&&(this._stashInitialSize=n.stashInitialSize),this._stashUsed=0,this._stashSize=this._stashInitialSize,this._bufferSize=3145728,this._stashBuffer=new ArrayBuffer(this._bufferSize),this._stashByteStart=0,this._enableStash=!0,!1===n.enableStashBuffer&&(this._enableStash=!1),this._loader=null,this._loaderClass=null,this._seekHandler=null,this._dataSource=t,this._isWebSocketURL=/wss?:\/\/(.+?)/.test(t.url),this._refTotalLength=t.filesize?t.filesize:null,this._totalLength=this._refTotalLength,this._fullRequestFlag=!1,this._currentRange=null,this._redirectedURL=null,this._speedNormalized=0,this._speedSampler=new l.default,this._speedNormalizeList=[64,128,256,384,512,768,1024,1536,2048,3072,4096],this._isEarlyEofReconnecting=!1,this._paused=!1,this._resumeFrom=0,this._onDataArrival=null,this._onSeeked=null,this._onError=null,this._onComplete=null,this._onRedirect=null,this._onRecoveredEarlyEof=null,this._selectSeekHandler(),this._selectLoader(),this._createLoader()}return o(e,[{key:"destroy",value:function(){this._loader.isWorking()&&this._loader.abort(),this._loader.destroy(),this._loader=null,this._loaderClass=null,this._dataSource=null,this._stashBuffer=null,this._stashUsed=this._stashSize=this._bufferSize=this._stashByteStart=0,this._currentRange=null,this._speedSampler=null,this._isEarlyEofReconnecting=!1,this._onDataArrival=null,this._onSeeked=null,this._onError=null,this._onComplete=null,this._onRedirect=null,this._onRecoveredEarlyEof=null,this._extraData=null}},{key:"isWorking",value:function(){return this._loader&&this._loader.isWorking()&&!this._paused}},{key:"isPaused",value:function(){return this._paused}},{key:"_selectSeekHandler",value:function(){var e=this._config;if("range"===e.seekType)this._seekHandler=new S.default(this._config.rangeLoadZeroStart);else if("param"===e.seekType){var t=e.seekParamStart||"bstart",n=e.seekParamEnd||"bend";this._seekHandler=new w.default(t,n)}else{if("custom"!==e.seekType)throw new E.InvalidArgumentException("Invalid seekType in config: "+e.seekType);if("function"!=typeof e.customSeekHandler)throw new E.InvalidArgumentException("Custom seekType specified in config but invalid customSeekHandler!");this._seekHandler=new e.customSeekHandler}}},{key:"_selectLoader",value:function(){if(this._isWebSocketURL)this._loaderClass=y.default;else if(f.default.isSupported())this._loaderClass=f.default;else if(_.default.isSupported())this._loaderClass=_.default;else{if(!v.default.isSupported())throw new E.RuntimeException("Your browser doesn't support xhr with arraybuffer responseType!");this._loaderClass=v.default}}},{key:"_createLoader",value:function(){this._loader=new this._loaderClass(this._seekHandler,this._config),!1===this._loader.needStashBuffer&&(this._enableStash=!1),this._loader.onContentLengthKnown=this._onContentLengthKnown.bind(this),this._loader.onURLRedirect=this._onURLRedirect.bind(this),this._loader.onDataArrival=this._onLoaderChunkArrival.bind(this),this._loader.onComplete=this._onLoaderComplete.bind(this),this._loader.onError=this._onLoaderError.bind(this),this._loader.onOpened=this._onIOOpened.bind(this)}},{key:"open",value:function(e){this._currentRange={from:0,to:-1},this._speedSampler.reset(),e||(this._fullRequestFlag=!0),this._loader.open(this._dataSource,Object.assign({},this._currentRange))}},{key:"abort",value:function(){this._loader.abort(),this._paused&&(this._paused=!1,this._resumeFrom=0)}},{key:"pause",value:function(){this.isWorking()&&(this._loader.abort(),0!==this._stashUsed?(this._resumeFrom=this._stashByteStart,this._currentRange.to=this._stashByteStart-1):this._resumeFrom=this._currentRange.to+1,this._stashUsed=0,this._stashByteStart=0,this._paused=!0)}},{key:"resume",value:function(){if(this._paused){
this._paused=!1;var e=this._resumeFrom;this._resumeFrom=0,this._internalSeek(e,!0)}}},{key:"resumeTime",value:function(e){this._paused&&(this._paused=!1,this._resumeFrom=0,this._internalSeekTime(e,!0))}},{key:"seek",value:function(e){this._paused=!1,this._stashUsed=0,this._stashByteStart=0,this._internalSeek(e,!0)}},{key:"_internalSeek",value:function(e,t){this._loader.isWorking()&&this._loader.abort(),this._flushStashBuffer(t),this._loader.destroy(),this._loader=null;var n={from:e,to:-1};this._currentRange={from:n.from,to:-1},this._speedSampler.reset(),this._stashSize=this._stashInitialSize,this._createLoader(),this._loader.open(this._dataSource,n),this._loader._range.from=0,this._onSeeked&&this._onSeeked()}},{key:"_internalSeekTime",value:function(e,t){this._loader.isWorking()&&this._loader.abort(),this._flushStashBuffer(t),this._loader.destroy(),this._loader=null;var n={from:0,to:-1,time:e};this._currentRange={from:n.from,to:-1,time:e},this._speedSampler.reset(),this._stashSize=this._stashInitialSize,this._createLoader(),this._loader.open(this._dataSource,n),this._loader._range.from=0,this.updateUrl(this._loader._requestURL),this._onSeeked&&this._onSeeked()}},{key:"updateUrl",value:function(e){if(!e||"string"!=typeof e||0===e.length)throw new E.InvalidArgumentException("Url must be a non-empty string!");this._dataSource.url=e,console.log("update url "+e)}},{key:"_expandBuffer",value:function(e){for(var t=this._stashSize;t+1048576<e;)t*=2;if((t+=1048576)!==this._bufferSize){var n=new ArrayBuffer(t);if(this._stashUsed>0){var r=new Uint8Array(this._stashBuffer,0,this._stashUsed);new Uint8Array(n,0,t).set(r,0)}this._stashBuffer=n,this._bufferSize=t}}},{key:"_normalizeSpeed",value:function(e){var t=this._speedNormalizeList,n=t.length-1,r=0,i=0,o=n;if(e<t[0])return t[0];for(;i<=o;){if((r=i+Math.floor((o-i)/2))===n||e>=t[r]&&e<t[r+1])return t[r];t[r]<e?i=r+1:o=r-1}}},{key:"_adjustStashSize",value:function(e){var t=0;(t=this._config.isLive?e:e<512?e:e>=512&&e<=1024?Math.floor(1.5*e):2*e)>8192&&(t=8192);var n=1024*t+1048576;this._bufferSize<n&&this._expandBuffer(n),this._stashSize=1024*t}},{key:"_dispatchChunks",value:function(e,t){return this._currentRange.to=t+e.byteLength-1,this._onDataArrival(e,t)}},{key:"_onIOOpened",value:function(e){this.onOpened&&this.onOpened(e)}},{key:"_onURLRedirect",value:function(e){this._redirectedURL=e,this._onRedirect&&this._onRedirect(e)}},{key:"_onContentLengthKnown",value:function(e){e&&this._fullRequestFlag&&(this._totalLength=e,this._fullRequestFlag=!1)}},{key:"_onLoaderChunkArrival",value:function(e,t,n){if(!this._onDataArrival)throw new E.IllegalStateException("IOController: No existing consumer (onDataArrival) callback!");if(!this._paused)if(this._isEarlyEofReconnecting&&(this._isEarlyEofReconnecting=!1,this._onRecoveredEarlyEof&&this._onRecoveredEarlyEof()),this._speedSampler.addBytes(e.byteLength),this._enableStash)if(0===this._stashUsed&&0===this._stashByteStart&&(this._stashByteStart=t),this._stashUsed+e.byteLength<=this._stashSize){var r=new Uint8Array(this._stashBuffer,0,this._stashSize);r.set(new Uint8Array(e),this._stashUsed),this._stashUsed+=e.byteLength}else{var i=new Uint8Array(this._stashBuffer,0,this._bufferSize);if(this._stashUsed>0){var o=this._stashBuffer.slice(0,this._stashUsed),a=this._dispatchChunks(o,this._stashByteStart);if(a<o.byteLength){if(a>0){var s=new Uint8Array(o,a);i.set(s,0),this._stashUsed=s.byteLength,this._stashByteStart+=a}}else this._stashUsed=0,this._stashByteStart+=a;this._stashUsed+e.byteLength>this._bufferSize&&(this._expandBuffer(this._stashUsed+e.byteLength),i=new Uint8Array(this._stashBuffer,0,this._bufferSize)),i.set(new Uint8Array(e),this._stashUsed),this._stashUsed+=e.byteLength}else{var u=this._dispatchChunks(e,t);if(u<e.byteLength){var l=e.byteLength-u;l>this._bufferSize&&(this._expandBuffer(l),i=new Uint8Array(this._stashBuffer,0,this._bufferSize)),i.set(new Uint8Array(e,u),0),this._stashUsed+=l,this._stashByteStart=t+u}}}else if(0===this._stashUsed){var d=this._dispatchChunks(e,t);if(d<e.byteLength){var c=e.byteLength-d;c>this._bufferSize&&this._expandBuffer(c);var f=new Uint8Array(this._stashBuffer,0,this._bufferSize);f.set(new Uint8Array(e,d),0),this._stashUsed+=c,this._stashByteStart=t+d}}else{this._stashUsed+e.byteLength>this._bufferSize&&this._expandBuffer(this._stashUsed+e.byteLength);var h=new Uint8Array(this._stashBuffer,0,this._bufferSize);h.set(new Uint8Array(e),this._stashUsed),this._stashUsed+=e.byteLength;var _=this._dispatchChunks(this._stashBuffer.slice(0,this._stashUsed),this._stashByteStart);if(_<this._stashUsed&&_>0){var p=new Uint8Array(this._stashBuffer,_);h.set(p,0)}this._stashUsed-=_,this._stashByteStart+=_}}},{key:"_flushStashBuffer",value:function(e){if(this._stashUsed>0){var t=this._stashBuffer.slice(0,this._stashUsed),n=this._dispatchChunks(t,this._stashByteStart),r=t.byteLength-n;if(n<t.byteLength){if(!e){if(n>0){var i=new Uint8Array(this._stashBuffer,0,this._bufferSize),o=new Uint8Array(t,n);i.set(o,0),this._stashUsed=o.byteLength,this._stashByteStart+=n}return 0}s.default.w(this.TAG,r+" bytes unconsumed data remain when flush buffer, dropped")}return this._stashUsed=0,this._stashByteStart=0,r}return 0}},{key:"_onLoaderComplete",value:function(e,t){this._flushStashBuffer(!0),this._onComplete&&this._onComplete(this._extraData)}},{key:"_onLoaderError",value:function(e,t){switch(s.default.e(this.TAG,"Loader error, code = "+t.code+", msg = "+t.msg),this._flushStashBuffer(!1),this._isEarlyEofReconnecting&&(this._isEarlyEofReconnecting=!1,e=d.LoaderErrors.UNRECOVERABLE_EARLY_EOF),e){case d.LoaderErrors.EARLY_EOF:if(!this._config.isLive&&this._totalLength){var n=this._currentRange.to+1;return void(n<this._totalLength&&(s.default.w(this.TAG,"Connection lost, trying reconnect..."),this._isEarlyEofReconnecting=!0,this._internalSeek(n,!1)))}e=d.LoaderErrors.UNRECOVERABLE_EARLY_EOF;break;case d.LoaderErrors.UNRECOVERABLE_EARLY_EOF:case d.LoaderErrors.CONNECTING_TIMEOUT:case d.LoaderErrors.HTTP_STATUS_CODE_INVALID:case d.LoaderErrors.EXCEPTION:}if(!this._onError)throw new E.RuntimeException("IOException: "+t.msg);this._onError(e,t)}},{key:"status",get:function(){return this._loader.status}},{key:"extraData",get:function(){return this._extraData},set:function(e){this._extraData=e}},{key:"onDataArrival",get:function(){return this._onDataArrival},set:function(e){this._onDataArrival=e}},{key:"onSeeked",get:function(){return this._onSeeked},set:function(e){this._onSeeked=e}},{key:"onError",get:function(){return this._onError},set:function(e){this._onError=e}},{key:"onComplete",get:function(){return this._onComplete},set:function(e){this._onComplete=e}},{key:"onRedirect",get:function(){return this._onRedirect},set:function(e){this._onRedirect=e}},{key:"onRecoveredEarlyEof",get:function(){return this._onRecoveredEarlyEof},set:function(e){this._onRecoveredEarlyEof=e}},{key:"currentURL",get:function(){return this._dataSource.url}},{key:"hasRedirect",get:function(){return null!=this._redirectedURL||void 0!=this._dataSource.redirectedURL}},{key:"currentRedirectedURL",get:function(){return this._redirectedURL||this._dataSource.redirectedURL}},{key:"currentSpeed",get:function(){return this._loaderClass===v.default?this._loader.currentSpeed:this._speedSampler.lastSecondKBps}},{key:"loaderType",get:function(){return this._loader.type}}]),e}();n.default=R},{"../utils/exception.js":43,"../utils/logger.js":44,"./fetch-stream-loader.js":23,"./loader.js":25,"./param-seek-handler.js":26,"./range-seek-handler.js":27,"./speed-sampler.js":28,"./websocket-loader.js":29,"./xhr-moz-chunked-loader.js":30,"./xhr-msstream-loader.js":31,"./xhr-range-loader.js":32}],25:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0}),n.BaseLoader=n.LoaderErrors=n.LoaderStatus=void 0;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=e("../utils/exception.js"),a=n.LoaderStatus={kIdle:0,kConnecting:1,kBuffering:2,kError:3,kComplete:4};n.LoaderErrors={OK:"OK",EXCEPTION:"Exception",HTTP_STATUS_CODE_INVALID:"HttpStatusCodeInvalid",CONNECTING_TIMEOUT:"ConnectingTimeout",EARLY_EOF:"EarlyEof",UNRECOVERABLE_EARLY_EOF:"UnrecoverableEarlyEof"},n.BaseLoader=function(){function e(t){r(this,e),this._type=t||"undefined",this._status=a.kIdle,this._needStash=!1,this._onContentLengthKnown=null,this._onURLRedirect=null,this._onDataArrival=null,this._onError=null,this._onComplete=null}return i(e,[{key:"destroy",value:function(){this._status=a.kIdle,this._onContentLengthKnown=null,this._onURLRedirect=null,this._onDataArrival=null,this._onError=null,this._onComplete=null}},{key:"isWorking",value:function(){return this._status===a.kConnecting||this._status===a.kBuffering}},{key:"open",value:function(e,t){throw new o.NotImplementedException("Unimplemented abstract function!")}},{key:"abort",value:function(){throw new o.NotImplementedException("Unimplemented abstract function!")}},{key:"type",get:function(){return this._type}},{key:"status",get:function(){return this._status}},{key:"needStashBuffer",get:function(){return this._needStash}},{key:"onContentLengthKnown",get:function(){return this._onContentLengthKnown},set:function(e){this._onContentLengthKnown=e}},{key:"onURLRedirect",get:function(){return this._onURLRedirect},set:function(e){this._onURLRedirect=e}},{key:"onDataArrival",get:function(){return this._onDataArrival},set:function(e){this._onDataArrival=e}},{key:"onError",get:function(){return this._onError},set:function(e){this._onError=e}},{key:"onComplete",get:function(){return this._onComplete},set:function(e){this._onComplete=e}}]),e}()},{"../utils/exception.js":43}],26:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){return(Array(t).join("0")+e).slice(-t)}Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=function(){function e(t,n){r(this,e),this._startName=t,this._endName=n}return o(e,[{key:"getConfig",value:function(e,t){var n=e,r=n;if(t&&t.time){var o=t.time/1e3,a=n.indexOf("starttime=")+10,s=n.substring(a,a+15),u=(n.substring(0,a),n.substring(a+15,n.length),s.substring(0,4)),l=s.substring(4,6),d=s.substring(6,8),c=s.substring(9,11),f=s.substring(11,13),h=s.substring(13,15),_=new Date(u,l,d,c,f,h,0),p=Date.parse(_);p+=1e3*o;var m=new Date(p),v=i(m.getFullYear(),4)+i(m.getMonth(),2)+i(m.getDate(),2)+"T"+i(m.getHours(),2)+i(m.getMinutes(),2)+i(m.getSeconds(),2);r=r.replace(s,v)}return{url:r,headers:null}}},{key:"removeURLParameters",value:function(e){return e}}]),e}();n.default=a},{}],27:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function e(t){r(this,e),this._zeroStart=t||!1}return i(e,[{key:"getConfig",value:function(e,t){var n={};if(0!==t.from||-1!==t.to){var r=void 0;r=-1!==t.to?"bytes="+t.from.toString()+"-"+t.to.toString():"bytes="+t.from.toString()+"-",n.Range=r}else this._zeroStart&&(n.Range="bytes=0-");return{url:e,headers:n}}},{key:"removeURLParameters",value:function(e){return e}}]),e}();n.default=o},{}],28:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function e(){r(this,e),this._firstCheckpoint=0,this._lastCheckpoint=0,this._intervalBytes=0,this._totalBytes=0,this._lastSecondBytes=0,self.performance&&self.performance.now?this._now=self.performance.now.bind(self.performance):this._now=Date.now}return i(e,[{key:"reset",value:function(){this._firstCheckpoint=this._lastCheckpoint=0,this._totalBytes=this._intervalBytes=0,this._lastSecondBytes=0}},{key:"addBytes",value:function(e){0===this._firstCheckpoint?(this._firstCheckpoint=this._now(),this._lastCheckpoint=this._firstCheckpoint,this._intervalBytes+=e,this._totalBytes+=e):this._now()-this._lastCheckpoint<1e3?(this._intervalBytes+=e,this._totalBytes+=e):(this._lastSecondBytes=this._intervalBytes,this._intervalBytes=e,this._totalBytes+=e,this._lastCheckpoint=this._now())}},{key:"currentKBps",get:function(){this.addBytes(0);var e=(this._now()-this._lastCheckpoint)/1e3;return 0==e&&(e=1),this._intervalBytes/e/1024}},{key:"lastSecondKBps",get:function(){return this.addBytes(0),0!==this._lastSecondBytes?this._lastSecondBytes/1024:this._now()-this._lastCheckpoint>=500?this.currentKBps:0}},{key:"averageKBps",get:function(){var e=(this._now()-this._firstCheckpoint)/1e3;return this._totalBytes/e/1024}}]),e}();n.default=o},{}],29:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(n,"__esModule",{value:!0});var a=function e(t,n,r){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,n,r)}if("value"in i)return i.value;var a=i.get;if(void 0!==a)return a.call(r)},s=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=e("../utils/logger.js"),l=(function(e){e&&e.__esModule}(u),e("./loader.js")),d=e("../utils/exception.js"),c=function(e){function t(){r(this,t);var e=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"websocket-loader"));return e.TAG="WebSocketLoader",e._needStash=!0,e._ws=null,e._requestAbort=!1,e._receivedLength=0,e}return o(t,e),s(t,null,[{key:"isSupported",value:function(){try{return void 0!==self.WebSocket}catch(e){return!1}}}]),s(t,[{key:"destroy",value:function(){this._ws&&this.abort(),a(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"open",value:function(e){try{var t=this._ws=new self.WebSocket(e.url);t.binaryType="arraybuffer",t.onopen=this._onWebSocketOpen.bind(this),t.onclose=this._onWebSocketClose.bind(this),t.onmessage=this._onWebSocketMessage.bind(this),t.onerror=this._onWebSocketError.bind(this),this._status=l.LoaderStatus.kConnecting}catch(e){this._status=l.LoaderStatus.kError;var n={code:e.code,msg:e.message};if(!this._onError)throw new d.RuntimeException(n.msg);this._onError(l.LoaderErrors.EXCEPTION,n)}}},{key:"abort",value:function(){var e=this._ws;!e||0!==e.readyState&&1!==e.readyState||(this._requestAbort=!0,e.close()),this._ws=null,this._status=l.LoaderStatus.kComplete}},{key:"_onWebSocketOpen",value:function(e){this._status=l.LoaderStatus.kBuffering}},{key:"_onWebSocketClose",value:function(e){if(!0===this._requestAbort)return void(this._requestAbort=!1);this._status=l.LoaderStatus.kComplete,this._onComplete&&this._onComplete(0,this._receivedLength-1)}},{key:"_onWebSocketMessage",value:function(e){var t=this;if(e.data instanceof ArrayBuffer)this._dispatchArrayBuffer(e.data);else if(e.data instanceof Blob){var n=new FileReader;n.onload=function(){t._dispatchArrayBuffer(n.result)},n.readAsArrayBuffer(e.data)}else{this._status=l.LoaderStatus.kError;var r={code:-1,msg:"Unsupported WebSocket message type: "+e.data.constructor.name};if(!this._onError)throw new d.RuntimeException(r.msg);this._onError(l.LoaderErrors.EXCEPTION,r)}}},{key:"_dispatchArrayBuffer",value:function(e){var t=e,n=this._receivedLength;this._receivedLength+=t.byteLength,this._onDataArrival&&this._onDataArrival(t,n,this._receivedLength)}},{key:"_onWebSocketError",value:function(e){this._status=l.LoaderStatus.kError;var t={code:e.code,msg:e.message};if(!this._onError)throw new d.RuntimeException(t.msg);this._onError(l.LoaderErrors.EXCEPTION,t)}}]),t}(l.BaseLoader);n.default=c},{"../utils/exception.js":43,"../utils/logger.js":44,"./loader.js":25}],30:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(n,"__esModule",{value:!0});var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},u=function e(t,n,r){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,n,r)}if("value"in i)return i.value;var a=i.get;if(void 0!==a)return a.call(r)},l=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),d=e("../utils/logger.js"),c=r(d),f=e("./loader.js"),h=e("../utils/exception.js"),_=e("../crypto/crypto.js"),p=r(_),m=function(e){function t(e,n){i(this,t);var r=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"xhr-moz-chunked-loader"));return r.TAG="MozChunkedLoader",r._seekHandler=e,r._config=n,r._needStash=!0,r._xhr=null,r._requestAbort=!1,r._contentLength=null,r._receivedLength=0,r._requestURL="",r._bInvaidPwd=!1,r}return a(t,e),l(t,null,[{key:"isSupported",value:function(){try{var e=new XMLHttpRequest;return e.open("GET","https://example.com",!0),e.responseType="moz-chunked-arraybuffer","moz-chunked-arraybuffer"===e.responseType}catch(e){return c.default.w("MozChunkedLoader",e.message),!1}}}]),l(t,[{key:"destroy",value:function(){this.abort(),this._xhr&&(this._xhr.onreadystatechange=null,this._xhr.onprogress=null,this._xhr.onloadend=null,this._xhr.onerror=null,this._xhr=null),u(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"open",value:function(e,t){this._dataSource=e,this._range=t,this._receivedLength=0;var n=e.url;this._config.reuseRedirectedURL&&void 0!=e.redirectedURL&&(n=e.redirectedURL);var r=this._seekHandler.getConfig(n,t);this._requestURL=r.url;var i=this._xhr=new XMLHttpRequest;if(i.open("GET",r.url,!0),i.responseType="moz-chunked-arraybuffer",i.onreadystatechange=this._onReadyStateChange.bind(this),i.onprogress=this._onProgress.bind(this),i.onloadend=this._onLoadEnd.bind(this),i.onerror=this._onXhrError.bind(this),e.withCredentials&&i.withCredentials&&(i.withCredentials=!0),"object"===s(r.headers)){var o=r.headers;for(var a in o)o.hasOwnProperty(a)&&i.setRequestHeader(a,o[a])}this._config.date&&i.setRequestHeader("x-amz-date",this._config.date),this._config.auth&&i.setRequestHeader("Authorization",this._config.auth),this._status=f.LoaderStatus.kConnecting,i.send()}},{key:"abort",value:function(){this._bInvaidPwd=!1,this._requestAbort=!0,this._xhr&&this._xhr.abort(),this._status=f.LoaderStatus.kComplete}},{key:"_onReadyStateChange",value:function(e){var t=e.target;if(2===t.readyState){if(void 0!=t.responseURL&&t.responseURL!==this._requestURL&&t.responseURL.length)return;if(0!==t.status&&(t.status<200||t.status>299)){if(this._status=f.LoaderStatus.kError,!this._onError)throw new h.RuntimeException("MozChunkedLoader: Http code invalid, "+t.status+" "+t.statusText);this._onError(f.LoaderErrors.HTTP_STATUS_CODE_INVALID,{code:t.status,msg:t.statusText})}else{this._status=f.LoaderStatus.kBuffering;var n="true"===t.getResponseHeader("Secretive");this.onOpened(n)}}}},{key:"_onProgress",value:function(e){if(this._status!==f.LoaderStatus.kError){null===this._contentLength&&null!==e.total&&0!==e.total&&(this._contentLength=e.total,this._onContentLengthKnown&&this._onContentLengthKnown(this._contentLength));var t=e.target.response,n=this._range.from+this._receivedLength;this._receivedLength+=t.byteLength,this._onDataArrival&&this._onDataArrival(t,n,this._receivedLength)}}},{key:"_onLoadEnd",value:function(e){if(401==e.target.status&&!this._bInvaidPwd){this._bInvaidPwd=!0;var t=e.target.getResponseHeader("WWW-Authenticate"),n=t.indexOf('realm="')+7,r=t.substring(n,t.indexOf(",",n)-1);n=t.indexOf('qop="')+5;var i=t.substring(n,t.indexOf(",",n)-1);i.replace('"',""),n=t.indexOf('nonce="')+7;var o=t.substring(n,t.indexOf('"',n));n=t.indexOf('algorithm="')+11;var a=t.substring(n,t.indexOf(",",n)-1),s=this._config.username,u=this._config.password,l=this._requestURL.substring(this._requestURL.indexOf("/",8),this._requestURL.length),d=p.default.generateUUID(),c=p.default.Digest(s,u,a,r,o,d,"00000001","GET",l,i);this.abort();var h=this._xhr=new XMLHttpRequest;return h.open("GET",this._requestURL,!0),h.responseType="moz-chunked-arraybuffer",h.onreadystatechange=this._onReadyStateChange.bind(this),h.onprogress=this._onProgress.bind(this),h.onloadend=this._onLoadEnd.bind(this),h.onerror=this._onXhrError.bind(this),h.withCredentials=!0,t='Digest username="'+s+'", realm="'+r+'", nonce="'+o+'", uri="'+l+'", algorithm='+a+', response="'+c+'", opaque="5ccc069c403ebaf9f0171e9517f40e41", qop="'+i+'", nc=00000001, cnonce="'+d+'"',h.setRequestHeader("Authorization",t),void h.send()}if(!0===this._requestAbort)return void(this._requestAbort=!1);this._status!==f.LoaderStatus.kError&&(this._status=f.LoaderStatus.kComplete,this._onComplete&&this._onComplete(this._range.from,this._range.from+this._receivedLength-1),this._receivedLength<=0&&200==e.target.status?this._onError&&this._onError("error",{code:-999,msg:"no stream , server disconnected"}):this._onError&&this._onError(f.LoaderErrors.HTTP_STATUS_CODE_INVALID,{code:e.target.status,msg:e.target.statusText}))}},{key:"_onXhrError",value:function(e){this._status=f.LoaderStatus.kError;var t=0,n=null;if(this._contentLength&&e.loaded<this._contentLength?(t=f.LoaderErrors.EARLY_EOF,n={code:-1,msg:"Moz-Chunked stream meet Early-Eof"}):(t=f.LoaderErrors.EXCEPTION,this._receivedLength?(this._receivedLength=0,n={code:-999,msg:"no stream , server disconnected , try to reconnect"}):n={code:-1,msg:e.constructor.name+" "+e.type}),!this._onError)throw new h.RuntimeException(n.msg);this._onError(t,n)}}]),t}(f.BaseLoader);n.default=m},{"../crypto/crypto.js":15,"../utils/exception.js":43,"../utils/logger.js":44,"./loader.js":25}],31:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(n,"__esModule",{value:!0});var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s=function e(t,n,r){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,n,r)}if("value"in i)return i.value;var a=i.get;if(void 0!==a)return a.call(r)},u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),l=e("../utils/logger.js"),d=function(e){return e&&e.__esModule?e:{default:e}}(l),c=e("./loader.js"),f=e("../utils/exception.js"),h=function(e){function t(e,n){r(this,t);var o=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"xhr-msstream-loader"));return o.TAG="MSStreamLoader",o._seekHandler=e,o._config=n,o._needStash=!0,o._xhr=null,o._reader=null,o._totalRange=null,o._currentRange=null,o._currentRequestURL=null,o._currentRedirectedURL=null,o._contentLength=null,o._receivedLength=0,o._bufferLimit=16777216,o._lastTimeBufferSize=0,o._isReconnecting=!1,o}return o(t,e),u(t,null,[{key:"isSupported",value:function(){try{if(void 0===self.MSStream||void 0===self.MSStreamReader)return!1;var e=new XMLHttpRequest;return e.open("GET","https://example.com",!0),e.responseType="ms-stream","ms-stream"===e.responseType}catch(e){return d.default.w("MSStreamLoader",e.message),!1}}}]),u(t,[{key:"destroy",value:function(){this.isWorking()&&this.abort(),this._reader&&(this._reader.onprogress=null,this._reader.onload=null,this._reader.onerror=null,this._reader=null),this._xhr&&(this._xhr.onreadystatechange=null,this._xhr=null),s(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"open",value:function(e,t){this._internalOpen(e,t,!1)}},{key:"_internalOpen",value:function(e,t,n){this._dataSource=e,n?this._currentRange=t:this._totalRange=t;var r=e.url;this._config.reuseRedirectedURL&&(void 0!=this._currentRedirectedURL?r=this._currentRedirectedURL:void 0!=e.redirectedURL&&(r=e.redirectedURL));var i=this._seekHandler.getConfig(r,t);this._currentRequestURL=i.url;var o=this._reader=new self.MSStreamReader;o.onprogress=this._msrOnProgress.bind(this),o.onload=this._msrOnLoad.bind(this),o.onerror=this._msrOnError.bind(this);var s=this._xhr=new XMLHttpRequest;if(s.open("GET",i.url,!0),s.responseType="ms-stream",s.onreadystatechange=this._xhrOnReadyStateChange.bind(this),s.onerror=this._xhrOnError.bind(this),e.withCredentials&&(s.withCredentials=!0),"object"===a(i.headers)){var u=i.headers;for(var l in u)u.hasOwnProperty(l)&&s.setRequestHeader(l,u[l])}this._isReconnecting?this._isReconnecting=!1:this._status=c.LoaderStatus.kConnecting,s.send()}},{key:"abort",value:function(){this._internalAbort(),this._status=c.LoaderStatus.kComplete}},{key:"_internalAbort",value:function(){this._reader&&(1===this._reader.readyState&&this._reader.abort(),this._reader.onprogress=null,this._reader.onload=null,this._reader.onerror=null,this._reader=null),this._xhr&&(this._xhr.abort(),this._xhr.onreadystatechange=null,this._xhr=null)}},{key:"_xhrOnReadyStateChange",value:function(e){var t=e.target;if(2===t.readyState)if(t.status>=200&&t.status<=299){if(this._status=c.LoaderStatus.kBuffering,void 0!=t.responseURL){var n=this._seekHandler.removeURLParameters(t.responseURL);t.responseURL!==this._currentRequestURL&&n!==this._currentRedirectedURL&&(this._currentRedirectedURL=n,this._onURLRedirect&&this._onURLRedirect(n))}var r=t.getResponseHeader("Content-Length");if(null!=r&&null==this._contentLength){var i=parseInt(r);i>0&&(this._contentLength=i,this._onContentLengthKnown&&this._onContentLengthKnown(this._contentLength))}}else{if(this._status=c.LoaderStatus.kError,!this._onError)throw new f.RuntimeException("MSStreamLoader: Http code invalid, "+t.status+" "+t.statusText);this._onError(c.LoaderErrors.HTTP_STATUS_CODE_INVALID,{code:t.status,msg:t.statusText})}else if(3===t.readyState&&t.status>=200&&t.status<=299){this._status=c.LoaderStatus.kBuffering;var o=t.response;this._reader.readAsArrayBuffer(o)}}},{key:"_xhrOnError",value:function(e){this._status=c.LoaderStatus.kError;var t=c.LoaderErrors.EXCEPTION,n={code:-1,msg:e.constructor.name+" "+e.type};if(!this._onError)throw new f.RuntimeException(n.msg);this._onError(t,n)}},{key:"_msrOnProgress",value:function(e){var t=e.target,n=t.result;if(null==n)return void this._doReconnectIfNeeded();var r=n.slice(this._lastTimeBufferSize);this._lastTimeBufferSize=n.byteLength;var i=this._totalRange.from+this._receivedLength;this._receivedLength+=r.byteLength,this._onDataArrival&&this._onDataArrival(r,i,this._receivedLength),n.byteLength>=this._bufferLimit&&(d.default.v(this.TAG,"MSStream buffer exceeded max size near "+(i+r.byteLength)+", reconnecting..."),this._doReconnectIfNeeded())}},{key:"_doReconnectIfNeeded",value:function(){if(null==this._contentLength||this._receivedLength<this._contentLength){this._isReconnecting=!0,this._lastTimeBufferSize=0,this._internalAbort();var e={from:this._totalRange.from+this._receivedLength,to:-1};this._internalOpen(this._dataSource,e,!0)}}},{key:"_msrOnLoad",value:function(e){this._status=c.LoaderStatus.kComplete,this._onComplete&&this._onComplete(this._totalRange.from,this._totalRange.from+this._receivedLength-1)}},{key:"_msrOnError",value:function(e){this._status=c.LoaderStatus.kError;var t=0,n=null;if(this._contentLength&&this._receivedLength<this._contentLength?(t=c.LoaderErrors.EARLY_EOF,n={code:-1,msg:"MSStream meet Early-Eof"}):(t=c.LoaderErrors.EARLY_EOF,n={code:-1,msg:e.constructor.name+" "+e.type}),!this._onError)throw new f.RuntimeException(n.msg);this._onError(t,n)}}]),t}(c.BaseLoader);n.default=h},{"../utils/exception.js":43,"../utils/logger.js":44,"./loader.js":25}],32:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(n,"__esModule",{value:!0});var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},u=function e(t,n,r){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,n,r)}if("value"in i)return i.value;var a=i.get;if(void 0!==a)return a.call(r)},l=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}
}(),d=e("../utils/logger.js"),c=r(d),f=e("./speed-sampler.js"),h=r(f),_=e("./loader.js"),p=e("../utils/exception.js"),m=function(e){function t(e,n){i(this,t);var r=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"xhr-range-loader"));return r.TAG="RangeLoader",r._seekHandler=e,r._config=n,r._needStash=!1,r._chunkSizeKBList=[128,256,384,512,768,1024,1536,2048,3072,4096,5120,6144,7168,8192],r._currentChunkSizeKB=384,r._currentSpeedNormalized=0,r._zeroSpeedChunkCount=0,r._xhr=null,r._speedSampler=new h.default,r._requestAbort=!1,r._waitForTotalLength=!1,r._totalLengthReceived=!1,r._currentRequestURL=null,r._currentRedirectedURL=null,r._currentRequestRange=null,r._totalLength=null,r._contentLength=null,r._receivedLength=0,r._lastTimeLoaded=0,r}return a(t,e),l(t,null,[{key:"isSupported",value:function(){try{var e=new XMLHttpRequest;return e.open("GET","https://example.com",!0),e.responseType="arraybuffer","arraybuffer"===e.responseType}catch(e){return c.default.w("RangeLoader",e.message),!1}}}]),l(t,[{key:"destroy",value:function(){this.isWorking()&&this.abort(),this._xhr&&(this._xhr.onreadystatechange=null,this._xhr.onprogress=null,this._xhr.onload=null,this._xhr.onerror=null,this._xhr=null),u(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"open",value:function(e,t){this._dataSource=e,this._range=t,this._status=_.LoaderStatus.kConnecting;var n=!1;void 0!=this._dataSource.filesize&&0!==this._dataSource.filesize&&(n=!0,this._totalLength=this._dataSource.filesize),this._totalLengthReceived||n?this._openSubRange():(this._waitForTotalLength=!0,this._internalOpen(this._dataSource,{from:0,to:-1}))}},{key:"_openSubRange",value:function(){var e=1024*this._currentChunkSizeKB,t=this._range.from+this._receivedLength,n=t+e;null!=this._contentLength&&n-this._range.from>=this._contentLength&&(n=this._range.from+this._contentLength-1),this._currentRequestRange={from:t,to:n},this._internalOpen(this._dataSource,this._currentRequestRange)}},{key:"_internalOpen",value:function(e,t){this._lastTimeLoaded=0;var n=e.url;this._config.reuseRedirectedURL&&(void 0!=this._currentRedirectedURL?n=this._currentRedirectedURL:void 0!=e.redirectedURL&&(n=e.redirectedURL));var r=this._seekHandler.getConfig(n,t);this._currentRequestURL=r.url;var i=this._xhr=new XMLHttpRequest;if(i.open("GET",r.url,!0),i.responseType="arraybuffer",i.onreadystatechange=this._onReadyStateChange.bind(this),i.onprogress=this._onProgress.bind(this),i.onload=this._onLoad.bind(this),i.onerror=this._onXhrError.bind(this),e.withCredentials&&i.withCredentials&&(i.withCredentials=!0),"object"===s(r.headers)){var o=r.headers;for(var a in o)o.hasOwnProperty(a)&&i.setRequestHeader(a,o[a])}i.send()}},{key:"abort",value:function(){this._requestAbort=!0,this._internalAbort(),this._status=_.LoaderStatus.kComplete}},{key:"_internalAbort",value:function(){this._xhr&&(this._xhr.onreadystatechange=null,this._xhr.onprogress=null,this._xhr.onload=null,this._xhr.onerror=null,this._xhr.abort(),this._xhr=null)}},{key:"_onReadyStateChange",value:function(e){var t=e.target;if(2===t.readyState){if(void 0!=t.responseURL){var n=this._seekHandler.removeURLParameters(t.responseURL);t.responseURL!==this._currentRequestURL&&n!==this._currentRedirectedURL&&(this._currentRedirectedURL=n,this._onURLRedirect&&this._onURLRedirect(n))}if(t.status>=200&&t.status<=299){if(this._waitForTotalLength)return;this._status=_.LoaderStatus.kBuffering}else{if(this._status=_.LoaderStatus.kError,!this._onError)throw new p.RuntimeException("RangeLoader: Http code invalid, "+t.status+" "+t.statusText);this._onError(_.LoaderErrors.HTTP_STATUS_CODE_INVALID,{code:t.status,msg:t.statusText})}}}},{key:"_onProgress",value:function(e){if(this._status!==_.LoaderStatus.kError){if(null===this._contentLength){var t=!1;if(this._waitForTotalLength){this._waitForTotalLength=!1,this._totalLengthReceived=!0,t=!0;var n=e.total;this._internalAbort(),null!=n&0!==n&&(this._totalLength=n)}if(-1===this._range.to?this._contentLength=this._totalLength-this._range.from:this._contentLength=this._range.to-this._range.from+1,t)return void this._openSubRange();this._onContentLengthKnown&&this._onContentLengthKnown(this._contentLength)}var r=e.loaded-this._lastTimeLoaded;this._lastTimeLoaded=e.loaded,this._speedSampler.addBytes(r)}}},{key:"_normalizeSpeed",value:function(e){var t=this._chunkSizeKBList,n=t.length-1,r=0,i=0,o=n;if(e<t[0])return t[0];for(;i<=o;){if((r=i+Math.floor((o-i)/2))===n||e>=t[r]&&e<t[r+1])return t[r];t[r]<e?i=r+1:o=r-1}}},{key:"_onLoad",value:function(e){if(this._status!==_.LoaderStatus.kError){if(this._waitForTotalLength)return void(this._waitForTotalLength=!1);this._lastTimeLoaded=0;var t=this._speedSampler.lastSecondKBps;if(0===t&&++this._zeroSpeedChunkCount>=3&&(t=this._speedSampler.currentKBps),0!==t){var n=this._normalizeSpeed(t);this._currentSpeedNormalized!==n&&(this._currentSpeedNormalized=n,this._currentChunkSizeKB=n)}var r=e.target.response,i=this._range.from+this._receivedLength;this._receivedLength+=r.byteLength;var o=!1;null!=this._contentLength&&this._receivedLength<this._contentLength?this._openSubRange():o=!0,this._onDataArrival&&this._onDataArrival(r,i,this._receivedLength),o&&(this._status=_.LoaderStatus.kComplete,this._onComplete&&this._onComplete(this._range.from,this._range.from+this._receivedLength-1))}}},{key:"_onXhrError",value:function(e){this._status=_.LoaderStatus.kError;var t=0,n=null;if(this._contentLength&&this._receivedLength>0&&this._receivedLength<this._contentLength?(t=_.LoaderErrors.EARLY_EOF,n={code:-1,msg:"RangeLoader meet Early-Eof"}):(t=_.LoaderErrors.EXCEPTION,n={code:-1,msg:e.constructor.name+" "+e.type}),!this._onError)throw new p.RuntimeException(n.msg);this._onError(t,n)}},{key:"currentSpeed",get:function(){return this._speedSampler.lastSecondKBps}}]),t}(_.BaseLoader);n.default=m},{"../utils/exception.js":43,"../utils/logger.js":44,"./loader.js":25,"./speed-sampler.js":28}],33:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=e("events"),u=r(s),l=e("../utils/logger.js"),d=r(l),c=e("../utils/browser.js"),f=r(c),h=e("./player-events.js"),_=r(h),p=e("../core/transmuxer.js"),m=r(p),v=e("../core/transmuxing-events.js"),g=r(v),y=e("../core/mse-controller.js"),b=r(y),S=e("../core/mse-events.js"),k=r(S),w=e("./player-errors.js"),E=e("../config.js"),R=e("../utils/exception.js"),A=function(){function e(t,n){if(i(this,e),this.TAG="FlvPlayer",this._type="FlvPlayer",this._emitter=new u.default,this._config=(0,E.createDefaultConfig)(),"object"===(void 0===n?"undefined":o(n))&&Object.assign(this._config,n),"flv"!==t.type.toLowerCase())throw new R.InvalidArgumentException("FlvPlayer requires an flv MediaDataSource input!");!0===t.isLive&&(this._config.isLive=!0),this.e={onvLoadedMetadata:this._onvLoadedMetadata.bind(this),onvSeeking:this._onvSeeking.bind(this),onvCanPlay:this._onvCanPlay.bind(this),onvStalled:this._onvStalled.bind(this),onvProgress:this._onvProgress.bind(this),onvTimeUpdate:this._onvTimeUpdate.bind(this)},self.performance&&self.performance.now?this._now=self.performance.now.bind(self.performance):this._now=Date.now,this._pendingSeekTime=null,this._requestSetTime=!1,this._seekpointRecord=null,this._progressChecker=null,this._mediaDataSource=t,this._mediaElement=null,this._msectl=null,this._transmuxer=null,this._mseSourceOpened=!1,this._hasPendingLoad=!1,this._receivedCanPlay=!1,this._mediaInfo=null,this._statisticsInfo=null,this._processStateCount=0;var r=f.default.chrome&&(f.default.version.major<50||50===f.default.version.major&&f.default.version.build<2661);this._alwaysSeekKeyframe=!!(r||f.default.msedge||f.default.msie),this._alwaysSeekKeyframe&&(this._config.accurateSeek=!1),this._streamTimer=null}return a(e,[{key:"destroy",value:function(){null!=this._progressChecker&&(window.clearInterval(this._progressChecker),this._progressChecker=null),this._transmuxer&&this.unload(),this._mediaElement&&this.detachMediaElement(),this.e=null,this._mediaDataSource=null,this._emitter.removeAllListeners(),this._emitter=null,this._processStateCount=0}},{key:"on",value:function(e,t){var n=this;e===_.default.MEDIA_INFO?null!=this._mediaInfo&&Promise.resolve().then(function(){n._emitter.emit(_.default.MEDIA_INFO,n.mediaInfo)}):e===_.default.STATISTICS_INFO&&null!=this._statisticsInfo&&Promise.resolve().then(function(){n._emitter.emit(_.default.STATISTICS_INFO,n.statisticsInfo)}),this._emitter.addListener(e,t)}},{key:"off",value:function(e,t){this._emitter.removeListener(e,t)}},{key:"attachMediaElement",value:function(e){var t=this;if(this._processStateCount=0,this._mediaElement=e,e.addEventListener("loadedmetadata",this.e.onvLoadedMetadata),e.addEventListener("seeking",this.e.onvSeeking),e.addEventListener("canplay",this.e.onvCanPlay),e.addEventListener("stalled",this.e.onvStalled),e.addEventListener("progress",this.e.onvProgress),e.addEventListener("timeupdate",this.e.onvTimeUpdate),this._msectl=new b.default(this._config),this._msectl.on(k.default.UPDATE_END,this._onmseUpdateEnd.bind(this)),this._msectl.on(k.default.BUFFER_FULL,this._onmseBufferFull.bind(this)),this._msectl.on(k.default.SOURCE_OPEN,function(){t._mseSourceOpened=!0,t._hasPendingLoad&&(t._hasPendingLoad=!1,t.load())}),this._msectl.on(k.default.ERROR,function(e){t._emitter.emit(_.default.ERROR,w.ErrorTypes.MEDIA_ERROR,w.ErrorDetails.MEDIA_MSE_ERROR,e)}),this._msectl.attachMediaElement(e),null!=this._pendingSeekTime)try{e.currentTime=this._pendingSeekTime,this._pendingSeekTime=null}catch(e){}}},{key:"detachMediaElement",value:function(){this._mediaElement&&(this._msectl.detachMediaElement(),this._mediaElement.removeEventListener("loadedmetadata",this.e.onvLoadedMetadata),this._mediaElement.removeEventListener("seeking",this.e.onvSeeking),this._mediaElement.removeEventListener("canplay",this.e.onvCanPlay),this._mediaElement.removeEventListener("stalled",this.e.onvStalled),this._mediaElement.removeEventListener("progress",this.e.onvProgress),this._mediaElement.removeEventListener("timeupdate",this.e.onvTimeUpdate),this._mediaElement=null),this._msectl&&(this._msectl.destroy(),this._msectl=null),this._streamTimer&&(clearInterval(this._streamTimer),this._streamTimer=null)}},{key:"load",value:function(){var e=this;if(!this._mediaElement)throw new R.IllegalStateException("HTMLMediaElement must be attached before load()!");if(this._transmuxer)throw new R.IllegalStateException("FlvPlayer.load() has been called, please call unload() first!");if(!this._hasPendingLoad){if(this._config.deferLoadAfterSourceOpen&&!1===this._mseSourceOpened)return void(this._hasPendingLoad=!0);this._mediaElement.readyState>0&&(this._requestSetTime=!0,this._mediaElement.currentTime=0),this._transmuxer=new m.default(this._mediaDataSource,this._config),this._transmuxer.on(g.default.INIT_SEGMENT,function(t,n){e._msectl.appendInitSegment(n)}),this._transmuxer.on(g.default.MEDIA_SEGMENT,function(t,n){if(e._msectl.appendMediaSegment(n),e._config.lazyLoad&&!e._config.isLive){var r=e._mediaElement.currentTime;n.info.endDts>=1e3*(r+e._config.lazyLoadMaxDuration)&&null==e._progressChecker&&(d.default.v(e.TAG,"Maximum buffering duration exceeded, suspend transmuxing task"),e._suspendTransmuxer())}}),this._transmuxer.on(g.default.LOADING_COMPLETE,function(){e._msectl.endOfStream(),e._emitter.emit(_.default.LOADING_COMPLETE)}),this._transmuxer.on(g.default.RECOVERED_EARLY_EOF,function(){e._emitter.emit(_.default.RECOVERED_EARLY_EOF)}),this._transmuxer.on(g.default.IO_ERROR,function(t,n){e._emitter.emit(_.default.ERROR,w.ErrorTypes.NETWORK_ERROR,t,n)}),this._transmuxer.on(g.default.DEMUX_ERROR,function(t,n){e._emitter.emit(_.default.ERROR,w.ErrorTypes.MEDIA_ERROR,t,{code:-1,msg:n})}),this._transmuxer.on(g.default.MEDIA_INFO,function(t){e._mediaInfo=t,e._emitter.emit(_.default.MEDIA_INFO,Object.assign({},t))}),this._transmuxer.on(g.default.STATISTICS_INFO,function(t){e._statisticsInfo=e._fillStatisticsInfo(t),e._emitter.emit(_.default.STATISTICS_INFO,Object.assign({},e._statisticsInfo))}),this._transmuxer.on(g.default.RECOMMEND_SEEKPOINT,function(t){e._mediaElement&&!e._config.accurateSeek&&(e._requestSetTime=!0,e._mediaElement.currentTime=t/1e3)}),this._transmuxer.open()}}},{key:"unload",value:function(){this._mediaElement&&this._mediaElement.pause(),this._msectl&&this._msectl.seek(0),this._transmuxer&&(this._transmuxer.close(),this._transmuxer.destroy(),this._transmuxer=null)}},{key:"play",value:function(){return this._mediaElement.play()}},{key:"pause",value:function(){this._mediaElement.pause()}},{key:"resume",value:function(e){if(e&&(this._mediaDataSource.url=e),this._config.isLive){var t=this._mediaElement;this.unload(),this.detachMediaElement(),this.attachMediaElement(t),this.load(),this.play()}else{var n=function(e,t){return(Array(t).join("0")+e).slice(-t)},r=this._mediaDataSource.url,i=this._mediaElement.currentTime,o=r.indexOf("starttime=")+10,a=r.substring(o,o+15),s=(r.substring(0,o),r.substring(o+15,r.length),a.substring(0,4)),u=a.substring(4,6),l=a.substring(6,8),d=a.substring(9,11),c=a.substring(11,13),f=a.substring(13,15),h=new Date(s,u,l,d,c,f,0),_=Date.parse(h);_+=1e3*i;var p=new Date(_),m=n(p.getFullYear(),4)+n(p.getMonth(),2)+n(p.getDate(),2)+"T"+n(p.getHours(),2)+n(p.getMinutes(),2)+n(p.getSeconds(),2);r=r.replace(a,m),console.log("zlplayer resume playback currenttime "+this._mediaElement.currentTime+" timestamp "+_+" with url"+r);var v=this._mediaDataSource;this._config;v.url=r;var g=this._mediaElement;this.unload(),this.detachMediaElement(),this.attachMediaElement(g),this.load(),this.play()}}},{key:"_fillStatisticsInfo",value:function(e){if(e.playerType=this._type,!(this._mediaElement instanceof HTMLVideoElement))return e;var t=!0,n=0,r=0;if(this._mediaElement.getVideoPlaybackQuality){var i=this._mediaElement.getVideoPlaybackQuality();n=i.totalVideoFrames,r=i.droppedVideoFrames}else void 0!=this._mediaElement.webkitDecodedFrameCount?(n=this._mediaElement.webkitDecodedFrameCount,r=this._mediaElement.webkitDroppedFrameCount):t=!1;return t&&(e.decodedFrames=n,e.droppedFrames=r),e}},{key:"_onmseUpdateEnd",value:function(){if(this._config.lazyLoad&&!this._config.isLive){for(var e=this._mediaElement.buffered,t=this._mediaElement.currentTime,n=0,r=0;r<e.length;r++){var i=e.start(r),o=e.end(r);if(i<=t&&t<o){i,n=o;break}}n>=t+this._config.lazyLoadMaxDuration&&null==this._progressChecker&&(d.default.v(this.TAG,"Maximum buffering duration exceeded, suspend transmuxing task"),this._suspendTransmuxer())}}},{key:"_onmseBufferFull",value:function(){d.default.v(this.TAG,"MSE SourceBuffer is full, suspend transmuxing task"),null==this._progressChecker&&this._suspendTransmuxer()}},{key:"_suspendTransmuxer",value:function(){this._transmuxer&&(this._transmuxer.pause(),null==this._progressChecker&&(this._progressChecker=window.setInterval(this._checkProgressAndResume.bind(this),1e3)))}},{key:"_checkProgressAndResume",value:function(){var e=this._mediaElement.currentTime,t=this._mediaElement.buffered,n=!1;if(this._config.lazyLoad)for(var r=0;r<t.length;r++){var i=t.start(r),o=t.end(r);if(e>=i&&e<o){e>=o-this._config.lazyLoadRecoverDuration&&(n=!0);break}}n&&(window.clearInterval(this._progressChecker),this._progressChecker=null,n&&(d.default.v(this.TAG,"Continue loading from paused position"),this._transmuxer.resume()))}},{key:"_isTimepointBuffered",value:function(e){for(var t=this._mediaElement.buffered,n=0;n<t.length;n++){var r=t.start(n),i=t.end(n);if(e>=r&&e<i)return!0}return!1}},{key:"_internalSeek",value:function(e){var t=this._isTimepointBuffered(e),n=!1,r=0;if(e<1&&this._mediaElement.buffered.length>0){var i=this._mediaElement.buffered.start(0);(i<1&&e<i||f.default.safari)&&(n=!0,r=f.default.safari?.1:i)}if(n)this._requestSetTime=!0,this._mediaElement.currentTime=r;else if(t){if(this._alwaysSeekKeyframe){var o=this._msectl.getNearestKeyframe(Math.floor(1e3*e));this._requestSetTime=!0,this._mediaElement.currentTime=null!=o?o.dts/1e3:e}else this._requestSetTime=!0,this._mediaElement.currentTime=e;null!=this._progressChecker&&this._checkProgressAndResume()}else null!=this._progressChecker&&(window.clearInterval(this._progressChecker),this._progressChecker=null),this._msectl.seek(e),this._transmuxer.seek(Math.floor(1e3*e)),this._config.accurateSeek&&(this._requestSetTime=!0,this._mediaElement.currentTime=e)}},{key:"_checkAndApplyUnbufferedSeekpoint",value:function(){if(this._seekpointRecord)if(this._seekpointRecord.recordTime<=this._now()-100){var e=this._mediaElement.currentTime;this._seekpointRecord=null,this._isTimepointBuffered(e)||(null!=this._progressChecker&&(window.clearTimeout(this._progressChecker),this._progressChecker=null),this._msectl.seek(e),this._transmuxer.seek(Math.floor(1e3*e)),this._config.accurateSeek&&(this._requestSetTime=!0,this._mediaElement.currentTime=e))}else window.setTimeout(this._checkAndApplyUnbufferedSeekpoint.bind(this),50)}},{key:"_checkAndResumeStuckPlayback",value:function(e){var t=this._mediaElement;if(e||!this._receivedCanPlay||t.readyState<2){var n=t.buffered;if(n.length>0&&t.currentTime<n.start(0))return d.default.w(this.TAG,"Playback seems stuck at "+t.currentTime+", seek to "+n.start(0)),this._requestSetTime=!0,void(this._mediaElement.currentTime=n.start(0))}if(this._config.isLive&&this._receivedCanPlay){if(t.readyState>2&&this._config.isLive){var r=t.buffered;if(r.length>0){var i=r.end(r.length-1);i>this._mediaElement.currentTime+3&&this._mediaElement.playbackRate<1.2?(console.log("checked buffer is more than 3s, play fast to reduce delay"),this._mediaElement.playbackRate=1.5):i<this._mediaElement.currentTime+1&&this._mediaElement.playbackRate>1.2&&(console.log("checked buffer is less than 1 s, play with normal speed"),this._mediaElement.playbackRate=1)}}if(this._streamTimeFlag=(new Date).getTime(),!this._streamTimer&&this._config.isLive&&this._mediaElement.readyState>2&&(this._streamTimer=setInterval(function(){(new Date).getTime()-this._streamTimeFlag>5e3&&(console.warn("zlplayer: stream timeout(5000ms) replay it"),this._emitter.emit(_.default.ERROR,w.ErrorTypes.MEDIA_ERROR,w.ErrorDetails.NEED_REPLAY,"stream timeout need replay"))}.bind(this),3e3)),++this._processStateCount>10&&(console.warn("zlplayer: checked play stucked"),this._config.isLive)){var o=this._mediaElement.buffered;if(o.length>0){var a=o.end(o.length-1);a>this._mediaElement.currentTime+1&&(console.log("zlplayer: seek to buffered time "+a),this._mediaElement.currentTime=a)}}}}},{key:"_onvLoadedMetadata",value:function(e){null!=this._pendingSeekTime&&(this._mediaElement.currentTime=this._pendingSeekTime,this._pendingSeekTime=null)}},{key:"_onvSeeking",value:function(e){var t=this._mediaElement.currentTime,n=this._mediaElement.buffered;if(this._requestSetTime)return void(this._requestSetTime=!1);if(t<1&&n.length>0){var r=n.start(0);if(r<1&&t<r||f.default.safari)return this._requestSetTime=!0,void(this._mediaElement.currentTime=f.default.safari?.1:r)}if(this._isTimepointBuffered(t)){if(this._alwaysSeekKeyframe){var i=this._msectl.getNearestKeyframe(Math.floor(1e3*t));null!=i&&(this._requestSetTime=!0,this._mediaElement.currentTime=i.dts/1e3)}return void(null!=this._progressChecker&&this._checkProgressAndResume())}}},{key:"_onvCanPlay",value:function(e){this._receivedCanPlay=!0,this._mediaElement.removeEventListener("canplay",this.e.onvCanPlay)}},{key:"_onvStalled",value:function(e){this._checkAndResumeStuckPlayback(!0)}},{key:"_onvProgress",value:function(e){this._checkAndResumeStuckPlayback()}},{key:"_onvTimeUpdate",value:function(e){this._processStateCount=0}},{key:"type",get:function(){return this._type}},{key:"buffered",get:function(){return this._mediaElement.buffered}},{key:"duration",get:function(){return this._mediaElement.duration}},{key:"volume",get:function(){return this._mediaElement.volume},set:function(e){this._mediaElement.volume=e}},{key:"muted",get:function(){return this._mediaElement.muted},set:function(e){this._mediaElement.muted=e}},{key:"currentTime",get:function(){return this._mediaElement?this._mediaElement.currentTime:0},set:function(e){this._mediaElement?this._internalSeek(e):this._pendingSeekTime=e}},{key:"mediaInfo",get:function(){return Object.assign({},this._mediaInfo)}},{key:"statisticsInfo",get:function(){return null==this._statisticsInfo&&(this._statisticsInfo={}),this._statisticsInfo=this._fillStatisticsInfo(this._statisticsInfo),Object.assign({},this._statisticsInfo)}}]),e}();n.default=A},{"../config.js":5,"../core/mse-controller.js":9,"../core/mse-events.js":10,"../core/transmuxer.js":11,"../core/transmuxing-events.js":13,"../utils/browser.js":42,"../utils/exception.js":43,"../utils/logger.js":44,"./player-errors.js":37,"./player-events.js":38,events:2}],34:[function(e,t,n){"use strict";function r(e){function t(){if(null!=ee){if(r.debug("Long poll..."),!$)return void r.warn("Is the server down? (connected=false)");var i=z+"/"+ee+"?rid="+(new Date).getTime();void 0!==X&&null!==X&&(i=i+"&maxev="+X),null!==J&&void 0!==J&&(i=i+"&token="+encodeURIComponent(J)),null!==Y&&void 0!==Y&&(i=i+"&apisecret="+encodeURIComponent(Y)),r.httpAPICall(i,{verb:"GET",withCredentials:K,success:n,timeout:Q,error:function(n,i){if(r.error(n+":",i),++re>3)return $=!1,void e.error("Lost connection to the server (is it down?)");t()}})}}function n(e,i){if(re=0,j||void 0===ee||null===ee||!0===i||setTimeout(t,200),j||!r.isArray(e)){if("keepalive"===e.janus)return void r.vdebug("Got a keepalive on session "+ee);if("ack"!==e.janus)if("success"!==e.janus)if("trickle"===e.janus){var o=e.sender;if(void 0===o||null===o)return void r.warn("Missing sender...");var a=te[o];if(void 0===a||null===a)return void r.debug("This handle is not attached to this session");var s=e.candidate;r.debug("Got a trickled candidate on session "+ee),r.debug(s);var u=a.webrtcStuff;u.pc&&u.remoteSdp?(r.debug("Adding remote candidate:",s),s&&!0!==s.completed?u.pc.addIceCandidate(s):u.pc.addIceCandidate()):(r.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),u.candidates||(u.candidates=[]),u.candidates.push(s),r.debug(u.candidates))}else{if("webrtcup"===e.janus){r.debug("Got a webrtcup event on session "+ee),r.debug(e);var o=e.sender;if(void 0===o||null===o)return void r.warn("Missing sender...");var a=te[o];return void 0===a||null===a?void r.debug("This handle is not attached to this session"):void a.webrtcState(!0)}if("hangup"===e.janus){r.debug("Got a hangup event on session "+ee),r.debug(e);var o=e.sender;if(void 0===o||null===o)return void r.warn("Missing sender...");var a=te[o];if(void 0===a||null===a)return void r.debug("This handle is not attached to this session");a.webrtcState(!1,e.reason),a.hangup()}else if("detached"===e.janus){r.debug("Got a detached event on session "+ee),r.debug(e);var o=e.sender;if(void 0===o||null===o)return void r.warn("Missing sender...");var a=te[o];if(void 0===a||null===a)return;a.detached=!0,a.ondetached(),a.detach()}else if("media"===e.janus){r.debug("Got a media event on session "+ee),r.debug(e);var o=e.sender;if(void 0===o||null===o)return void r.warn("Missing sender...");var a=te[o];if(void 0===a||null===a)return void r.debug("This handle is not attached to this session");a.mediaState(e.type,e.receiving)}else if("slowlink"===e.janus){r.debug("Got a slowlink event on session "+ee),r.debug(e);var o=e.sender;if(void 0===o||null===o)return void r.warn("Missing sender...");var a=te[o];if(void 0===a||null===a)return void r.debug("This handle is not attached to this session");a.slowLink(e.uplink,e.nacks)}else{if("error"===e.janus){r.error("Ooops: "+e.error.code+" "+e.error.reason),r.debug(e);var l=e.transaction;if(null!==l&&void 0!==l){var d=ie[l];null!==d&&void 0!==d&&d(e),delete ie[l]}return}if("event"===e.janus){r.debug("Got a plugin event on session "+ee),r.debug(e);var o=e.sender;if(void 0===o||null===o)return void r.warn("Missing sender...");var c=e.plugindata;if(void 0===c||null===c)return void r.warn("Missing plugindata...");r.debug("  -- Event is coming from "+o+" ("+c.plugin+")");var f=c.data;r.debug(f);var a=te[o];if(void 0===a||null===a)return void r.warn("This handle is not attached to this session");var h=e.jsep;void 0!==h&&null!==h&&(r.debug("Handling SDP as well..."),r.debug(h));var _=a.onmessage;null!==_&&void 0!==_?(r.debug("Notifying application..."),_(f,h)):r.debug("No provided notification callback")}else r.warn("Unknown message/event  '"+e.janus+"' on session "+ee),r.debug(e)}}else{r.debug("Got a success on session "+ee),r.debug(e);var l=e.transaction;if(null!==l&&void 0!==l){var d=ie[l];null!==d&&void 0!==d&&d(e),delete ie[l]}}else{r.debug("Got an ack on session "+ee),r.debug(e);var l=e.transaction;if(null!==l&&void 0!==l){var d=ie[l];null!==d&&void 0!==d&&d(e),delete ie[l]}}}else for(var p=0;p<e.length;p++)n(e[p],!0)}function o(){if(null!==z&&j&&$){N=setTimeout(o,Z);var e={janus:"keepalive",session_id:ee,transaction:r.randomString(12)};null!==J&&void 0!==J&&(e.token=J),null!==Y&&void 0!==Y&&(e.apisecret=Y),P.send(JSON.stringify(e))}}function a(i){var s=r.randomString(12),u={janus:"create",transaction:s};if(i.reconnect&&($=!1,u.janus="claim",u.session_id=ee,P&&(P.onopen=null,P.onerror=null,P.onclose=null,N&&(clearTimeout(N),N=null))),null!==J&&void 0!==J&&(u.token=J),null!==Y&&void 0!==Y&&(u.apisecret=Y),null===z&&r.isArray(F)&&(z=F[V],0===z.indexOf("ws")?(j=!0,r.log("Server #"+(V+1)+": trying WebSockets to contact Janus ("+z+")")):(j=!1,r.log("Server #"+(V+1)+": trying REST API to contact Janus ("+z+")"))),j){P=r.newWebSocket(z,"janus-protocol"),U={error:function(){if(r.error("Error connecting to the Janus WebSockets server... "+z),r.isArray(F)&&!i.reconnect)return++V==F.length?void i.error("Error connecting to any of the provided Janus servers: Is the server down?"):(z=null,void setTimeout(function(){a(i)},200));i.error("Error connecting to the Janus WebSockets server: Is the server down?")},open:function(){ie[s]=function(e){if(r.debug(e),"success"!==e.janus)return r.error("Ooops: "+e.error.code+" "+e.error.reason),void i.error(e.error.reason);N=setTimeout(o,Z),$=!0,ee=e.session_id?e.session_id:e.data.id,i.reconnect?r.log("Claimed session: "+ee):r.log("Created session: "+ee),r.sessions[ee]=ne,i.success()},P.send(JSON.stringify(u))},message:function(e){n(JSON.parse(e.data))},close:function(){null!==z&&$&&($=!1,e.error("Lost connection to the server (is it down?)"))}};for(var l in U)P.addEventListener(l,U[l])}else r.httpAPICall(z,{verb:"POST",withCredentials:K,body:u,success:function(e){if(r.debug(e),"success"!==e.janus)return r.error("Ooops: "+e.error.code+" "+e.error.reason),void i.error(e.error.reason);$=!0,ee=e.session_id?e.session_id:e.data.id,i.reconnect?r.log("Claimed session: "+ee):r.log("Created session: "+ee),r.sessions[ee]=ne,t(),i.success()},error:function(e,t){if(r.error(e+":",t),r.isArray(F)&&!i.reconnect)return++V==F.length?void i.error("Error connecting to any of the provided Janus servers: Is the server down?"):(z=null,void setTimeout(function(){a(i)},200));""===t?i.error(e+": Is the server down?"):i.error(e+": "+t)}})}function s(t){t=t||{},t.success="function"==typeof t.success?t.success:r.noop;var n=!0;void 0!==t.asyncRequest&&null!==t.asyncRequest&&(n=!0===t.asyncRequest);var i=!0;if(void 0!==t.notifyDestroyed&&null!==t.notifyDestroyed&&(i=!0===t.notifyDestroyed),r.log("Destroying session "+ee+" (async="+n+")"),!$)return r.warn("Is the server down? (connected=false)"),void t.success();if(void 0===ee||null===ee)return r.warn("No session to destroy"),t.success(),void(i&&e.destroyed());delete r.sessions[ee];var o={janus:"destroy",transaction:r.randomString(12)};if(null!==J&&void 0!==J&&(o.token=J),null!==Y&&void 0!==Y&&(o.apisecret=Y),j){o.session_id=ee;var a=function(){for(var e in U)P.removeEventListener(e,U[e]);P.removeEventListener("message",s),P.removeEventListener("error",u),N&&clearTimeout(N),P.close()},s=function(n){var r=JSON.parse(n.data);r.session_id==o.session_id&&r.transaction==o.transaction&&(a(),t.success(),i&&e.destroyed())},u=function(n){a(),t.error("Failed to destroy the server: Is the server down?"),i&&e.destroyed()};return P.addEventListener("message",s),P.addEventListener("error",u),void P.send(JSON.stringify(o))}r.httpAPICall(z+"/"+ee,{verb:"POST",async:n,withCredentials:K,body:o,success:function(n){r.log("Destroyed session:"),r.debug(n),ee=null,$=!1,"success"!==n.janus&&r.error("Ooops: "+n.error.code+" "+n.error.reason),t.success(),i&&e.destroyed()},error:function(n,o){r.error(n+":",o),ee=null,$=!1,t.success(),i&&e.destroyed()}})}function u(e){if(e=e||{},e.success="function"==typeof e.success?e.success:r.noop,e.error="function"==typeof e.error?e.error:r.noop,e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:r.noop,e.iceState="function"==typeof e.iceState?e.iceState:r.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:r.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:r.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:r.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:r.noop,e.onlocalstream="function"==typeof e.onlocalstream?e.onlocalstream:r.noop,e.onremotestream="function"==typeof e.onremotestream?e.onremotestream:r.noop,e.ondata="function"==typeof e.ondata?e.ondata:r.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:r.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:r.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:r.noop,!$)return r.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");var t=e.plugin;if(void 0===t||null===t)return r.error("Invalid plugin"),void e.error("Invalid plugin");var n=e.opaqueId,i=e.token?e.token:J,o=r.randomString(12),a={janus:"attach",plugin:t,opaque_id:n,transaction:o};if(null!==i&&void 0!==i&&(a.token=i),null!==Y&&void 0!==Y&&(a.apisecret=Y),j)return ie[o]=function(n){if(r.debug(n),"success"!==n.janus)return r.error("Ooops: "+n.error.code+" "+n.error.reason),void e.error("Ooops: "+n.error.code+" "+n.error.reason);var o=n.data.id;r.log("Created handle: "+o);var a={session:ne,plugin:t,id:o,token:i,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:null,dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return o},getPlugin:function(){return t},getVolume:function(){return b(o,!0)},getRemoteVolume:function(){return b(o,!0)},getLocalVolume:function(){return b(o,!1)},isAudioMuted:function(){return S(o,!1)},muteAudio:function(){return k(o,!1,!0)},unmuteAudio:function(){return k(o,!1,!1)},isVideoMuted:function(){return S(o,!0)},muteVideo:function(){return k(o,!0,!0)},unmuteVideo:function(){return k(o,!0,!1)},getBitrate:function(){return w(o)},send:function(e){l(o,e)},data:function(e){c(o,e)},dtmf:function(e){f(o,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){p(o,e)},createAnswer:function(e){p(o,e)},handleRemoteJsep:function(e){m(o,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){R(o,!0===e)},detach:function(e){h(o,e)}};te[o]=a,e.success(a)},
a.session_id=ee,void P.send(JSON.stringify(a));r.httpAPICall(z+"/"+ee,{verb:"POST",withCredentials:K,body:a,success:function(n){if(r.debug(n),"success"!==n.janus)return r.error("Ooops: "+n.error.code+" "+n.error.reason),void e.error("Ooops: "+n.error.code+" "+n.error.reason);var o=n.data.id;r.log("Created handle: "+o);var a={session:ne,plugin:t,id:o,token:i,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannel:null,dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return o},getPlugin:function(){return t},getVolume:function(){return b(o,!0)},getRemoteVolume:function(){return b(o,!0)},getLocalVolume:function(){return b(o,!1)},isAudioMuted:function(){return S(o,!1)},muteAudio:function(){return k(o,!1,!0)},unmuteAudio:function(){return k(o,!1,!1)},isVideoMuted:function(){return S(o,!0)},muteVideo:function(){return k(o,!0,!0)},unmuteVideo:function(){return k(o,!0,!1)},getBitrate:function(){return w(o)},send:function(e){l(o,e)},data:function(e){c(o,e)},dtmf:function(e){f(o,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){p(o,e)},createAnswer:function(e){p(o,e)},handleRemoteJsep:function(e){m(o,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){R(o,!0===e)},detach:function(e){h(o,e)}};te[o]=a,e.success(a)},error:function(e,t){r.error(e+":",t)}})}function l(e,t){if(t=t||{},t.success="function"==typeof t.success?t.success:r.noop,t.error="function"==typeof t.error?t.error:r.noop,!$)return r.warn("Is the server down? (connected=false)"),void t.error("Is the server down? (connected=false)");var n=te[e];if(null===n||void 0===n||null===n.webrtcStuff||void 0===n.webrtcStuff)return r.warn("Invalid handle"),void t.error("Invalid handle");var i=t.message,o=t.jsep,a=r.randomString(12),s={janus:"message",body:i,transaction:a};if(null!==n.token&&void 0!==n.token&&(s.token=n.token),null!==Y&&void 0!==Y&&(s.apisecret=Y),null!==o&&void 0!==o&&(s.jsep=o),r.debug("Sending message to plugin (handle="+e+"):"),r.debug(s),j)return s.session_id=ee,s.handle_id=e,ie[a]=function(e){if(r.debug("Message sent!"),r.debug(e),"success"===e.janus){var n=e.plugindata;if(void 0===n||null===n)return r.warn("Request succeeded, but missing plugindata..."),void t.success();r.log("Synchronous transaction successful ("+n.plugin+")");var i=n.data;return r.debug(i),void t.success(i)}if("ack"!==e.janus)return void(void 0!==e.error&&null!==e.error?(r.error("Ooops: "+e.error.code+" "+e.error.reason),t.error(e.error.code+" "+e.error.reason)):(r.error("Unknown error"),t.error("Unknown error")));t.success()},void P.send(JSON.stringify(s));r.httpAPICall(z+"/"+ee+"/"+e,{verb:"POST",withCredentials:K,body:s,success:function(e){if(r.debug("Message sent!"),r.debug(e),"success"===e.janus){var n=e.plugindata;if(void 0===n||null===n)return r.warn("Request succeeded, but missing plugindata..."),void t.success();r.log("Synchronous transaction successful ("+n.plugin+")");var i=n.data;return r.debug(i),void t.success(i)}if("ack"!==e.janus)return void(void 0!==e.error&&null!==e.error?(r.error("Ooops: "+e.error.code+" "+e.error.reason),t.error(e.error.code+" "+e.error.reason)):(r.error("Unknown error"),t.error("Unknown error")));t.success()},error:function(e,n){r.error(e+":",n),t.error(e+": "+n)}})}function d(e,t){if(!$)return void r.warn("Is the server down? (connected=false)");var n=te[e];if(null===n||void 0===n||null===n.webrtcStuff||void 0===n.webrtcStuff)return void r.warn("Invalid handle");var i={janus:"trickle",candidate:t,transaction:r.randomString(12)};if(null!==n.token&&void 0!==n.token&&(i.token=n.token),null!==Y&&void 0!==Y&&(i.apisecret=Y),r.vdebug("Sending trickle candidate (handle="+e+"):"),r.vdebug(i),j)return i.session_id=ee,i.handle_id=e,void P.send(JSON.stringify(i));r.httpAPICall(z+"/"+ee+"/"+e,{verb:"POST",withCredentials:K,body:i,success:function(e){if(r.vdebug("Candidate sent!"),r.vdebug(e),"ack"!==e.janus)return void r.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,t){r.error(e+":",t)}})}function c(e,t){t=t||{},t.success="function"==typeof t.success?t.success:r.noop,t.error="function"==typeof t.error?t.error:r.noop;var n=te[e];if(null===n||void 0===n||null===n.webrtcStuff||void 0===n.webrtcStuff)return r.warn("Invalid handle"),void t.error("Invalid handle");var i=n.webrtcStuff,o=t.text;if(null===o||void 0===o)return r.warn("Invalid text"),void t.error("Invalid text");r.log("Sending string on data channel: "+o),i.dataChannel.send(o),t.success()}function f(e,t){t=t||{},t.success="function"==typeof t.success?t.success:r.noop,t.error="function"==typeof t.error?t.error:r.noop;var n=te[e];if(null===n||void 0===n||null===n.webrtcStuff||void 0===n.webrtcStuff)return r.warn("Invalid handle"),void t.error("Invalid handle");var i=n.webrtcStuff;if(null===i.dtmfSender||void 0===i.dtmfSender){if(void 0!==i.pc&&null!==i.pc){var o=i.pc.getSenders(),a=o.find(function(e){return e.track&&"audio"===e.track.kind});if(!a)return r.warn("Invalid DTMF configuration (no audio track)"),void t.error("Invalid DTMF configuration (no audio track)");i.dtmfSender=a.dtmf,i.dtmfSender&&(r.log("Created DTMF Sender"),i.dtmfSender.ontonechange=function(e){r.debug("Sent DTMF tone: "+e.tone)})}if(null===i.dtmfSender||void 0===i.dtmfSender)return r.warn("Invalid DTMF configuration"),void t.error("Invalid DTMF configuration")}var s=t.dtmf;if(null===s||void 0===s)return r.warn("Invalid DTMF parameters"),void t.error("Invalid DTMF parameters");var u=s.tones;if(null===u||void 0===u)return r.warn("Invalid DTMF string"),void t.error("Invalid DTMF string");var l=s.duration;null!==l&&void 0!==l||(l=500);var d=s.gap;null!==d&&void 0!==d||(d=50),r.debug("Sending DTMF string "+u+" (duration "+l+"ms, gap "+d+"ms)"),i.dtmfSender.insertDTMF(u,l,d)}function h(e,t){t=t||{},t.success="function"==typeof t.success?t.success:r.noop,t.error="function"==typeof t.error?t.error:r.noop;var n=!0;void 0!==t.asyncRequest&&null!==t.asyncRequest&&(n=!0===t.asyncRequest),r.log("Destroying handle "+e+" (async="+n+")"),R(e);var i=te[e];if(null===i||void 0===i||i.detached)return delete te[e],void t.success();if(!$)return r.warn("Is the server down? (connected=false)"),void t.error("Is the server down? (connected=false)");var o={janus:"detach",transaction:r.randomString(12)};if(null!==i.token&&void 0!==i.token&&(o.token=i.token),null!==Y&&void 0!==Y&&(o.apisecret=Y),j)return o.session_id=ee,o.handle_id=e,P.send(JSON.stringify(o)),delete te[e],void t.success();r.httpAPICall(z+"/"+ee+"/"+e,{verb:"POST",async:n,withCredentials:K,body:o,success:function(n){r.log("Destroyed handle:"),r.debug(n),"success"!==n.janus&&r.error("Ooops: "+n.error.code+" "+n.error.reason),delete te[e],t.success()},error:function(n,i){r.error(n+":",i),delete te[e],t.success()}})}function _(e,t,n,o,a){var s=te[e];if(null===s||void 0===s||null===s.webrtcStuff||void 0===s.webrtcStuff)return r.warn("Invalid handle"),void o.error("Invalid handle");var u=s.webrtcStuff;r.debug("streamsDone:",a),a&&(r.debug("  -- Audio tracks:",a.getAudioTracks()),r.debug("  -- Video tracks:",a.getVideoTracks()));var l=!1;if(u.myStream&&n.update&&!u.streamExternal){if((!n.update&&L(n)||n.update&&(n.addAudio||n.replaceAudio))&&a.getAudioTracks()&&a.getAudioTracks().length)if(u.myStream.addTrack(a.getAudioTracks()[0]),n.replaceAudio&&"firefox"===r.webRTCAdapter.browserDetails.browser){r.log("Replacing audio track:",a.getAudioTracks()[0]);for(var c in u.pc.getSenders()){var f=u.pc.getSenders()[c];f&&f.track&&"audio"===f.track.kind&&f.replaceTrack(a.getAudioTracks()[0])}}else if("firefox"===r.webRTCAdapter.browserDetails.browser&&r.webRTCAdapter.browserDetails.version>=59){r.log((n.replaceVideo?"Replacing":"Adding")+" video track:",a.getVideoTracks()[0]);var h=null,_=u.pc.getTransceivers();if(_&&_.length>0)for(var p in _){var m=_[p];if(m.sender&&m.sender.track&&"audio"===m.sender.track.kind||m.receiver&&m.receiver.track&&"audio"===m.receiver.track.kind){h=m;break}}h&&h.sender?h.sender.replaceTrack(a.getVideoTracks()[0]):u.pc.addTrack(a.getVideoTracks()[0],a)}else r.log((n.replaceAudio?"Replacing":"Adding")+" audio track:",a.getAudioTracks()[0]),u.pc.addTrack(a.getAudioTracks()[0],a);if((!n.update&&O(n)||n.update&&(n.addVideo||n.replaceVideo))&&a.getVideoTracks()&&a.getVideoTracks().length)if(u.myStream.addTrack(a.getVideoTracks()[0]),n.replaceVideo&&"firefox"===r.webRTCAdapter.browserDetails.browser){r.log("Replacing video track:",a.getVideoTracks()[0]);for(var c in u.pc.getSenders()){var f=u.pc.getSenders()[c];f&&f.track&&"video"===f.track.kind&&f.replaceTrack(a.getVideoTracks()[0])}}else if("firefox"===r.webRTCAdapter.browserDetails.browser&&r.webRTCAdapter.browserDetails.version>=59){r.log((n.replaceVideo?"Replacing":"Adding")+" video track:",a.getVideoTracks()[0]);var b=null,_=u.pc.getTransceivers();if(_&&_.length>0)for(var p in _){var m=_[p];if(m.sender&&m.sender.track&&"video"===m.sender.track.kind||m.receiver&&m.receiver.track&&"video"===m.receiver.track.kind){b=m;break}}b&&b.sender?b.sender.replaceTrack(a.getVideoTracks()[0]):u.pc.addTrack(a.getVideoTracks()[0],a)}else r.log((n.replaceVideo?"Replacing":"Adding")+" video track:",a.getVideoTracks()[0]),u.pc.addTrack(a.getVideoTracks()[0],a)}else u.myStream=a,l=!0;if(!u.pc){var S={iceServers:G,iceTransportPolicy:H,bundlePolicy:q},k={optional:[{DtlsSrtpKeyAgreement:!0}]};if(!0===W&&k.optional.push({googIPv6:!0}),o.rtcConstraints&&"object"===i(o.rtcConstraints)){r.debug("Adding custom PeerConnection constraints:",o.rtcConstraints);for(var p in o.rtcConstraints)k.optional.push(o.rtcConstraints[p])}"edge"===r.webRTCAdapter.browserDetails.browser&&(S.bundlePolicy="max-bundle"),r.log("Creating PeerConnection"),r.debug(k),u.pc=new RTCPeerConnection(S,k),r.debug(u.pc),u.pc.getStats&&(u.volume={},u.bitrate.value="0 kbits/sec"),r.log("Preparing local SDP and gathering candidates (trickle="+u.trickle+")"),u.pc.oniceconnectionstatechange=function(e){u.pc&&s.iceState(u.pc.iceConnectionState)},u.pc.onicecandidate=function(t){if(null==t.candidate||"edge"===r.webRTCAdapter.browserDetails.browser&&t.candidate.candidate.indexOf("endOfCandidates")>0)r.log("End of candidates."),u.iceDone=!0,!0===u.trickle?d(e,{completed:!0}):y(e,o);else{var n={candidate:t.candidate.candidate,sdpMid:t.candidate.sdpMid,sdpMLineIndex:t.candidate.sdpMLineIndex};!0===u.trickle&&d(e,n)}},u.pc.ontrack=function(e){r.log("Handling Remote Track"),r.debug(e),e.streams&&(u.remoteStream=e.streams[0],s.onremotestream(u.remoteStream),e.track&&!e.track.onended&&(r.log("Adding onended callback to track:",e.track),e.track.onended=function(e){r.log("Remote track removed:",e),u.remoteStream&&(u.remoteStream.removeTrack(e.target),s.onremotestream(u.remoteStream))}))}}if(l&&null!==a&&void 0!==a&&(r.log("Adding local stream"),a.getTracks().forEach(function(e){r.log("Adding local track:",e),u.pc.addTrack(e,a)})),M(n)&&!u.dataChannel){r.log("Creating data channel");var w=function(e){r.log("Received message on data channel: "+e.data),s.ondata(e.data)},E=function(){var e=null!==u.dataChannel?u.dataChannel.readyState:"null";r.log("State change on data channel: "+e),"open"===e&&s.ondataopen()},R=function(e){r.error("Got error on data channel:",e)};u.dataChannel=u.pc.createDataChannel("JanusDataChannel",{ordered:!1}),u.dataChannel.onmessage=w,u.dataChannel.onopen=E,u.dataChannel.onclose=E,u.dataChannel.onerror=R}u.myStream&&s.onlocalstream(u.myStream),null===t||void 0===t?v(e,n,o):u.pc.setRemoteDescription(t).then(function(){if(r.log("Remote description accepted!"),u.remoteSdp=t.sdp,u.candidates&&u.candidates.length>0){for(var i in u.candidates){var a=u.candidates[i];r.debug("Adding remote candidate:",a),a&&!0!==a.completed?u.pc.addIceCandidate(a):u.pc.addIceCandidate()}u.candidates=[]}g(e,n,o)},o.error)}function p(e,t){t=t||{},t.success="function"==typeof t.success?t.success:r.noop,t.error="function"==typeof t.error?t.error:E;var n=t.jsep;t.media=t.media||{audio:!0,video:!0};var o=t.media,a=te[e];if(null===a||void 0===a||null===a.webrtcStuff||void 0===a.webrtcStuff)return r.warn("Invalid handle"),void t.error("Invalid handle");var s=a.webrtcStuff;if(s.trickle=B(t.trickle),void 0===s.pc||null===s.pc)o.update=!1;else if(void 0!==s.pc&&null!==s.pc)if(r.log("Updating existing media session"),o.update=!0,null!==t.stream&&void 0!==t.stream)t.stream!==s.myStream&&r.log("Renegotiation involves a new external stream");else{if(o.addAudio){if(o.replaceAudio=!1,o.removeAudio=!1,o.audioSend=!0,s.myStream&&s.myStream.getAudioTracks()&&s.myStream.getAudioTracks().length)return r.error("Can't add audio stream, there already is one"),void t.error("Can't add audio stream, there already is one")}else o.removeAudio?(o.replaceAudio=!1,o.addAudio=!1,o.audioSend=!1):o.replaceAudio&&(o.addAudio=!1,o.removeAudio=!1,o.audioSend=!0);if(null===s.myStream||void 0===s.myStream?(o.replaceAudio&&(o.replaceAudio=!1,o.addAudio=!0,o.audioSend=!0),L(o)&&(o.addAudio=!0)):null!==s.myStream.getAudioTracks()&&void 0!==s.myStream.getAudioTracks()&&0!==s.myStream.getAudioTracks().length||(o.replaceAudio&&(o.replaceAudio=!1,o.addAudio=!0,o.audioSend=!0),L(o)&&(o.addAudio=!0)),o.addVideo){if(o.replaceVideo=!1,o.removeVideo=!1,o.videoSend=!0,s.myStream&&s.myStream.getVideoTracks()&&s.myStream.getVideoTracks().length)return r.error("Can't add video stream, there already is one"),void t.error("Can't add video stream, there already is one")}else o.removeVideo?(o.replaceVideo=!1,o.addVideo=!1,o.videoSend=!1):o.replaceVideo&&(o.addVideo=!1,o.removeVideo=!1,o.videoSend=!0);null===s.myStream||void 0===s.myStream?(o.replaceVideo&&(o.replaceVideo=!1,o.addVideo=!0,o.videoSend=!0),O(o)&&(o.addVideo=!0)):null!==s.myStream.getVideoTracks()&&void 0!==s.myStream.getVideoTracks()&&0!==s.myStream.getVideoTracks().length||(o.replaceVideo&&(o.replaceVideo=!1,o.addVideo=!0,o.videoSend=!0),O(o)&&(o.addVideo=!0)),o.addData&&(o.data=!0)}if(o.update&&!s.streamExternal){if(o.removeAudio||o.replaceAudio){if(s.myStream&&s.myStream.getAudioTracks()&&s.myStream.getAudioTracks().length){var u=s.myStream.getAudioTracks()[0];r.log("Removing audio track:",u),s.myStream.removeTrack(u);try{u.stop()}catch(e){}}if(s.pc.getSenders()&&s.pc.getSenders().length){var l=!0;if(o.replaceAudio&&"firefox"===r.webRTCAdapter.browserDetails.browser&&(l=!1),l)for(var d in s.pc.getSenders()){var u=s.pc.getSenders()[d];u&&u.track&&"audio"===u.track.kind&&(r.log("Removing audio sender:",u),s.pc.removeTrack(u))}}}if(o.removeVideo||o.replaceVideo){if(s.myStream&&s.myStream.getVideoTracks()&&s.myStream.getVideoTracks().length){var u=s.myStream.getVideoTracks()[0];r.log("Removing video track:",u),s.myStream.removeTrack(u);try{u.stop()}catch(e){}}if(s.pc.getSenders()&&s.pc.getSenders().length){var c=!0;if(o.replaceVideo&&"firefox"===r.webRTCAdapter.browserDetails.browser&&(c=!1),c)for(var d in s.pc.getSenders()){var u=s.pc.getSenders()[d];u&&u.track&&"video"===u.track.kind&&(r.log("Removing video sender:",u),s.pc.removeTrack(u))}}}}if(null!==t.stream&&void 0!==t.stream){var f=t.stream;if(r.log("MediaStream provided by the application"),r.debug(f),o.update&&s.myStream&&s.myStream!==t.stream&&!s.streamExternal){try{var h=s.myStream.getTracks();for(var p in h){var m=h[p];r.log(m),null!==m&&void 0!==m&&m.stop()}}catch(e){}s.myStream=null}return s.streamExternal=!0,void _(e,n,o,t,f)}if(L(o)||O(o)){var v={mandatory:{},optional:[]};a.consentDialog(!0);var g=L(o);!0===g&&void 0!=o&&null!=o&&"object"===i(o.audio)&&(g=o.audio);var y=O(o);if(!0===y&&void 0!=o&&null!=o){if(!(!0===t.simulcast)||n||void 0!==o.video&&!1!==o.video||(o.video="hires"),o.video&&"screen"!=o.video&&"window"!=o.video)if("object"===i(o.video))y=o.video;else{var b=0,S=0;"lowres"===o.video?(S=240,240,b=320):"lowres-16:9"===o.video?(S=180,180,b=320):"hires"===o.video||"hires-16:9"===o.video||"hdres"===o.video?(S=720,720,b=1280):"fhdres"===o.video?(S=1080,1080,b=1920):"4kres"===o.video?(S=2160,2160,b=3840):"stdres"===o.video?(S=480,480,b=640):"stdres-16:9"===o.video?(S=360,360,b=640):(r.log("Default video setting is stdres 4:3"),S=480,480,b=640),r.log("Adding media constraint:",o.video),y={height:{ideal:S},width:{ideal:b}},r.log("Adding video constraint:",y)}else if("screen"===o.video||"window"===o.video){var k=function(r,i){a.consentDialog(!1),r?t.error(r):_(e,n,o,t,i)},w=function(e,t,n){r.log("Adding media constraint (screen capture)"),r.debug(e),navigator.mediaDevices.getUserMedia(e).then(function(e){n?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(n){e.addTrack(n.getAudioTracks()[0]),t(null,e)}):t(null,e)}).catch(function(e){a.consentDialog(!1),t(e)})};if(o.screenshareFrameRate||(o.screenshareFrameRate=3),navigator.getDisplayMedia)return void navigator.getDisplayMedia({video:!0}).then(function(r){a.consentDialog(!1),L(o)?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(i){r.addTrack(i.getAudioTracks()[0]),_(e,n,o,t,r)}):_(e,n,o,t,r)},function(e){a.consentDialog(!1),t.error(e)});if("chrome"===r.webRTCAdapter.browserDetails.browser){var R=r.webRTCAdapter.browserDetails.version,A=33;window.navigator.userAgent.match("Linux")&&(A=35),R>=26&&R<=A?(v={video:{mandatory:{googLeakyBucket:!0,maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:o.screenshareFrameRate,maxFrameRate:o.screenshareFrameRate,chromeMediaSource:"screen"}},audio:L(o)},w(v,k)):r.extension.getScreen(function(e,n){if(e)return a.consentDialog(!1),t.error(e);v={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:o.screenshareFrameRate,maxFrameRate:o.screenshareFrameRate},optional:[{googLeakyBucket:!0},{googTemporalLayeredScreencast:!0}]}},v.video.mandatory.chromeMediaSourceId=n,w(v,k,L(o))})}else if(window.navigator.userAgent.match("Firefox")){var C=parseInt(window.navigator.userAgent.match(/Firefox\/(.*)/)[1],10);if(!(C>=33)){var D=new Error("NavigatorUserMediaError");return D.name="Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)",a.consentDialog(!1),void t.error(D)}v={video:{mozMediaSource:o.video,mediaSource:o.video},audio:L(o)},w(v,function(e,t){if(k(e,t),!e)var n=t.currentTime,r=window.setInterval(function(){t||window.clearInterval(r),t.currentTime==n&&(window.clearInterval(r),t.onended&&t.onended()),n=t.currentTime},500)})}return}}null!==o&&void 0!==o&&"screen"===o.video||navigator.mediaDevices.enumerateDevices().then(function(i){var s=i.some(function(e){return"audioinput"===e.kind}),u=I(o)||i.some(function(e){return"videoinput"===e.kind}),l=L(o),d=O(o),c=T(o),f=x(o);if(l||d||c||f){var h=!!l&&s,p=!!d&&u;if(!h&&!p)return a.consentDialog(!1),t.error("No capture device found"),!1;if(!h&&c)return a.consentDialog(!1),t.error("Audio capture is required, but no capture device found"),!1;if(!p&&f)return a.consentDialog(!1),t.error("Video capture is required, but no capture device found"),!1}var m={audio:!!s&&g,video:!!u&&y};r.debug("getUserMedia constraints",m),navigator.mediaDevices.getUserMedia(m).then(function(r){a.consentDialog(!1),_(e,n,o,t,r)}).catch(function(e){a.consentDialog(!1),t.error({code:e.code,name:e.name,message:e.message})})}).catch(function(e){a.consentDialog(!1),t.error("enumerateDevices error",e)})}else _(e,n,o,t)}function m(e,t){t=t||{},t.success="function"==typeof t.success?t.success:r.noop,t.error="function"==typeof t.error?t.error:E;var n=t.jsep,i=te[e];if(null===i||void 0===i||null===i.webrtcStuff||void 0===i.webrtcStuff)return r.warn("Invalid handle"),void t.error("Invalid handle");var o=i.webrtcStuff;if(void 0!==n&&null!==n){if(null===o.pc)return r.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void t.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");o.pc.setRemoteDescription(n).then(function(){if(r.log("Remote description accepted!"),o.remoteSdp=n.sdp,o.candidates&&o.candidates.length>0){for(var e in o.candidates){var i=o.candidates[e];r.debug("Adding remote candidate:",i),i&&!0!==i.completed?o.pc.addIceCandidate(i):o.pc.addIceCandidate()}o.candidates=[]}t.success()},t.error)}else t.error("Invalid JSEP")}function v(e,t,n){n=n||{},n.success="function"==typeof n.success?n.success:r.noop,n.error="function"==typeof n.error?n.error:r.noop;var i=te[e];if(null===i||void 0===i||null===i.webrtcStuff||void 0===i.webrtcStuff)return r.warn("Invalid handle"),void n.error("Invalid handle");var o=i.webrtcStuff,a=!0===n.simulcast;a?r.log("Creating offer (iceDone="+o.iceDone+", simulcast="+a+")"):r.log("Creating offer (iceDone="+o.iceDone+")");var s={};if("firefox"===r.webRTCAdapter.browserDetails.browser&&r.webRTCAdapter.browserDetails.version>=59){var u=null,l=null,d=o.pc.getTransceivers();if(d&&d.length>0)for(var c in d){var f=d[c];f.sender&&f.sender.track&&"audio"===f.sender.track.kind||f.receiver&&f.receiver.track&&"audio"===f.receiver.track.kind?u||(u=f):(f.sender&&f.sender.track&&"video"===f.sender.track.kind||f.receiver&&f.receiver.track&&"video"===f.receiver.track.kind)&&(l||(l=f))}var h=L(t),_=C(t);h||_?h&&_?u&&(u.direction="sendrecv",r.log("Setting audio transceiver to sendrecv:",u)):h&&!_?u&&(u.direction="sendonly",r.log("Setting audio transceiver to sendonly:",u)):!h&&_&&(u?(u.direction="recvonly",r.log("Setting audio transceiver to recvonly:",u)):(u=o.pc.addTransceiver("audio",{direction:"recvonly"}),r.log("Adding recvonly audio transceiver:",u))):t.removeAudio&&u&&(u.direction="inactive",r.log("Setting audio transceiver to inactive:",u));var p=O(t),m=D(t);p||m?p&&m?l&&(l.direction="sendrecv",r.log("Setting video transceiver to sendrecv:",l)):p&&!m?l&&(l.direction="sendonly",r.log("Setting video transceiver to sendonly:",l)):!p&&m&&(l?(l.direction="recvonly",r.log("Setting video transceiver to recvonly:",l)):(l=o.pc.addTransceiver("video",{direction:"recvonly"}),r.log("Adding recvonly video transceiver:",l))):t.removeVideo&&l&&(l.direction="inactive",r.log("Setting video transceiver to inactive:",l))}else s.offerToReceiveAudio=C(t),s.offerToReceiveVideo=D(t);!0===n.iceRestart&&(s.iceRestart=!0),r.debug(s);var v=O(t);if(v&&a&&"firefox"===r.webRTCAdapter.browserDetails.browser){r.log("Enabling Simulcasting for Firefox (RID)");var g=o.pc.getSenders()[1];r.log(g);var y=g.getParameters();r.log(y),g.setParameters({encodings:[{rid:"high",active:!0,priority:"high",maxBitrate:1e6},{rid:"medium",active:!0,priority:"medium",maxBitrate:3e5},{rid:"low",active:!0,priority:"low",maxBitrate:1e5}]})}o.pc.createOffer(s).then(function(e){if(r.debug(e),r.log("Setting local description"),v&&a&&("chrome"===r.webRTCAdapter.browserDetails.browser?(r.log("Enabling Simulcasting for Chrome (SDP munging)"),e.sdp=A(e.sdp)):"firefox"!==r.webRTCAdapter.browserDetails.browser&&r.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),o.mySdp=e.sdp,o.pc.setLocalDescription(e).catch(n.error),o.mediaConstraints=s,!o.iceDone&&!o.trickle)return void r.log("Waiting for all candidates...");r.log("Offer ready"),r.debug(n);var t={type:e.type,sdp:e.sdp};n.success(t)},n.error)}function g(e,t,n){n=n||{},n.success="function"==typeof n.success?n.success:r.noop,n.error="function"==typeof n.error?n.error:r.noop;var i=te[e];if(null===i||void 0===i||null===i.webrtcStuff||void 0===i.webrtcStuff)return r.warn("Invalid handle"),void n.error("Invalid handle");var o=i.webrtcStuff,a=!0===n.simulcast;a?r.log("Creating answer (iceDone="+o.iceDone+", simulcast="+a+")"):r.log("Creating answer (iceDone="+o.iceDone+")");var s=null;if("firefox"===r.webRTCAdapter.browserDetails.browser&&r.webRTCAdapter.browserDetails.version>=59){s={};var u=null,l=null,d=o.pc.getTransceivers();if(d&&d.length>0)for(var c in d){var f=d[c];f.sender&&f.sender.track&&"audio"===f.sender.track.kind||f.receiver&&f.receiver.track&&"audio"===f.receiver.track.kind?u||(u=f):(f.sender&&f.sender.track&&"video"===f.sender.track.kind||f.receiver&&f.receiver.track&&"video"===f.receiver.track.kind)&&(l||(l=f))}var h=L(t),_=C(t);h||_?h&&_?u&&(u.direction="sendrecv",r.log("Setting audio transceiver to sendrecv:",u)):h&&!_?u&&(u.direction="sendonly",r.log("Setting audio transceiver to sendonly:",u)):!h&&_&&(u?(u.direction="recvonly",r.log("Setting audio transceiver to recvonly:",u)):(u=o.pc.addTransceiver("audio",{direction:"recvonly"}),r.log("Adding recvonly audio transceiver:",u))):t.removeAudio&&u&&(u.direction="inactive",r.log("Setting audio transceiver to inactive:",u));var p=O(t),m=D(t);p||m?p&&m?l&&(l.direction="sendrecv",r.log("Setting video transceiver to sendrecv:",l)):p&&!m?l&&(l.direction="sendonly",r.log("Setting video transceiver to sendonly:",l)):!p&&m&&(l?(l.direction="recvonly",r.log("Setting video transceiver to recvonly:",l)):(l=o.pc.addTransceiver("video",{direction:"recvonly"}),r.log("Adding recvonly video transceiver:",l))):t.removeVideo&&l&&(l.direction="inactive",r.log("Setting video transceiver to inactive:",l))}else s="firefox"==r.webRTCAdapter.browserDetails.browser||"edge"==r.webRTCAdapter.browserDetails.browser?{offerToReceiveAudio:C(t),offerToReceiveVideo:D(t)}:{mandatory:{OfferToReceiveAudio:C(t),OfferToReceiveVideo:D(t)}};r.debug(s);var v=O(t);if(v&&a&&"firefox"===r.webRTCAdapter.browserDetails.browser){r.log("Enabling Simulcasting for Firefox (RID)");var g=o.pc.getSenders()[1];r.log(g);var y=g.getParameters();r.log(y),g.setParameters({encodings:[{rid:"high",active:!0,priority:"high",maxBitrate:1e6},{rid:"medium",active:!0,priority:"medium",maxBitrate:3e5},{rid:"low",active:!0,priority:"low",maxBitrate:1e5}]})}o.pc.createAnswer(s).then(function(e){if(r.debug(e),r.log("Setting local description"),v&&a&&("chrome"===r.webRTCAdapter.browserDetails.browser?r.warn("simulcast=true, but this is an answer, and video breaks in Chrome if we enable it"):"firefox"!==r.webRTCAdapter.browserDetails.browser&&r.warn("simulcast=true, but this is not Chrome nor Firefox, ignoring")),o.mySdp=e.sdp,o.pc.setLocalDescription(e).catch(n.error),o.mediaConstraints=s,!o.iceDone&&!o.trickle)return void r.log("Waiting for all candidates...");var t={type:e.type,sdp:e.sdp};n.success(t)},n.error)}function y(e,t){t=t||{},t.success="function"==typeof t.success?t.success:r.noop,t.error="function"==typeof t.error?t.error:r.noop;var n=te[e];if(null===n||void 0===n||null===n.webrtcStuff||void 0===n.webrtcStuff)return void r.warn("Invalid handle, not sending anything");var i=n.webrtcStuff;if(r.log("Sending offer/answer SDP..."),null===i.mySdp||void 0===i.mySdp)return void r.warn("Local SDP instance is invalid, not sending anything...");i.mySdp={type:i.pc.localDescription.type,sdp:i.pc.localDescription.sdp},!1===i.trickle&&(i.mySdp.trickle=!1),r.debug(t),i.sdpSent=!0,t.success(i.mySdp)}function b(e,t){var n=te[e];if(null===n||void 0===n||null===n.webrtcStuff||void 0===n.webrtcStuff)return r.warn("Invalid handle"),0;var i=t?"remote":"local",o=n.webrtcStuff;return o.volume[i]||(o.volume[i]={value:0}),o.pc.getStats&&"chrome"===r.webRTCAdapter.browserDetails.browser?!t||null!==o.remoteStream&&void 0!==o.remoteStream?t||null!==o.myStream&&void 0!==o.myStream?null===o.volume[i].timer||void 0===o.volume[i].timer?(r.log("Starting "+i+" volume monitor"),o.volume[i].timer=setInterval(function(){o.pc.getStats(function(e){for(var n=e.result(),r=0;r<n.length;r++){var a=n[r];"ssrc"==a.type&&(t&&a.stat("audioOutputLevel")?o.volume[i].value=parseInt(a.stat("audioOutputLevel")):!t&&a.stat("audioInputLevel")&&(o.volume[i].value=parseInt(a.stat("audioInputLevel"))))}})},200),0):o.volume[i].value:(r.warn("Local stream unavailable"),0):(r.warn("Remote stream unavailable"),0):(r.warn("Getting the "+i+" volume unsupported by browser"),0)}function S(e,t){var n=te[e];if(null===n||void 0===n||null===n.webrtcStuff||void 0===n.webrtcStuff)return r.warn("Invalid handle"),!0;var i=n.webrtcStuff;return null===i.pc||void 0===i.pc?(r.warn("Invalid PeerConnection"),!0):void 0===i.myStream||null===i.myStream?(r.warn("Invalid local MediaStream"),!0):t?null===i.myStream.getVideoTracks()||void 0===i.myStream.getVideoTracks()||0===i.myStream.getVideoTracks().length?(r.warn("No video track"),!0):!i.myStream.getVideoTracks()[0].enabled:null===i.myStream.getAudioTracks()||void 0===i.myStream.getAudioTracks()||0===i.myStream.getAudioTracks().length?(r.warn("No audio track"),!0):!i.myStream.getAudioTracks()[0].enabled}function k(e,t,n){var i=te[e];if(null===i||void 0===i||null===i.webrtcStuff||void 0===i.webrtcStuff)return r.warn("Invalid handle"),!1;var o=i.webrtcStuff;return null===o.pc||void 0===o.pc?(r.warn("Invalid PeerConnection"),!1):void 0===o.myStream||null===o.myStream?(r.warn("Invalid local MediaStream"),!1):t?null===o.myStream.getVideoTracks()||void 0===o.myStream.getVideoTracks()||0===o.myStream.getVideoTracks().length?(r.warn("No video track"),!1):(o.myStream.getVideoTracks()[0].enabled=!n,!0):null===o.myStream.getAudioTracks()||void 0===o.myStream.getAudioTracks()||0===o.myStream.getAudioTracks().length?(r.warn("No audio track"),!1):(o.myStream.getAudioTracks()[0].enabled=!n,!0)}function w(e){var t=te[e];if(null===t||void 0===t||null===t.webrtcStuff||void 0===t.webrtcStuff)return r.warn("Invalid handle"),"Invalid handle";var n=t.webrtcStuff;return null===n.pc||void 0===n.pc?"Invalid PeerConnection":n.pc.getStats?null===n.bitrate.timer||void 0===n.bitrate.timer?(r.log("Starting bitrate timer (via getStats)"),n.bitrate.timer=setInterval(function(){n.pc.getStats().then(function(e){e.forEach(function(e){if(e){var t=!1;if(("video"===e.mediaType||e.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===e.type&&e.id.indexOf("rtcp")<0?t=!0:"ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName||(t=!0),t)if(n.bitrate.bsnow=e.bytesReceived,n.bitrate.tsnow=e.timestamp,null===n.bitrate.bsbefore||null===n.bitrate.tsbefore)n.bitrate.bsbefore=n.bitrate.bsnow,n.bitrate.tsbefore=n.bitrate.tsnow;else{var i=n.bitrate.tsnow-n.bitrate.tsbefore;"safari"==r.webRTCAdapter.browserDetails.browser&&(i/=1e3);var o=Math.round(8*(n.bitrate.bsnow-n.bitrate.bsbefore)/i);n.bitrate.value=o+" kbits/sec",n.bitrate.bsbefore=n.bitrate.bsnow,n.bitrate.tsbefore=n.bitrate.tsnow}}})})},1e3),"0 kbits/sec"):n.bitrate.value:(r.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser")}function E(e){r.error("WebRTC error:",e)}function R(e,t){r.log("Cleaning WebRTC stuff");var n=te[e];if(null!==n&&void 0!==n){var i=n.webrtcStuff;if(null!==i&&void 0!==i){if(!0===t){var o={janus:"hangup",transaction:r.randomString(12)};null!==n.token&&void 0!==n.token&&(o.token=n.token),null!==Y&&void 0!==Y&&(o.apisecret=Y),r.debug("Sending hangup request (handle="+e+"):"),r.debug(o),j?(o.session_id=ee,o.handle_id=e,P.send(JSON.stringify(o))):r.httpAPICall(z+"/"+ee+"/"+e,{verb:"POST",withCredentials:K,body:o})}i.remoteStream=null,i.volume&&(i.volume.local&&i.volume.local.timer&&clearInterval(i.volume.local.timer),i.volume.remote&&i.volume.remote.timer&&clearInterval(i.volume.remote.timer)),i.volume={},i.bitrate.timer&&clearInterval(i.bitrate.timer),i.bitrate.timer=null,i.bitrate.bsnow=null,i.bitrate.bsbefore=null,i.bitrate.tsnow=null,i.bitrate.tsbefore=null,i.bitrate.value=null;try{if(!i.streamExternal&&null!==i.myStream&&void 0!==i.myStream){r.log("Stopping local stream tracks");var a=i.myStream.getTracks();for(var s in a){var u=a[s];r.log(u),null!==u&&void 0!==u&&u.stop()}}}catch(e){}i.streamExternal=!1,i.myStream=null;try{i.pc.close()}catch(e){}i.pc=null,i.candidates=null,i.mySdp=null,i.remoteSdp=null,i.iceDone=!1,i.dataChannel=null,i.dtmfSender=null}n.oncleanup()}}function A(e){for(var t=e.split("\r\n"),n=!1,i=[-1],o=[-1],a=null,s=null,u=null,l=null,d=-1,c=0;c<t.length;c++){var f=t[c].match(/m=(\w+) */)
;if(f){var h=f[1];if("video"===h){if(!(i[0]<0)){d=c;break}n=!0}else if(i[0]>-1){d=c;break}}else if(n){var _=t[c].match(/a=ssrc-group:FID (\d+) (\d+)/);if(_)i[0]=_[1],o[0]=_[2],t.splice(c,1),c--;else{if(i[0]){var p=t[c].match("a=ssrc:"+i[0]+" cname:(.+)");if(p&&(a=p[1]),p=t[c].match("a=ssrc:"+i[0]+" msid:(.+)"),p&&(s=p[1]),p=t[c].match("a=ssrc:"+i[0]+" mslabel:(.+)"),p&&(u=p[1]),p=t[c].match("a=ssrc:"+i+" label:(.+)"),p&&(l=p[1]),0===t[c].indexOf("a=ssrc:"+o)){t.splice(c,1),c--;continue}if(0===t[c].indexOf("a=ssrc:"+i[0])){t.splice(c,1),c--;continue}}0!=t[c].length||(t.splice(c,1),c--)}}}if(i[0]<0){d=-1,n=!1;for(var c=0;c<t.length;c++){var f=t[c].match(/m=(\w+) */);if(f){var h=f[1];if("video"===h){if(!(i[0]<0)){d=c;break}n=!0}else if(i[0]>-1){d=c;break}}else if(n){if(i[0]<0){var m=t[c].match(/a=ssrc:(\d+)/);if(m){i[0]=m[1],t.splice(c,1),c--;continue}}else{var p=t[c].match("a=ssrc:"+i[0]+" cname:(.+)");if(p&&(a=p[1]),p=t[c].match("a=ssrc:"+i[0]+" msid:(.+)"),p&&(s=p[1]),p=t[c].match("a=ssrc:"+i[0]+" mslabel:(.+)"),p&&(u=p[1]),p=t[c].match("a=ssrc:"+i[0]+" label:(.+)"),p&&(l=p[1]),0===t[c].indexOf("a=ssrc:"+o[0])){t.splice(c,1),c--;continue}if(0===t[c].indexOf("a=ssrc:"+i[0])){t.splice(c,1),c--;continue}}0!=t[c].length||(t.splice(c,1),c--)}}}if(i[0]<0)return r.warn("Couldn't find the video SSRC, simulcasting NOT enabled"),e;d<0&&(d=t.length),i[1]=Math.floor(4294967295*Math.random()),i[2]=Math.floor(4294967295*Math.random()),o[1]=Math.floor(4294967295*Math.random()),o[2]=Math.floor(4294967295*Math.random());for(var c=0;c<i.length;c++)a&&(t.splice(d,0,"a=ssrc:"+i[c]+" cname:"+a),d++),s&&(t.splice(d,0,"a=ssrc:"+i[c]+" msid:"+s),d++),u&&(t.splice(d,0,"a=ssrc:"+i[c]+" mslabel:"+u),d++),l&&(t.splice(d,0,"a=ssrc:"+i[c]+" label:"+l),d++),a&&(t.splice(d,0,"a=ssrc:"+o[c]+" cname:"+a),d++),s&&(t.splice(d,0,"a=ssrc:"+o[c]+" msid:"+s),d++),u&&(t.splice(d,0,"a=ssrc:"+o[c]+" mslabel:"+u),d++),l&&(t.splice(d,0,"a=ssrc:"+o[c]+" label:"+l),d++);return t.splice(d,0,"a=ssrc-group:FID "+i[2]+" "+o[2]),t.splice(d,0,"a=ssrc-group:FID "+i[1]+" "+o[1]),t.splice(d,0,"a=ssrc-group:FID "+i[0]+" "+o[0]),t.splice(d,0,"a=ssrc-group:SIM "+i[0]+" "+i[1]+" "+i[2]),e=t.join("\r\n"),e.endsWith("\r\n")||(e+="\r\n"),e}function L(e){return r.debug("isAudioSendEnabled:",e),void 0===e||null===e||!1!==e.audio&&(void 0===e.audioSend||null===e.audioSend||!0===e.audioSend)}function T(e){return r.debug("isAudioSendRequired:",e),void 0!==e&&null!==e&&(!1!==e.audio&&!1!==e.audioSend&&(void 0!==e.failIfNoAudio&&null!==e.failIfNoAudio&&!0===e.failIfNoAudio))}function C(e){return r.debug("isAudioRecvEnabled:",e),void 0===e||null===e||!1!==e.audio&&(void 0===e.audioRecv||null===e.audioRecv||!0===e.audioRecv)}function O(e){return r.debug("isVideoSendEnabled:",e),void 0===e||null===e||!1!==e.video&&(void 0===e.videoSend||null===e.videoSend||!0===e.videoSend)}function x(e){return r.debug("isVideoSendRequired:",e),void 0!==e&&null!==e&&(!1!==e.video&&!1!==e.videoSend&&(void 0!==e.failIfNoVideo&&null!==e.failIfNoVideo&&!0===e.failIfNoVideo))}function D(e){return r.debug("isVideoRecvEnabled:",e),void 0===e||null===e||!1!==e.video&&(void 0===e.videoRecv||null===e.videoRecv||!0===e.videoRecv)}function I(e){if(r.debug("isScreenSendEnabled:",e),void 0===e||null===e)return!1;if("object"!==i(e.video)||"object"!==i(e.video.mandatory))return!1;var t=e.video.mandatory;return t.chromeMediaSource?"desktop"===t.chromeMediaSource||"screen"===t.chromeMediaSource:t.mozMediaSource?"window"===t.mozMediaSource||"screen"===t.mozMediaSource:!!t.mediaSource&&("window"===t.mediaSource||"screen"===t.mediaSource)}function M(e){return r.debug("isDataEnabled:",e),"edge"==r.webRTCAdapter.browserDetails.browser?(r.warn("Edge doesn't support data channels yet"),!1):void 0!==e&&null!==e&&!0===e.data}function B(e){return r.debug("isTrickleEnabled:",e),void 0===e||null===e||!0===e}if(void 0===r.initDone)return e.error("Library not initialized"),{};if(!r.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(r.log("Library initialized: "+r.initDone),e=e||{},e.success="function"==typeof e.success?e.success:r.noop,e.error="function"==typeof e.error?e.error:r.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:r.noop,null===e.server||void 0===e.server)return e.error("Invalid server url"),{};var j=!1,P=null,U={},N=null,F=null,V=0,z=e.server;r.isArray(z)?(r.log("Multiple servers provided ("+z.length+"), will use the first that works"),z=null,F=e.server,r.debug(F)):0===z.indexOf("ws")?(j=!0,r.log("Using WebSockets to contact Janus: "+z)):(j=!1,r.log("Using REST API to contact Janus: "+z));var G=e.iceServers;void 0!==G&&null!==G||(G=[{urls:"stun:119.3.6.122:3478"}]);var H=e.iceTransportPolicy,q=e.bundlePolicy,W=e.ipv6;void 0!==W&&null!==W||(W=!1);var K=!1;void 0!==e.withCredentials&&null!==e.withCredentials&&(K=!0===e.withCredentials);var X=null;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(X=e.max_poll_events),X<1&&(X=1);var J=null;void 0!==e.token&&null!==e.token&&(J=e.token);var Y=null;void 0!==e.apisecret&&null!==e.apisecret&&(Y=e.apisecret),this.destroyOnUnload=!0,void 0!==e.destroyOnUnload&&null!==e.destroyOnUnload&&(this.destroyOnUnload=!0===e.destroyOnUnload);var Z=25e3;void 0!==e.keepAlivePeriod&&null!==e.keepAlivePeriod&&(Z=e.keepAlivePeriod),isNaN(Z)&&(Z=25e3);var Q=6e4;void 0!==e.longPollTimeout&&null!==e.longPollTimeout&&(Q=e.longPollTimeout),isNaN(Q)&&(Q=6e4);var $=!1,ee=null,te={},ne=this,re=0,ie={};a(e),this.getServer=function(){return z},this.isConnected=function(){return $},this.reconnect=function(e){e=e||{},e.success="function"==typeof e.success?e.success:r.noop,e.error="function"==typeof e.error?e.error:r.noop,e.reconnect=!0,a(e)},this.getSessionId=function(){return ee},this.destroy=function(e){s(e)},this.attach=function(e){u(e)}}Object.defineProperty(n,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r.sessions={},r.isExtensionEnabled=function(){if(navigator.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){var e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),t=33;return window.navigator.userAgent.match("Linux")&&(t=35),e>=26&&e<=t||r.extension.isInstalled()}return!0};var o={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return null!==document.querySelector("#janus-extension-installed")},getScreen:function(e){var t=window.setTimeout(function(){return error=new Error("NavigatorUserMediaError"),error.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',e(error)},1e3);this.cache[t]=e,window.postMessage({type:"janusGetScreen",id:t},"*")},init:function(){var e={};this.cache=e,window.addEventListener("message",function(t){if(t.origin==window.location.origin)if("janusGotScreen"==t.data.type&&e[t.data.id]){var n=e[t.data.id];if(delete e[t.data.id],""===t.data.sourceId){var r=new Error("NavigatorUserMediaError");r.name="You cancelled the request for permission, giving up...",n(r)}else n(null,t.data.sourceId)}else"janusGetScreenPending"==t.data.type&&(console.log("clearing ",t.data.id),window.clearTimeout(t.data.id))})}};r.useDefaultDependencies=function(e){var t=e&&e.fetch||fetch,n=e&&e.Promise||Promise,a=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new a(e,t)},extension:e&&e.extension||o,isArray:function(e){return Array.isArray(e)},webRTCAdapter:e&&e.adapter||adapter,httpAPICall:function(e,o){var a={method:o.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};"POST"===o.verb&&(a.headers["Content-Type"]="application/json"),void 0!==o.withCredentials&&(a.credentials=!0===o.withCredentials?"include":o.withCredentials?o.withCredentials:"omit"),void 0!==o.body&&(a.body=JSON.stringify(o.body));var s=t(e,a).catch(function(e){return n.reject({message:"Probably a network error, is the server down?",error:e})});if(void 0!==o.timeout){var u=new n(function(e,t){var n=setTimeout(function(){return clearTimeout(n),t({message:"Request timed out",timeout:o.timeout})},o.timeout)});s=n.race([s,u])}return s.then(function(e){return e.ok?i(o.success)===i(r.noop)?e.json().then(function(e){o.success(e)}).catch(function(t){return n.reject({message:"Failed to parse response body",error:t,response:e})}):void 0:n.reject({message:"API call failed",response:e})}).catch(function(e){i(o.error)===i(r.noop)&&o.error(e.message||"<< internal error >>",e)}),s}}},r.useOldDependencies=function(e){var t=e&&e.jQuery||jQuery,n=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new n(e,t)},isArray:function(e){return t.isArray(e)},extension:e&&e.extension||o,webRTCAdapter:e&&e.adapter||adapter,httpAPICall:function(e,n){var o=void 0!==n.body?{contentType:"application/json",data:JSON.stringify(n.body)}:{},a=void 0!==n.withCredentials?{xhrFields:{withCredentials:n.withCredentials}}:{};return t.ajax(t.extend(o,a,{url:e,type:n.verb,cache:!1,dataType:"json",async:n.async,timeout:n.timeout,success:function(e){i(n.success)===i(r.noop)&&n.success(e)},error:function(e,t,o){i(n.error)===i(r.noop)&&n.error(t,o)}}))}}},r.noop=function(){},r.init=function(e){if(e=e||{},e.callback="function"==typeof e.callback?e.callback:r.noop,!0===r.initDone)e.callback();else{if("undefined"!=typeof console&&void 0!==console.log||(console={log:function(){}}),r.trace=r.noop,r.debug=r.noop,r.vdebug=r.noop,r.log=r.noop,r.warn=r.noop,r.error=r.noop,!0===e.debug||"all"===e.debug)r.trace=console.trace.bind(console),r.debug=console.debug.bind(console),r.vdebug=console.debug.bind(console),r.log=console.log.bind(console),r.warn=console.warn.bind(console),r.error=console.error.bind(console);else if(Array.isArray(e.debug))for(var t in e.debug){var n=e.debug[t];switch(n){case"trace":r.trace=console.trace.bind(console);break;case"debug":r.debug=console.debug.bind(console);break;case"vdebug":r.vdebug=console.debug.bind(console);break;case"log":r.log=console.log.bind(console);break;case"warn":r.warn=console.warn.bind(console);break;case"error":r.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+n+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}}r.log("Initializing library");var i=e.dependencies||r.useDefaultDependencies();r.isArray=i.isArray,r.webRTCAdapter=i.webRTCAdapter,r.httpAPICall=i.httpAPICall,r.newWebSocket=i.newWebSocket,r.extension=i.extension,r.extension.init(),r.listDevices=function(e,t){e="function"==typeof e?e:r.noop,null==t&&(t={audio:!0,video:!0}),navigator.mediaDevices?navigator.mediaDevices.getUserMedia(t).then(function(t){navigator.mediaDevices.enumerateDevices().then(function(n){r.debug(n),e(n);try{var i=t.getTracks();for(var o in i){var a=i[o];null!==a&&void 0!==a&&a.stop()}}catch(e){}})}).catch(function(t){r.error(t),e([])}):(r.warn("navigator.mediaDevices unavailable"),e([]))},r.attachMediaStream=function(e,t){if("chrome"===r.webRTCAdapter.browserDetails.browser){r.webRTCAdapter.browserDetails.version>=43?e.srcObject=t:void 0!==e.src?e.src=URL.createObjectURL(t):r.error("Error attaching stream to element")}else e.srcObject=t},r.reattachMediaStream=function(e,t){if("chrome"===r.webRTCAdapter.browserDetails.browser){r.webRTCAdapter.browserDetails.version>=43?e.srcObject=t.srcObject:void 0!==e.src?e.src=t.src:r.error("Error reattaching stream to element")}else e.srcObject=t.srcObject};var o=window.onbeforeunload;window.onbeforeunload=function(){r.log("Closing window");for(var e in r.sessions)null!==r.sessions[e]&&void 0!==r.sessions[e]&&r.sessions[e].destroyOnUnload&&(r.log("Destroying session "+e),r.sessions[e].destroy({asyncRequest:!1,notifyDestroyed:!1}));o&&"function"==typeof o&&o()},r.initDone=!0,e.callback()}},r.isWebrtcSupported=function(){return void 0!==window.RTCPeerConnection&&null!==window.RTCPeerConnection&&void 0!==navigator.getUserMedia&&null!==navigator.getUserMedia},r.randomString=function(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n="",r=0;r<e;r++){var i=Math.floor(Math.random()*t.length);n+=t.substring(i,i+1)}return n},n.default=r},{}],35:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=e("./janus.js"),s=r(a),u=e("events"),l=r(u),d=e("../utils/exception.js"),c=e("./player-events.js"),f=r(c),h=e("./player-errors.js"),_=!1;!function(){s.default.init({debug:!0,dependencies:s.default.useDefaultDependencies(),callback:function(){s.default.log("Janus inited"),_=!0}})}();var p=function(){function e(t,n){if(i(this,e),this.TAG="JanusStreamPlayer",this._type="JanusStreamPlayer",this._emitter=new l.default,this._config=n,"janusstream"!=t.type.toLowerCase())throw new d.InvalidArgumentException("JanusStreamPlayer requires an JanusStream MediaDataSource input!");1==t.isLive&&(this._config.isLive=!0),this.e={onvLoadedMetadata:this._onvLoadedMetadata.bind(this),onvSeeking:this._onvSeeking.bind(this),onvCanPlay:this._onvCanPlay.bind(this),onvStalled:this._onvStalled.bind(this),onvProgress:this._onvProgress.bind(this),onvTimeUpdate:this._onvTimeUpdate.bind(this)},this._now=Date.now,this._requestSetTime=!1,this._seekpointRecord=null,this._progressChecker=null,this._mediaDataSource=t,this._mediaElement=null,this._hasPendingLoad=!1,this._receivedCanPlay=!1,this._mediaInfo=null,this._statisticsInfo=null,this._processStateCount=0,this._streamTimer=null,this._pluginHandle=null}return o(e,[{key:"destroy",value:function(){null!=this._progressChecker&&(window.clearInterval(this._progressChecker),this._progressChecker=null),this._mediaElement&&this.detachMediaElement()}},{key:"on",value:function(e,t){this._emitter.addListener(e,t)}},{key:"off",value:function(e,t){this._emitter.removeListener(e,t)}},{key:"attachMediaElement",value:function(e){this._processStateCount=0,this._mediaElement=e,e.addEventListener("loadedmetadata",this.e.onvLoadedMetadata),e.addEventListener("seeking",this.e.onvSeeking),e.addEventListener("canplay",this.e.onvCanPlay),e.addEventListener("stalled",this.e.onvStalled),e.addEventListener("progress",this.e.onvProgress),e.addEventListener("timeupdate",this.e.onvTimeUpdate)}},{key:"detachMediaElement",value:function(){if(this._mediaElement&&(this._mediaElement.removeEventListener("loadedmetadata",this.e.onvLoadedMetadata),this._mediaElement.removeEventListener("seeking",this.e.onvSeeking),this._mediaElement.removeEventListener("canplay",this.e.onvCanPlay),this._mediaElement.removeEventListener("stalled",this.e.onvStalled),this._mediaElement.removeEventListener("progress",this.e.onvProgress),this._mediaElement.removeEventListener("timeupdate",this.e.onvTimeUpdate),this._mediaElement=null,this._streamTimer&&(clearInterval(this._streamTimer),this._streamTimer=null)),this._pluginHandle){var e={request:"stop"};this._pluginHandle.send({message:e}),this._pluginHandle.hangup(),this._janus&&(this._janus.destroy(),this._janus=null)}}},{key:"load",value:function(){}},{key:"unload",value:function(){}},{key:"play",value:function(){this._janus||(this._janus=new s.default({server:this._config.server,success:this._onServerConnected.bind(this),error:this._onServerConnectError.bind(this)}))}},{key:"pause",value:function(){this._mediaElement.pause()}},{key:"resume",value:function(e){e&&(this._mediaDataSource.url=e),this.detachMediaElement(),this.attachMediaElement(this._mediaElement),this.play()}},{key:"_checkAndResumeStuckPlayback",value:function(e){}},{key:"_onvLoadedMetadata",value:function(e){}},{key:"_onvSeeking",value:function(e){}},{key:"_onvCanPlay",value:function(e){}},{key:"_onvStalled",value:function(e){}},{key:"_onvProgress",value:function(e){this._checkAndResumeStuckPlayback()}},{key:"_onvTimeUpdate",value:function(e){this._processStateCount=0}},{key:"_onServerConnected",value:function(){s.default.log("Janus server connect success");var e=navigator.userAgent;e.indexOf("Chrome")<0&&e.indexOf("Safari")>-1&&navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function(e){console.log("getUserMedia OK")}).catch(function(e){console.log("getUserMedia error "+e.name+" "+e.message)});var t="janus.plugin.streamdistrib"+s.default.randomString(12);this._janus.attach({plugin:"janus.plugin.streamdistrib",opaqueId:t,success:this._onPluginAttached.bind(this),error:this._onPluginAttachError.bind(this),onmessage:this._onPluginMsg.bind(this),onremotestream:this._onRemoteStream.bind(this),oncleanup:this._onJanusCleanup.bind(this)})}},{key:"_onServerConnectError",value:function(e){s.default.error("connectJanusServer error "+e),this._janus=null,this._emitter.emit(f.default.ERROR,h.ErrorTypes.NETWORK_ERROR,e,{code:-1,msg:"Connect Janus Server Error"}),this.destroy()}},{key:"_onPluginAttached",value:function(e){this._pluginHandle=e,s.default.log("plugin attached! ("+e.getPlugin()+" , id= "+e.getId()+")");var t={request:"watch",type:"streamdistrib",source:this._mediaDataSource.url};e.send({message:t})}},{key:"_onPluginAttachError",value:function(e){s.default.error("attach plugin error",e),this._emitter.emit(f.default.ERROR,h.ErrorTypes.NETWORK_ERROR,e,{code:-1,msg:"Attach Stream Plugin Error"}),this.destroy()}},{key:"_onPluginMsg",value:function(e,t){s.default.debug("got a message"),s.default.debug(e);var n=e.result;if(null!==n&&void 0!==n){if(void 0!==n.status&&null!==n.status){var r=n.status;"preparing"===r&&void 0!==t&&null!==t&&(s.default.debug("Handling SDP as well..."),s.default.debug(t),this._pluginHandle.createAnswer({jsep:t,media:{audioSend:!1,videoSend:!1},success:this._onCreateAnswerSuccess.bind(this),error:this._onCreateAnswerError.bind(this)}))}}else if(void 0!==e.error&&null!==e.error)return void(455==e.error_code&&(this._emitter.emit(f.default.ERROR,h.ErrorTypes.NETWORK_ERROR,e.error,{code:404,msg:"Not Found"}),this.destroy()))}},{key:"_onRemoteStream",value:function(e){s.default.debug(" got a remote stream"),s.default.debug(e),s.default.attachMediaStream(this._mediaElement,e),this._mediaElement.play()}},{key:"_onJanusCleanup",value:function(){s.default.log(" ::: Got a cleanup notification :::")}},{key:"_onCreateAnswerSuccess",value:function(e){s.default.debug("Got SDP!"),s.default.debug(e);var t={request:"start"};this._pluginHandle.send({message:t,jsep:e})}},{key:"_onCreateAnswerError",value:function(e){s.default.error("WebRTC error:",e),this._emitter.emit(f.default.ERROR,h.ErrorTypes.MEDIA_ERROR,e,{code:-1,msg:"WebRTC CreateAnswer Error"}),this.destroy()}},{key:"type",get:function(){return this._type}},{key:"buffered",get:function(){return this._mediaElement.buffered}},{key:"duration",get:function(){return this._mediaElement.duration}},{key:"volume",get:function(){return this._mediaElement.volume},set:function(e){this._mediaElement.volume=e}},{key:"muted",get:function(){return this._mediaElement.muted},set:function(e){this._mediaElement.muted=e}},{key:"currentTime",get:function(){if(this._mediaElement)return this._mediaElement.currentTime},set:function(e){this._mediaElement&&this._internalSeek(e)}}]),e}();n.default=p},{"../utils/exception.js":43,"./janus.js":34,"./player-errors.js":37,"./player-events.js":38,events:2}],36:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=e("events"),u=r(s),l=e("./player-events.js"),d=r(l),c=e("../config.js"),f=e("../utils/exception.js"),h=function(){function e(t,n){if(i(this,e),this.TAG="NativePlayer",this._type="NativePlayer",this._emitter=new u.default,this._config=(0,c.createDefaultConfig)(),"object"===(void 0===n?"undefined":o(n))&&Object.assign(this._config,n),"flv"===t.type.toLowerCase())throw new f.InvalidArgumentException("NativePlayer does't support flv MediaDataSource input!");if(t.hasOwnProperty("segments"))throw new f.InvalidArgumentException("NativePlayer("+t.type+") doesn't support multipart playback!");this.e={onvLoadedMetadata:this._onvLoadedMetadata.bind(this)},this._pendingSeekTime=null,this._statisticsReporter=null,this._mediaDataSource=t,this._mediaElement=null}return a(e,[{key:"destroy",value:function(){this._mediaElement&&(this.unload(),this.detachMediaElement()),this.e=null,this._mediaDataSource=null,this._emitter.removeAllListeners(),this._emitter=null}},{key:"on",value:function(e,t){var n=this;e===d.default.MEDIA_INFO?null!=this._mediaElement&&0!==this._mediaElement.readyState&&Promise.resolve().then(function(){n._emitter.emit(d.default.MEDIA_INFO,n.mediaInfo)}):e===d.default.STATISTICS_INFO&&null!=this._mediaElement&&0!==this._mediaElement.readyState&&Promise.resolve().then(function(){n._emitter.emit(d.default.STATISTICS_INFO,n.statisticsInfo)}),this._emitter.addListener(e,t)}},{key:"off",value:function(e,t){this._emitter.removeListener(e,t)}},{key:"attachMediaElement",value:function(e){if(this._mediaElement=e,e.addEventListener("loadedmetadata",this.e.onvLoadedMetadata),null!=this._pendingSeekTime)try{e.currentTime=this._pendingSeekTime,this._pendingSeekTime=null}catch(e){}}},{key:"detachMediaElement",value:function(){this._mediaElement&&(this._mediaElement.src="",this._mediaElement.removeAttribute("src"),this._mediaElement.removeEventListener("loadedmetadata",this.e.onvLoadedMetadata),this._mediaElement=null),null!=this._statisticsReporter&&(window.clearInterval(this._statisticsReporter),this._statisticsReporter=null)}},{key:"load",value:function(){if(!this._mediaElement)throw new f.IllegalStateException("HTMLMediaElement must be attached before load()!");this._mediaElement.src=this._mediaDataSource.url,this._mediaElement.readyState>0&&(this._mediaElement.currentTime=0),this._mediaElement.preload="auto",this._mediaElement.load(),this._statisticsReporter=window.setInterval(this._reportStatisticsInfo.bind(this),this._config.statisticsInfoReportInterval)}},{key:"unload",value:function(){this._mediaElement&&(this._mediaElement.src="",this._mediaElement.removeAttribute("src")),null!=this._statisticsReporter&&(window.clearInterval(this._statisticsReporter),this._statisticsReporter=null)}},{key:"play",value:function(){return this._mediaElement.play()}},{key:"pause",value:function(){this._mediaElement.pause()}},{key:"_onvLoadedMetadata",value:function(e){null!=this._pendingSeekTime&&(this._mediaElement.currentTime=this._pendingSeekTime,this._pendingSeekTime=null),this._emitter.emit(d.default.MEDIA_INFO,this.mediaInfo)}},{key:"_reportStatisticsInfo",value:function(){this._emitter.emit(d.default.STATISTICS_INFO,this.statisticsInfo)}},{key:"type",get:function(){return this._type}},{key:"buffered",get:function(){return this._mediaElement.buffered}},{key:"duration",get:function(){return this._mediaElement.duration}},{key:"volume",get:function(){return this._mediaElement.volume},set:function(e){this._mediaElement.volume=e}},{key:"muted",get:function(){return this._mediaElement.muted},set:function(e){this._mediaElement.muted=e}},{key:"currentTime",get:function(){return this._mediaElement?this._mediaElement.currentTime:0},set:function(e){this._mediaElement?this._mediaElement.currentTime=e:this._pendingSeekTime=e}},{key:"mediaInfo",get:function(){var e=this._mediaElement instanceof HTMLAudioElement?"audio/":"video/",t={mimeType:e+this._mediaDataSource.type};return this._mediaElement&&(t.duration=Math.floor(1e3*this._mediaElement.duration),this._mediaElement instanceof HTMLVideoElement&&(t.width=this._mediaElement.videoWidth,t.height=this._mediaElement.videoHeight)),t}},{key:"statisticsInfo",get:function(){var e={playerType:this._type,url:this._mediaDataSource.url};if(!(this._mediaElement instanceof HTMLVideoElement))return e;var t=!0,n=0,r=0;if(this._mediaElement.getVideoPlaybackQuality){var i=this._mediaElement.getVideoPlaybackQuality();n=i.totalVideoFrames,r=i.droppedVideoFrames}else void 0!=this._mediaElement.webkitDecodedFrameCount?(n=this._mediaElement.webkitDecodedFrameCount,r=this._mediaElement.webkitDroppedFrameCount):t=!1;return t&&(e.decodedFrames=n,e.droppedFrames=r),e}}]),e}();n.default=h},{"../config.js":5,"../utils/exception.js":43,"./player-events.js":38,events:2}],37:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.ErrorDetails=n.ErrorTypes=void 0;var r=e("../io/loader.js"),i=e("../demux/demux-errors.js"),o=function(e){return e&&e.__esModule?e:{default:e}}(i);n.ErrorTypes={NETWORK_ERROR:"NetworkError",MEDIA_ERROR:"MediaError",OTHER_ERROR:"OtherError"},n.ErrorDetails={NETWORK_EXCEPTION:r.LoaderErrors.EXCEPTION,NETWORK_STATUS_CODE_INVALID:r.LoaderErrors.HTTP_STATUS_CODE_INVALID,NETWORK_TIMEOUT:r.LoaderErrors.CONNECTING_TIMEOUT,NETWORK_UNRECOVERABLE_EARLY_EOF:r.LoaderErrors.UNRECOVERABLE_EARLY_EOF,MEDIA_MSE_ERROR:"MediaMSEError",MEDIA_FORMAT_ERROR:o.default.FORMAT_ERROR,MEDIA_FORMAT_UNSUPPORTED:o.default.FORMAT_UNSUPPORTED,MEDIA_CODEC_UNSUPPORTED:o.default.CODEC_UNSUPPORTED,NEED_REPLAY:"NeedReplay"}},{"../demux/demux-errors.js":17,"../io/loader.js":25}],38:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r={ERROR:"error",LOADING_COMPLETE:"loading_complete",RECOVERED_EARLY_EOF:"recovered_early_eof",MEDIA_INFO:"media_info",STATISTICS_INFO:"statistics_info"};n.default=r},{}],39:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function e(){r(this,e)}return i(e,null,[{key:"getSilentFrame",value:function(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null}}]),e}();n.default=o},{}],40:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function e(){r(this,e)}return i(e,null,[{key:"init",value:function(){e.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[],".mp3":[]};for(var t in e.types)e.types.hasOwnProperty(t)&&(e.types[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]);var n=e.constants={};n.FTYP=new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,97,118,99,49]),n.STSD_PREFIX=new Uint8Array([0,0,0,0,0,0,0,1]),n.STTS=new Uint8Array([0,0,0,0,0,0,0,0]),n.STSC=n.STCO=n.STTS,n.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),n.HDLR_VIDEO=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),n.HDLR_AUDIO=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]),n.DREF=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),n.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),n.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0])}},{key:"box",value:function(e){for(var t=8,n=null,r=Array.prototype.slice.call(arguments,1),i=r.length,o=0;o<i;o++)t+=r[o].byteLength;n=new Uint8Array(t),n[0]=t>>>24&255,n[1]=t>>>16&255,n[2]=t>>>8&255,n[3]=255&t,n.set(e,4);for(var a=8,s=0;s<i;s++)n.set(r[s],a),a+=r[s].byteLength;return n}},{key:"generateInitSegment",value:function(t){var n=e.box(e.types.ftyp,e.constants.FTYP),r=e.moov(t),i=new Uint8Array(n.byteLength+r.byteLength);return i.set(n,0),i.set(r,n.byteLength),i}},{key:"moov",value:function(t){var n=e.mvhd(t.timescale,t.duration),r=e.trak(t),i=e.mvex(t);return e.box(e.types.moov,n,r,i)}},{key:"mvhd",value:function(t,n){return e.box(e.types.mvhd,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t,n>>>24&255,n>>>16&255,n>>>8&255,255&n,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]))}},{key:"trak",value:function(t){return e.box(e.types.trak,e.tkhd(t),e.mdia(t))}},{key:"tkhd",value:function(t){var n=t.id,r=t.duration,i=t.presentWidth,o=t.presentHeight;return e.box(e.types.tkhd,new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,n>>>24&255,n>>>16&255,n>>>8&255,255&n,0,0,0,0,r>>>24&255,r>>>16&255,r>>>8&255,255&r,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,i>>>8&255,255&i,0,0,o>>>8&255,255&o,0,0]))}},{key:"mdia",value:function(t){return e.box(e.types.mdia,e.mdhd(t),e.hdlr(t),e.minf(t))}},{key:"mdhd",value:function(t){var n=t.timescale,r=t.duration;return e.box(e.types.mdhd,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,n>>>24&255,n>>>16&255,n>>>8&255,255&n,r>>>24&255,r>>>16&255,r>>>8&255,255&r,85,196,0,0]))}},{key:"hdlr",value:function(t){var n=null;return n="audio"===t.type?e.constants.HDLR_AUDIO:e.constants.HDLR_VIDEO,e.box(e.types.hdlr,n)}},{key:"minf",value:function(t){var n=null;return n="audio"===t.type?e.box(e.types.smhd,e.constants.SMHD):e.box(e.types.vmhd,e.constants.VMHD),e.box(e.types.minf,n,e.dinf(),e.stbl(t))}},{key:"dinf",value:function(){return e.box(e.types.dinf,e.box(e.types.dref,e.constants.DREF))}},{key:"stbl",value:function(t){return e.box(e.types.stbl,e.stsd(t),e.box(e.types.stts,e.constants.STTS),e.box(e.types.stsc,e.constants.STSC),e.box(e.types.stsz,e.constants.STSZ),e.box(e.types.stco,e.constants.STCO))}},{key:"stsd",value:function(t){
return"audio"===t.type?"mp3"===t.codec?e.box(e.types.stsd,e.constants.STSD_PREFIX,e.mp3(t)):e.box(e.types.stsd,e.constants.STSD_PREFIX,e.mp4a(t)):e.box(e.types.stsd,e.constants.STSD_PREFIX,e.avc1(t))}},{key:"mp3",value:function(t){var n=t.channelCount,r=t.audioSampleRate,i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,n,0,16,0,0,0,0,r>>>8&255,255&r,0,0]);return e.box(e.types[".mp3"],i)}},{key:"mp4a",value:function(t){var n=t.channelCount,r=t.audioSampleRate,i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,n,0,16,0,0,0,0,r>>>8&255,255&r,0,0]);return e.box(e.types.mp4a,i,e.esds(t))}},{key:"esds",value:function(t){var n=t.config||[],r=n.length,i=new Uint8Array([0,0,0,0,3,23+r,0,1,0,4,15+r,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([r]).concat(n).concat([6,1,2]));return e.box(e.types.esds,i)}},{key:"avc1",value:function(t){var n=t.avcc,r=t.codecWidth,i=t.codecHeight,o=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,r>>>8&255,255&r,i>>>8&255,255&i,0,72,0,0,0,72,0,0,0,0,0,0,0,1,10,120,113,113,47,102,108,118,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,255,255]);return e.box(e.types.avc1,o,e.box(e.types.avcC,n))}},{key:"mvex",value:function(t){return e.box(e.types.mvex,e.trex(t))}},{key:"trex",value:function(t){var n=t.id,r=new Uint8Array([0,0,0,0,n>>>24&255,n>>>16&255,n>>>8&255,255&n,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]);return e.box(e.types.trex,r)}},{key:"moof",value:function(t,n){return e.box(e.types.moof,e.mfhd(t.sequenceNumber),e.traf(t,n))}},{key:"mfhd",value:function(t){var n=new Uint8Array([0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t]);return e.box(e.types.mfhd,n)}},{key:"traf",value:function(t,n){var r=t.id,i=e.box(e.types.tfhd,new Uint8Array([0,0,0,0,r>>>24&255,r>>>16&255,r>>>8&255,255&r])),o=e.box(e.types.tfdt,new Uint8Array([0,0,0,0,n>>>24&255,n>>>16&255,n>>>8&255,255&n])),a=e.sdtp(t),s=e.trun(t,a.byteLength+16+16+8+16+8+8);return e.box(e.types.traf,i,o,s,a)}},{key:"sdtp",value:function(t){for(var n=t.samples||[],r=n.length,i=new Uint8Array(4+r),o=0;o<r;o++){var a=n[o].flags;i[o+4]=a.isLeading<<6|a.dependsOn<<4|a.isDependedOn<<2|a.hasRedundancy}return e.box(e.types.sdtp,i)}},{key:"trun",value:function(t,n){var r=t.samples||[],i=r.length,o=12+16*i,a=new Uint8Array(o);n+=8+o,a.set([0,0,15,1,i>>>24&255,i>>>16&255,i>>>8&255,255&i,n>>>24&255,n>>>16&255,n>>>8&255,255&n],0);for(var s=0;s<i;s++){var u=r[s].duration,l=r[s].size,d=r[s].flags,c=r[s].cts;a.set([u>>>24&255,u>>>16&255,u>>>8&255,255&u,l>>>24&255,l>>>16&255,l>>>8&255,255&l,d.isLeading<<2|d.dependsOn,d.isDependedOn<<6|d.hasRedundancy<<4|d.isNonSync,0,0,c>>>24&255,c>>>16&255,c>>>8&255,255&c],12+16*s)}return e.box(e.types.trun,a)}},{key:"mdat",value:function(t){return e.box(e.types.mdat,t)}}]),e}();o.init(),n.default=o},{}],41:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=e("../utils/logger.js"),s=r(a),u=e("./mp4-generator.js"),l=r(u),d=e("./aac-silent.js"),c=r(d),f=e("../utils/browser.js"),h=r(f),_=e("../core/media-segment-info.js"),p=e("../utils/exception.js"),m=function(){function e(t){i(this,e),this.TAG="MP4Remuxer",this._config=t,this._isLive=!0===t.isLive,this._dtsBase=-1,this._dtsBaseInited=!1,this._audioDtsBase=1/0,this._videoDtsBase=1/0,this._audioNextDts=void 0,this._videoNextDts=void 0,this._audioMeta=null,this._videoMeta=null,this._audioSegmentInfoList=new _.MediaSegmentInfoList("audio"),this._videoSegmentInfoList=new _.MediaSegmentInfoList("video"),this._onInitSegment=null,this._onMediaSegment=null,this._forceFirstIDR=!(!h.default.chrome||!(h.default.version.major<50||50===h.default.version.major&&h.default.version.build<2661)),this._fillSilentAfterSeek=h.default.msedge||h.default.msie,this._mp3UseMpegAudio=!h.default.firefox,this._fillAudioTimestampGap=this._config.fixAudioTimestampGap}return o(e,[{key:"destroy",value:function(){this._dtsBase=-1,this._dtsBaseInited=!1,this._audioMeta=null,this._videoMeta=null,this._audioSegmentInfoList.clear(),this._audioSegmentInfoList=null,this._videoSegmentInfoList.clear(),this._videoSegmentInfoList=null,this._onInitSegment=null,this._onMediaSegment=null}},{key:"bindDataSource",value:function(e){return e.onDataAvailable=this.remux.bind(this),e.onTrackMetadata=this._onTrackMetadataReceived.bind(this),this}},{key:"insertDiscontinuity",value:function(){this._audioNextDts=this._videoNextDts=void 0}},{key:"seek",value:function(e){this._videoSegmentInfoList.clear(),this._audioSegmentInfoList.clear()}},{key:"remux",value:function(e,t){if(!this._onMediaSegment)throw new p.IllegalStateException("MP4Remuxer: onMediaSegment callback must be specificed!");this._dtsBaseInited||this._calculateDtsBase(e,t),this._remuxVideo(t),this._remuxAudio(e)}},{key:"_onTrackMetadataReceived",value:function(e,t){var n=null,r="mp4",i=t.codec;if("audio"===e)this._audioMeta=t,"mp3"===t.codec&&this._mp3UseMpegAudio?(r="mpeg",i="",n=new Uint8Array):n=l.default.generateInitSegment(t);else{if("video"!==e)return;this._videoMeta=t,n=l.default.generateInitSegment(t)}if(!this._onInitSegment)throw new p.IllegalStateException("MP4Remuxer: onInitSegment callback must be specified!");this._onInitSegment(e,{type:e,data:n.buffer,codec:i,container:e+"/"+r,mediaDuration:t.duration})}},{key:"_calculateDtsBase",value:function(e,t){this._dtsBaseInited||(e.samples&&e.samples.length&&(this._audioDtsBase=e.samples[0].dts),t.samples&&t.samples.length&&(this._videoDtsBase=t.samples[0].dts),this._dtsBase=Math.min(this._audioDtsBase,this._videoDtsBase),this._dtsBaseInited=!0)}},{key:"_remuxAudio",value:function(e){if(null!=this._audioMeta){var t=e,n=t.samples,r=void 0,i=-1,o=-1,a=this._audioMeta.refSampleDuration,u="mp3"===this._audioMeta.codec&&this._mp3UseMpegAudio,d=this._dtsBaseInited&&void 0===this._audioNextDts,f=!1;if(n&&0!==n.length){var p=0,m=null,v=0;u?(p=0,v=t.length):(p=8,v=8+t.length);var g=n[0].dts-this._dtsBase;if(this._audioNextDts)r=g-this._audioNextDts;else if(this._audioSegmentInfoList.isEmpty())r=0,this._fillSilentAfterSeek&&!this._videoSegmentInfoList.isEmpty()&&"mp3"!==this._audioMeta.originalCodec&&(f=!0);else{var y=this._audioSegmentInfoList.getLastSampleBefore(g);if(null!=y){var b=g-(y.originalDts+y.duration);b<=3&&(b=0);var S=y.dts+y.duration+b;r=g-S}else r=0}if(f){var k=g-r,w=this._videoSegmentInfoList.getLastSegmentBefore(g);if(null!=w&&w.beginDts<k){var E=c.default.getSilentFrame(this._audioMeta.originalCodec,this._audioMeta.channelCount);if(E){var R=w.beginDts,A=k-w.beginDts;s.default.v(this.TAG,"InsertPrefixSilentAudio: dts: "+R+", duration: "+A),n.unshift({unit:E,dts:R,pts:R}),v+=E.byteLength}}else f=!1}for(var L=[],T=0;T<n.length;T++){var C=n[T],O=C.unit,x=C.dts-this._dtsBase,D=x-r;this.lastAudioDts||(this.lastAudioDts=x),x-this.lastAudioDts>3e3&&this.meanAudioDuration>0&&(x=this.lastAudioDts+this.meanAudioDuration,D=x),this.lastAudioDts=x,-1===i&&(i=D);var I=0;if(this.meanAudioDuration||(this.meanAudioDuration=0),T!==n.length-1){I=n[T+1].dts-this._dtsBase-r-D}else I=L.length>=1?L[L.length-1].duration:Math.floor(a);I<1e3&&I>0?this.meanAudioDuration=(this.meanAudioDuration+I)/2:I=this.meanAudioDuration;var M=!1,B=null;if(I>1.5*a&&"mp3"!==this._audioMeta.codec&&this._fillAudioTimestampGap&&!h.default.safari){M=!0;var j=Math.abs(I-a),P=Math.ceil(j/a),U=D+a;s.default.w(this.TAG,"Large audio timestamp gap detected, may cause AV sync to drift. Silent frames will be generated to avoid unsync.\ndts: "+(D+I)+" ms, expected: "+(D+Math.round(a))+" ms, delta: "+Math.round(j)+" ms, generate: "+P+" frames");var N=c.default.getSilentFrame(this._audioMeta.originalCodec,this._audioMeta.channelCount);null==N&&(s.default.w(this.TAG,"Unable to generate silent frame for "+this._audioMeta.originalCodec+" with "+this._audioMeta.channelCount+" channels, repeat last frame"),N=O),B=[];for(var F=0;F<P;F++){var V=Math.round(U);if(B.length>0){var z=B[B.length-1];z.duration=V-z.dts}var G={dts:V,pts:V,cts:0,unit:N,size:N.byteLength,duration:0,originalDts:x,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0}};B.push(G),v+=O.byteLength,U+=a}var H=B[B.length-1];H.duration=D+I-H.dts,I=Math.round(a)}L.push({dts:D,pts:D,cts:0,unit:C.unit,size:C.unit.byteLength,duration:I,originalDts:x,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0}}),M&&L.push.apply(L,B)}u?m=new Uint8Array(v):(m=new Uint8Array(v),m[0]=v>>>24&255,m[1]=v>>>16&255,m[2]=v>>>8&255,m[3]=255&v,m.set(l.default.types.mdat,4));for(var q=0;q<L.length;q++){var W=L[q].unit;m.set(W,p),p+=W.byteLength}var K=L[L.length-1];o=K.dts+K.duration,this._audioNextDts=o;var X=new _.MediaSegmentInfo;X.beginDts=i,X.endDts=o,X.beginPts=i,X.endPts=o,X.originalBeginDts=L[0].originalDts,X.originalEndDts=K.originalDts+K.duration,X.firstSample=new _.SampleInfo(L[0].dts,L[0].pts,L[0].duration,L[0].originalDts,!1),X.lastSample=new _.SampleInfo(K.dts,K.pts,K.duration,K.originalDts,!1),this._isLive||this._audioSegmentInfoList.append(X),t.samples=L,t.sequenceNumber++;var J=null;J=u?new Uint8Array:l.default.moof(t,i),t.samples=[],t.length=0;var Y={type:"audio",data:this._mergeBoxes(J,m).buffer,sampleCount:L.length,info:X};u&&d&&(Y.timestampOffset=i),this._onMediaSegment("audio",Y)}}}},{key:"_remuxVideo",value:function(e){if(null!=this._videoMeta){var t=e,n=t.samples,r=void 0,i=-1,o=-1,a=-1,s=-1;if(n&&0!==n.length){var u=8,d=8+e.length,c=new Uint8Array(d);c[0]=d>>>24&255,c[1]=d>>>16&255,c[2]=d>>>8&255,c[3]=255&d,c.set(l.default.types.mdat,4);var f=n[0].dts-this._dtsBase;if(this._videoNextDts)r=f-this._videoNextDts;else if(this._videoSegmentInfoList.isEmpty())r=0;else{var h=this._videoSegmentInfoList.getLastSampleBefore(f);if(null!=h){var p=f-(h.originalDts+h.duration);p<=3&&(p=0);var m=h.dts+h.duration+p;r=f-m}else r=0}for(var v=new _.MediaSegmentInfo,g=[],y=0;y<n.length;y++){this.meanVideoDuration||(this.meanVideoDuration=0);var b=n[y],S=b.dts-this._dtsBase,k=b.isKeyframe,w=S-r,E=b.cts,R=w+E;this.lastVideoDts||(this.lastVideoDts=S),S-this.lastVideoDts>3e3&&this.meanVideoDuration>0&&(S=this.lastVideoDts+this.meanVideoDuration,w=S,R=w+E),this.lastVideoDts=S,-1===i&&(i=w,a=R);var A=0;if(y!==n.length-1){A=n[y+1].dts-this._dtsBase-r-w}else A=g.length>=1?g[g.length-1].duration:Math.floor(this._videoMeta.refSampleDuration);if(A<1e3&&A>0?this.meanVideoDuration=(this.meanVideoDuration+A)/2:A=this.meanVideoDuration,k){var L=new _.SampleInfo(w,R,A,b.dts,!0);L.fileposition=b.fileposition,v.appendSyncPoint(L)}g.push({dts:w,pts:R,cts:E,units:b.units,size:b.length,isKeyframe:k,duration:A,originalDts:S,flags:{isLeading:0,dependsOn:k?2:1,isDependedOn:k?1:0,hasRedundancy:0,isNonSync:k?0:1}})}for(var T=0;T<g.length;T++)for(var C=g[T].units;C.length;){var O=C.shift(),x=O.data;c.set(x,u),u+=x.byteLength}var D=g[g.length-1];if(o=D.dts+D.duration,s=D.pts+D.duration,this._videoNextDts=o,v.beginDts=i,v.endDts=o,v.beginPts=a,v.endPts=s,v.originalBeginDts=g[0].originalDts,v.originalEndDts=D.originalDts+D.duration,v.firstSample=new _.SampleInfo(g[0].dts,g[0].pts,g[0].duration,g[0].originalDts,g[0].isKeyframe),v.lastSample=new _.SampleInfo(D.dts,D.pts,D.duration,D.originalDts,D.isKeyframe),this._isLive||this._videoSegmentInfoList.append(v),t.samples=g,t.sequenceNumber++,this._forceFirstIDR){var I=g[0].flags;I.dependsOn=2,I.isNonSync=0}var M=l.default.moof(t,i);t.samples=[],t.length=0,this._onMediaSegment("video",{type:"video",data:this._mergeBoxes(M,c).buffer,sampleCount:g.length,info:v})}}}},{key:"_mergeBoxes",value:function(e,t){var n=new Uint8Array(e.byteLength+t.byteLength);return n.set(e,0),n.set(t,e.byteLength),n}},{key:"onInitSegment",get:function(){return this._onInitSegment},set:function(e){this._onInitSegment=e}},{key:"onMediaSegment",get:function(){return this._onMediaSegment},set:function(e){this._onMediaSegment=e}}]),e}();n.default=m},{"../core/media-segment-info.js":8,"../utils/browser.js":42,"../utils/exception.js":43,"../utils/logger.js":44,"./aac-silent.js":39,"./mp4-generator.js":40}],42:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r={};!function(){var e=self.navigator.userAgent.toLowerCase(),t=/(edge)\/([\w.]+)/.exec(e)||/(opr)[\/]([\w.]+)/.exec(e)||/(chrome)[ \/]([\w.]+)/.exec(e)||/(iemobile)[\/]([\w.]+)/.exec(e)||/(version)(applewebkit)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+).*(version)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||e.indexOf("trident")>=0&&/(rv)(?::| )([\w.]+)/.exec(e)||e.indexOf("compatible")<0&&/(firefox)[ \/]([\w.]+)/.exec(e)||[],n=/(ipad)/.exec(e)||/(ipod)/.exec(e)||/(windows phone)/.exec(e)||/(iphone)/.exec(e)||/(kindle)/.exec(e)||/(android)/.exec(e)||/(windows)/.exec(e)||/(mac)/.exec(e)||/(linux)/.exec(e)||/(cros)/.exec(e)||[],i={browser:t[5]||t[3]||t[1]||"",version:t[2]||t[4]||"0",majorVersion:t[4]||t[2]||"0",platform:n[0]||""},o={};if(i.browser){o[i.browser]=!0;var a=i.majorVersion.split(".");o.version={major:parseInt(i.majorVersion,10),string:i.version},a.length>1&&(o.version.minor=parseInt(a[1],10)),a.length>2&&(o.version.build=parseInt(a[2],10))}i.platform&&(o[i.platform]=!0),(o.chrome||o.opr||o.safari)&&(o.webkit=!0),(o.rv||o.iemobile)&&(o.rv&&delete o.rv,i.browser="msie",o.msie=!0),o.edge&&(delete o.edge,i.browser="msedge",o.msedge=!0),o.opr&&(i.browser="opera",o.opera=!0),o.safari&&o.android&&(i.browser="android",o.android=!0),o.name=i.browser,o.platform=i.platform;for(var s in r)r.hasOwnProperty(s)&&delete r[s];Object.assign(r,o)}(),n.default=r},{}],43:[function(e,t,n){"use strict";function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=n.RuntimeException=function(){function e(t){o(this,e),this._message=t}return a(e,[{key:"toString",value:function(){return this.name+": "+this.message}},{key:"name",get:function(){return"RuntimeException"}},{key:"message",get:function(){return this._message}}]),e}();n.IllegalStateException=function(e){function t(e){return o(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return i(t,e),a(t,[{key:"name",get:function(){return"IllegalStateException"}}]),t}(s),n.InvalidArgumentException=function(e){function t(e){return o(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return i(t,e),a(t,[{key:"name",get:function(){return"InvalidArgumentException"}}]),t}(s),n.NotImplementedException=function(e){function t(e){return o(this,t),r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return i(t,e),a(t,[{key:"name",get:function(){return"NotImplementedException"}}]),t}(s)},{}],44:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=e("events"),a=function(e){return e&&e.__esModule?e:{default:e}}(o),s=function(){function e(){r(this,e)}return i(e,null,[{key:"e",value:function(t,n){t&&!e.FORCE_GLOBAL_TAG||(t=e.GLOBAL_TAG);var r="["+t+"] > "+n;e.ENABLE_CALLBACK&&e.emitter.emit("log","error",r),e.ENABLE_ERROR&&(console.error?console.error(r):console.warn?console.warn(r):console.log(r))}},{key:"i",value:function(t,n){t&&!e.FORCE_GLOBAL_TAG||(t=e.GLOBAL_TAG);var r="["+t+"] > "+n;e.ENABLE_CALLBACK&&e.emitter.emit("log","info",r),e.ENABLE_INFO&&(console.info?console.info(r):console.log(r))}},{key:"w",value:function(t,n){t&&!e.FORCE_GLOBAL_TAG||(t=e.GLOBAL_TAG);var r="["+t+"] > "+n;e.ENABLE_CALLBACK&&e.emitter.emit("log","warn",r),e.ENABLE_WARN&&(console.warn?console.warn(r):console.log(r))}},{key:"d",value:function(t,n){t&&!e.FORCE_GLOBAL_TAG||(t=e.GLOBAL_TAG);var r="["+t+"] > "+n;e.ENABLE_CALLBACK&&e.emitter.emit("log","debug",r),e.ENABLE_DEBUG&&(console.debug?console.debug(r):console.log(r))}},{key:"v",value:function(t,n){t&&!e.FORCE_GLOBAL_TAG||(t=e.GLOBAL_TAG);var r="["+t+"] > "+n;e.ENABLE_CALLBACK&&e.emitter.emit("log","verbose",r),e.ENABLE_VERBOSE&&console.log(r)}}]),e}();s.GLOBAL_TAG="flv.js",s.FORCE_GLOBAL_TAG=!1,s.ENABLE_ERROR=!0,s.ENABLE_INFO=!0,s.ENABLE_WARN=!0,s.ENABLE_DEBUG=!0,s.ENABLE_VERBOSE=!0,s.ENABLE_CALLBACK=!1,s.emitter=new a.default,n.default=s},{events:2}],45:[function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=e("events"),s=r(a),u=e("./logger.js"),l=r(u),d=function(){function e(){i(this,e)}return o(e,null,[{key:"getConfig",value:function(){return{globalTag:l.default.GLOBAL_TAG,forceGlobalTag:l.default.FORCE_GLOBAL_TAG,enableVerbose:l.default.ENABLE_VERBOSE,enableDebug:l.default.ENABLE_DEBUG,enableInfo:l.default.ENABLE_INFO,enableWarn:l.default.ENABLE_WARN,enableError:l.default.ENABLE_ERROR,enableCallback:l.default.ENABLE_CALLBACK}}},{key:"applyConfig",value:function(e){l.default.GLOBAL_TAG=e.globalTag,l.default.FORCE_GLOBAL_TAG=e.forceGlobalTag,l.default.ENABLE_VERBOSE=e.enableVerbose,l.default.ENABLE_DEBUG=e.enableDebug,l.default.ENABLE_INFO=e.enableInfo,l.default.ENABLE_WARN=e.enableWarn,l.default.ENABLE_ERROR=e.enableError,l.default.ENABLE_CALLBACK=e.enableCallback}},{key:"_notifyChange",value:function(){var t=e.emitter;if(t.listenerCount("change")>0){var n=e.getConfig();t.emit("change",n)}}},{key:"registerListener",value:function(t){e.emitter.addListener("change",t)}},{key:"removeListener",value:function(t){e.emitter.removeListener("change",t)}},{key:"addLogListener",value:function(t){l.default.emitter.addListener("log",t),l.default.emitter.listenerCount("log")>0&&(l.default.ENABLE_CALLBACK=!0,e._notifyChange())}},{key:"removeLogListener",value:function(t){l.default.emitter.removeListener("log",t),0===l.default.emitter.listenerCount("log")&&(l.default.ENABLE_CALLBACK=!1,e._notifyChange())}},{key:"forceGlobalTag",get:function(){return l.default.FORCE_GLOBAL_TAG},set:function(t){l.default.FORCE_GLOBAL_TAG=t,e._notifyChange()}},{key:"globalTag",get:function(){return l.default.GLOBAL_TAG},set:function(t){l.default.GLOBAL_TAG=t,e._notifyChange()}},{key:"enableAll",get:function(){return l.default.ENABLE_VERBOSE&&l.default.ENABLE_DEBUG&&l.default.ENABLE_INFO&&l.default.ENABLE_WARN&&l.default.ENABLE_ERROR},set:function(t){l.default.ENABLE_VERBOSE=t,l.default.ENABLE_DEBUG=t,l.default.ENABLE_INFO=t,l.default.ENABLE_WARN=t,l.default.ENABLE_ERROR=t,e._notifyChange()}},{key:"enableDebug",get:function(){return l.default.ENABLE_DEBUG},set:function(t){l.default.ENABLE_DEBUG=t,e._notifyChange()}},{key:"enableVerbose",get:function(){return l.default.ENABLE_VERBOSE},set:function(t){l.default.ENABLE_VERBOSE=t,e._notifyChange()}},{key:"enableInfo",get:function(){return l.default.ENABLE_INFO},set:function(t){l.default.ENABLE_INFO=t,e._notifyChange()}},{key:"enableWarn",get:function(){return l.default.ENABLE_WARN},set:function(t){l.default.ENABLE_WARN=t,e._notifyChange()}},{key:"enableError",get:function(){return l.default.ENABLE_ERROR},set:function(t){l.default.ENABLE_ERROR=t,e._notifyChange()}}]),e}();d.emitter=new s.default,n.default=d},{"./logger.js":44,events:2}],46:[function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function t(){r(this,t)}return i(t,null,[{key:"install",value:function(){Object.setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},Object.assign=Object.assign||function(e){if(void 0===e||null===e)throw new TypeError("Cannot convert undefined or null to object");for(var t=Object(e),n=1;n<arguments.length;n++){var r=arguments[n];if(void 0!==r&&null!==r)for(var i in r)r.hasOwnProperty(i)&&(t[i]=r[i])}return t},"function"!=typeof self.Promise&&e("es6-promise").polyfill()}}]),t}();o.install(),n.default=o},{"es6-promise":1}],47:[function(e,t,n){"use strict";function r(e,t,n){var r=e;if(t+n<r.length){for(;n--;)if(128!=(192&r[++t]))return!1;return!0}return!1}function i(e){for(var t=[],n=e,i=0,o=e.length;i<o;)if(n[i]<128)t.push(String.fromCharCode(n[i])),++i;else{if(n[i]<192);else if(n[i]<224){if(r(n,i,1)){var a=(31&n[i])<<6|63&n[i+1];if(a>=128){t.push(String.fromCharCode(65535&a)),i+=2;continue}}}else if(n[i]<240){if(r(n,i,2)){var s=(15&n[i])<<12|(63&n[i+1])<<6|63&n[i+2];if(s>=2048&&55296!=(63488&s)){t.push(String.fromCharCode(65535&s)),i+=3;continue}}}else if(n[i]<248&&r(n,i,3)){var u=(7&n[i])<<18|(63&n[i+1])<<12|(63&n[i+2])<<6|63&n[i+3];if(u>65536&&u<1114112){u-=65536,t.push(String.fromCharCode(u>>>10|55296)),t.push(String.fromCharCode(1023&u|56320)),i+=4;continue}}t.push(String.fromCharCode(65533)),++i}return t.join("")}Object.defineProperty(n,"__esModule",{value:!0}),n.default=i},{}]},{},[22])(22)});
/*
*@author liuguifng
*@date 2018.02.06
*@package  
*@access public
*
*/

class Logger {

    constructor(name, writedb, maxcount) {
        this._name = name ? name : 'ZLLogger';
        this._maxcount = maxcount ? maxcount : 1024 * 1024;
        if (writedb) {
            let result = indexedDB.open(this._name, 1);
            result.onerror = function (event) {
                console.error('ZLLogger open db error');
            };
            result.onsuccess = function (event) {
                // Do something with request.result!
                this._dataBase = event.target.result;
                this._isValid = true;
            }.bind(this);
            result.onupgradeneeded = function (e) { 
                let db = e.target.result;
                if (!db.objectStoreNames.contains(this._name)) { 
                    let store = db.createObjectStore(this._name); 
                    store.createIndex('name', 'name');
                    store.createIndex('tag', 'tag');
                    store.createIndex('level', 'level');
                    store.createIndex('time', 'time');
                    store.createIndex('info', 'info');
                } 
            }.bind(this);
        }
        else {
            this._isValid = true;
        }
    }

    write(tag, level, info, showconsole) {
        
        if (!this._isValid) {
            console.warn('invalid ZLLogger');
            return;
        }

        let timeNow = new Date();

        if (this._dataBase) {
            let objectStore = this._dataBase.transaction(this._name, 'readwrite').objectStore(this._name);

            if (objectStore) {
                let countRequest = objectStore.count();
                countRequest.onsuccess = function () {
                    if (countRequest.result >= this._maxcount) {
                        let keyRangeValue = IDBKeyRange.upperBound((new Date().getTime()));
                        let nRemovedCount = 0;
                        objectStore.openCursor(keyRangeValue).onsuccess = function (event) {
                            let cursor = event.target.result;
                            if (cursor) {
                                objectStore.delete(cursor.key);
                                nRemovedCount++;
                                if (nRemovedCount < 100) {
                                    cursor.continue();
                                }
                            }
                        };
                    }
                }.bind(this);
                
                objectStore.put({name: this._name, tag: tag, level: level, time: timeNow.toString(), info: info}, timeNow.getTime());
            }
        }
        if (showconsole) {
            let logfunc = console.log;
            if (level === 'warn') { 
                logfunc = console.warn;
            }
            else if (level === 'error') {
                logfunc = console.error;
            }
            logfunc(`[${this._name}][${tag}][${level}][${timeNow.toString()}]  ${info}`);
        }
    }
    
    query(timebegin, timeend) {

        if (!this._isValid) {
            console.warn('invalid ZLLogger');
            return;
        }   
        let keyRangeValue = IDBKeyRange.bound(timebegin, timeend, true, true);
        let objectStore = this._dataBase.transaction(this._name).objectStore(this._name);
        objectStore.openCursor(keyRangeValue).onsuccess = function (event) {
            let cursor = event.target.result;
            if (cursor) {
                console.log(JSON.stringify(cursor.value));
                cursor.continue();
            }
        };
    }

    clear() {
        console.warn('clear log');

        if (this._dataBase) {
            let store = this._dataBase.transaction(this._name, 'readwrite').objectStore(this._name);
            store.clear();
        }  
    }
}



/*
*@author liuguifng
*@date 2017.08.15
*@package  
*@access public
*
*/


function setCss3(obj, attrObj) {
    for (let i in attrObj) {
        let newi = i;
        if (newi.indexOf('-') > 0) {
            let num = newi.indexOf('-'); 
            newi = newi.replace(newi.substr(num, 2), newi.substr(num + 1, 1).toUpperCase());
        }
        obj.style[newi] = attrObj[i];
        newi = newi.replace(newi.charAt(0), newi.charAt(0).toUpperCase());
        obj.style['webkit' + newi] = attrObj[i];
        obj.style['moz' + newi] = attrObj[i];
        obj.style['o' + newi] = attrObj[i];
        obj.style['ms' + newi] = attrObj[i];
    }
}

function controlbar(videoElement, shownTime) {
    this.videoElement = videoElement;
    this.shownTime = shownTime;
    this.totolTime = 0;
    this.currentTime = 0;
    this.buffTime = 0;
    this.speed = 1.0;

    //控制条框架
    this.frameDiv = document.createElement('div');
    this.frameDiv.style.top = this.videoElement.offsetHeight;
    this.frameDiv.style.left = this.videoElement.left;
    this.frameDiv.style.backgroundColor = 'rgba(100, 100, 100, 0.5)';
    this.frameDiv.style.zIndex = 200;
    this.frameDiv.style.width = this.videoElement.offsetWidth;
    this.frameDiv.style.height = '30px';
    this.frameDiv.style.position = 'absolute';
    this.frameDiv.style.float = 'left';

    //控制条播放/暂停按钮
    this.btnPlay = document.createElement('img');
    this.btnPlay.style.width = this.frameDiv.style.height;
    this.btnPlay.style.height = this.frameDiv.style.height;
    this.btnPlay.style.float = 'left';
    this.btnPlay.src = zlplayer.resPath + 'res/play.png';

    this.btnPlay.onclick = function () {
        videoElement.paused ? videoElement.play() : videoElement.pause();
    };

    this.frameDiv.appendChild(this.btnPlay);

    //控制条进度框架
    this.progressBoxDiv = document.createElement('div');
    this.progressBoxDiv.style.width = (parseInt(this.frameDiv.style.width) - 2 * parseInt(this.btnPlay.style.height) - 70) + 'px';
    this.progressBoxDiv.style.height = this.frameDiv.style.height;
    this.progressBoxDiv.style.float = 'left';
    this.progressBoxDiv.style.display =  'inline-block';
    this.progressBoxDiv.style.verticalAlign =  'center';
    this.frameDiv.appendChild(this.progressBoxDiv);

    //控制条播放进度
    this.progressPlayDiv = document.createElement('div');
    this.progressPlayDiv.style.width = '0px';
    this.progressPlayDiv.style.height = this.progressBoxDiv.style.height;
    this.progressPlayDiv.style.backgroundColor = 'rgba(10, 10, 10, 0.8)';
    this.progressPlayDiv.style.float = 'left';
    this.progressBoxDiv.appendChild(this.progressPlayDiv);
    
    //进度条拖拽按钮
    this.progressHandle = document.createElement('div');
    this.progressHandle.style.width = '8px';
    this.progressHandle.style.height = this.progressBoxDiv.style.height;
    this.progressHandle.style.backgroundColor = 'rgba(10, 10, 10, 1)';
    this.progressHandle.style.float = 'left';
    this.progressBoxDiv.appendChild(this.progressHandle);

    //进度条缓冲进度
    this.progressBufDiv = document.createElement('div');
    this.progressBufDiv.style.width = '0px';
    this.progressBufDiv.style.height = this.progressBoxDiv.style.height;
    this.progressBufDiv.style.backgroundColor = 'rgba(155, 155, 155, 0.8)';
    this.progressBufDiv.style.float = 'left';
    this.progressBoxDiv.appendChild(this.progressBufDiv);

    //时间
    this.timeText = document.createElement('span');
    this.timeText.innerText = '00:00/00:00';
    this.timeText.style.height = this.frameDiv.style.height;
    this.timeText.style.width = '90px';
    this.timeText.style.float = 'left';
    this.timeText.style.color = 'rgb(255,255,255)';
    this.timeText.style.display = 'inline-block';
    this.timeText.style.textAlign = 'center';
    this.timeText.style.lineHeight = this.timeText.style.height;

    this.frameDiv.appendChild(this.timeText);

    /*
    //速度
    this.speedText = document.createElement('sapn');
    this.speedText.innerText = 'x1.0';
    this.speedText.style.height = this.frameDiv.style.height;
    this.speedText.style.width = '30px';
    this.speedText.style.backgroundColor = 'rgba(100, 100, 100, 0)';
    this.speedText.style.color = 'rgb(100,100,100)';
    this.speedText.style.float = 'left';
    this.speedText.style.display = 'inline-block';
    this.speedText.style.textAlign = 'center';
    this.speedText.style.lineHeight = this.timeText.style.height;
    this.frameDiv.appendChild(this.speedText);
    */

     //音频按钮
    this.btnSound = document.createElement('img');
    this.btnSound.style.height = this.frameDiv.style.height;
    this.btnSound.style.width = this.frameDiv.style.height;
    this.btnSound.style.float = 'right';
    this.btnSound.src = zlplayer.resPath + 'res/sound.png';
 
    this.btnSound.onclick = function () {
        if (videoElement.muted) {
            videoElement.muted = false;
            if (!videoElement.muted) {
                this.btnSound.src = zlplayer.resPath + 'res/sound.png';
            }
        }
        else {
            videoElement.muted = true;
            this.btnSound.src = zlplayer.resPath + 'res/mute.png';
        }
    }.bind(this); 
     
    videoElement.addEventListener('canplay', function () {
        if (videoElement.muted) {
            this.btnSound.src = zlplayer.resPath + 'res/mute.png';
        }
        else {
            this.btnSound.src = zlplayer.resPath + 'res/sound.png';
        }
        this.resize();
    }.bind(this));

    //全屏按钮
    this.btnFullScreen = document.createElement('img');
    this.btnFullScreen.style.height = this.frameDiv.style.height;
    this.btnFullScreen.style.width = this.frameDiv.style.height;
    this.btnFullScreen.style.float = 'right';
    this.btnFullScreen.src = zlplayer.resPath + 'res/fullscreen.png';

    this.btnFullScreen.onclick = function () {
        let e = document.createEvent('MouseEvent');
        e.initEvent('dblclick', false, false);
        videoElement.dispatchEvent(e); 
    };

    this.frameDiv.appendChild(this.btnFullScreen);
    this.frameDiv.appendChild(this.btnSound);

    window.addEventListener('resize', function () {
        this.resize();
    }.bind(this));

    videoElement.addEventListener('loadedmetadata', function () {
        let duration = videoElement.duration;
        this.updateTime(0, 0, duration);
    }.bind(this));

    videoElement.addEventListener('play', function () {
        this.btnPlay.src = zlplayer.resPath + 'res/pause.png';
    }.bind(this));

    videoElement.addEventListener('pause', function () {
        this.btnPlay.src = zlplayer.resPath + 'res/play.png';
    }.bind(this));

    videoElement.addEventListener('ended', function () {
        this.btnPlay.src = zlplayer.resPath + 'res/play.png';
    }.bind(this));

    videoElement.addEventListener('timeupdate', function () {
        let currentTime = videoElement.currentTime;
        let duration = videoElement.duration;
        if (videoElement.buffered.length > 0) {
            let bufferd = videoElement.buffered.end(0);
            this.updateTime(currentTime, bufferd, duration);
        }

        if (currentTime > 1.0 && currentTime < 2.0) {
            this.resize();
        }
    }.bind(this));

    let timerShown = null;
    videoElement.addEventListener('mouseleave', function (ev) {
        timerShown = setTimeout(function () {
            if (this.frameDiv.style.display != 'none') {
                this.frameDiv.style.display = 'none';
            }
        }.bind(this), this.shownTime);
    }.bind(this));

    videoElement.addEventListener('mousemove', function (ev) {
        if (this.frameDiv.style.display == 'none') {
            this.frameDiv.style.display = '';
        }
        if (timerShown) {
            clearTimeout(timerShown);
            timerShown = null;
        }
    }.bind(this));

    document.addEventListener('fullscreenchange', function () { 
        videoElement.controls = document.fullScreen;
        setTimeout(() => {
            this.resize();
        }, 300);
    }.bind(this));

    document.addEventListener('webkitfullscreenchange', function () { 
        setTimeout(() => {
            this.resize();
        }, 300);
    }.bind(this));
    document.addEventListener('mozfullscreenchange', function () { 
        setTimeout(() => {
            this.resize();
        }, 300);
    }.bind(this));

    this.frameDiv.onmousemove = function () {
        if (timerShown) {
            clearTimeout(timerShown);
            timerShown = null;
        }
    };

    this.frameDiv.onmouseleave = function () {
        if (!timerShown) {
            timerShown = setTimeout(function () {
                if (this.frameDiv.style.display != 'none') {
                    this.frameDiv.style.display = 'none';
                }
            }.bind(this), this.shownTime);
        }
    }.bind(this);

    let handle = this.progressHandle;
    let box = this.progressBoxDiv;
    let controler = this;
    let drag = false;
    let buffBar = this.progressBufDiv;
    let playProgress = this.progressPlayDiv;
    let textSpan = this.timeText;

    function getPoint(obj) { 
        let t = obj.offsetTop; 
        let l = obj.offsetLeft; 
        //判断是否有父容器，如果存在则累加其边距
        while ((obj = obj.offsetParent)) {
            t += obj.offsetTop; 
            l += obj.offsetLeft; 
        }
        return {top: t, left: l};
    }
    box.onmousedown = function (ev) {
        let evPtX = ev.pageX - getPoint(box).left;
        if ((evPtX > handle.offsetLeft && evPtX < buffBar.offsetLeft) || videoElement.paused) {
            return;
        }
        if (evPtX >= (buffBar.offsetLeft + parseInt(buffBar.style.width))) {
            return;
        }
        let duration = videoElement.duration;
        if (isNaN(duration) || duration == Infinity) {
            return;
        }
        let currentTime = parseInt(evPtX / (textSpan.offsetLeft - box.offsetLeft) *  duration);
        videoElement.currentTime = currentTime;
    };
    
    /*
    handle.onmousedown = function(ev) {
        if (videoElement.paused) {
            return;
        }
        videoElement.pause();
        drag = true;
        box.onmousemove = function(event) {
                let evPtX = event.layerX - box.offsetLeft;
                let duration = videoElement.duration;
                let currentTime = parseInt(evPtX/(textSpan.offsetLeft - box.offsetLeft) *  duration );
                let bufferd = videoElement.buffered.end(0);
                controler.updateTime(currentTime, bufferd, duration);
        };
        box.onmouseup = function(event) {
            box.onmousemove = null;
            box.onmouseup = null;
            drag = false;
            videoElement.play();
            let duration = videoElement.duration;
            let evPtX = event.layerX - box.offsetLeft;
            let currentTime = parseInt(evPtX/(textSpan.offsetLeft - box.offsetLeft) *  duration );
            videoElement.currentTime = currentTime;
        };
        box.onmouseleave = function() {
            if (drag) {
                box.onmousemove = null;
            box.onmouseup = null;
                drag = false;
                videoElement.play();
                videoElement.currentTime = controler.currentTime;
            }
        }; 
    };
    */
    this.show();
}

controlbar.prototype.updateTime = function (currentTime, buffTime, totalTime) {
    if (totalTime < 0 || isNaN(totalTime) || totalTime == Infinity) {
        totalTime = currentTime;
        buffTime = 0;
    }

    this.currentTime = currentTime;
    this.buffTime = buffTime;
    this.totalTime = totalTime;
    
    this.timeText.innerText = parseInt(currentTime / 60) + ':' + parseInt(currentTime % 60) + '/' + parseInt(totalTime / 60) + ':' + parseInt(totalTime % 60);
    this.progressPlayDiv.style.width = parseInt((this.progressBoxDiv.offsetWidth - this.progressHandle.offsetWidth) * currentTime / totalTime)  + 'px';
    this.progressBufDiv.style.width = buffTime - currentTime > 0 ? parseInt((this.progressBoxDiv.offsetWidth - this.progressHandle.offsetWidth) * (buffTime - currentTime) / totalTime)  + 'px' : '0px';
};

controlbar.prototype.resize = function () {
    let isVertical = this.videoElement.rotate == 90 || this.videoElement.rotate == 270;
    this.frameDiv.style.width =  (isVertical ? this.videoElement.offsetHeight : this.videoElement.offsetWidth) + 'px';
    this.frameDiv.style.top = (isVertical ? this.videoElement.offsetLeft + this.videoElement.offsetWidth - 30 : this.videoElement.offsetTop + this.videoElement.offsetHeight - 30) + 'px';
    this.frameDiv.style.left = this.videoElement.offsetLeft + 'px';
    this.progressBoxDiv.style.width = (parseInt(this.frameDiv.style.width) - 2 * parseInt(this.btnPlay.style.height) - 130) + 'px';
};

controlbar.prototype.show = function () {
    if (this.videoElement.parentNode) {
        this.videoElement.parentNode.appendChild(this.frameDiv);
        this.resize();
    }
};

controlbar.prototype.hide = function () {
    if (this.videoElement.parentNode && this.frameDiv.parentNode == this.videoElement.parentNode) {
        this.videoElement.parentNode.removeChild(this.frameDiv);
        this.resize();
    }
};

let zlplayer = function (videoElement, config) {
    
    flvjs.LoggingControl.enableAll = false;
    flvjs.LoggingControl.enableError = true;

    this.isFullScreen = false;

    this.canvas = document.createElement('canvas');
    this.canvas.style.display = 'none';

    //TODU: check video and config valid
    if (!config.username || !config.password || config.username.length == 0) {
        config.username = 'admin';
        config.password = '123456';
    }
    //in url, parse username and password in url
    let posStart = config.url.indexOf('//') + 2;
    let posEnd = config.url.indexOf('@');
    if (posEnd >= 0) {
        let usrInfo = config.url.substring(posStart, posEnd);
        let posSplit = usrInfo.indexOf(':');
        if (posSplit > 0) { 
            //no userinfo in config use parsed info
            if (config.username.length == 0 && config.password.length == 0) {
                config.username = usrInfo.substring(0, posSplit);
                config.password = usrInfo.substring(posSplit + 1);
            }
            config.url = config.url.substring(0, posStart) + config.url.substring(posEnd + 1);
        }
    } 
    
    this.flvSrc = {
        type: typeof(config.type) == 'undefined' ? 'flv' : config.type,
        isLive: config.isLive,
        hasAudio: typeof(config.hasAudio) == 'undefined'  ? !config.isLive : config.hasAudio,
        url: config.url,
        fixAudioTimestampGap: false,
        withCredentials: true
    };

    this.enableFullScreen = config.enableFullScreen;
    this.enableFillWindow = config.enableFillWindow;
    this.maxRelexRgnPtCount = config.relexRgnPtCount;
    this.useCustomFullScreen = config.useCustomFullScreen;

    let liveConfig = {
        enableWorker: true,
        enableStashBuffer: true,
        stashInitialSize: 256,
        lazyLoad: false,

        autoCleanupSourceBuffer: true,
        autoCleanupMinBackwardDuration: 1.5,
        autoCleanupMaxBackwardDuration: 2.2,
        username: config.username,
        password: config.password,
        server: config.server
    };

    let playbackConfig = {
        enableWorker: true,
        lazyLoad: true,
        enableStashBuffer: true,
        autoCleanupSourceBuffer: false,
        autoCleanupMinBackwardDuration: 5,
        autoCleanupMaxBackwardDuration: 10,
        username: config.username,
        password: config.password,
        seekType: 'param',
        date: config.date,
        auth: config.auth,
        server: config.server
    };

    let streamConfig = null;
    if (config.isLive) {
        streamConfig = liveConfig;
    } else {
        streamConfig = playbackConfig;
    }

    this.streamConfig = streamConfig;
    this.videoElement = videoElement;

    if (videoElement.parentNode) {
        if (videoElement.parentNode.style.width == 'auto') {
            videoElement.parentNode.style.width = '576px';
            videoElement.widthX = 95;
        }
        if (videoElement.parentNode.style.height == 'auto') {
            videoElement.parentNode.style.height = '704px';
            videoElement.heightX = 95;
        }
    }

    if (videoElement.style.width == '' && !videoElement.widthX) {
        videoElement.style.width = '100%';
    }
    if (videoElement.style.height == '' && !videoElement.heightX) {
        videoElement.style.height = '100%';
    }
    
    if ((videoElement.style.width.indexOf('%') > 0 || videoElement.style.height.indexOf('%') >= 0) && (!videoElement.widthX || !videoElement.heightX)) {
        if (videoElement.style.width.indexOf('%') >= 0) {
            videoElement.widthX = parseInt(videoElement.style.width);
            if (config.rotate && videoElement.rotate == 90 || videoElement.rotate == 270) {
                videoElement.style.width = videoElement.parentNode.offsetWidth * videoElement.widthX / 100.0 + 'px';
            }
        }
        if (videoElement.style.height.indexOf('%') >= 0) {
            videoElement.heightX = parseInt(videoElement.style.height);
            if (config.rotate && videoElement.rotate == 90 || videoElement.rotate == 270) {
                videoElement.style.height = videoElement.parentNode.offsetHeight * videoElement.heightX / 100.0 + 'px';
            }
        }
    }
    
    this.videoElement.controls = false;
    this.videoElement.muted = true;

    if (config.enableFilter && config.filter) {
        this.filter = config.filter; 
        if (this.videoElement.parentNode) {
            this.videoElement.parentNode.appendChild(this.canvas);
        }
        this.canvas.width = this.videoElement.offsetWidth;
        this.canvas.height = this.videoElement.offsetHeight;
        this.canvas.style.zIndex = 100;
        this.canvas.style.display = '';
        this.canvas.style.position = 'absolute';
        this.canvas.style.left = `${this.videoElement.offsetLeft}px`;
        this.canvas.style.top = `${this.videoElement.offsetTop}px`;
        
        this.canvas.addEventListener('mousemove', function (event) {
            let eventMove = document.createEvent('MouseEvent');  
            eventMove.initMouseEvent('mousemove', true, true, window, 0,  
            event.screenX, event.screenY, event.clientX, event.clientY, false, false, false, false, 0, null);  
            videoElement.dispatchEvent(eventMove);
        });
    
        this.canvas.addEventListener('mouseleave', function (event) {
            let eventMove = document.createEvent('MouseEvents');  
            eventMove.initMouseEvent('mouseleave', true, false);  
            videoElement.dispatchEvent(eventMove);
        });

        videoElement.addEventListener('canplay', function  ()  {
            this.canvasInterval = setInterval(zlplayer.prototype.drawCanvasFrame.bind(this), 25);
        }.bind(this));

        videoElement.addEventListener('ended', function () {
            if (this.canvasInterval) {
                clearInterval(this.canvasInterval);
                this.canvasInterval = null;
            }
        }.bind(this));
    }

    if (!config.isLive) {
        this.controlbar = new controlbar(this.videoElement, 5000);
    }
    
    window.addEventListener('resize', this.onBodyResize.bind(this)); 
    
    let flvPlayer = flvjs.createPlayer(this.flvSrc, this.streamConfig);
   
    flvPlayer.on('error', function (type, reason, desc) {
        switch (type) {
            case 'MediaError':
                if (reason == 'NeedReplay') {
                    let ctx = this.canvas.getContext('2d');
                    this.canvas.width = this.videoElement.offsetWidth;
                    this.canvas.height = this.videoElement.offsetHeight;
                    ctx.drawImage(this.videoElement, 0, 0, this.canvas.width, this.canvas.height);
                    let image = this.canvas.toDataURL('image/png');
                    this.videoElement.poster = image;
                    //this.resume();   去掉，改由外面用户自己重新打开 v1.5.1
                }
                break;
            case 'NetworkError':
                if (desc.code == -999) {
                    let ctx = this.canvas.getContext('2d');
                    this.canvas.width = this.videoElement.offsetWidth;
                    this.canvas.height = this.videoElement.offsetHeight;
                    ctx.drawImage(this.videoElement, 0, 0, this.canvas.width, this.canvas.height);
                    let image = this.canvas.toDataURL('image/png');
                    this.videoElement.poster = image;
                    //this.resume(); 去掉，改由外面用户自己重新打开 v1.5.1
                }
                break;
            default:
                this.videoElement.poster = '#000000';
        }

        zlplayer.logger.write('zlplayer', 'error', `play error : type[${type}] reason[${reason}]desc[${JSON.stringify(desc)}]`);

    }.bind(this));

    flvPlayer.attachMediaElement(this.videoElement);
    this.flvPlayer = flvPlayer;

    if (config.enableFillWindow) {
        setCss3(this.videoElement, {'object-fit': 'fill'});
    }

    if (config.rotate) {
        this.rotate(config.rotate);
    }

    //去除右键事件
    videoElement.addEventListener('contextmenu', function (e) {
        e.preventDefault();
    });

    //双击全屏/取消全屏
    videoElement.addEventListener('dblclick', function () {
        if (!this.enableFullScreen) {
            return;
        }
        //自己实现全屏（铺满整个window可视区域）
        if (this.useCustomFullScreen) {
            this.isFullScreen = !this.isFullScreen;
            if (this.isFullScreen) {
                this.videoElement.style.width = '100%';
                this.videoElement.style.height = '100%';
                this.videoElement.style.position = 'absolute';
                this.videoElement.style.zIndex = 9999;
                setCss3(this.videoElement, {'object-fit': 'contain'});
            }
            else
            {
                this.videoElement.style.position = 'static';
                this.videoElement.style.zIndex = 0;
                setCss3(this.videoElement, {'object-fit': 'fill'});
            }
            this.onBodyResize();
            if (this.controlbar) {
                this.controlbar.resize();
            }
            return;
        }
        //使用原生的全屏
        let videoElement = this.videoElement;
        if (videoElement.fullscreenElement) {
            if (videoElement.mozCancelFullScreen) {
                videoElement.mozCancelFullScreen();
            }
            else {
                videoElement.webkitCancelFullscreen();
            }
            this.isFullScreen = false;
        } else {
            if (videoElement.mozRequestFullScreen) {
                videoElement.mozRequestFullScreen();
            }
            else
            {
                videoElement.webkitRequestFullScreen();
            }
            this.isFullScreen = true;
        }
    }.bind(this));
     
    //*报警记录中的窗口自动竖向拉长  comment by liuguifang at 20180711
    if (navigator.userAgent.indexOf('Safari') > -1) {
        // 规避了safari 播放时会白屏（resize或点击其他控件失去焦点后恢复）
        videoElement.addEventListener('canplay', function  ()  {
            videoElement.style.width = (parseInt(videoElement.style.width) - 2) + 'px';
            this.onBodyResize();
        }.bind(this));
    }

    document.addEventListener('fullscreenchange', function () { 
        videoElement.controls = (document.fullScreen || !config.useCustomFullScreen) && !config.isLive;
    });
    document.addEventListener('webkitfullscreenchange', function () { 
        videoElement.controls = (document.webkitFullScreen || !config.useCustomFullScreen) && !config.isLive;
    });
    document.addEventListener('mozfullscreenchange', function () { 
        videoElement.controls = (document.mozFullScreen || !config.useCustomFullScreen) && !config.isLive;
    });
        
    return this;
};

zlplayer.version = '2.0.6';

zlplayer.logger = new Logger('zlplayer-log');

zlplayer.playerMap = new Map();

zlplayer.resPath = '../js/plugin/';

/**
 *
     创建播放器并绑定video dom
 *
 @method +createPlayer  
 *
 @for zlplayer
 *
 @param {videoElement object} 播放器绑定的video dom 
 *    
 @param {config object} 播放器配置 
 *    
 @return {FLVPlayer}  播放器对象
 */
zlplayer.createPlayer = function (videoElement, config) {
    let player = new zlplayer(videoElement, config);
    zlplayer.playerMap.set(player, player);
    return player;
};

/**
 *
    销毁某个播放器
 *
 @method +destroyPlayer  
 *
 @for zlplayer
 *
 @param {zlplayer object} 播放器对象
   
 @return {void}  
 */
zlplayer.destroyPlayer = function (player) {
    if (player) {
        player.stop();
        player.stopRelexRgn();
    }
    zlplayer.playerMap.delete(player);
    player = null;
};

/**
 *
    销毁所有播放器
 *
 @method +clearPlayer  
 *
 @for zlplayer
 *
 @return {void}  
 */
zlplayer.clearPlayer = function () {
    for (let player of zlplayer.playerMap.values()) {
        if (player) {
            player.stop();
            player = null;
        }
    }
    zlplayer.playerMap.clear();
};

/**
 *
     开始播放
 *
 @method -play  
 *
 @for zlplayer
 *
 @return {void}  
 */
zlplayer.prototype.play = function () {

    zlplayer.logger.write('zlplayer', 'debug', `play config :${JSON.stringify(this.streamConfig)}`);

    this.flvPlayer.load();
    this.flvPlayer.play();
    if (this.controlbar) {
        this.controlbar.show();
    }
};

/**
 *
     停止播放
 *
 @method -play  
 *
 @for zlplayer
 *
 @return {void}  
 */
zlplayer.prototype.stop = function () {
    if (this.flvPlayer) {
        this.videoElement.poster = '#000000';
        this.flvPlayer.unload();
        this.flvPlayer.destroy();
        this.flvPlayer = null;
    }
    this.clearRelexRgn();
    if (this.controlbar) {
        this.controlbar.hide();
    }
    if (this.canvasInterval) {
        clearInterval(this.canvasInterval);
        this.canvasInterval = null;
    }
    if (this.canvas) {
        this.canvas.style.display = 'none';
        if (this.canvas.parentNode == this.videoElement.parentNode && this.videoElement.parentNode) {
            this.videoElement.parentNode.removeChild(this.canvas);
        }
    }
    if (this.rgnCanvas) {
        this.rgnCanvas.style.display = 'none';
        if (this.rgnCanvas.parentNode == this.videoElement.parentNode && this.videoElement.parentNode) {
            this.videoElement.parentNode.removeChild(this.rgnCanvas);
        }
    }

    zlplayer.logger.write('zlplayer', 'debug', `stop config :${JSON.stringify(this.streamConfig)}`);
};


zlplayer.prototype.resume = function () {
    if (this.flvPlayer) {
        this.flvPlayer.resume(this.flvSrc.url);
    }
};

/**
 *
    旋转
 *
 @method -rotate
 *
 @param  deg  角度
 *
 @for zlplayer
 *
 @return {void}  
 */
zlplayer.prototype.rotate = function (deg) {
    if (this.videoElement.rotate != deg) {
        if (deg == 90 || deg == 180 || deg == 270 || deg == 360 || deg == 0) {
            if (deg == 360) {
                deg = 0;
            }
            if (270 == this.videoElement.rotate) {
                this.videoElement.rotate = -90;
            }
            this.videoElement.rotate = deg;  
        }
    }
    if (this.onBodyResize) {
        this.onBodyResize();
    } 
};

/**
 *
     设置事件回调
 *
 @method -setEventCb  
 *
 @for zlplayer
 *
 @param {eventCb cb function}      function(type,reason,desc)
 *    
 @return {void}  
 */
zlplayer.prototype.setEventCb = function (eventCb) {
    if (this.flvPlayer) {
        this.flvPlayer.on('error', eventCb);
    }
};

zlplayer.prototype.on = function (name, func) {
    if (this.flvPlayer) {
        if (name == 'error') {
            this.flvPlayer.on('error', func);
        }
    }
};


/**
 *
    抓图
 *
 @method -capture  
 *
 @for zlplayer
 * 
 @return {void}  
 */
zlplayer.prototype.capture = function () {
    //draw image
    if (!this.canvas) {
        this.canvas = document.createElement('canvas');
        this.canvas.display = 'none';
    }
    let ctx = this.canvas.getContext('2d');
    this.canvas.width = this.videoElement.videoWidth;
    this.canvas.height = this.videoElement.videoHeight;
    ctx.drawImage(this.videoElement, 0, 0, this.canvas.width, this.canvas.height);  
    
    //create image link and sava file
    let image = this.canvas.toDataURL('image/png').replace('image/png', 'image/octet-stream'); 
    this.onBodyResize();
    return image;
};

/**
 *
    开始录像
 *
 @method -startRecord  
 *
 @for zlplayer
 * 
 @return {image object}  
 */
zlplayer.prototype.startRecord = function () {
    //safari not support 'captureStream'
    if (this.recoding || navigator.userAgent.indexOf('Safari') > -1) {
        return;
    }
    if (this.flvPlayer) {
        this.videoElement.captureStream = this.videoElement.captureStream || this.videoElement.mozCaptureStream;
        if (!this.videoElement.captureStream) {
            alert('需要您的浏览器开启“实验性网络平台”选项\n（浏览器地址栏输入： chrome://flags/#enable-experimental-web-platform-features   点击“enable”或者“开启”）');
            return;
        }
        let options = {mimeType: 'video/webm'};
        if (!this.mediaRecorder) {
            this.mediaRecorder = new MediaRecorder(this.videoElement.captureStream(), options);
            this.mediaRecorder.onstop = function () { console.log('player stoped'); };
            this.mediaRecorder.ondataavailable = function (event) {
                if (event.data && event.data.size > 0 && this.recordedBlobs) {
                    this.recordedBlobs.push(event.data);
                }
            }.bind(this);
        }
        
        this.recordedBlobs = new Array();
    }
    this.mediaRecorder.start(10);
    this.recoding = true;
};

/**
 *
    停止录像
 *
 @method -stopRecord  
 *
 @for zlplayer
 * 
 @return {blob object}  
 */
zlplayer.prototype.stopRecord = function () {
    if (!this.recoding) {
        return;
    }
    this.mediaRecorder.stop();
    this.recoding = false;
    if (this.recordedBlobs && this.recordedBlobs.length > 0) {
        let blob = new Blob(this.recordedBlobs, {type: 'video/webm'});
        this.recordedBlobs = null;
        return blob;
    }
    return null;
};

/**
 *
    调整宽高（主要是旋转后的调整）
 *
 @method -onBodyResize  
 *
 @for zlplayer
 * 
 @return {void}  
 */
zlplayer.prototype.onBodyResize = function () {

    let element = this.videoElement;
    if (!element) {
        return;
    }

    let showRgn = this.isFullScreen && this.useCustomFullScreen ? {width: window.innerWidth, height: window.innerHeight} 
    : {width: this.videoElement.parentNode.offsetWidth, height: this.videoElement.parentNode.offsetHeight};

    let isVertical = element.rotate && element.rotate == 90 || element.rotate == 270;
    if (element.widthX) {
        if (isVertical) {
            element.style.height = showRgn.width * element.widthX / 100.0 + 'px';
        }
        else {
            element.style.width = showRgn.width * element.widthX / 100.0 + 'px';
        }
    }
    if (element.heightX) {
        if (isVertical) {
            element.style.width = showRgn.height * element.heightX / 100.0 + 'px';
        }
        else {
            element.style.height = showRgn.height * element.heightX / 100.0 + 'px';
        }
    }
    let xOffset = 0;
    if (element.rotate && element.rotate == 90) {
        xOffset = (parseInt(element.offsetHeight) - parseInt(element.offsetWidth)) / 2; 
    }
    else if (element.rotate && element.rotate == 270) {
        xOffset = (parseInt(element.offsetWidth) - parseInt(element.offsetHeight)) / 2;  
    }

    setCss3(element, {'transform': `rotate(${element.rotate}deg) translate(${-xOffset}px, ${-xOffset}px)`}); 

   
    if (this.isDrawingRgn) {

        if (this.rgnCanvas) {
            this.rgnCanvas.width = isVertical ? element.offsetHeight : element.offsetWidth;
            this.rgnCanvas.height = isVertical ?  element.offsetWidth : element.offsetHeight;
            this.rgn.cx = isVertical ? element.offsetHeight : element.offsetWidth;
            this.rgn.cy = isVertical ? element.offsetWidth : element.offsetHeight;
        }

        setTimeout(function () {
            if (this.rgn && this.rgn.points.length) {
                this.onUpdateRgn();
            }
        }.bind(this), 100);
    }
    if (this.controlbar) {
        this.controlbar.resize();
    }

    if (this.canvas) {
        this.canvas.style.top = `${element.offsetTop}px`;
        this.canvas.style.left = `${element.offsetLeft}px`;
        this.canvas.width = isVertical ? element.offsetHeight : element.offsetWidth;
        this.canvas.height = isVertical ?  element.offsetWidth : element.offsetHeight;
    }
};

/**
 *
    开始绘制区域
 *
 @method -startRelexRgn  
 *
 @for zlplayer
  *
 @param {minPoints integer , rgn min point count}  
 *
 @param {maxPoints integer , rgn max point count}    
 *
 @param {initRgn rgn Object }    
 *
 @return {void}  
 */
zlplayer.prototype.startRelexRgn = function (minPoints, maxPoints, initRgn) {
    if (this.isDrawingRgn) {
        this.stopRelexRgn();
    }
    if (minPoints) {
        this.minRelexRgnPtCount = minPoints;
    }
    if (maxPoints) {
        this.maxRelexRgnPtCount = maxPoints;
        if (minPoints > maxPoints) {
            this.minRelexRgnPtCount = maxPoints;
        }
    }
    if (!this.minRelexRgnPtCount) {
        this.minRelexRgnPtCount = 3;
    }
    if (!this.maxRelexRgnPtCount) {
        this.maxRelexRgnPtCount = 8;
    }
    this.isRgnEditing = false;
    this.isRgnComplete = false;

    if (!this.rgnCanvas) {
        this.rgnCanvas = document.createElement('canvas');
        if (this.videoElement.parentNode) {
            this.videoElement.parentNode.appendChild(this.rgnCanvas);
        }
    }
    this.rgnCanvas.width = this.videoElement.offsetWidth;
    this.rgnCanvas.height = this.videoElement.offsetHeight;
    this.rgnCanvas.style.zIndex = 100;
    this.rgnCanvas.style.display = '';
    this.rgnCanvas.style.position = 'absolute';
    this.rgnCanvas.style.left = this.videoElement.offsetLeft + 'px';
    this.rgnCanvas.style.top = this.videoElement.offsetTop + 'px';

    this.rgn = {};
    this.rgn.origin = initRgn && initRgn.origin ? initRgn.origin : 'left-top';
    this.rgn.cx = this.videoElement.offsetWidth;
    this.rgn.cy = this.videoElement.offsetHeight;
    this.rgn.points = [];
    this.rgn.minPoints = this.minRelexRgnPtCount;
    this.rgn.maxPoints = this.maxRelexRgnPtCount;

    if (!this.isDrawingRgn) {
        this.isDrawingRgn = true;
    }
    this.isRgnComplete = this.isRgnEditing = initRgn && initRgn.points && initRgn.points.length;
    this.isInitRgn = initRgn && initRgn.points && initRgn.points.length;
    
    //点击增加一个点 或者 闭合后编辑区域
    this.rgnCanvas.onclick = function (event) {
        let ox = event.offsetX;
        let oy = event.offsetY;
        if (!this.isDrawingRgn) {
            return;
        }
        if (this.rgn.maxPoints > this.rgn.points.length && !this.isRgnComplete) {
            if (this.rgn) {
                let newPt = {xaxis: ox / this.rgnCanvas.width, yaxis: oy / this.rgnCanvas.height};
                this.rgn.points.push(newPt);
            }
        }
        if (this.rgn.points.length >= this.rgn.maxPoints && !this.isRgnComplete)
        {
            this.isRgnComplete = true;
            this.isRgnEditing = true;
        }
        if (this.isDrawingRgn) {
            this.onUpdateRgn();
        }
        let ctx = this.rgnCanvas.getContext('2d');  
        ctx.strokeStyle = 'red';   
        ctx.lineWidth = 2.0;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        //ctx.beginPath();
        ctx.moveTo(ox, oy);
        ctx.lineTo(ox, oy);
        //ctx.closePath();
        ctx.stroke();
    }.bind(this);

    //如果拖动光标，且光标在控制点上时，拖动区域
    this.rgnCanvas.onmousemove = function (event) {
        function hitPoint(ptSrc, ptDst) {
            if (ptSrc && ptDst) {
                let distance = Math.sqrt((ptSrc.xaxis - ptDst.xaxis) * (ptSrc.xaxis - ptDst.xaxis) + (ptSrc.yaxis - ptDst.yaxis) * (ptSrc.yaxis - ptDst.yaxis));
                //console.log(`distance is ${distance}`);
                return distance < 12;
            }
            return false;
        }
        if (this.isRgnEditing && event.buttons) {
            //两个点是否命中点
            
            //光标的点与区域的控制点基本命中时移动控制点到光标位置
            for (let i = 0; i < this.rgn.points.length; i++) {
                let ox = this.rgn.points[i].xaxis * this.rgn.cx; 
                let oy = this.rgn.points[i].yaxis * this.rgn.cy; 
                if (hitPoint({xaxis: event.offsetX, yaxis: event.offsetY}, {xaxis: ox, yaxis: oy})) {
                    this.rgn.points[i].xaxis = event.offsetX / this.rgn.cx;
                    this.rgn.points[i].yaxis = event.offsetY / this.rgn.cy;
                    setTimeout(function () {
                        this.onUpdateRgn();
                    }.bind(this), 50);
                    break;
                }
            }
        }
    }.bind(this);
 
    //右键，取消/结束区域绘制  变为可编辑状态
    this.rgnCanvas.oncontextmenu = function (event) {
        this.ptMouse = null;
        if (this.rgn.points.length < this.rgn.minPoints) {
            //no more pts to draw a rgn
            this.rgn.points = [];
        }
        else {
            this.isRgnComplete = true;
            this.isRgnEditing = true;
        }
        
        if (this.isDrawingRgn) {
            this.onUpdateRgn();
        }
        
        return false;
    }.bind(this);
    
    //更新绘图区域
    this.onUpdateRgn = function () {
        let ctx = this.rgnCanvas.getContext('2d');  
        ctx.clearRect(0, 0, this.videoElement.offsetWidth, this.videoElement.offsetHeight);
        ctx.strokeStyle = 'red';
        ctx.fillStyle = 'yellow';    
        ctx.lineWidth = 2.0;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        if (this.rgn && this.rgn.points.length) {
            ctx.beginPath();
            /*this.rgn.points.forEach(function(pt){
                ctx.arc (pt.xaxis, pt.yaxis, 4, 0, 2 * Math.PI, false); 
            });
            ctx.fill();*/
            //连接每一个点
            let ptLast = null;
            let ptFirst = this.rgn.points[0];
            for (let i = 0; i < this.rgn.points.length; i++) {
                let pt = Object.assign({}, this.rgn.points[i]);

                if (!ptLast) {
                    ptLast = pt;
                }

                let penPt = {xaxis: ptLast.xaxis * this.rgn.cx, yaxis: ptLast.yaxis * this.rgn.cy};

                ctx.moveTo(penPt.xaxis, penPt.yaxis);
                penPt = {xaxis: pt.xaxis * this.rgn.cx, yaxis: pt.yaxis * this.rgn.cy};
                ctx.lineTo(penPt.xaxis, penPt.yaxis); 
                ptLast = pt;

                //编辑的时候显示可拖动的点
                if (this.isRgnEditing) {
                    ctx.moveTo(penPt.xaxis, penPt.yaxis);
                    ctx.arc(penPt.xaxis, penPt.yaxis, 4, 0, Math.PI * 2, true);
                }
            }
            //结束后连接起始点与结束点
            if (this.isRgnComplete) {
                let penPt = {xaxis: ptLast.xaxis * this.rgn.cx, yaxis: ptLast.yaxis * this.rgn.cy};
                ctx.moveTo(penPt.xaxis, penPt.yaxis);
                ptLast = ptFirst;
                penPt = {xaxis: ptLast.xaxis * this.rgn.cx, yaxis: ptLast.yaxis * this.rgn.cy};
                ctx.lineTo(penPt.xaxis, penPt.yaxis); 
            }
            else
            {
                /*
                //连接光标的弹簧线
                if (this.ptMouse) {
                    ctx.lineWidth = 1.0;
                    //ctx.strokeStyle = "yellow";
                    let ptEnd = this.rgn.points[this.rgn.points.length-1];
                    ctx.moveTo(ptEnd.xaxis*this.rgn.cx, ptEnd.yaxis*this.rgn.cy);
                    ctx.lineTo(this.ptMouse.xaxis, this.ptMouse.yaxis);
                }*/
            }
            ctx.closePath();
            ctx.stroke();
        }
    }.bind(this);

    //显示设置的区域
    if (initRgn && initRgn.points) {
        for (let i = 0; i < initRgn.points.length; i++) {
            let ox = initRgn.points[i].xaxis / initRgn.cx; 
            let oy = initRgn.points[i].yaxis / initRgn.cy; 
            if ('left-bottom' == initRgn.origin) {
                oy = 1 - oy;
            }
            else if ('right-top' == initRgn.origin) {
                ox = 1 - ox;
            }
            else if ('right-bottom' == initRgn.origin) {
                ox = 1 - ox;
                oy = 1 - oy;
            }
            this.rgn.points.push({xaxis: ox, yaxis: oy});
            this.onUpdateRgn();
        }
    }
};


/**
 *
    停止绘制区域
 *
 @method -stopRelexRgn  
 *
 @for zlplayer
 * 
 @param {callback cb function}      function(player, rgns)
 * 
 @return {void}  
 */
zlplayer.prototype.stopRelexRgn = function (callback) {
    this.isRgnComplete = true;
    this.isRgnEditing = false;
    this.isInitRgn = false;
    this.onUpdateRgn();

    //回调区域
    if (callback && this.rgn && this.rgn.points) {
        let rgnResult = {};
        rgnResult.points = [];
        rgnResult.cx = this.rgn.cx;
        rgnResult.cy = this.rgn.cy;
        rgnResult.minPoints = this.rgn.minPoints;
        rgnResult.maxPoints = this.rgn.maxPoints;
        for (let i = this.rgn.points.length - 1; i >= 0; i--) {
            let pt = {};
            pt.xaxis = parseInt(this.rgn.points[i].xaxis * this.rgn.cx);
            pt.yaxis = parseInt(this.rgn.points[i].yaxis * this.rgn.cy);
            
            let originDirect = this.rgn.origin;
            if (originDirect) {
                //origin direction is 'left-top'
                if ('left-bottom' == originDirect) {
                    pt.yaxis = this.rgn.cy - pt.yaxis;
                }
                else if ('right-top' == originDirect) {
                    pt.xaxis = this.rgn.cx - pt.xaxis;
                }
                else if ('right-bottom' == originDirect) {
                    pt.xaxis = this.rgn.cx - pt.xaxis;
                    pt.yaxis = this.rgn.cy - pt.yaxis;
                }
            }

            rgnResult.origin = this.rgn.origin;
            rgnResult.points.push(pt);
        }
        callback(this, rgnResult);
    }
};

/**
 *
    清除绘制区域
 *
 @method -clearRelexRgn  
 *
 @for zlplayer
 * 
 @return {void}  
 */
zlplayer.prototype.clearRelexRgn = function () {
    this.isRgnComplete = true;
    this.isDrawingRgn = false;
    this.isInitRgn = false;
    this.rgn = null;
    this.ptMouse = null;
    if (this.rgnCanvas) {
        this.rgnCanvas.style.display = 'none';
    } 
};

/**
 *
    canvas 绘制视频帧
 *
 @method -drawCanvasFrame  
 *
 @for zlplayer
 * 
 @return {void}  
 */

zlplayer.prototype.drawCanvasFrame = function () {
    let ctx = this.canvas.getContext('2d');
    ctx.filter = this.filter;
    ctx.drawImage(this.videoElement, 0, 0, this.canvas.width, this.canvas.height);  
};